(()=>{"use strict";var t,i,s,n,e={6389:(t,i,s)=>{s.d(i,{$g:()=>B,$o:()=>W,A2:()=>r,Ap:()=>j,BH:()=>q,De:()=>at,EX:()=>Y,F5:()=>J,FU:()=>a,GK:()=>$,Gg:()=>F,HB:()=>ct,HI:()=>lt,HV:()=>K,Hy:()=>z,IU:()=>l,K9:()=>m,KI:()=>g,L2:()=>nt,L6:()=>Q,L7:()=>ut,Ls:()=>Z,NS:()=>u,Nh:()=>_,OX:()=>c,P2:()=>tt,PX:()=>d,QR:()=>ht,Rk:()=>S,UP:()=>f,VT:()=>w,W7:()=>mt,WB:()=>G,XM:()=>X,YS:()=>V,ZQ:()=>T,_:()=>A,aW:()=>L,ah:()=>k,dH:()=>R,dl:()=>U,e7:()=>pt,eJ:()=>st,fH:()=>rt,fl:()=>v,g5:()=>ot,gI:()=>D,ge:()=>x,he:()=>E,hf:()=>M,iE:()=>it,j_:()=>et,jc:()=>wt,jk:()=>dt,kp:()=>P,mX:()=>I,oq:()=>y,pT:()=>H,sO:()=>vt,uk:()=>b,vB:()=>ft,vT:()=>o,xF:()=>C,xz:()=>N,zI:()=>O,zN:()=>p});var n=s(9246),e=s(6101),h=s(832);const o=Math.PI/180,r=(Math.PI,new h.A(1,1,1,1)),a=new h.A(0,0,0,0),c=new e.A(0,0,-1),l=new e.A(0,0,1),u=(new e.A(-1,0,0),new e.A(1,0,0)),f=new e.A(0,1,0),d=new e.A(0,-1,0),v=1,m=-1,w=new e.A(0,0,0),p=new n.A,g="YXZ",x=new e.A(1,1,1),M=(new n.A,"convex"),S="concave",y=1e3,_=new e.A(0,1e4,0),P=new e.A(0,-1e4,0),A="player",D=.04,q=0,T=10,E=0,C=1,b=2,U=.001,N=1.94384,R=.5,I=.25,z=.4,L=.35,F=6e3,O=8e3,V=4e3,k=1500,G=0,B=1,H=1,j=2,W=3,$=2,X=1,Z=2,Y=.1,K=1e-6,J=(new h.A(.02,.02,.02,0),new h.A(.02,.02,.02,1)),Q=new h.A(3,1.5,0,0),tt=new h.A(0,0,0,0),it=.5,st=.5,nt=4,et=300,ht=400,ot=100,rt=500/N,at=8,ct=.1,lt=.01,ut=50,ft=.1,dt=.8,vt=1,mt=1e3,wt=15,pt=1e3},1035:(t,i,s)=>{s.d(i,{A:()=>b});var n=s(1447),e=s(1992),h=s(7830),o=s(6101);class r{constructor(){this.type="Curve",this.arcLengthDivisions=200,this.needsUpdate=!1,this.cacheArcLengths=null}getPoint(){console.warn("Curve: .getPoint() not implemented.")}getPointAt(t,i){const s=this.getUtoTmapping(t);return this.getPoint(s,i)}getPoints(t=5){const i=[];for(let s=0;s<=t;s++)i.push(this.getPoint(s/t));return i}getLength(){const t=this.getLengths();return t[t.length-1]}getLengths(t=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===t+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const i=[];let s,n=this.getPoint(0),e=0;i.push(0);for(let h=1;h<=t;h++)s=this.getPoint(h/t),e+=s.distanceTo(n),i.push(e),n=s;return this.cacheArcLengths=i,i}getUtoTmapping(t,i=null){const s=this.getLengths();let n=0;const e=s.length;let h;h=i||t*s[e-1];let o,r=0,a=e-1;for(;r<=a;)if(n=Math.floor(r+(a-r)/2),o=s[n]-h,o<0)r=n+1;else{if(!(o>0)){a=n;break}a=n-1}if(n=a,s[n]===h)return n/(e-1);const c=s[n];return(n+(h-c)/(s[n+1]-c))/(e-1)}getTangent(t,i){const s=1e-4;let n=t-s,e=t+s;n<0&&(n=0),e>1&&(e=1);const r=this.getPoint(n),a=this.getPoint(e),c=i||(r.isVec2?new h.A:new o.A);return c.copy(a).sub(r).normalize(),c}getTangentAt(t,i){const s=this.getUtoTmapping(t);return this.getTangent(s,i)}computeFrenetFrames(t,i=!1){const s=new o.A,h=[],r=[],a=[],c=new o.A,l=new e.A;for(let i=0;i<=t;i++){const s=i/t;h[i]=this.getTangentAt(s,new o.A)}r[0]=new o.A,a[0]=new o.A;let u=Number.MAX_VALUE;const f=Math.abs(h[0].x),d=Math.abs(h[0].y),v=Math.abs(h[0].z);f<=u&&(u=f,s.set(1,0,0)),d<=u&&(u=d,s.set(0,1,0)),v<=u&&s.set(0,0,1),c.crossVectors(h[0],s).normalize(),r[0].crossVectors(h[0],c),a[0].crossVectors(h[0],r[0]);for(let i=1;i<=t;i++){if(r[i]=r[i-1].clone(),a[i]=a[i-1].clone(),c.crossVectors(h[i-1],h[i]),c.length()>Number.EPSILON){c.normalize();const t=Math.acos((0,n.qE)(h[i-1].dot(h[i]),-1,1));r[i].applyMat4(l.makeRotationAxis(c,t))}a[i].crossVectors(h[i],r[i])}if(!0===i){let i=Math.acos((0,n.qE)(r[0].dot(r[t]),-1,1));i/=t,h[0].dot(c.crossVectors(r[0],r[t]))>0&&(i=-i);for(let s=1;s<=t;s++)r[s].applyMat4(l.makeRotationAxis(h[s],i*s)),a[s].crossVectors(h[s],r[s])}return{tangents:h,normals:r,binormals:a}}clone(){return(new this.constructor).copy(this)}copy(t){return this.arcLengthDivisions=t.arcLengthDivisions,this}toJSON(){const t={metadata:{version:4.7,type:"Curve",generator:"Curve.toJSON"}};return t.arcLengthDivisions=this.arcLengthDivisions,t.type=this.type,t}fromJSON(t){return this.arcLengthDivisions=t.arcLengthDivisions,this}}class a extends r{constructor(){super(),this.type="CurvePath",this.curves=[],this.autoClose=!1}add(t){this.curves.push(t)}getPoint(t,i){const s=t*this.getLength(),n=this.getCurveLengths();let e=0;for(;e<n.length;){if(n[e]>=s){const t=n[e]-s,h=this.curves[e],o=h.getLength(),r=0===o?0:1-t/o;return h.getPointAt(r,i)}e++}return null}getLength(){const t=this.getCurveLengths();return t[t.length-1]}getCurveLengths(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;const t=[];let i=0;for(let s=0,n=this.curves.length;s<n;s++)i+=this.curves[s].getLength(),t.push(i);return this.cacheLengths=t,t}getPoints(t=12){const i=[];let s;for(let n=0,e=this.curves;n<e.length;n++){const h=e[n],o=h.isEllipseCurve?2*t:h.isLineCurve||h.isLineCurve3?1:h.isSplineCurve?t*h.points.length:t,r=h.getPoints(o);for(const t of r)s&&s.equals(t)||(i.push(t),s=t)}return this.autoClose&&i.length>1&&!i[i.length-1].equals(i[0])&&i.push(i[0]),i}copy(t){super.copy(t),this.curves=[];for(let i=0,s=t.curves.length;i<s;i++){const s=t.curves[i];this.curves.push(s.clone())}return this.autoClose=t.autoClose,this}}class c extends r{constructor(t=new h.A,i=new h.A){super(),this.isLineCurve=!0,this.type="LineCurve",this.v1=t,this.v2=i}getPoint(t,i=new h.A){const s=i;return 1===t?s.copy(this.v2):(s.copy(this.v2).sub(this.v1,s),s.scale(t,s).add(this.v1,s)),s}getPointAt(t,i){return this.getPoint(t,i)}getTangent(t,i=new h.A){return i.subVectors(this.v2,this.v1).normalize()}getTangentAt(t,i){return this.getTangent(t,i)}copy(t){return super.copy(t),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){const t=super.toJSON();return t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}}function l(t,i,s,n){return function(t,i){const s=1-t;return s*s*i}(t,i)+function(t,i){return 2*(1-t)*t*i}(t,s)+function(t,i){return t*t*i}(t,n)}class u extends r{constructor(t=new h.A,i=new h.A,s=new h.A){super(),this.isQuadraticBezierCurve=!0,this.type="QuadraticBezierCurve",this.v0=t,this.v1=i,this.v2=s}getPoint(t,i=new h.A){const s=i,n=this.v0,e=this.v1,o=this.v2;return s.set(l(t,n.x,e.x,o.x),l(t,n.y,e.y,o.y)),s}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this}}class f extends a{constructor(t){super(),this.type="Path",this.currentPoint=new h.A,t&&this.setFromPoints(t)}setFromPoints(t){this.moveTo(t[0].x,t[0].y);for(let i=1,s=t.length;i<s;i++)this.lineTo(t[i].x,t[i].y);return this}moveTo(t,i){return this.currentPoint.set(t,i),this}lineTo(t,i){const s=new c(this.currentPoint.clone(),new h.A(t,i));return this.curves.push(s),this.currentPoint.set(t,i),this}quadraticCurveTo(t,i,s,n){const e=new u(this.currentPoint.clone(),new h.A(t,i),new h.A(s,n));return this.curves.push(e),this.currentPoint.set(s,n),this}copy(t){return super.copy(t),this.currentPoint.copy(t.currentPoint),this}}class d extends f{constructor(t){super(t),this.type="Shape",this.holes=[]}getPointsHoles(t){const i=[];for(let s=0,n=this.holes.length;s<n;s++)i[s]=this.holes[s].getPoints(t);return i}extractPoints(t){return{shape:this.getPoints(t),holes:this.getPointsHoles(t)}}copy(t){super.copy(t),this.holes=[];for(let i=0,s=t.holes.length;i<s;i++){const s=t.holes[i];this.holes.push(s.clone())}return this}toJSON(){const t=super.toJSON();t.uuid=this.uuid,t.holes=[];for(let i=0,s=this.holes.length;i<s;i++){const s=this.holes[i];t.holes.push(s.toJSON())}return t}fromJSON(t){super.fromJSON(t),this.uuid=t.uuid,this.holes=[];for(let i=0,s=t.holes.length;i<s;i++){const s=t.holes[i];this.holes.push((new f).fromJSON(s))}return this}}class v{constructor(t=1,i=1,s=1,n=1){this.isColor=!0,this.set(t,i,s,n)}set(t,i,s,n){this.r=t,this.g=i,this.b=s,this.a=n}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this}copyFromArray(t){return this.r=t[0],this.g=t[1],this.b=t[2],this.a=t[3],this}}class m{constructor(){this.type="ShapePath",this.color=new v,this.subPaths=[],this.currentPath=null}moveTo(t,i){return this.currentPath=new f,this.subPaths.push(this.currentPath),this.currentPath.moveTo(t,i),this}lineTo(t,i){return this.currentPath.lineTo(t,i),this}quadraticCurveTo(t,i,s,n){return this.currentPath.quadraticCurveTo(t,i,s,n),this}toShapes(t){function i(t,i){const s=i.length;let n=!1;for(let e=s-1,h=0;h<s;e=h++){let s=i[e],o=i[h],r=o.x-s.x,a=o.y-s.y;if(Math.abs(a)>Number.EPSILON){if(a<0&&(s=i[h],r=-r,o=i[e],a=-a),t.y<s.y||t.y>o.y)continue;if(t.y===s.y){if(t.x===s.x)return!0}else{const i=a*(t.x-s.x)-r*(t.y-s.y);if(0===i)return!0;if(i<0)continue;n=!n}}else{if(t.y!==s.y)continue;if(o.x<=t.x&&t.x<=s.x||s.x<=t.x&&t.x<=o.x)return!0}}return n}const s=m.isClockWise,n=this.subPaths;if(0===n.length)return[];let e,h,o;const r=[];if(1===n.length)return h=n[0],o=new d,o.curves=h.curves,r.push(o),r;let a=!s(n[0].getPoints());a=t?!a:a;const c=[],l=[];let u,f,v=[],w=0;l[w]=void 0,v[w]=[];for(let i=0,o=n.length;i<o;i++)h=n[i],u=h.getPoints(),e=s(u),e=t?!e:e,e?(!a&&l[w]&&w++,l[w]={s:new d,p:u},l[w].s.curves=h.curves,a&&w++,v[w]=[]):v[w].push({h,p:u[0]});if(!l[0])return function(t){const i=[];for(let s=0,n=t.length;s<n;s++){const n=t[s],e=new d;e.curves=n.curves,i.push(e)}return i}(n);if(1<l.length){let t=!1,s=0;for(let t=0,i=l.length;t<i;t++)c[t]=[];for(let n=0,e=l.length;n<e;n++){const e=v[n];for(let h=0;h<e.length;h++){const o=e[h];let r=!0;for(let e=0;e<l.length;e++)i(o.p,l[e].p)&&(n!==e&&s++,r?(r=!1,c[e].push(o)):t=!0);r&&c[n].push(o)}}s>0&&!1===t&&(v=c)}for(let t=0,i=l.length;t<i;t++){o=l[t].s,r.push(o),f=v[t];for(let t=0,i=f.length;t<i;t++)o.holes.push(f[t].h)}return r}static isClockWise(t){return m.area(t)<0}static area(t){const i=t.length;let s=0;for(let n=i-1,e=0;e<i;n=e++)s+=t[n].x*t[e].y-t[e].x*t[n].y;return.5*s}}class w{parse(t){return new p(t)}}class p{constructor(t){this.isFont=!0,this.type="Font",this.data=t}generateShapes(t,i=100){const s=[],n=function(t,i,s){const n=Array.from(t),e=i/s.resolution,h=(s.boundingBox.yMax-s.boundingBox.yMin+s.underlineThickness)*e,o=[];let r=0,a=0;for(const t of n)if("\n"===t)r=0,a-=h;else{const i=g(t,e,r,a,s);r+=i.offsetX,o.push(i.path)}return{paths:o,totalWidth:r,lineHeight:(s.ascender+s.descender-.5*s.underlineThickness)*e}}(t,i,this.data);for(const t of n.paths)s.push(...t.toShapes());return{shapes:s,totalWidth:n.totalWidth,lineHeight:n.lineHeight}}}function g(t,i,s,n,e){const h=e.glyphs[t]||e.glyphs["?"];if(!h)return void console.error(`Character "${t}" does not exists in font family "${e.familyName}".`);const o=new m;let r,a,c,l,u,f;if(h.o){const t=h.$||(h.$=h.o.split(" "));for(let e=0,h=t.length;e<h;){switch(t[e++]){case"m":r=t[e++]*i+s,a=t[e++]*i+n,o.moveTo(r,a);break;case"l":r=t[e++]*i+s,a=t[e++]*i+n,o.lineTo(r,a);break;case"q":c=t[e++]*i+s,l=t[e++]*i+n,u=t[e++]*i+s,f=t[e++]*i+n,o.quadraticCurveTo(u,f,c,l)}}}return{offsetX:h.ha*i,path:o}}var x=s(6839);class M{static area(t){const i=t.length;let s=0;for(let n=i-1,e=0;e<i;n=e++)s+=t[n].x*t[e].y-t[e].x*t[n].y;return.5*s}static isClockWise(t){return M.area(t)<0}static triangulateShape(t,i){const s=[],n=[],e=[];S(t),y(s,t);let h=t.length;i.forEach(S);for(const t of i)n.push(h),h+=t.length,y(s,t);const o=(0,x.Ay)(s,n);for(let t=0;t<o.length;t+=3)e.push(o.slice(t,t+3));return e}}function S(t){const i=t.length;i>2&&t[i-1].equals(t[0])&&t.pop()}function y(t,i){for(const s of i)t.push(s.x),t.push(s.y)}class _{constructor(t=new d([new h.A(0,.5),new h.A(-.5,-.5),new h.A(.5,-.5)]),i=12){this.type="ShapeGeometry",this.parameters={shapes:t,curveSegments:i};const s=[],n=[],e=[],o=[];if(Array.isArray(t))for(const i of t)r(i);else r(t);function r(t){const h=n.length/3,r=t.extractPoints(i);let a=r.shape;const c=r.holes;M.isClockWise(a)||(a=a.reverse());for(let t=0,i=c.length;t<i;t++){const i=c[t];!0===M.isClockWise(i)&&(c[t]=i.reverse())}const l=M.triangulateShape(a,c);for(let t=0,i=c.length;t<i;t++){const i=c[t];a=a.concat(i)}for(let t=0,i=a.length;t<i;t++){const i=a[t];n.push(i.x,i.y,0),e.push(0,0,1),o.push(i.x,i.y)}for(let t=0,i=l.length;t<i;t++){const i=l[t],n=i[0]+h,e=i[1]+h,o=i[2]+h;s.push(n,e,o)}}this.vertices=n,this.indices=s}}var P=s(2780),A=s(7133),D=s(1235),q=s(9633);const T={glyphs:{0:{ha:690,x_min:61,x_max:629,o:"m 346 -17 q 137 103 213 -17 q 61 446 61 224 q 137 786 61 669 q 346 903 213 903 q 553 786 478 903 q 629 446 629 669 q 553 103 629 224 q 346 -17 478 -17 m 346 75 q 471 163 424 75 q 518 446 518 251 q 471 726 518 640 q 346 811 424 811 q 220 726 268 811 q 172 446 172 640 q 220 163 172 251 q 346 75 268 75 z "},1:{ha:690,x_min:110,x_max:610,o:"m 110 0 l 110 94 l 313 94 l 313 747 l 151 747 l 151 821 q 258 848 213 832 q 339 886 303 864 l 426 886 l 426 94 l 610 94 l 610 0 l 110 0 z "},2:{ha:690,x_min:50,x_max:628,o:"m 56 0 l 56 68 q 282 302 189 201 q 424 484 375 403 q 472 636 472 565 q 431 761 472 713 q 304 810 389 810 q 201 778 249 810 q 115 703 154 747 l 50 768 q 169 866 106 829 q 318 903 232 903 q 513 831 442 903 q 583 642 583 760 q 537 473 583 558 q 409 294 490 388 q 222 90 328 200 q 297 96 258 93 q 371 99 336 99 l 628 99 l 628 0 l 56 0 z "},3:{ha:690,x_min:36,x_max:619,o:"m 328 -17 q 151 22 222 -17 q 36 108 81 60 l 94 183 q 189 110 135 142 q 321 78 243 78 q 453 122 401 78 q 504 240 504 167 q 477 333 504 293 q 388 394 450 372 q 221 417 326 417 l 221 504 q 370 526 315 504 q 449 586 425 549 q 472 669 472 624 q 431 772 472 735 q 319 810 390 810 q 217 785 264 810 q 131 719 171 760 l 69 792 q 183 872 121 840 q 324 903 246 903 q 514 844 439 903 q 589 678 589 785 q 544 546 589 597 q 428 467 500 494 l 428 461 q 564 385 508 443 q 619 236 619 328 q 581 101 619 158 q 476 14 542 44 q 328 -17 410 -17 z "},4:{ha:690,x_min:24,x_max:651,o:"m 144 336 l 422 336 l 422 593 q 425 679 422 629 q 429 764 428 729 l 424 764 q 389 701 407 732 q 351 639 371 671 l 144 336 m 422 0 l 422 244 l 24 244 l 24 319 l 403 886 l 531 886 l 531 336 l 651 336 l 651 244 l 531 244 l 531 0 l 422 0 z "},5:{ha:690,x_min:35,x_max:624,o:"m 325 -17 q 150 21 219 -17 q 35 104 81 58 l 90 179 q 183 109 131 140 q 314 78 236 78 q 452 133 396 78 q 508 281 508 188 q 457 424 508 372 q 319 475 406 475 q 241 461 274 475 q 168 421 208 447 l 107 460 l 136 886 l 579 886 l 579 788 l 236 788 l 213 525 q 276 551 244 542 q 349 561 308 561 q 487 531 425 561 q 586 440 549 501 q 624 283 624 379 q 581 120 624 188 q 471 18 539 53 q 325 -17 403 -17 z "},6:{ha:690,x_min:67,x_max:635,o:"m 363 456 q 269 428 319 456 q 178 339 219 400 q 238 142 189 210 q 372 74 288 74 q 482 127 438 74 q 526 268 526 181 q 485 405 526 354 q 363 456 444 456 m 372 -17 q 217 31 286 -17 q 107 173 147 78 q 67 410 67 268 q 115 696 67 588 q 240 853 163 804 q 404 903 317 903 q 528 876 476 903 q 618 808 581 849 l 554 738 q 489 788 528 769 q 408 807 450 807 q 294 772 346 807 q 210 653 243 736 q 175 431 178 571 q 272 512 217 482 q 382 542 328 542 q 566 473 497 542 q 635 268 635 404 q 599 119 635 183 q 503 19 563 56 q 372 -17 444 -17 z "},7:{ha:690,x_min:61,x_max:632,o:"m 246 0 q 281 299 254 167 q 362 549 308 432 q 503 788 415 667 l 61 788 l 61 886 l 632 886 l 632 815 q 503 623 553 715 q 425 437 453 531 q 383 236 397 343 q 364 0 369 129 l 246 0 z "},8:{ha:690,x_min:57,x_max:633,o:"m 347 -17 q 199 15 264 -17 q 95 101 133 46 q 57 226 57 157 q 81 330 57 285 q 144 409 106 375 q 224 465 182 443 l 224 471 q 138 556 175 506 q 100 675 100 606 q 133 794 100 743 q 224 874 167 846 q 351 903 281 903 q 534 836 467 903 q 601 667 601 769 q 582 580 601 621 q 535 506 563 539 q 479 453 507 474 l 479 447 q 554 394 519 425 q 611 322 589 364 q 633 219 633 279 q 598 100 633 154 q 498 15 563 46 q 347 -17 433 -17 m 410 483 q 478 568 454 524 q 503 661 503 613 q 463 772 503 726 q 349 818 422 818 q 247 779 288 818 q 206 675 206 740 q 234 588 206 622 q 310 528 263 553 q 410 483 357 504 m 350 68 q 476 112 428 68 q 524 224 524 156 q 490 317 524 281 q 402 379 457 353 q 283 431 347 406 q 195 347 231 396 q 160 238 160 299 q 215 116 160 164 q 350 68 269 68 z "},9:{ha:690,x_min:56,x_max:622,o:"m 163 618 q 203 481 163 532 q 326 431 244 431 q 420 458 371 431 q 513 549 469 486 q 451 745 501 678 q 317 813 401 813 q 208 759 253 813 q 163 618 163 706 m 285 -17 q 160 10 214 -17 q 71 76 107 38 l 135 149 q 201 97 163 117 q 281 78 239 78 q 396 114 343 78 q 481 233 449 150 q 515 458 514 317 q 418 375 474 406 q 307 344 363 344 q 124 413 193 344 q 56 618 56 482 q 92 767 56 703 q 187 867 128 831 q 317 903 246 903 q 474 856 404 903 q 583 714 543 808 q 622 476 622 619 q 574 190 622 299 q 450 33 526 82 q 285 -17 374 -17 z "}," ":{ha:278,x_min:0,x_max:0,o:""},A:{ha:756,x_min:4,x_max:751,o:"m 282 510 l 239 371 l 513 371 l 469 510 q 422 662 444 586 q 378 817 400 738 l 372 817 q 329 662 351 738 q 282 510 307 586 m 4 0 l 313 911 l 443 911 l 751 0 l 628 0 l 542 278 l 210 278 l 122 0 l 4 0 z "},B:{ha:817,x_min:125,x_max:761,o:"m 125 0 l 125 911 l 396 911 q 559 889 489 911 q 669 818 629 867 q 708 689 708 769 q 674 566 708 621 q 575 490 640 511 l 575 485 q 709 415 657 469 q 761 267 761 361 q 717 118 761 178 q 596 29 674 58 q 415 0 518 0 l 125 0 m 240 524 l 375 524 q 543 564 492 524 q 594 674 594 604 q 541 786 594 753 q 381 819 488 819 l 240 819 l 240 524 m 240 92 l 399 92 q 582 135 517 92 q 647 271 647 179 q 583 395 647 356 q 399 435 518 435 l 240 435 l 240 92 z "},C:{ha:793,x_min:72,x_max:749,o:"m 469 -17 q 266 40 356 -17 q 124 201 176 96 q 72 456 72 307 q 125 708 72 603 q 269 871 178 814 q 476 928 361 928 q 624 894 560 928 q 726 815 688 860 l 664 740 q 582 803 628 779 q 478 826 536 826 q 327 781 392 826 q 227 654 263 736 q 192 458 192 572 q 226 260 192 344 q 324 131 261 176 q 474 85 388 85 q 590 113 539 85 q 685 188 642 140 l 749 115 q 626 18 694 53 q 469 -17 558 -17 z "},D:{ha:854,x_min:125,x_max:783,o:"m 125 0 l 125 911 l 353 911 q 674 794 564 911 q 783 460 783 676 q 674 121 783 242 q 358 0 565 0 l 125 0 m 240 94 l 344 94 q 584 191 504 94 q 664 460 664 288 q 584 724 664 632 q 344 817 504 817 l 240 817 l 240 94 z "},E:{ha:732,x_min:125,x_max:664,o:"m 125 0 l 125 911 l 650 911 l 650 814 l 240 814 l 240 528 l 586 528 l 586 429 l 240 429 l 240 99 l 664 99 l 664 0 l 125 0 z "},F:{ha:686,x_min:125,x_max:650,o:"m 125 0 l 125 911 l 650 911 l 650 814 l 240 814 l 240 506 l 588 506 l 588 408 l 240 408 l 240 0 l 125 0 z "},G:{ha:857,x_min:72,x_max:764,o:"m 483 -17 q 271 40 364 -17 q 125 201 178 96 q 72 456 72 307 q 126 708 72 603 q 275 871 181 814 q 490 928 369 928 q 649 892 585 928 q 753 815 714 857 l 689 740 q 608 801 654 776 q 493 826 563 826 q 333 781 401 826 q 228 654 265 736 q 192 458 192 572 q 270 185 192 286 q 494 85 349 85 q 588 99 543 85 q 658 139 632 114 l 658 376 l 465 376 l 465 472 l 764 472 l 764 89 q 648 13 721 43 q 483 -17 575 -17 z "},H:{ha:906,x_min:125,x_max:781,o:"m 125 0 l 125 911 l 240 911 l 240 529 l 664 529 l 664 911 l 781 911 l 781 0 l 664 0 l 664 429 l 240 429 l 240 0 l 125 0 z "},I:{ha:365,x_min:125,x_max:240,o:"m 125 0 l 125 911 l 240 911 l 240 0 l 125 0 z "},J:{ha:667,x_min:43,x_max:546,o:"m 294 -17 q 43 129 124 -17 l 126 188 q 196 109 157 133 q 283 85 235 85 q 393 130 357 85 q 429 279 429 175 l 429 911 l 546 911 l 546 268 q 520 125 546 190 q 439 22 494 60 q 294 -17 383 -17 z "},K:{ha:804,x_min:125,x_max:799,o:"m 125 0 l 125 911 l 240 911 l 240 454 l 244 454 l 624 911 l 754 911 l 469 564 l 799 0 l 669 0 l 397 474 l 240 289 l 240 0 l 125 0 z "},L:{ha:675,x_min:125,x_max:639,o:"m 125 0 l 125 911 l 240 911 l 240 99 l 639 99 l 639 0 l 125 0 z "},M:{ha:1010,x_min:125,x_max:885,o:"m 125 0 l 125 911 l 264 911 l 439 425 q 472 330 456 378 q 504 235 488 282 l 510 235 q 541 330 526 282 q 572 425 556 378 l 744 911 l 885 911 l 885 0 l 776 0 l 776 501 q 782 637 776 563 q 792 771 788 711 l 786 771 l 714 564 l 542 92 l 465 92 l 293 564 l 221 771 l 215 771 q 224 637 219 711 q 229 501 229 563 l 229 0 l 125 0 z "},N:{ha:899,x_min:125,x_max:774,o:"m 125 0 l 125 911 l 244 911 l 574 339 l 672 150 l 678 150 q 669 294 674 219 q 664 440 664 368 l 664 911 l 774 911 l 774 0 l 654 0 l 324 574 l 225 761 l 219 761 q 230 621 225 693 q 235 476 235 549 l 235 0 l 125 0 z "},O:{ha:922,x_min:72,x_max:851,o:"m 461 -17 q 259 42 347 -17 q 122 207 171 100 q 72 460 72 314 q 122 710 72 606 q 259 872 171 815 q 461 928 347 928 q 664 872 576 928 q 801 710 751 815 q 851 460 851 606 q 801 207 851 314 q 664 42 751 100 q 461 -17 576 -17 m 461 85 q 603 131 543 85 q 697 262 664 178 q 731 460 731 346 q 657 728 731 629 q 461 826 583 826 q 265 728 339 826 q 192 460 192 629 q 225 262 192 346 q 319 131 258 178 q 461 85 381 85 z "},P:{ha:786,x_min:125,x_max:726,o:"m 125 0 l 125 911 l 385 911 q 564 886 488 911 q 683 802 640 861 q 726 643 726 743 q 633 431 726 500 q 390 361 540 361 l 240 361 l 240 0 l 125 0 m 240 456 l 376 456 q 553 501 496 456 q 611 643 611 546 q 551 780 611 742 q 371 818 490 818 l 240 818 l 240 456 z "},Q:{ha:922,x_min:72,x_max:871,o:"m 461 79 q 603 126 543 79 q 697 258 664 172 q 731 460 731 343 q 657 728 731 629 q 461 826 583 826 q 265 728 339 826 q 192 460 192 629 q 225 258 192 343 q 319 126 258 172 q 461 79 381 79 m 740 -229 q 529 -167 614 -229 q 404 -12 444 -106 q 231 63 306 1 q 114 225 156 124 q 72 460 72 326 q 122 710 72 606 q 259 872 171 815 q 461 928 347 928 q 664 872 576 928 q 801 710 751 815 q 851 460 851 606 q 811 229 851 329 q 699 67 771 129 q 529 -11 626 6 q 620 -101 561 -71 q 753 -132 679 -132 q 807 -128 783 -132 q 849 -119 831 -125 l 871 -208 q 815 -223 850 -217 q 740 -229 781 -229 z "},R:{ha:790,x_min:125,x_max:756,o:"m 125 0 l 125 911 l 410 911 q 575 887 503 911 q 688 806 647 863 q 729 656 729 750 q 674 485 729 550 q 524 397 618 421 l 756 0 l 625 0 l 406 385 l 240 385 l 240 0 l 125 0 m 240 479 l 393 479 q 557 523 500 479 q 614 656 614 567 q 557 782 614 746 q 393 818 500 818 l 240 818 l 240 479 z "},S:{ha:742,x_min:58,x_max:688,o:"m 378 -17 q 200 20 282 -17 q 58 118 118 57 l 128 199 q 242 116 176 147 q 379 85 308 85 q 519 126 469 85 q 569 233 569 167 q 549 308 569 281 q 495 356 529 336 q 418 394 461 375 l 288 451 q 202 499 244 469 q 131 574 160 528 q 103 686 103 619 q 140 810 103 756 q 242 897 176 865 q 389 928 307 928 q 540 897 471 928 q 658 815 610 865 l 596 740 q 503 803 554 781 q 389 826 453 826 q 266 790 313 826 q 219 693 219 754 q 242 622 219 650 q 300 575 265 593 q 371 542 335 557 l 500 486 q 595 433 553 464 q 663 356 638 401 q 688 243 688 311 q 650 112 688 171 q 543 18 613 53 q 378 -17 474 -17 z "},T:{ha:744,x_min:39,x_max:706,o:"m 314 0 l 314 814 l 39 814 l 39 911 l 706 911 l 706 814 l 431 814 l 431 0 l 314 0 z "},U:{ha:896,x_min:121,x_max:775,o:"m 449 -17 q 281 21 356 -17 q 164 144 207 58 q 121 376 121 231 l 121 911 l 236 911 l 236 374 q 265 201 236 264 q 341 111 293 138 q 449 85 389 85 q 558 111 510 85 q 635 201 607 138 q 664 374 664 264 l 664 911 l 775 911 l 775 376 q 732 144 775 231 q 615 21 689 58 q 449 -17 542 -17 z "},V:{ha:715,x_min:0,x_max:715,o:"m 292 0 l 0 911 l 124 911 l 269 419 q 313 269 294 339 q 358 118 332 199 l 364 118 q 408 269 389 199 q 451 419 428 339 l 597 911 l 715 911 l 426 0 l 292 0 z "},W:{ha:1092,x_min:32,x_max:1058,o:"m 225 0 l 32 911 l 151 911 l 247 415 q 274 268 260 342 q 300 121 288 194 l 306 121 q 338 269 321 194 q 369 415 354 343 l 496 911 l 601 911 l 728 415 q 761 269 744 343 q 794 121 778 194 l 800 121 q 825 269 813 194 q 851 415 838 343 l 947 911 l 1058 911 l 869 0 l 731 0 l 593 549 q 570 652 581 601 q 549 756 560 703 l 543 756 q 521 652 533 703 q 497 549 508 601 l 363 0 l 225 0 z "},X:{ha:713,x_min:21,x_max:692,o:"m 21 0 l 286 471 l 39 911 l 167 911 l 290 678 q 324 617 308 647 q 361 546 340 586 l 367 546 q 401 617 386 586 q 432 678 415 647 l 553 911 l 675 911 l 426 465 l 692 0 l 564 0 l 431 246 q 394 315 413 279 q 353 392 375 350 l 347 392 q 310 315 328 350 q 275 246 292 279 l 143 0 l 21 0 z "},Y:{ha:661,x_min:-1,x_max:663,o:"m 272 0 l 272 353 l -1 911 l 122 911 l 240 654 q 284 556 263 604 q 328 456 306 507 l 333 456 q 381 556 357 507 q 425 654 404 604 l 542 911 l 663 911 l 389 353 l 389 0 l 272 0 z "},Z:{ha:749,x_min:63,x_max:690,o:"m 63 0 l 63 69 l 542 814 l 106 814 l 106 911 l 686 911 l 686 843 l 206 99 l 690 99 l 690 0 l 63 0 z "},a:{ha:700,x_min:72,x_max:601,o:"m 269 -17 q 128 34 185 -17 q 72 175 72 85 q 172 345 72 286 q 486 428 271 404 q 474 510 486 471 q 433 573 463 549 q 347 597 403 597 q 238 575 289 597 q 146 525 186 553 l 101 604 q 217 663 149 635 q 367 692 286 692 q 546 616 490 692 q 601 414 601 540 l 601 0 l 507 0 l 497 81 l 493 81 q 390 13 446 42 q 269 -17 333 -17 m 303 75 q 394 99 351 75 q 486 165 438 122 l 486 353 q 251 290 318 332 q 183 183 183 249 q 218 101 183 126 q 303 75 253 75 z "},b:{ha:768,x_min:114,x_max:704,o:"m 413 -17 q 315 6 365 -17 q 219 69 264 29 l 215 69 l 206 0 l 114 0 l 114 989 l 228 989 l 228 719 l 225 597 q 326 665 271 638 q 436 692 381 692 q 636 599 568 692 q 704 349 704 506 q 663 151 704 233 q 556 26 622 69 q 413 -17 490 -17 m 393 79 q 531 151 476 79 q 586 347 586 222 q 545 527 586 458 q 408 596 504 596 q 321 572 365 596 q 228 504 276 549 l 228 150 q 316 95 272 111 q 393 79 360 79 z "},c:{ha:633,x_min:64,x_max:599,o:"m 381 -17 q 219 25 292 -17 q 106 146 147 67 q 64 336 64 225 q 109 529 64 450 q 228 650 154 608 q 389 692 303 692 q 503 668 456 692 q 586 613 551 644 l 528 538 q 466 581 499 564 q 393 597 433 597 q 284 565 332 597 q 209 473 236 532 q 182 336 182 414 q 240 149 182 221 q 390 78 297 78 q 478 98 438 78 q 549 146 518 118 l 599 69 q 497 6 553 29 q 381 -17 442 -17 z "},d:{ha:771,x_min:65,x_max:657,o:"m 344 -17 q 142 76 218 -17 q 65 336 65 168 q 106 526 65 446 q 215 649 147 606 q 358 692 282 692 q 460 671 417 692 q 547 614 503 650 l 542 729 l 542 989 l 657 989 l 657 0 l 563 0 l 553 79 l 549 79 q 457 12 510 40 q 344 -17 404 -17 m 369 79 q 542 172 458 79 l 542 525 q 459 580 499 564 q 378 596 419 596 q 280 563 324 596 q 210 473 236 531 q 183 338 183 415 q 232 148 183 217 q 369 79 281 79 z "},e:{ha:689,x_min:64,x_max:636,o:"m 388 -17 q 224 26 297 -17 q 107 147 150 68 q 64 336 64 226 q 108 526 64 447 q 221 649 151 606 q 367 692 290 692 q 566 606 496 692 q 636 375 636 519 q 635 340 636 357 q 632 310 635 322 l 176 310 q 244 139 183 203 q 401 75 304 75 q 491 90 450 75 q 569 128 532 104 l 610 53 q 512 4 567 25 q 388 -17 457 -17 m 175 392 l 536 392 q 492 548 536 494 q 369 601 449 601 q 242 547 299 601 q 175 392 186 492 z "},f:{ha:406,x_min:42,x_max:443,o:"m 133 0 l 133 582 l 42 582 l 42 668 l 133 675 l 133 782 q 181 945 133 885 q 331 1006 229 1006 q 392 999 363 1006 q 443 983 421 993 l 418 896 q 342 913 381 913 q 247 782 247 913 l 247 675 l 390 675 l 390 582 l 247 582 l 247 0 l 133 0 z "},g:{ha:700,x_min:63,x_max:683,o:"m 342 -311 q 140 -264 218 -311 q 63 -129 63 -217 q 89 -47 63 -86 q 161 24 115 -7 l 161 29 q 119 72 136 44 q 101 139 101 100 q 125 214 101 182 q 175 264 149 246 l 175 269 q 115 344 142 297 q 88 451 88 392 q 122 579 88 525 q 215 663 157 633 q 342 692 274 692 q 394 687 369 692 q 438 675 419 682 l 672 675 l 672 588 l 533 588 q 573 528 557 565 q 589 449 589 492 q 556 324 589 376 q 467 242 522 271 q 342 214 411 214 q 240 238 288 214 q 210 203 222 222 q 197 157 197 185 q 223 104 197 125 q 317 83 249 83 l 447 83 q 624 45 565 83 q 683 -78 683 7 q 642 -193 683 -140 q 524 -278 600 -246 q 342 -311 447 -311 m 342 290 q 442 334 400 290 q 485 451 485 378 q 443 567 485 525 q 342 608 401 608 q 240 567 282 608 q 199 451 199 525 q 241 334 199 378 q 342 290 283 290 m 358 -232 q 514 -190 456 -232 q 572 -94 572 -147 q 537 -29 572 -47 q 436 -11 501 -11 l 319 -11 q 277 -8 300 -11 q 232 0 254 -6 q 179 -56 196 -26 q 163 -114 163 -85 q 215 -200 163 -168 q 358 -232 267 -232 z "},h:{ha:756,x_min:114,x_max:654,o:"m 114 0 l 114 989 l 228 989 l 228 719 l 224 581 q 326 659 272 626 q 449 692 379 692 q 605 624 556 692 q 654 428 654 557 l 654 0 l 540 0 l 540 413 q 510 550 540 507 q 413 593 479 593 q 320 567 361 593 q 228 489 279 540 l 228 0 l 114 0 z "},i:{ha:342,x_min:96,x_max:249,o:"m 114 0 l 114 675 l 228 675 l 228 0 l 114 0 m 172 814 q 117 834 139 814 q 96 889 96 854 q 117 943 96 922 q 172 964 139 964 q 227 943 206 964 q 249 889 249 922 q 227 834 249 854 q 172 814 206 814 z "},j:{ha:343,x_min:-56,x_max:247,o:"m 44 -301 q -12 -296 14 -301 q -56 -283 -37 -290 l -32 -197 q -3 -205 -19 -201 q 32 -208 14 -208 q 99 -173 82 -208 q 115 -76 115 -137 l 115 675 l 229 675 l 229 -76 q 188 -240 229 -179 q 44 -301 146 -301 m 171 814 q 116 834 138 814 q 94 889 94 854 q 116 943 94 922 q 171 964 138 964 q 226 943 204 964 q 247 889 247 922 q 226 834 247 854 q 171 814 204 814 z "},k:{ha:688,x_min:114,x_max:675,o:"m 114 0 l 114 989 l 226 989 l 226 319 l 231 319 l 518 675 l 644 675 l 418 404 l 675 0 l 550 0 l 353 325 l 226 178 l 226 0 l 114 0 z "},l:{ha:354,x_min:114,x_max:300,o:"m 235 -17 q 142 23 171 -17 q 114 136 114 63 l 114 989 l 228 989 l 228 128 q 238 90 228 101 q 260 78 247 78 q 270 78 265 78 q 285 81 275 79 l 300 -6 q 274 -14 289 -11 q 235 -17 258 -17 z "},m:{ha:1151,x_min:114,x_max:1046,o:"m 114 0 l 114 675 l 208 675 l 218 578 l 222 578 q 319 659 267 626 q 432 692 372 692 q 553 658 510 692 q 618 563 597 624 q 725 656 671 619 q 840 692 779 692 q 995 624 944 692 q 1046 428 1046 557 l 1046 0 l 932 0 l 932 413 q 901 550 932 507 q 807 593 871 593 q 638 489 732 593 l 638 0 l 524 0 l 524 413 q 493 550 524 507 q 397 593 463 593 q 228 489 322 593 l 228 0 l 114 0 z "},n:{ha:760,x_min:114,x_max:654,o:"m 114 0 l 114 675 l 208 675 l 218 578 l 222 578 q 325 659 271 626 q 449 692 379 692 q 605 624 556 692 q 654 428 654 557 l 654 0 l 540 0 l 540 413 q 510 550 540 507 q 413 593 479 593 q 320 567 361 593 q 228 489 279 540 l 228 0 l 114 0 z "},o:{ha:753,x_min:64,x_max:689,o:"m 376 -17 q 223 25 294 -17 q 108 146 151 67 q 64 336 64 225 q 108 529 64 450 q 223 650 151 608 q 376 692 294 692 q 531 650 460 692 q 645 529 601 608 q 689 336 689 450 q 645 146 689 225 q 531 25 601 67 q 376 -17 460 -17 m 376 78 q 517 149 464 78 q 571 336 571 221 q 517 525 571 453 q 376 597 464 597 q 236 525 290 597 q 182 336 182 453 q 236 149 182 221 q 376 78 290 78 z "},p:{ha:771,x_min:114,x_max:704,o:"m 114 -285 l 114 675 l 208 675 l 218 597 l 222 597 q 323 664 268 636 q 438 692 378 692 q 636 598 568 692 q 704 347 704 504 q 663 151 704 233 q 556 26 622 69 q 413 -17 490 -17 q 319 4 365 -17 q 225 61 272 25 l 228 -57 l 228 -285 l 114 -285 m 393 79 q 531 151 476 79 q 586 347 586 222 q 545 527 586 458 q 408 596 504 596 q 322 572 365 596 q 228 504 278 549 l 228 150 q 317 95 274 111 q 393 79 360 79 z "},q:{ha:771,x_min:65,x_max:657,o:"m 542 -285 l 542 -44 l 547 78 q 455 11 507 39 q 344 -17 403 -17 q 142 76 218 -17 q 65 336 65 168 q 106 526 65 446 q 215 649 147 606 q 358 692 282 692 q 461 672 417 692 q 551 611 506 651 l 554 611 l 565 675 l 657 675 l 657 -285 l 542 -285 m 369 79 q 542 172 458 79 l 542 525 q 459 580 499 564 q 378 596 419 596 q 280 563 324 596 q 210 473 236 531 q 183 338 183 415 q 232 148 183 217 q 369 79 281 79 z "},r:{ha:482,x_min:114,x_max:486,o:"m 114 0 l 114 675 l 208 675 l 218 553 l 222 553 q 307 654 257 617 q 414 692 357 692 q 486 678 454 692 l 464 578 q 433 586 447 583 q 399 589 419 589 q 309 554 356 589 q 228 433 263 519 l 228 0 l 114 0 z "},s:{ha:582,x_min:39,x_max:538,o:"m 290 -17 q 153 10 218 -17 q 39 76 88 38 l 96 153 q 188 95 140 118 q 294 72 235 72 q 394 103 361 72 q 428 178 428 135 q 405 236 428 213 q 347 276 382 260 q 274 306 311 292 q 181 347 226 324 q 106 406 135 369 q 76 500 76 443 q 138 637 76 582 q 310 692 200 692 q 426 669 372 692 q 519 615 481 647 l 464 543 q 392 586 429 569 q 310 603 354 603 q 216 574 246 603 q 186 506 186 544 q 207 453 186 474 q 261 419 228 433 q 332 389 294 404 q 428 348 381 371 q 506 287 475 325 q 538 185 538 249 q 509 85 538 131 q 426 11 481 39 q 290 -17 371 -17 z "},t:{ha:469,x_min:33,x_max:451,o:"m 326 -17 q 176 46 218 -17 q 133 208 133 108 l 133 582 l 33 582 l 33 668 l 139 675 l 153 864 l 249 864 l 249 675 l 431 675 l 431 582 l 249 582 l 249 207 q 272 110 249 144 q 353 76 294 76 q 392 83 371 76 q 429 94 413 89 l 451 8 q 391 -9 424 -1 q 326 -17 358 -17 z "},u:{ha:756,x_min:104,x_max:642,o:"m 311 -17 q 154 51 204 -17 q 104 247 104 118 l 104 675 l 219 675 l 219 263 q 249 125 219 168 q 346 82 279 82 q 440 109 399 82 q 528 196 481 136 l 528 675 l 642 675 l 642 0 l 547 0 l 538 106 l 533 106 q 433 17 486 50 q 311 -17 381 -17 z "},v:{ha:649,x_min:17,x_max:632,o:"m 260 0 l 17 675 l 135 675 l 263 292 q 294 192 278 242 q 325 93 310 142 l 331 93 q 362 192 346 142 q 392 292 378 242 l 519 675 l 632 675 l 393 0 l 260 0 z "},w:{ha:997,x_min:33,x_max:964,o:"m 221 0 l 33 675 l 150 675 l 250 285 q 271 191 261 238 q 290 97 281 144 l 296 97 q 318 191 307 144 q 342 285 329 238 l 446 675 l 557 675 l 663 285 q 687 191 675 238 q 710 97 699 144 l 715 97 q 737 191 726 144 q 757 285 747 238 l 856 675 l 964 675 l 783 0 l 644 0 l 547 363 q 524 458 535 411 q 501 557 514 506 l 496 557 q 474 458 485 506 q 449 361 463 410 l 354 0 l 221 0 z "},x:{ha:619,x_min:19,x_max:600,o:"m 19 0 l 240 353 l 36 675 l 160 675 l 250 526 q 282 471 265 500 q 317 414 299 442 l 322 414 q 353 471 338 442 q 383 526 368 500 l 465 675 l 585 675 l 381 340 l 600 0 l 476 0 l 378 157 q 342 218 360 188 q 304 278 324 249 l 299 278 q 264 219 281 249 q 231 157 247 189 l 139 0 l 19 0 z "},y:{ha:649,x_min:17,x_max:632,o:"m 125 -290 q 83 -286 103 -290 q 46 -276 63 -282 l 68 -186 q 93 -192 79 -189 q 119 -196 107 -196 q 214 -155 176 -196 q 272 -51 251 -114 l 288 -1 l 17 675 l 135 675 l 272 301 q 305 208 288 258 q 338 111 322 158 l 343 111 q 372 207 358 157 q 400 301 386 257 l 521 675 l 632 675 l 378 -56 q 322 -175 354 -122 q 241 -259 289 -228 q 125 -290 193 -290 z "},z:{ha:590,x_min:43,x_max:554,o:"m 43 0 l 43 61 l 399 582 l 82 582 l 82 675 l 543 675 l 543 614 l 188 93 l 554 93 l 554 0 l 43 0 z "},"&":{ha:846,x_min:44,x_max:825,o:"m 263 714 q 274 636 263 676 q 306 554 286 596 q 415 641 368 596 q 461 746 461 686 q 441 816 461 786 q 375 846 421 846 q 293 808 324 846 q 263 714 263 771 m 322 -17 q 177 16 240 -17 q 79 106 114 49 q 44 236 44 163 q 70 344 44 297 q 136 429 96 392 q 224 499 176 467 q 180 609 196 556 q 164 713 164 663 q 190 822 164 774 q 265 899 217 871 q 375 928 313 928 q 507 878 460 928 q 554 747 554 828 q 524 640 554 688 q 447 554 493 593 q 349 478 400 515 q 454 342 393 408 q 579 222 515 276 q 653 347 621 279 q 707 492 686 414 l 814 492 q 748 320 788 403 q 654 165 708 238 q 744 111 701 133 q 825 78 788 89 l 794 -17 q 694 23 747 -3 q 585 88 640 49 q 468 12 533 40 q 322 -17 403 -17 m 156 243 q 208 121 156 167 q 335 75 260 75 q 426 94 382 75 q 508 149 469 114 q 380 276 442 207 q 269 419 318 346 q 189 338 222 381 q 156 243 156 296 z "},".":{ha:346,x_min:90,x_max:256,o:"m 174 -17 q 115 8 139 -17 q 90 69 90 32 q 115 134 90 110 q 174 158 139 158 q 231 134 207 158 q 256 69 256 110 q 231 8 256 32 q 174 -17 207 -17 z "},",":{ha:346,x_min:65,x_max:275,o:"m 93 -236 l 65 -169 q 158 -99 125 -143 q 190 0 192 -56 q 183 -1 188 -1 q 176 -1 179 -1 q 119 19 143 -1 q 94 78 94 39 q 119 137 94 115 q 179 158 144 158 q 249 122 224 158 q 275 24 275 86 q 226 -133 275 -65 q 93 -236 178 -200 z "},":":{ha:346,x_min:90,x_max:256,o:"m 174 485 q 115 509 139 485 q 90 571 90 533 q 115 635 90 611 q 174 660 139 660 q 231 635 207 660 q 256 571 256 611 q 231 509 256 533 q 174 485 207 485 m 174 -17 q 115 8 139 -17 q 90 69 90 32 q 115 134 90 110 q 174 158 139 158 q 231 134 207 158 q 256 69 256 110 q 231 8 256 32 q 174 -17 207 -17 z "},";":{ha:346,x_min:65,x_max:275,o:"m 174 485 q 115 509 139 485 q 90 571 90 533 q 115 635 90 611 q 174 660 139 660 q 231 635 207 660 q 256 571 256 611 q 231 509 256 533 q 174 485 207 485 m 93 -236 l 65 -169 q 158 -99 125 -143 q 190 0 192 -56 q 183 -1 188 -1 q 176 -1 179 -1 q 119 19 143 -1 q 94 78 94 39 q 119 137 94 115 q 179 158 144 158 q 249 122 224 158 q 275 24 275 86 q 226 -133 275 -65 q 93 -236 178 -200 z "},"-":{ha:432,x_min:57,x_max:376,o:"m 57 304 l 57 392 l 376 392 l 376 304 l 57 304 z "},"?":{ha:590,x_min:53,x_max:524,o:"m 222 275 q 229 390 213 340 q 276 482 246 440 q 337 561 306 524 q 390 636 368 599 q 413 718 413 674 q 378 813 413 774 q 278 853 344 853 q 191 831 232 853 q 118 772 150 810 l 53 832 q 156 915 97 882 q 292 947 215 947 q 460 888 397 947 q 524 725 524 828 q 501 627 524 671 q 447 544 479 583 q 383 465 414 506 q 334 379 353 425 q 322 275 315 333 l 222 275 m 275 -17 q 217 8 240 -17 q 193 69 193 32 q 217 134 193 110 q 275 158 240 158 q 334 134 310 158 q 358 69 358 110 q 334 8 358 32 q 275 -17 310 -17 z "},"!":{ha:401,x_min:118,x_max:283,o:"m 161 275 l 146 800 l 143 931 l 258 931 l 256 800 l 240 275 l 161 275 m 201 -17 q 142 8 167 -17 q 118 69 118 32 q 142 134 118 110 q 201 158 167 158 q 259 134 235 158 q 283 69 283 110 q 259 8 283 32 q 201 -17 235 -17 z "},"+":{ha:690,x_min:47,x_max:643,o:"m 300 144 l 300 415 l 47 415 l 47 501 l 300 501 l 300 772 l 390 772 l 390 501 l 643 501 l 643 415 l 390 415 l 390 144 l 300 144 z "},"−":{ha:690,x_min:47,x_max:643,o:"m 47 415 l 47 501 l 643 501 l 643 415 l 47 415 z "},"/":{ha:486,x_min:14,x_max:468,o:"m 14 -222 l 385 986 l 468 986 l 97 -222 l 14 -222 z "}},familyName:"Source Sans Pro",ascender:1367,descender:-379,underlinePosition:-69,underlineThickness:69,boundingBox:{yMin:-407,xMin:-631,yMax:1344,xMax:2999},resolution:1e3,original_font_information:{format:0,copyright:"© 2010 - 2018 Adobe Systems Incorporated (http://www.adobe.com/), with Reserved Font Name ‘Source’.",fontFamily:"Source Sans Pro",fontSubfamily:"Regular",uniqueID:"2.045;ADBO;SourceSansPro-Regular;ADOBE",fullName:"Source Sans Pro",version:"Version 2.045;hotconv 1.0.109;makeotfexe 2.5.65596",postScriptName:"SourceSansPro-Regular",trademark:"Source is a trademark of Adobe Systems Incorporated in the United States and/or other countries.",manufacturer:"Adobe Systems Incorporated",designer:"Paul D. Hunt",manufacturerURL:"http://www.adobe.com/type",licence:"This Font Software is licensed under the SIL Open Font License, Version 1.1. This license is available with a FAQ at: http://scripts.sil.org/OFL. This Font Software is distributed on an ‘AS IS’ BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the SIL Open Font License for the specific language, permissions and limitations governing your use of this Font Software.",licenceURL:"http://scripts.sil.org/OFL",unknown1:"Preferred Athabaskan ogoneks",unknown2:"Slashed zero",unknown3:"Straight l",unknown4:"Alternate a",unknown5:"Alternate g",unknown6:"Serifed I",unknown7:"Titling figures"},cssFontWeight:"normal",cssFontStyle:"normal"};var E=s(7545);const C=WebGL2RenderingContext;class b{static font=(new w).parse(T);static generateFontMesh(t,i={}){const s=b.generateGeometry(t,i),n=new q.A(i),e=new A.A(s,n);return e.frustumCulled=!1,e}static generateGeometry(t,i={}){const s=i.size??.04,n=i.align??E.C7,e=b.font.generateShapes(t,s),h=new _(e.shapes);let o=0;n===E.oM&&(o=-e.totalWidth/2),n===E.t7&&(o=-e.totalWidth);for(let t=0;t<h.vertices.length/3;t++)h.vertices[3*t]=h.vertices[3*t]+o,h.vertices[3*t+1]=h.vertices[3*t+1]-.5*e.lineHeight;const r=new P.A;return r.setAttribute("position",new D.A(new Float32Array(h.vertices),3,C.FLOAT)),r.setIndices(new D.A(new Uint16Array(h.indices),1,C.UNSIGNED_SHORT)),r.calculateBoundingBox(),r}static cache=new Map}},1296:(t,i,s)=>{s.d(i,{A:()=>e});s(9262);var n=s(7737);s(5639),s(7133);class e extends n.A{constructor(){super(),this.initProperties()}initProperties(){this.mesh=null,this.scene=null,this.game=null,this.body=null,this.bodies=[],this.audio=null,this.audios=[],this.parent=null,this.children=[],this.isStatic=!1}add(t){super.add(t),this.mesh&&t.mesh&&this.mesh.add(t.mesh),this.scene&&this.scene.addComponents(t)}remove(t){super.remove(t),this.mesh&&t.mesh&&this.mesh.remove(t.mesh),this.scene&&this.scene.removeComponents(t)}async load(){for(const t of this.children)await t.load()}getLoadTasks(){return[new LoadTask("Loading game objects...",this.load.bind(this))]}onBeforeFixedUpdate(t){for(const i of this.children)i.onBeforeFixedUpdate(t)}onAfterFixedUpdate(t){}onAdded(t){}onRemoved(t){}onPause(){}onContinue(){}copy(t,i=!0){return this.mesh=t.mesh,this.name=t.name,super.copy(t,i)}clone(t=!0){return(new this.constructor).copy(this,t)}}},9146:(t,i,s)=>{s.d(i,{Eh:()=>h,Ue:()=>n,l2:()=>e});const n=50,e=.3,h=3e4},1744:(t,i,s)=>{s.d(i,{A:()=>tt});var n=s(6389),e=s(5487),h=s(9782),o=s(7228),r=s(1447),a=s(2638),c=s(813),l=s(7975),u=s(4801),f=s(2318),d=s(6527),v=(s(261),s(3739),s(1296)),m=s(7830),w=s(6101),p=s(2780),g=s(7133);var x=s(611);var M=s(649),S=s(4867),y=s(2036);class _ extends M.Ay{constructor(t,i={}){super(i),this.isStructuredDeferredShadingMaterial=!0,this.staticShadowCascades=i.staticShadowCascades??4,this.dynamicShadowCascades=i.dynamicShadowCascades??4,this.numRays=t,this.uniforms=this.getUniforms()}init(t){this.shaderType=t.shaderType??n.$g,this.useAO=t.useAO??!0,this.useCSM=t.useCSM??!0,this.viewDistance=t.viewDistance??d.uG,this.volumetricCloudsQuality=t.volumetricCloudsQuality??n.$o}getVertSource(){return`#version 300 es\n\n            in vec3 position;\n\n            uniform mat4 viewMatrix;\n            uniform mat4 projectionMatrix;\n\n            #define NUM_CLOUD_RAYS ${this.numRays}\n\n            #if 0 < NUM_CLOUD_RAYS\n            in vec3 direction1;\n            in float weight1;\n            out vec3 vDirection1;\n            out float vWeight1;\n            #endif\n\n            #if 1 < NUM_CLOUD_RAYS\n            in vec3 direction2;\n            in float weight2;\n            out vec3 vDirection2;\n            out float vWeight2;\n            #endif\n\n            #if 2 < NUM_CLOUD_RAYS\n            in vec3 direction3;\n            in float weight3;\n            out vec3 vDirection3;\n            out float vWeight3;\n            #endif\n\n            void main() {\n                #if 0 < NUM_CLOUD_RAYS\n                vDirection1 = direction1;\n                vWeight1 = weight1;\n                #endif\n\n                #if 1 < NUM_CLOUD_RAYS\n                vDirection2 = direction2;\n                vWeight2 = weight2;\n                #endif\n\n                #if 2 < NUM_CLOUD_RAYS\n                vDirection3 = direction3;\n                vWeight3 = weight3;\n                #endif\n\n                vec4 viewPosition = viewMatrix * vec4(position, 0.0);\n                viewPosition.w = 1.0;\n                gl_Position = projectionMatrix * viewPosition;\n            }\n        `}getFragSource(){return`#version 300 es\n\n            precision mediump float;\n            precision mediump sampler2DArray;\n            precision mediump sampler2DArrayShadow;\n            precision mediump sampler3D;\n\n            ${this.shaderType===n.$g?"#define USE_PBR":""}\n            \n            ${this.useCSM?"#define USE_CSM":""}\n            ${this.useAO?"#define USE_AO":""}\n\n            const float MIN_ROUGHNESS = 0.0525;\n\n            uniform vec2 resolution;\n            uniform vec2 invResolution;\n\n            uniform sampler2D tColor;\n            uniform sampler2D tDepth;\n            uniform sampler2D tNormal;\n            uniform sampler2D tSurface;\n            uniform sampler2D tEmissive;\n            uniform sampler2D tFlatNormal;\n            uniform sampler2D tTransparent;\n\n            uniform mat4 invViewMatrix;\n            uniform mat4 invProjectionMatrix;\n\n            uniform vec3 cameraPosition;\n\n            uniform float cameraFar;\n            uniform float cameraNear;\n            uniform float cameraFov;\n            uniform float cameraAspect;\n\n            uniform float viewDistance;\n\n            #define NUM_CLOUD_RAYS ${this.numRays}\n\n            #if 0 < NUM_CLOUD_RAYS\n            in vec3 vDirection1;\n            in float vWeight1;\n            #endif\n\n            #if 1 < NUM_CLOUD_RAYS\n            in vec3 vDirection2;\n            in float vWeight2;\n            #endif\n\n            #if 2 < NUM_CLOUD_RAYS\n            in vec3 vDirection3;\n            in float vWeight3;\n            #endif\n\n            out vec4 gDiffuse;\n\n            ${S.mz}\n\n            ${S.SY}\n\n            uniform sampler2D tBRDF;\n\n            uniform sampler2DArrayShadow tDynamicShadows;\n            uniform mat4 dynamicShadowMatrices[${this.dynamicShadowCascades}];\n            uniform float dynamicShadowTexelSizes[${this.dynamicShadowCascades}];\n            uniform float dynamicShadowMaxFar;\n            uniform float dynamicShadowCascades;\n\n            uniform sampler2DArrayShadow tStaticShadows;\n            uniform mat4 staticShadowMatrices[${this.staticShadowCascades}];\n            uniform float staticShadowTexelSizes[${this.staticShadowCascades}];\n            uniform float staticShadowMaxFar;\n            uniform float staticShadowCascades;\n\n            uniform float invShadowMapResolution;\n\n            float saturate(float a) {\n                return clamp(a, 0.0, 1.0);\n            }\n\n            vec3 getViewPosition(vec2 uv, float depth) {\n                vec4 clipSpacePosition = vec4(uv * 2.0 - 1.0, depth * 2.0 - 1.0, 1.0);\n                vec4 viewSpacePosition = invProjectionMatrix * clipSpacePosition;\n                return viewSpacePosition.xyz / viewSpacePosition.w;\n            }\n\n            vec3 getViewDirection(vec3 viewPosition) {\n                return normalize((invViewMatrix * vec4(viewPosition, 0.0)).xyz);\n            }\n\n            vec3 getWorldPosition(vec3 viewPosition) {\n                return (invViewMatrix * vec4(viewPosition, 1.0)).xyz;\n            }\n\n            \n    #define AO_NUM_SLICES 4\n    #define AO_DELTA_ANGLE (PI / float(AO_NUM_SLICES))\n    #define INV_AO_NUM_SLICES 1.0 / float(AO_NUM_SLICES)\n\n    #define AO_NUM_STEPS 4\n    #define INV_AO_NUM_STEPS (1.0 / float(AO_NUM_STEPS + 1))\n    \n    #define AO_RADIUS_PIXELS 100.0\n\n    #define SQRT2 sqrt(2.0)\n\n    const vec2 JITTER_LUT[64] = vec2[64](\n        vec2(0.500000, 0.333333), vec2(0.250000, 0.666667), vec2(0.750000, 0.111111), vec2(0.125000, 0.444444), vec2(0.625000, 0.777778), vec2(0.375000, 0.222222), vec2(0.875000, 0.555556), vec2(0.062500, 0.888889),\n        vec2(0.562500, 0.037037), vec2(0.312500, 0.370370), vec2(0.812500, 0.703704), vec2(0.187500, 0.148148), vec2(0.687500, 0.481481), vec2(0.437500, 0.814815), vec2(0.937500, 0.259259), vec2(0.031250, 0.592593),\n        vec2(0.531250, 0.925926), vec2(0.281250, 0.074074), vec2(0.781250, 0.407407), vec2(0.156250, 0.740741), vec2(0.656250, 0.185185), vec2(0.406250, 0.518519), vec2(0.906250, 0.851852), vec2(0.093750, 0.296296),\n        vec2(0.593750, 0.629630), vec2(0.343750, 0.962963), vec2(0.843750, 0.012346), vec2(0.218750, 0.345679), vec2(0.718750, 0.679012), vec2(0.468750, 0.123457), vec2(0.968750, 0.456790), vec2(0.015625, 0.790123),\n        vec2(0.515625, 0.234568), vec2(0.265625, 0.567901), vec2(0.765625, 0.901235), vec2(0.140625, 0.049383), vec2(0.640625, 0.382716), vec2(0.390625, 0.716049), vec2(0.890625, 0.160494), vec2(0.078125, 0.493827),\n        vec2(0.578125, 0.827160), vec2(0.328125, 0.271605), vec2(0.828125, 0.604938), vec2(0.203125, 0.938272), vec2(0.703125, 0.086420), vec2(0.453125, 0.419753), vec2(0.953125, 0.753086), vec2(0.046875, 0.197531),\n        vec2(0.546875, 0.530864), vec2(0.296875, 0.864198), vec2(0.796875, 0.308642), vec2(0.171875, 0.641975), vec2(0.671875, 0.975309), vec2(0.421875, 0.024691), vec2(0.921875, 0.358025), vec2(0.109375, 0.691358),\n        vec2(0.609375, 0.135802), vec2(0.359375, 0.469136), vec2(0.859375, 0.802469), vec2(0.234375, 0.246914), vec2(0.734375, 0.580247), vec2(0.484375, 0.913580), vec2(0.984375, 0.061728), vec2(0.007813, 0.395062)\n    );\n\n    float GTAO(vec2 vUv) {\n        float depth = texture(tDepth, vUv, 0.0).r;\n        if (depth == 1.0) {\n            return 1.0;\n        }\n\n        vec3 centerPosition = getViewPosition(vUv, depth);\n        vec3 view = normalize(-centerPosition);\n\n        float planeWidth = -centerPosition.z * 2.0 * tan(cameraFov * 0.5);\n        float maxSampleDistance = planeWidth * (AO_RADIUS_PIXELS / resolution.y);\n\n        float visibility = 0.0;\n\n        vec3 normal = normalize(texture(tFlatNormal, vUv).xyz);\n\n        ivec2 p = ivec2(gl_FragCoord.xy);\n        int index = (p.y & 7) * 8 + (p.x & 7); // 8 * 8 kernel\n        vec2 jitter = JITTER_LUT[index];\n        \n        float phi = AO_DELTA_ANGLE * jitter.x;\n        for (int slice = 0; slice < AO_NUM_SLICES; slice++) {\n            vec2 omega = vec2(cos(phi), sin(phi));\n\n            vec3 direction = vec3(omega, 0.0);\n            vec3 orthoDirection = direction - view * dot(direction, view);\n            vec3 axis = normalize(cross(direction, view));\n            vec3 projNormal = normal - axis * dot(normal, axis);\n\n            float projLength = length(projNormal);\n            projNormal = normalize(projNormal);\n\n            float sgnN = sign(dot(orthoDirection, projNormal));\n            float cosN = clamp(dot(projNormal, view), 0.0, 1.0);\n            float thetaN = sgnN * acos(cosN);\n\n            for (float side = -1.0; side <= 1.0; side += 2.0) {\n                float horizonAngle = PI;\n\n                float jitter = side * jitter.y;\n\n                float angleOffset = thetaN * side;\n\n                float alpha = jitter * INV_AO_NUM_STEPS;\n                for (float step = 0.0; step < float(AO_NUM_STEPS); step++) {\n                    float scaling = SQRT2 + pow(alpha, 2.0) * AO_RADIUS_PIXELS;\n                    // float scaling = SQRT2 + alpha * AO_RADIUS_PIXELS;\n                    vec2 sampleUv = vUv + side * scaling * invResolution * omega;\n                    float sampleDepth = texture(tDepth, sampleUv).r;\n                    vec3 samplePosition = getViewPosition(sampleUv, sampleDepth);\n                    vec3 deltaPosition = samplePosition - centerPosition;\n\n                    vec3 sampleHorizon = normalize(deltaPosition);\n                    float sampleHorizonCos = dot(sampleHorizon, view);\n                    float sampleHorizonAngle = acos(sampleHorizonCos) - angleOffset;\n\n                    // if (vUv.x < 0.5) {\n                    //     sampleHorizonCos = dot(sampleHorizon, projNormal);\n                    //     sampleHorizonAngle = acos(sampleHorizonCos);\n                    // }\n\n                    float sampleDistance = length(deltaPosition);\n                    // float falloff = pow(clamp(sampleDistance / maxSampleDistance - 0.5, 0.0, 0.5) * 2.0, 2.0);\n                    float falloff = clamp(sampleDistance / maxSampleDistance - 0.5, 0.0, 0.5) * 2.0;\n                    sampleHorizonAngle = mix(sampleHorizonAngle, PI / 2.0, falloff);\n\n                    horizonAngle = min(horizonAngle, sampleHorizonAngle);\n\n                    alpha += INV_AO_NUM_STEPS;\n                }\n                    \n                float h = thetaN + clamp(side * horizonAngle, -PI / 2.0, PI / 2.0);\n                visibility += projLength * (cosN + 2.0 * h * sin(thetaN) - cos(2.0 * h - thetaN)) / 4.0;\n            }\n\n            phi += AO_DELTA_ANGLE;\n        }\n\n        return visibility * INV_AO_NUM_SLICES;\n    }\n\n    vec3 GI(vec3 albedo, float ao) {\n        return (2.0404 * albedo - 0.3324) * pow(ao, 3.0) - (4.7951 * albedo - 0.6417) * pow(ao, 2.0) + (2.7552 * albedo + 0.6903) * ao;\n    }\n\n\n\n            ${n.Ap<=this.volumetricCloudsQuality?"#define USE_DETAIL_NOISE":""}\n            ${n.$o<=this.volumetricCloudsQuality?"#define USE_EXTRA_DETAIL_NOISE":""}\n\n            \n    const int NUM_MAX_CLOUD_STEPS = 128;\n\n    const float CLOUD_STEP_SIZE = 100.0;\n    const float INV_CLOUD_STEP_SIZE = 1.0 / CLOUD_STEP_SIZE;\n\n    const float HALF_CLOUD_STEP_SIZE = CLOUD_STEP_SIZE / 2.0;\n\n    uniform struct CloudsProfile {\n        float scattering;\n        float extinction;\n        \n        float top;\n        float bottom;\n        \n        vec3 shapeTextureScale;\n        vec3 detailTextureScale;\n        vec3 extraDetailTextureScale;\n        vec3 extraExtraDetailTextureScale;\n        \n        vec3 invShapeTextureScale;\n        vec3 invDetailTextureScale;\n        vec3 invExtraDetailTextureScale;\n        vec3 invExtraExtraDetailTextureScale;\n\n        float detailIntensity;\n    };\n\n    uniform CloudsProfile cloudsProfile;\n\n    const float DENSITY_THRESHOLD = 0.0001;\n\n    uniform sampler3D tShapeNoise;\n    uniform sampler3D tDetailNoise;\n    \n    uniform vec2 cloudsOffset;\n\n    const float LOD_SCALE = 8.0;\n\n    const float SCATTERING_ATTENUATION = 0.5;\n    const float EXTINCTION_ATTENUATION = 0.2;\n\n    struct CloudsIntegrationResults {\n        vec2 inScattering;\n        float transmittance;\n        float opticalDistance;\n        float uniformDistance;\n    };\n\n    float getLod(float distance, float firstLodDistance) {\n        return floor(log2(distance / firstLodDistance) + 1.0);\n    }\n\n    float sampleExtraExtraDetail(vec3 samplePosition, float sampleDistance) {\n        float lod = getLod(sampleDistance, cloudsProfile.extraExtraDetailTextureScale.x * LOD_SCALE);\n        vec3 uvw = samplePosition * cloudsProfile.invExtraExtraDetailTextureScale;\n        return textureLod(tDetailNoise, uvw, lod).r * 2.0 - 1.0;\n    }\n\n    float sampleExtraDetail(vec3 samplePosition, float sampleDistance) {\n        float lod = getLod(sampleDistance, cloudsProfile.extraDetailTextureScale.x * LOD_SCALE);\n        vec3 uvw = samplePosition * cloudsProfile.invExtraDetailTextureScale;\n        return textureLod(tDetailNoise, uvw, lod).r * 2.0 - 1.0;\n    }\n\n    float sampleDetail(vec3 samplePosition, float sampleDistance) {\n        float lod = getLod(sampleDistance, cloudsProfile.detailTextureScale.x * LOD_SCALE);\n        vec3 uvw = samplePosition * cloudsProfile.invDetailTextureScale;\n        return 1.0 - textureLod(tDetailNoise, uvw, lod).r; // 差し引きするので反転\n    }\n\n    vec2 sampleShape(vec3 samplePosition, float sampleDistance) {\n        float lod = getLod(sampleDistance, cloudsProfile.shapeTextureScale.x * LOD_SCALE);\n        vec3 uvw = (samplePosition + vec3(cloudsOffset.x, 0.0, cloudsOffset.y)) * cloudsProfile.invShapeTextureScale;\n        return textureLod(tShapeNoise, uvw, lod).rg;\n    }\n\n    float rand(vec2 co){\n        return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\n    }\n\n    int getNumSamples(vec3 startPosition, vec3 viewDirection, float sampleDistance) {\n        float heightDiff;\n        if (0.0 < viewDirection.y && startPosition.y < cloudsProfile.top) {\n            heightDiff = startPosition.y - cloudsProfile.top;\n        } else if (viewDirection.y < 0.0 && cloudsProfile.bottom < startPosition.y) {\n            heightDiff = startPosition.y - cloudsProfile.bottom;\n        }\n\n        float minDistance = min(heightDiff / viewDirection.y, sampleDistance);\n        int numSteps = int(minDistance * INV_CLOUD_STEP_SIZE);\n\n        return min(numSteps, NUM_MAX_CLOUD_STEPS);\n    }\n\n    const float SCATTERING_ATTENUATION_FACTOR = 0.5;\n    const float EXTINCTION_ATTENUATION_FACTOR = 0.2;\n\n    #define USE_SDF\n\n    CloudsIntegrationResults integrateClouds(vec3 direction, vec3 startPosition, vec3 viewDirection, float fragDistance) {\n        float sampleScale = 1.0 / dot(viewDirection, direction);\n\n        float fogStartDistance = viewDistance * 0.5;\n        float fogEffectiveDistance = 1.0 / (viewDistance - fogStartDistance);\n\n        #ifdef USE_SDF\n            float startT = dot(startPosition, direction);\n            float stepLength = CLOUD_STEP_SIZE * sampleScale;\n            float snappedT = ceil(startT / CLOUD_STEP_SIZE) * CLOUD_STEP_SIZE;\n            vec3 samplePosition = startPosition + (snappedT - startT) * viewDirection * sampleScale;\n        #else\n            float cameraT = dot(cameraPosition, direction);\n            vec3 samplePosition = cameraPosition;\n        #endif\n\n        vec2 totalInScattering = vec2(0.0);\n        float totalTransmittance = 1.0;\n\n        float weightedDistanceSum = 0.0;\n        float transmittanceSum = 0.0;\n        \n        for (int i = 0; i < NUM_MAX_CLOUD_STEPS; i++) {\n            #ifdef USE_SDF\n            #else\n                float stepLength = CLOUD_STEP_SIZE * pow(2.0, float(i / 16));\n                float currentT = dot(samplePosition, direction) + stepLength * 0.5;\n                float snappedT = ceil(currentT / stepLength) * stepLength;\n                samplePosition = cameraPosition + (snappedT - cameraT) * viewDirection * sampleScale;\n            #endif\n            \n            float sampleDistance = length(samplePosition - cameraPosition);\n            if (fragDistance < sampleDistance) {\n                break;\n            }\n\n            vec2 shapeSample = sampleShape(samplePosition, sampleDistance);\n            \n            if (0.0 <= shapeSample.r) {\n                #ifdef USE_SDF\n                    float numSteps = ceil(shapeSample.r * cloudsProfile.shapeTextureScale.r / stepLength);\n                    samplePosition += viewDirection * numSteps * stepLength;\n                #endif\n                continue;\n            }\n\n            float density = -shapeSample.r;\n            #ifdef USE_DETAIL_NOISE\n                density -= sampleDetail(samplePosition, sampleDistance) * cloudsProfile.detailIntensity;\n            #endif\n            \n            #ifdef USE_EXTRA_DETAIL_NOISE\n                density += sampleExtraDetail(samplePosition, sampleDistance) * cloudsProfile.detailIntensity * 0.25;\n            #endif\n            \n            // attenuate far clouds\n            // float distancePlane = length((samplePosition - cameraPosition).xz);\n            // float attenuation = max(distancePlane - 15000.0, 0.0);\n            // density *= exp(-attenuation * 0.0002);\n\n            float fogFactor = max(sampleDistance - fogStartDistance, 0.0) * fogEffectiveDistance;\n            // float fogAlpha = saturate(pow(fogFactor, 2.0));\n            float fogAlpha = saturate(fogFactor);\n            density = mix(density, 0.0, fogAlpha);\n            \n            if (density <= 0.0) {\n                #ifdef USE_SDF\n                    samplePosition += viewDirection * stepLength;\n                #endif\n\n                continue;\n            }\n\n            float sampleScattering = cloudsProfile.scattering * density;\n            float sampleExtinction = cloudsProfile.extinction * density;\n\n            float stepSize = min(stepLength, max(sampleDistance - stepLength, 0.0));\n            stepSize = min(fragDistance - sampleDistance, stepSize);\n            float deltaTransmittance = exp(-sampleExtinction * stepSize);\n\n            float lightExtinction = cloudsProfile.extinction * shapeSample.g;\n\n            float aoTerm = (cloudsProfile.extinction / cloudsProfile.scattering) * density * 10.0;\n\n            float directLuminance = 0.0;\n            float indirectLuminance = 0.0;\n            for (float j = 0.0; j < 4.0; j++) {\n                float scatteringAttenuation = pow(SCATTERING_ATTENUATION_FACTOR, j);\n                float extinctionAttenuation = pow(EXTINCTION_ATTENUATION_FACTOR, j);\n                directLuminance += 1.0 / (PI * 4.0) * scatteringAttenuation * exp(-lightExtinction * extinctionAttenuation);\n\n                float ao = 1.0 / (1.0 + aoTerm * extinctionAttenuation);\n                indirectLuminance += 1.0 * scatteringAttenuation * ao;\n            }\n\n            vec2 deltaInScattering = vec2(directLuminance, indirectLuminance) * (sampleScattering / sampleExtinction) * (1.0 - deltaTransmittance);\n            \n            weightedDistanceSum += totalTransmittance * (1.0 - deltaTransmittance) * sampleDistance;\n            transmittanceSum += totalTransmittance * (1.0 - deltaTransmittance);\n\n            totalInScattering += totalTransmittance * deltaInScattering;\n            totalTransmittance *= deltaTransmittance;\n\n            if (totalTransmittance < 0.01) {\n                break;\n            }\n\n            #ifdef USE_SDF\n                samplePosition += viewDirection * stepLength;\n            #endif\n        }\n\n        float opticalDistance = 0.0 < transmittanceSum ? (weightedDistanceSum / transmittanceSum) : 1.0;\n\n        return CloudsIntegrationResults(\n            totalInScattering,\n            totalTransmittance,\n            opticalDistance,\n            0.0\n        );\n    }\n\n    vec4 computeCloudShadowAlt(vec3 samplePosition, vec3 sunIrradiance) {\n        float sampleDistance = length(samplePosition - cameraPosition);\n        float lightSample = sampleShape(samplePosition, sampleDistance).g;\n        if (lightSample == 0.0) {\n            return vec4(0.0,0.0,0.0,1.0);\n        }\n\n        float lightScattering = cloudsProfile.scattering * lightSample;\n        float lightExtinction = cloudsProfile.extinction * lightSample;\n\n        vec3 sunTerm = sunIrradiance / (PI * 4.0);\n\n        vec3 luminance = vec3(0.0);\n        for (float j = 0.0; j < 16.0; j++) {\n            float scatteringAttenuation = pow(SCATTERING_ATTENUATION, j);\n            float extinctionAttenuation = pow(EXTINCTION_ATTENUATION, j);\n            luminance += sunTerm * scatteringAttenuation * exp(-lightExtinction * extinctionAttenuation);\n        }\n\n        float transmittance = exp(-lightExtinction);\n        vec3 inScattering = luminance * (lightScattering / lightExtinction) * (1.0 - transmittance);\n        return vec4(inScattering, transmittance);\n    }\n\n    vec4 computeCloudShadow(vec3 samplePosition) {\n        float sampleDistance = length(samplePosition - cameraPosition);\n        vec2 shapeSample = sampleShape(samplePosition, sampleDistance);\n        float lightExtinction = cloudsProfile.extinction * shapeSample.g;\n\n        float totalWeight = 0.0;\n        float totalTransmittance = 0.0;\n\n        for (float j = 0.0; j < 4.0; j++) {\n            float scatteringAttenuation = pow(SCATTERING_ATTENUATION, j);\n            float extinctionAttenuation = pow(EXTINCTION_ATTENUATION, j);\n\n            totalTransmittance += exp(-lightExtinction * extinctionAttenuation) * scatteringAttenuation;\n            totalWeight += scatteringAttenuation;\n        }\n\n        float transmittance = totalTransmittance / totalWeight;\n\n        return vec4(vec3(0.0), transmittance);\n    }\n\n\n\n            ${x.A}\n\n            void integrateClouds(\n                    vec3 direction,\n                    vec3 startPosition,\n                    vec3 viewDirection,\n                    float fragDistance,\n                    vec3 sunIrradianceClouds,\n                    vec3 skyIrradianceClouds,\n                    out float transmittance,\n                    out vec3 inscattering,\n                    out float opticalDistance,\n                    out float opticalWeight,\n                    float weight) {\n                CloudsIntegrationResults results = integrateClouds(direction, startPosition, viewDirection, fragDistance);\n                \n                transmittance = results.transmittance * weight;\n                inscattering = (results.inScattering.x * sunIrradianceClouds + results.inScattering.y * skyIrradianceClouds) * weight;\n\n                opticalWeight = (1.0 - results.transmittance) * weight;\n                opticalDistance = results.opticalDistance * opticalWeight;\n            }\n\n            int getShadowLayer(float maxFar, float cascades, float viewZ) {\n                float scale = maxFar / pow(2.0, cascades - 1.0);\n                float tmpLayer = log2(-viewZ / scale) + 1.0;\n\n                // int layer = int(tmpLayer);\n                // return clamp(layer, 0, int(cascades) - 1);\n                return int(max(tmpLayer, 0.0));\n            }\n\n            float sampleShadow(int layer, float viewZ, vec3 worldPosition, mat4 shadowMatrix, sampler2DArrayShadow shadowMaps, float texelSize, float dotNL) {\n                vec4 lightSpacePos = shadowMatrix * vec4(worldPosition, 1.0);\n\n                vec3 projCoords = lightSpacePos.xyz / lightSpacePos.w;\n                projCoords = projCoords * 0.5 + 0.5;\n\n                float theta = acos(clamp(dotNL, -1.0, 1.0));\n                // float bias = texelSize * 0.00003 + texelSize * 0.000015 * tan(theta);\n                float bias = texelSize * 0.00005 + tan(theta) * texelSize * 0.00002;\n\n                // single shadow\n                float shadow = texture(shadowMaps, vec4(projCoords.xy, layer, projCoords.z - bias));\n\n                // // PCF shadow\n                // float shadow = 0.0;\n                // for (int y = -2 ; y <= 2 ; y++) {\n                //     for (int x = -2 ; x <= 2 ; x++) {\n                //         vec2 offsets = vec2(float(x) * invShadowMapResolution, float(y) * invShadowMapResolution);\n                //         vec2 uv = vec2(projCoords.xy + offsets);\n                //         shadow += texture(shadowMaps, vec4(uv, layer, projCoords.z - bias));\n                //     }\n                // }\n                // shadow /= 25.0;\n                \n                return shadow;\n            }\n\n            void main() {\n                vec2 vUv = gl_FragCoord.xy * invResolution;\n                \n                #if 0 < NUM_CLOUD_RAYS\n                vec3 direction1 = normalize(vDirection1);\n                #endif\n\n                #if 1 < NUM_CLOUD_RAYS\n                vec3 direction2 = normalize(vDirection2);\n                #endif\n                \n                #if 2 < NUM_CLOUD_RAYS\n                vec3 direction3 = normalize(vDirection3);\n                #endif\n\n                vec3 albedo = texture(tColor, vUv).rgb;\n                // vec3 albedo = vec3(1.0);\n                vec3 emissive = texture(tEmissive, vUv).rgb;\n\n                vec4 surface = texture(tSurface, vUv);\n                float roughness = max(surface.g, MIN_ROUGHNESS);\n                // float roughness = surface.g;\n                float metalness = surface.b;\n\n                float depth = texture(tDepth, vUv).x;\n                vec3 viewPosition = getViewPosition(vUv, depth);\n                vec3 viewDirection = getViewDirection(viewPosition);\n                \n                float fragDistance = length(viewPosition);\n\n                vec3 worldPosition = getWorldPosition(viewPosition);\n                \n                vec3 sunIrradianceClouds = getSunIrradiance(500.0 * METERS_TO_KMS);\n                vec3 skyIrradianceClouds = getInscattering(500.0 * METERS_TO_KMS);\n\n                vec4 cloudShadow = computeCloudShadow(worldPosition);\n                vec3 directLight = getSunIrradiance(worldPosition.y * METERS_TO_KMS) * cloudShadow.a;\n\n                vec3 directLightBk = directLight;\n\n                vec3 N = normalize(texture(tNormal, vUv).rgb);\n                vec3 V = normalize(-viewDirection);\n                vec3 L = normalize(atmosphereProfile.sunDirection);\n                float dotNL = saturate(dot(N, L));\n\n                #ifdef USE_CSM\n                    int staticShadowLayer = getShadowLayer(staticShadowMaxFar, staticShadowCascades, viewPosition.z);\n                    if (staticShadowLayer < int(staticShadowCascades)) {\n                        directLight *= sampleShadow(staticShadowLayer, viewPosition.z, worldPosition,\n                                staticShadowMatrices[staticShadowLayer], tStaticShadows, staticShadowTexelSizes[staticShadowLayer], dotNL);\n                    }\n                    \n                    int dynamicShadowLayer = getShadowLayer(dynamicShadowMaxFar, dynamicShadowCascades, viewPosition.z);\n                    if (dynamicShadowLayer < int(dynamicShadowCascades)) {\n                        directLight *= sampleShadow(dynamicShadowLayer, viewPosition.z, worldPosition,\n                                dynamicShadowMatrices[dynamicShadowLayer], tDynamicShadows, dynamicShadowTexelSizes[dynamicShadowLayer], dotNL);\n                    }\n                #endif\n\n                #ifdef USE_PBR\n                    // float multipleScattering = 1.0 / (1.0 - 0.1);\n                    vec3 indirectDiffuse = getSkyIrradiance(N.y, worldPosition.y * METERS_TO_KMS);\n                    // indirectDiffuse += directLightBk / (4.0 * PI) * (1.0 / (1.0 - 0.1) - 1.0);\n\n                    vec3 reflectionDirection = normalize(reflect(-V, N));\n                    vec3 indirectSpecular = getSkyReflection(reflectionDirection.y, worldPosition.y * METERS_TO_KMS, roughness);\n\n                    #ifdef USE_AO\n                        float ao = GTAO(vUv);\n                        // ao = GI(albedo, ao);\n                        indirectDiffuse *= ao;\n                        indirectSpecular *= ao;\n                        // directLight *= ao;\n                    #endif\n\n                    vec3 color = BRDF(albedo, metalness, roughness, N, V, L, directLight, indirectDiffuse, indirectSpecular);\n                #else\n                    vec3 directColor = albedo * dotNL * directLight / PI;\n                    vec3 indirectColor = getSkyIrradiance(N.y, worldPosition.y * METERS_TO_KMS) * albedo;\n\n                    #ifdef USE_AO\n                        float ao = GTAO(vUv);\n                        // vec3 ao = GI(albedo, ao);\n                        indirectColor *= ao;\n                        // directColor *= ao;\n                    #endif\n                    \n                    vec3 color = directColor + indirectColor;\n                #endif\n\n                // apply aireal scattering\n                vec3 inScatter = vec3(0.0);\n                vec3 transmittance = vec3(1.0);\n                getAirealScattering(viewDirection.y, cameraPosition.y * METERS_TO_KMS, fragDistance * METERS_TO_KMS, inScatter, transmittance);\n                color *= transmittance;\n                color += inScatter;\n\n                vec3 sunDisk = directLight * 500.0 * exp(-max(acos(dot(viewDirection, atmosphereProfile.sunDirection)) - 0.002, 0.0) * 1000.0);\n                vec3 skyColor = getSkyReflection(-V.y, cameraPosition.y * METERS_TO_KMS, 0.0);\n\n                float fogStartDistance = viewDistance * 0.5;\n                float fogEffectiveDistance = viewDistance - fogStartDistance;\n                float fogFactor = max(fragDistance - fogStartDistance, 0.0) / fogEffectiveDistance;\n                // float fogAlpha = saturate(pow(fogFactor, 2.0));\n                float fogAlpha = saturate(fogFactor);\n                color = mix(color, skyColor + sunDisk, fogAlpha);\n\n                float totalTransmittance = 0.0;\n                vec3 totalInScattering = vec3(0.0);\n\n                float totalOpticalDistance = 0.0;\n                float totalOpticalWeight = 0.0;\n\n                float cloudTopDistance = (cloudsProfile.top - cameraPosition.y) / viewDirection.y;\n                float cloudBottomDistance = (cloudsProfile.bottom - cameraPosition.y) / viewDirection.y;\n                float maxCloudDistance = min(max(cloudTopDistance, cloudBottomDistance), fragDistance);\n\n                float offsetDistance = max(min(cloudTopDistance, cloudBottomDistance), 0.0);\n                vec3 cloudStartPosition = cameraPosition + viewDirection * offsetDistance;\n\n                #if 0 < NUM_CLOUD_RAYS\n                float transmittance1;\n                vec3 inscattering1;\n                float opticalDistance1;\n                float opticalWeight1;\n                integrateClouds(direction1, cloudStartPosition, viewDirection, maxCloudDistance, sunIrradianceClouds,\n                        skyIrradianceClouds, transmittance1, inscattering1, opticalDistance1, opticalWeight1, vWeight1);\n                totalTransmittance += transmittance1;\n                totalInScattering += inscattering1;\n                totalOpticalDistance += opticalDistance1;\n                totalOpticalWeight += opticalWeight1;\n                #endif\n                \n                #if 1 < NUM_CLOUD_RAYS\n                float transmittance2;\n                vec3 inscattering2;\n                float opticalDistance2;\n                float opticalWeight2;\n                integrateClouds(direction2, cloudStartPosition, viewDirection, maxCloudDistance, sunIrradianceClouds,\n                        skyIrradianceClouds, transmittance2, inscattering2, opticalDistance2, opticalWeight2, vWeight2);\n                totalTransmittance += transmittance2;\n                totalInScattering += inscattering2;\n                totalOpticalDistance += opticalDistance2;\n                totalOpticalWeight += opticalWeight2;\n                #endif\n                \n                #if 2 < NUM_CLOUD_RAYS\n                float transmittance3;\n                vec3 inscattering3;\n                float opticalDistance3;\n                float opticalWeight3;\n                integrateClouds(direction3, cloudStartPosition, viewDirection, maxCloudDistance, sunIrradianceClouds,\n                        skyIrradianceClouds, transmittance3, inscattering3, opticalDistance3, opticalWeight3, vWeight3);\n                totalTransmittance += transmittance3;\n                totalInScattering += inscattering3;\n                totalOpticalDistance += opticalDistance3;\n                totalOpticalWeight += opticalWeight3;\n                #endif\n\n                float opticalDistance = totalOpticalDistance / totalOpticalWeight;\n\n                vec3 inScatterClouds = vec3(0.0);\n                vec3 transmittanceClouds = vec3(1.0);\n                getAirealScattering(viewDirection.y, cameraPosition.y * METERS_TO_KMS, opticalDistance * METERS_TO_KMS, inScatterClouds, transmittanceClouds);\n\n                totalInScattering *= transmittanceClouds;\n                totalInScattering += inScatterClouds * (1.0 - totalTransmittance);\n\n                color *= totalTransmittance;\n                color += totalInScattering;\n\n                // transparent objects\n                vec4 sampleTransparent = texture(tTransparent, vUv);\n                float transparentAlpha = exp(-sampleTransparent.a);\n                color *= transparentAlpha;\n                color.rgb += (sampleTransparent.rgb / (sampleTransparent.a + 0.00001)) * (1.0 - transparentAlpha);\n\n                gDiffuse.rgb = color;\n                gDiffuse.a = 1.0;\n\n                gl_FragDepth = depth;\n            }\n        `}getUniforms(){return{invViewMatrix:this.invViewMatrix,invProjectionMatrix:this.invProjectionMatrix,tColor:this.colorTexture,tNormal:this.normalTexture,tSurface:this.surfaceTexture,tEmissive:this.emissiveTexture,tFlatNormal:this.flatNormalTexture,tDepth:this.depthTexture,cameraPosition:new w.A,sunDirection:new w.A,resolution:new m.A,invResolution:new m.A,cameraFar:0,cameraNear:0,cameraFov:0,cameraAspect:0,tStaticShadows:new y.A,staticShadowTexelSizes:[],staticShadowMatrices:[],staticShadowCascades:0,staticShadowMaxFar:0,tDynamicShadows:new y.A,dynamicShadowTexelSizes:[],dynamicShadowMatrices:[],dynamicShadowCascades:0,dynamicShadowMaxFar:0,invShadowMapResolution:0,atmosphereProfile:{},cloudsProfile:{},viewDistance:this.viewDistance}}}var P=s(1235),A=s(9459);const D=WebGL2RenderingContext;class q extends v.A{constructor(t={}){super(),this.bevel=t.bevel??.1,this.options=t,this.rawVerts=[new w.A(.607,0,.795).scale(1),new w.A(.188,.577,.795).scale(1),new w.A(-.491,.357,.795).scale(1),new w.A(-.491,-.357,.795).scale(1),new w.A(.188,-.577,.795).scale(1),new w.A(.982,0,.188).scale(1),new w.A(.304,.934,.188).scale(1),new w.A(-.795,.577,.188).scale(1),new w.A(-.795,-.577,.188).scale(1),new w.A(.304,-.934,.188).scale(1),new w.A(.795,.577,-.188).scale(1),new w.A(-.304,.934,-.188).scale(1),new w.A(-.982,0,-.188).scale(1),new w.A(-.304,-.934,-.188).scale(1),new w.A(.795,-.577,-.188).scale(1),new w.A(.491,.357,-.795).scale(1),new w.A(-.188,.577,-.795).scale(1),new w.A(-.607,0,-.795).scale(1),new w.A(-.188,-.577,-.795).scale(1),new w.A(.491,-.357,-.795).scale(1)],this.faceVertIndices=[[0,1,2,3,4],[0,5,10,6,1],[1,6,11,7,2],[2,7,12,8,3],[3,8,13,9,4],[4,9,14,5,0],[10,15,16,11,6],[11,16,17,12,7],[12,17,18,13,8],[13,18,19,14,9],[5,14,19,15,10],[15,19,18,17,16]],this.vertFaceIndices=[];for(let t=0;t<20;t++){let i=0;for(let s=0;s<12;s++)for(let n=0;n<5;n++)this.faceVertIndices[s][n]==t&&(void 0===this.vertFaceIndices[t]&&(this.vertFaceIndices[t]=[]),this.vertFaceIndices[t][i++]=s)}this.edges=[[0,1,0,1],[0,2,1,2],[0,3,2,3],[0,4,3,4],[0,5,4,0],[1,10,5,10],[1,6,10,6],[1,2,1,6],[2,6,6,11],[2,7,11,7],[2,3,7,2],[3,7,7,12],[3,8,12,8],[3,4,8,3],[4,8,8,13],[4,9,13,9],[4,5,9,4],[5,9,9,14],[5,10,14,5],[5,1,5,0],[6,11,15,16],[6,7,16,11],[7,11,16,17],[7,8,17,12],[8,11,17,18],[8,9,18,13],[9,11,18,19],[9,10,19,14],[10,11,19,15],[10,6,15,10]],this.faceMidPoints=[];for(let t=0;t<12;t++){const i=new w.A;for(let s=0;s<5;s++)i.add(this.rawVerts[this.faceVertIndices[t][s]],i);i.scale(.2,i),this.faceMidPoints[t]=i}this.geometries=[this.tt(),this.it(),this.st()],this.materials=[new _(1,this.options),new _(2,this.options),new _(3,this.options)],this.meshes=[new g.A(this.geometries[0],this.materials[0]),new g.A(this.geometries[1],this.materials[1]),new g.A(this.geometries[2],this.materials[2])]}tt(){const t=[],i=[],s=[],n=[];for(let e=0;e<12;e++){const h=this.faceMidPoints[e],o=h.clone().normalize();for(let i=0;i<5;i++){const r=this.rawVerts[this.faceVertIndices[e][i]].sub(h);r.scale(1-this.bevel,r),r.add(h,r),t.push(r),s.push(o),n.push(1)}i.push(5*e+2,5*e+1,5*e+0,5*e+3,5*e+2,5*e+0,5*e+4,5*e+3,5*e+0)}return this.nt(t,i,[s],[n],1)}it(){const t=[],i=[],s=[],n=[],e=[],h=[];for(const o of this.edges){const r=o[0],a=o[1],c=o[2],l=o[3],u=this.faceMidPoints[r],f=this.faceMidPoints[a],d=this.rawVerts[c],v=this.rawVerts[l];t.push(d.sub(u).scale(1-this.bevel).add(u)),t.push(d.sub(f).scale(1-this.bevel).add(f)),t.push(v.sub(f).scale(1-this.bevel).add(f)),t.push(v.sub(u).scale(1-this.bevel).add(u));let m=t.length-4,w=t.length-3,p=t.length-2,g=t.length-1;if(t[w].sub(t[m]).cross(t[p].sub(t[m])).dot(d)<0){let t=w;w=g,g=t}i.push(p,w,m,g,p,m);d.add(v).scale(.5).normalize();const x=u.clone().normalize(),M=f.clone().normalize();s.push(x,x,x,x),n.push(M,M,M,M),e.push(1,0,0,1),h.push(0,1,1,0)}return this.nt(t,i,[s,n],[e,h],2)}st(){const t=[],i=[],s=[],n=[],e=[],h=[],o=[],r=[];for(let a=0;a<20;a++){const c=this.faceMidPoints[this.vertFaceIndices[a][0]].clone().normalize(),l=this.faceMidPoints[this.vertFaceIndices[a][1]].clone().normalize(),u=this.faceMidPoints[this.vertFaceIndices[a][2]].clone().normalize();for(let i=0;i<3;i++){let h=this.vertFaceIndices[a][i];const o=this.faceMidPoints[h],r=this.rawVerts[a].sub(o);r.scale(1-this.bevel,r),r.add(o,r),t.push(r),s.push(c),n.push(l),e.push(u)}h.push(1,0,0),o.push(0,1,0),r.push(0,0,1);let f=t.length-3,d=t.length-2,v=t.length-1;if(t[d].sub(t[f]).cross(t[v].sub(t[f])).dot(this.rawVerts[a])<0){let t=d;d=v,v=t}i.push(v,d,f)}return this.nt(t,i,[s,n,e],[h,o,r],3)}nt(t,i,s,n,e){const h={position:new P.A(new Float32Array(w.A.serialize(t)),3,D.FLOAT)};for(let t=0;t<e;t++){const i=t+1;h[`direction${i}`]=new P.A(new Float32Array(w.A.serialize(s[t])),3,D.FLOAT),h[`weight${i}`]=new P.A(new Float32Array(n[t]),1,D.FLOAT)}const o=new P.A(new Uint16Array(i),1,D.UNSIGNED_SHORT);return new p.A(h,o)}encodeNormalToUV(t){const i=Math.sqrt(Math.max(8*t.z+8,.001));return new m.A(t.x,t.y).scale(1/i).addScalar(.5)}dispose(t){for(const i of this.materials)t.disposeMaterial(i)}}var T=s(8023),E=s(1649);class C extends T.A{constructor(t={}){super(t)}getFragSource(){return"#version 300 es\n\n            precision mediump float;\n\n            uniform sampler2D tDiffuse;\n            uniform vec2 invResolution;\n            \n            in vec2 vUv;\n\n            out vec4 gDiffuse;\n\n            void main(void) {\n                float x = invResolution.x;\n                float y = invResolution.y;\n\n                // Take 13 samples around current texel:\n                // a - b - c\n                // - j - k -\n                // d - e - f\n                // - l - m -\n                // g - h - i\n                vec3 a = texture(tDiffuse, vec2(vUv.x - 2.0 * x, vUv.y + 2.0 * y)).rgb;\n                vec3 b = texture(tDiffuse, vec2(vUv.x,           vUv.y + 2.0 * y)).rgb;\n                vec3 c = texture(tDiffuse, vec2(vUv.x + 2.0 * x, vUv.y + 2.0 * y)).rgb;\n\n                vec3 d = texture(tDiffuse, vec2(vUv.x - 2.0 * x, vUv.y)).rgb;\n                vec3 e = texture(tDiffuse, vec2(vUv.x,           vUv.y)).rgb;\n                vec3 f = texture(tDiffuse, vec2(vUv.x + 2.0 * x, vUv.y)).rgb;\n\n                vec3 g = texture(tDiffuse, vec2(vUv.x - 2.0 * x, vUv.y - 2.0 * y)).rgb;\n                vec3 h = texture(tDiffuse, vec2(vUv.x  ,         vUv.y - 2.0 * y)).rgb;\n                vec3 i = texture(tDiffuse, vec2(vUv.x + 2.0 * x, vUv.y - 2.0 * y)).rgb;\n\n                vec3 j = texture(tDiffuse, vec2(vUv.x - x, vUv.y + y)).rgb;\n                vec3 k = texture(tDiffuse, vec2(vUv.x + x, vUv.y + y)).rgb;\n                vec3 l = texture(tDiffuse, vec2(vUv.x - x, vUv.y - y)).rgb;\n                vec3 m = texture(tDiffuse, vec2(vUv.x + x, vUv.y - y)).rgb;\n\n                vec3 downsample = e * 0.125;\n                downsample += (a + c + g + i) * 0.03125;\n                downsample += (b + d + f + h) * 0.0625;\n                downsample += (j + k + l + m) * 0.125;\n\n                gDiffuse = vec4(downsample, 1.0);\n            }\n        "}getUniforms(){return{tDiffuse:new E.A,invResolution:new m.A}}update(t,i){this.uniforms.invResolution.set(1/t.width,1/t.height),this.uniforms.tDiffuse=i.texture}}var b=s(2577);class U extends T.A{constructor(t={}){super(t),this.blending=M.vU,this.transparent=!0}getFragSource(){return"#version 300 es\n\n            precision mediump float;\n\n            uniform sampler2D tTexture;\n            uniform float filterRadius;\n            uniform vec2 invResolution;\n            \n            in vec2 vUv;\n\n            out vec4 gDiffuse;\n                \n            void main() {\n                vec3 upsample = vec3(0.0);\n                // The filter kernel is applied with a radius, specified in texture\n                // coordinates, so that the radius will vary across mip resolutions.\n                float x = invResolution.x;\n                float y = invResolution.y;\n\n                // Take 9 samples around current texel:\n                // a - b - c\n                // d - e - f\n                // g - h - i\n                vec3 a = texture(tTexture, vec2(vUv.x - x, vUv.y + y)).rgb;\n                vec3 b = texture(tTexture, vec2(vUv.x,     vUv.y + y)).rgb;\n                vec3 c = texture(tTexture, vec2(vUv.x + x, vUv.y + y)).rgb;\n\n                vec3 d = texture(tTexture, vec2(vUv.x - x, vUv.y    )).rgb;\n                vec3 e = texture(tTexture, vec2(vUv.x,     vUv.y    )).rgb;\n                vec3 f = texture(tTexture, vec2(vUv.x + x, vUv.y    )).rgb;\n\n                vec3 g = texture(tTexture, vec2(vUv.x - x, vUv.y - y)).rgb;\n                vec3 h = texture(tTexture, vec2(vUv.x,     vUv.y - y)).rgb;\n                vec3 i = texture(tTexture, vec2(vUv.x + x, vUv.y - y)).rgb;\n\n                // Apply weighted distribution, by using a 3x3 tent filter:\n                //  1   | 1 2 1 |\n                // -- * | 2 4 2 |\n                // 16   | 1 2 1 |\n                upsample = e*4.0;\n                upsample += (b + d + f + h) * 2.0;\n                upsample += (a + c + g + i);\n                upsample *= 1.0 / 16.0;\n\n                gDiffuse = vec4(upsample, 1.0);\n            }\n        "}getUniforms(t){return{tTexture:new E.A,invResolution:new m.A}}update(t){this.uniforms.tTexture=t.texture,this.uniforms.invResolution.set(t.width,t.height),this.uniforms.invResolution.invert(this.uniforms.invResolution)}}class N extends M.Ay{constructor(t={}){super(t),this.uniforms=this.getUniforms()}init(t){this.useBloom=t.useBloom??!0}getVertSource(){return`#version 300 es\n\n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec2 uv;\n\n            uniform float cameraHeight;\n            \n            out vec2 vUv;\n            out float vExposure;\n\n            ${S.mz}\n\n            ${S.SY}\n\n            void main() {\n                vUv = uv;\n                \n                vec3 sunIrradiance = getSunIrradiance(0.0);\n                vec3 skyIrradiance = getInscattering(0.0);\n\n                float brightness = dot(sunIrradiance / (4.0 * PI) + skyIrradiance, vec3(1.0, 1.0, 1.0));\n                vExposure = 1.0 / brightness * 1.25;\n\n                gl_Position = vec4(position, 1.0);\n            }\n        `}getFragSource(){return`#version 300 es\n\n            #define BLOOM_FACTOR 0.25\n\n            ${this.useBloom?"#define USE_BLOOM":""}\n\n            #define GAMMA ${this.useBloom?"1.2":"1.6"}\n\n            #define EXPOSURE ${this.useBloom?"1.0":"0.75"}\n\n            precision mediump float;\n            precision mediump sampler2DArray;\n            precision mediump sampler2DArrayShadow;\n            precision mediump sampler3D;\n\n            uniform sampler2D tDiffuse;\n            uniform sampler2D tBloom;\n            uniform float mipLength;\n            uniform float exposure;\n\n            uniform float damageEffect;\n\n            in vec2 vUv;\n            in float vExposure;\n\n            out vec4 gDiffuse;\n\n            vec3 tonemap(vec3 color) {\n                float y = 0.425;\n                return vec3(1.0) - exp(-color / y);\n            }\n\n            vec3 Uncharted2ToneMapping(vec3 color) {\n                float A = 0.15;\n                float B = 0.50;\n                float C = 0.10;\n                float D = 0.20;\n                float E = 0.02;\n                float F = 0.30;\n                color = ((color*(A*color+C*B)+D*E)/(color*(A*color+B)+D*F)) - E/F;\n                return color * 6.0;\n                // return clamp(color * 8.0, 0.0, 1.0);\n            }\n\n            vec3 ReinhardToneMapping(vec3 color) {\n                return color / (color + vec3(1.0));\n            }\n                \n            vec3 ACESFilmToneMapping(vec3 x) {\n                const float a = 2.51;\n                const float b = 0.03;\n                const float c = 2.43;\n                const float d = 0.59;\n                const float e = 0.14;\n                return clamp((x * (a * x + b)) / (x * (c * x + d) + e), 0.0, 1.0);\n            }\n\n            // ACES tone map (faster approximation)\n            // see: https://knarkowicz.wordpress.com/2016/01/06/aces-filmic-tone-mapping-curve/\n            vec3 toneMapACES_Narkowicz(vec3 color) {\n                const float A = 2.51;\n                const float B = 0.03;\n                const float C = 2.43;\n                const float D = 0.59;\n                const float E = 0.14;\n                return clamp((color * (A * color + B)) / (color * (C * color + D) + E), 0.0, 1.0);\n            }\n\n            // ACES filmic tone map approximation\n            // see https://github.com/TheRealMJP/BakingLab/blob/master/BakingLab/ACES.hlsl\n            vec3 RRTAndODTFit(vec3 color) {\n                vec3 a = color * (color + 0.0245786) - 0.000090537;\n                vec3 b = color * (0.983729 * color + 0.4329510) + 0.238081;\n                return a / b;\n            }\n\n            vec3 toneMap_KhronosPbrNeutral( vec3 color ) {\n                const float startCompression = 0.8 - 0.04;\n                const float desaturation = 0.15;\n\n                float x = min(color.r, min(color.g, color.b));\n                float offset = x < 0.08 ? x - 6.25 * x * x : 0.04;\n                color -= offset;\n\n                float peak = max(color.r, max(color.g, color.b));\n                if (peak < startCompression) return color;\n\n                const float d = 1. - startCompression;\n                float newPeak = 1. - d * d / (peak + d - startCompression);\n                color *= newPeak / peak;\n\n                float g = 1. - 1. / (desaturation * (peak - newPeak) + 1.);\n                return mix(color, newPeak * vec3(1, 1, 1), g);\n            }\n\n            void main() {\n                #ifdef USE_BLOOM\n                gDiffuse.rgb = mix(texture(tDiffuse, vUv).rgb, texture(tBloom, vUv).rgb / mipLength, BLOOM_FACTOR);\n                #else\n                gDiffuse.rgb = texture(tDiffuse, vUv).rgb;\n                #endif\n\n                vec2 coord = vUv * 2.0 - 1.0;\n                float vignet = exp(-length(coord) * 0.35);\n                gDiffuse.rgb = tonemap(gDiffuse.rgb * vExposure * EXPOSURE * vignet * 1.8);\n                // gDiffuse.rgb *= vec3(1.2, 1.15, 1.2);\n                gDiffuse.rgb = pow(gDiffuse.rgb, vec3(1.0 / GAMMA));\n\n                gDiffuse.rgb = mix(gDiffuse.rgb, vec3(1.0, 0.0, 0.0), (1.0 - exp(-length(coord) * 0.35)) * damageEffect);\n                \n                gDiffuse.a = 1.0;\n            }\n        `}getUniforms(){return{tDiffuse:new E.A,tBloom:new E.A,exposure:1,mipLength:0,cameraHeight:0,atmosphereProfile:{},damageEffect:0}}}var R=s(1992),I=s(9246),z=s(7907);class L extends b.A{constructor(t={}){super(t),this.isArrayFramebuffer=!0,this.currentLayer=0,this.maxLayer=t.layers}et(t){this.textures=[];for(let i=0;i<this.count;i++){const s=new y.A(t);this.textures[i]=s}this.texture=this.textures[0]}}const F=WebGL2RenderingContext;class O extends y.A{constructor(t={}){super(t),this.isTextureArrayShadow=!0,this.magFilter=t.magFilter??F.LINEAR,this.minFilter=t.minFilter??F.LINEAR,this.wrapS=t.wrapS??F.CLAMP_TO_EDGE,this.wrapT=t.wrapT??F.CLAMP_TO_EDGE,this.internalFormat=t.internalFormat??F.DEPTH_COMPONENT32F,this.format=t.format??F.DEPTH_COMPONENT,this.type=t.type??F.FLOAT,this.generateMipmap=t.generateMipmap??!1}}class V extends L{constructor(t={}){super(t),this.isArrayShadowFramebuffer=!0}et(t){this.texture=null,this.textures=[]}ht(t){this.depthTexture=new O(t)}}class k extends M.Ay{constructor(t={}){super(t)}getVertSource(){return"#version 300 es\n        \n            precision mediump float;\n            \n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec3 normal;\n            layout (location = 2) in vec2 uv;\n            \n            // uniform mat4 modelMatrix;\n            // // uniform mat4 viewMatrix;\n            // uniform mat4 modelViewMatrix;\n            // uniform mat4 projectionMatrix;\n            \n            out vec2 vUv;\n            out vec3 vNormal;\n            out vec3 vPosition;\n\n            void main() {\n                vUv = uv;\n\n                // vec4 worldNormal = modelMatrix * vec4(normal, 0.0);\n                // vNormal = normalize(worldNormal.xyz);\n\n                // vPosition = (modelViewMatrix * vec4(position, 1.0)).xyz;\n                // gl_Position = projectionMatrix * vec4(vPosition, 1.0);\n                gl_Position = vec4(vPosition, 1.0);\n            }\n        "}getFragSource(){return"#version 300 es\n            \n            precision mediump float;\n            precision mediump sampler2DArray;\n\n            in vec2 vUv;\n            in vec3 vNormal;\n            in vec3 vPosition;\n\n            // #ifdef USE_COLOR_MAP\n            //     uniform sampler2D tColor;\n            // #endif\n            // uniform vec4 colorFactor;\n\n            // uniform sampler2D tEmissive;\n            // uniform vec4 emissiveFactor;\n\n            // uniform float roughness;\n            // uniform float metalness;\n\n            uniform sampler2DArray tStaticShadows;\n\n            layout(location = 0) out vec4 gColor;\n            // layout(location = 1) out vec4 gNormal;\n            // layout(location = 2) out vec4 gSurface;\n            // layout(location = 3) out vec4 gEmissive;\n            // layout(location = 4) out vec4 gFlatNormal;\n\n            void main() {\n                // #ifdef USE_COLOR_MAP\n                //     gColor = texture(tColor, vUv) * colorFactor;\n                // #else\n                //     gColor = colorFactor;\n                // #endif\n\n                // gNormal = vec4(normalize(vNormal), 0.0);\n                // gSurface = vec4(0.0, roughness, metalness, 0.0);\n                // gEmissive = texture(tEmissive, vUv) * emissiveFactor;\n\n                // vec3 dx = dFdx(vPosition);\n                // vec3 dy = dFdy(vPosition);\n                // gFlatNormal = vec4(normalize(cross(normalize(dx), normalize(dy))), 1.0);\n\n                gColor = vec4(1.0, 0.0, 0.0, 1.0);\n            }\n        "}getUniforms(t){return{}}}const G=new w.A(0,0,-1),B=(new w.A,new w.A),H=(new m.A,new w.A),j=new w.A,W=new I.A,$=new m.A;class X{constructor(t={}){this.cascades=t.cascades??6,this.maxFar=t.maxFar??16e3,this.lightNear=0,this.lightFar=32e3,this.lightMargin=1600,this.frustumScaleRatio=this.maxFar/Math.pow(2,this.cascades-1),this.updatePartially=t.updatePartially??!1,this.viewProjectionMatrices=[];for(let t=0;t<this.cascades;t++)this.viewProjectionMatrices[t]=new R.A;this.texelSizes=[],this.shadowCastDistance=t.shadowCastDistance??16e3,this.shadowMapResolution=t.shadowMapResolution??2048,this.shadowCameras=[];for(let t=0;t<this.cascades;t++)this.shadowCameras.push(new z.A({}));this.renderTarget=new V({width:this.shadowMapResolution,height:this.shadowMapResolution,layers:this.cascades}),this.shadowMaterial=new k,this.currentUpdateIndex=0}getCascade(t,i,s){const n=i/Math.pow(2,s-1);return Math.floor(Math.log2(t/n)+1)}updateShadowCamera(t,i,s,e,h){const o=0===h?0:Math.pow(2,h-1)*this.frustumScaleRatio,r=Math.pow(2,h)*this.frustumScaleRatio,a=e*o,c=e*r,l=Math.sqrt((.5*a+.5*c)**2+(r-o)**2),u=Math.max(c,l);this.shadowCameras[h].updateDimensions(u,u,this.lightNear,this.lightFar),this.texelSizes[h]=u/this.shadowMapResolution,G.scale(.5*(o+r),H),i.vmult(H,H),t.add(H,H),s.scale(.5*u+this.lightMargin,j),H.add(j,this.shadowCameras[h].position);{n.IU.cross(s,B),B.normalize();const t=Math.acos(n.IU.dot(s));this.shadowCameras[h].quaternion.setFromAxisAngle(B,t)}{this.shadowCameras[h].quaternion.conjugate(W);const t=W.vmult(this.shadowCameras[h].position,this.shadowCameras[h].position),i=u/this.shadowMapResolution;t.x=Math.round(t.x/i)*i,t.y=Math.round(t.y/i)*i,t.z=Math.round(t.z/i)*i,this.shadowCameras[h].quaternion.vmult(t,this.shadowCameras[h].position)}this.shadowCameras[h].updateModelMatrix(),this.shadowCameras[h].updateViewMatrix(),this.shadowCameras[h].projectionMatrix.mult(this.shadowCameras[h].viewMatrix,this.viewProjectionMatrices[h]),this.shadowCameras[h].updateFrustum()}render(t,i,s,n){const e=2*Math.tan(.5*i.fov),h=$.set(e*i.aspect,e).length();for(let e=0;e<this.cascades;e++){if(this.updatePartially&&e!==this.currentUpdateIndex)continue;const o=this.shadowCameras[e];this.updateShadowCamera(i.position,i.quaternion,n,h,e),t.setFramebufferLayer(this.renderTarget,e),t.clear();for(const n of s)t.drawShadow(n,o,i.position)}this.currentUpdateIndex++,this.cascades<=this.currentUpdateIndex&&(this.currentUpdateIndex=0)}dispose(t){t.disposeFramebuffer(this.renderTarget),t.disposeMaterial(this.shadowMaterial)}}var Z=s(8633);class Y extends M.Ay{constructor(t={}){super(t),this.uniforms=this.getUniforms(),this.renderingPass=n.uk,this.transparent=!0,this.depthWrite=!1,this.depthTest=!1}getVertSource(){return"#version 300 es\n\n            layout (location = 0) in vec3 position;\n\n            void main() {\n                gl_Position = vec4(position, 1.0);\n            }\n        "}getFragSource(){return"#version 300 es\n\n            precision mediump float;\n\n            uniform float alpha;\n\n            out vec4 gDiffuse;\n\n            void main() {\n                gDiffuse.rgb = vec3(0.0);\n                gDiffuse.a = 1.0 - alpha;\n            }\n        "}getUniforms(){return{alpha:1}}}const K=WebGL2RenderingContext;class J{constructor(t,i){this.renderer=t,this.graphicSettings=i,this.init()}init(){this.staticCSM=new X({cascades:6,maxFar:16e3,updatePartially:!0}),this.dynamicCSM=new X({cascades:10,maxFar:1600,updatePartially:!1}),this.multipleFramebuffer=new b.A({width:window.innerWidth,height:window.innerHeight,count:5,useDepthBuffer:!0}),this.forwardFramebuffer=new b.A({width:window.innerWidth,height:window.innerHeight,useDepthBuffer:!0}),this.shadingFramebuffer=new b.A({width:window.innerWidth,height:window.innerHeight,useDepthBuffer:!0,generateMipmap:!0,magFilter:K.LINEAR,minFilter:K.LINEAR_MIPMAP_NEAREST}),this.onResize=function(){this.multipleFramebuffer.setSize(window.innerWidth,window.innerHeight),this.shadingFramebuffer.setSize(window.innerWidth,window.innerHeight),this.forwardFramebuffer.setSize(window.innerWidth,window.innerHeight)}.bind(this),window.addEventListener("resize",this.onResize),this.dodecahedron=new q({shaderType:this.graphicSettings.shaderType??n.$g,useCSM:this.graphicSettings.useCSM??!0,useAO:this.graphicSettings.useGTAO??!0,volumetricCloudsQuality:this.graphicSettings.volumetricCloudsQuality,staticShadowCascades:this.staticCSM.cascades,dynamicShadowCascades:this.dynamicCSM.cascades,viewDistance:this.graphicSettings.viewDistance});for(const t of this.dodecahedron.materials)t.uniforms.tColor=this.multipleFramebuffer.textures[0],t.uniforms.tNormal=this.multipleFramebuffer.textures[1],t.uniforms.tSurface=this.multipleFramebuffer.textures[2],t.uniforms.tEmissive=this.multipleFramebuffer.textures[3],t.uniforms.tFlatNormal=this.multipleFramebuffer.textures[4],t.uniforms.tDepth=this.multipleFramebuffer.depthTexture;if(this.composerMaterial=new N({useBloom:this.graphicSettings.useBloom??!0}),this.screenFadeMaterial=new Y,this.composerPass=new Z.A(this.composerMaterial),this.screenFadePass=new Z.A(this.screenFadeMaterial),this.graphicSettings.useBloom){this.bloomMipLength=0,this.updateMaxMipLevel=function(){this.bloomMipLength=Math.floor(Math.log2(.5*Math.min(window.innerWidth,window.innerHeight)))+1},window.addEventListener("resize",this.updateMaxMipLevel),this.updateMaxMipLevel(),this.bloomFramebuffers=[];for(let t=0;t<10;t++){const i=.5*Math.pow(.5,t),s=new b.A({count:1,useDepthBuffer:!1,generateMipmap:!0,magFilter:K.LINEAR,minFilter:K.LINEAR_MIPMAP_NEAREST});s.onResize=function(){s.setSize(Math.ceil(window.innerWidth*i),Math.ceil(window.innerHeight*i))},window.addEventListener("resize",s.onResize),s.onResize(),this.bloomFramebuffers.push(s)}this.downsamplingMaterial=new C,this.downsamplingPass=new Z.A(this.downsamplingMaterial),this.upsamplingMaterial=new U,this.upsamplingPass=new Z.A(this.upsamplingMaterial)}this.deferredList=[],this.dynamicList=[],this.staticList=[],this.forwardList=[],this.uiList=[]}dispose(){if(this.staticCSM&&this.staticCSM.dispose(this.renderer),this.dynamicCSM&&this.dynamicCSM.dispose(this.renderer),this.multipleFramebuffer&&this.renderer.disposeFramebuffer(this.multipleFramebuffer),this.forwardFramebuffer&&this.renderer.disposeFramebuffer(this.forwardFramebuffer),this.shadingFramebuffer&&this.renderer.disposeFramebuffer(this.shadingFramebuffer),this.onResize&&window.removeEventListener("resize",this.onResize),this.dodecahedron&&this.dodecahedron.dispose(this.renderer),this.composerMaterial&&this.renderer.disposeMaterial(this.composerMaterial),this.updateMaxMipLevel&&window.removeEventListener("resize",this.updateMaxMipLevel),this.bloomFramebuffers)for(const t of this.bloomFramebuffers)window.removeEventListener("resize",t.onResize),this.renderer.disposeFramebuffer(t);this.downsamplingMaterial&&this.renderer.disposeMaterial(this.downsamplingMaterial),this.upsamplingMaterial&&this.renderer.disposeMaterial(this.upsamplingMaterial)}execute(t,i,s=1){i.updateModelMatrix(),i.updateViewMatrix(),i.updateFrustum(),this.deferredList.length=0,this.dynamicList.length=0,this.staticList.length=0,this.forwardList.length=0,this.uiList.length=0;for(const s of t.meshes)s.updateModelMatrix(),this.ot(s,i);if(t.isGame){this.graphicSettings.useCSM&&(this.staticCSM.render(this.renderer,i,this.staticList,t.atmosphereProfile.sunDirection),this.dynamicCSM.render(this.renderer,i,this.dynamicList,t.atmosphereProfile.sunDirection)),this.renderer.setFramebuffer(this.multipleFramebuffer),this.renderer.clear();for(const t of this.deferredList)this.renderer.draw(t,i);this.multipleFramebuffer.depthTexture.needsUpdate=!0,this.renderer.setFramebuffer(this.forwardFramebuffer),this.renderer.clear(),this.renderer.copyDepthTexture(this.multipleFramebuffer,this.forwardFramebuffer),this.renderer.setFramebuffer(this.forwardFramebuffer);for(const s of this.forwardList){const n=s.material,e=n.uniforms;t.atmosphereProfile.setToMaterialUniforms(n),e.cameraPosition&&e.cameraPosition.copy(i.position),e.tBRDF=this.brdfTexture,this.renderer.draw(s,i),s.onAfterRender&&s.onAfterRender(this.renderer,i)}this.renderer.setFramebuffer(this.shadingFramebuffer),this.renderer.clear();for(const s of this.dodecahedron.materials)this.rt(t,s,i);for(const t of this.dodecahedron.meshes)this.renderer.draw(t,i);if(this.shadingFramebuffer.texture.needsUpdate=!0,this.graphicSettings.useBloom){for(let t=0;t<Math.min(10,this.bloomMipLength);t++){const i=0==t?this.shadingFramebuffer:this.bloomFramebuffers[t-1];this.downsamplingMaterial.update(this.bloomFramebuffers[t],i),this.renderer.setFramebuffer(this.bloomFramebuffers[t]),this.renderer.clear(),this.downsamplingPass.render(this.renderer),this.bloomFramebuffers[t].texture.needsUpdate=!0}for(let t=Math.min(10,this.bloomMipLength)-1;0<t;t--)this.renderer.setFramebuffer(this.bloomFramebuffers[t-1]),this.upsamplingMaterial.update(this.bloomFramebuffers[t]),this.upsamplingPass.render(this.renderer),this.bloomFramebuffers[t-1].texture.needsUpdate=!0;this.composerMaterial.uniforms.tBloom=this.bloomFramebuffers[0].texture}}if(this.renderer.setFramebuffer(null),this.renderer.clear(),t.isGame){t.atmosphereProfile.setToMaterialUniforms(this.composerMaterial);const s=this.composerMaterial.uniforms;s.tDiffuse=this.shadingFramebuffer.texture,s.mipLength=this.bloomMipLength,s.cameraHeight=i.position.y,i.cameraShakeScale?s.damageEffect=i.cameraShakeScale:s.damageEffect=0,this.composerPass.render(this.renderer)}for(const t of this.uiList)t.draw(this.renderer,i),t.onAfterRender&&t.onAfterRender(this.renderer,i);s<1&&(this.screenFadeMaterial.uniforms.alpha=s,this.screenFadePass.render(this.renderer)),this.renderer.flush()}ot(t,i,s=!1){if(!t.visible)return;s=s||t.isStatic;const e=i.position.distanceTo(t.worldPosition);if(!(t.drawDistance<e)){if(t.isMesh){if(t.frustumCulled&&!i.frustum.test(t.worldPosition,t.geometry.boundingRadius))return;switch(t.material.renderingPass){case n.xF:this.forwardList.push(t);break;case n.uk:this.uiList.push(t);break;default:this.deferredList.push(t),s?this.staticList.push(t):this.dynamicList.push(t)}}for(const n of t.children)this.ot(n,i,s);t.onBeforeRender&&t.onBeforeRender(this.renderer,i)}}ct(t,i){t.distanceToCamera=t.worldPosition.distanceTo(i.worldPosition);for(const s of t.children)this.ct(s,i)}lt(t,i){this.staticCSM.updateFromCamera(i,this.atmosphereProfile.sunDirection);for(let t=0;t<this.staticCSM.cascades;t++){const i=this.staticCSM.shadowCameras[t];this.renderer.setFramebufferLayer(this.staticCSM.renderTarget,t),this.renderer.clear();const s=0===t?0:Math.pow(2,t-1)*this.staticCSM.frustumScaleRatio,n=Math.pow(2,t)*this.staticCSM.frustumScaleRatio;for(const t of this.deferredList)this.renderer.drawShadow(t,i,s,n)}}rt(t,i,s){const n=i.uniforms;n.cameraPosition=s.position,n.invProjectionMatrix=s.invProjectionMatrix,n.invViewMatrix=s.modelMatrix,n.sunDirection.copy(t.atmosphereProfile.sunDirection),n.sunDirection.normalize(),n.resolution.set(this.multipleFramebuffer.width,this.multipleFramebuffer.height),n.invResolution.set(1/this.multipleFramebuffer.width,1/this.multipleFramebuffer.height),n.cameraNear=s.near,n.cameraFar=s.far,n.cameraFov=s.fov,n.cameraAspect=s.aspect,n.tStaticShadows=this.staticCSM.renderTarget.depthTexture,n.staticShadowMatrices=this.staticCSM.viewProjectionMatrices,n.staticShadowTexelSizes=this.staticCSM.texelSizes,n.staticShadowCascades=this.staticCSM.cascades,n.staticShadowMaxFar=this.staticCSM.maxFar,n.tDynamicShadows=this.dynamicCSM.renderTarget.depthTexture,n.dynamicShadowMatrices=this.dynamicCSM.viewProjectionMatrices,n.dynamicShadowTexelSizes=this.dynamicCSM.texelSizes,n.dynamicShadowCascades=this.dynamicCSM.cascades,n.dynamicShadowMaxFar=this.dynamicCSM.maxFar,n.invShadowMapResolution=1/this.staticCSM.shadowMapResolution,n.tTransparent=this.forwardFramebuffer.texture,n.cameraPosition=s.position,n.tTransmittance=t.atmosphereProfile.transmittanceTexture,n.tInscattering=t.atmosphereProfile.multipleScatteringTexture,n.tAverageColor=t.atmosphereProfile.averageColorTexture,n.tIrradiance=t.atmosphereProfile.irradianceTexture,n.tReflection=t.atmosphereProfile.environmentTexture,n.maxMipLevel=t.atmosphereCalculator?.reflectionFramebuffer.maxLevel,n.cloudsProfile=t.cloudsProfile,n.tShapeNoise=t.cloudsProfile.shapeTexture,n.tDetailNoise=t.cloudsProfile.detailTexture,t.atmosphereProfile.setToMaterialUniforms(i)}applyGraphicSettings(t){this.graphicSettings=t,this.dispose(),this.init()}}const Q=1/60;class tt{constructor(){const t=localStorage.getItem("control_settings");this.controlSettings=new f.A(t?JSON.parse(t):{});const i=localStorage.getItem("graphic_settings");this.graphicSettings=new d.Ay(i?JSON.parse(i):{});const s=localStorage.getItem("audio_settings");this.audioSettings=new u.A(s?JSON.parse(s):{}),this.playerController=new l.A(this.controlSettings),this.ut(),this.scene=null,this.nextScene=null,this.lastScene=null,this.fade=1,this.lastFade=this.fade,this.fadeSpeed=1,this.isFadingout=!1,this.isFadingin=!1,this.onFadeout=null,this.onFadein=null,this.renderer=new A.A(this.gl),this.renderingPipeline=new J(this.renderer,this.graphicSettings),this.halfRefreshRateMode=!1,this.skipFrame=!1,this.isNextSceneLoading=!1,this.isSceneFadedout=!0,this.timeAccumulated=0,this.currentTime=0,this.totalTime=0,this.audioContext=c.p8,this.masterGain=c.p8.createGain(),this.masterGain.connect(c.p8.destination),this.effectGain=c.p8.createGain(),this.effectGain.connect(this.masterGain),this.musicGain=c.p8.createGain(),this.musicGain.connect(this.masterGain),this.gain=1,this.focused=!0,window.addEventListener("blur",()=>{this.focused=!1}),window.addEventListener("focus",()=>{this.focused=!0}),this.ft()}ut(){if(this.canvas=document.getElementById("canvas"),this.gl=this.canvas.getContext("webgl2",{alpha:!1,premultipliedAlpha:!1,desynchronized:!1}),!this.gl){const t="Error: WebGL 2 is not supported on your browser.";throw document.getElementById("debug").textContent=t,new Error("Failed to get WebGL context.")}const t=()=>{const t=window.innerWidth,i=window.innerHeight;this.canvas.width=t,this.canvas.height=i,this.gl.viewport(0,0,t,i),this.scene?.onWindowResize&&this.scene.onWindowResize()};window.addEventListener("resize",t.bind(this)),t.bind(this)(),this.canPointerLock=!1}getLoadTasks(){return[new a.A("Loading textures",o.A.load),new a.A("Loading models",h.A.load),new a.A("Loading audios",e.A.load)]}loadResources(){}openScene(t){this.scene?(this.nextScene=t,this.fadeout(function(){this.lastScene=this.scene,this.scene=this.nextScene,this.nextScene=null,this.fadein(function(){this.scene.startMusic()}.bind(this))})):this.scene=t}ft(){this.halfRefreshRateMode&&(this.skipFrame=!this.skipFrame),this.skipFrame||this.dt(),requestAnimationFrame(this.ft.bind(this))}dt(){const t=this.vt()/1e3;if(this.wt(t),this.playerController.update(t),this.scene){this.scene.update(this.scene,t);const i=this.gt(t);this.scene.lateUpdate(this.scene,t,i),this.masterGain.gain.setTargetAtTime(this.focused?this.gain:0,c.p8.currentTime,n.HI),this.effectGain.gain.setTargetAtTime(this.focused?this.audioSettings.sfxVolume:0,c.p8.currentTime,n.HI),this.musicGain.gain.setTargetAtTime(this.focused?.5*this.audioSettings.bgmVolume:0,c.p8.currentTime,n.HI),this.renderingPipeline.execute(this.scene,this.scene.mainCamera,Math.abs(this.fade))}this.playerController.reset()}wt(t){this.isFadingin&&(this.fade+=t*this.fadeSpeed,this.onFadein&&1<=this.fade&&(this.onFadein(),this.onFadein=null,this.isFadingin=!1)),this.isFadingout&&(this.fade-=t*this.fadeSpeed,this.onFadeout&&this.fade<=0&&(this.onFadeout(),this.onFadeout=null,this.isFadingout=!1)),this.fade=(0,r.qE)(this.fade)}vt(){const t=performance.now(),i=this.lastCallTime?Math.min(t-this.lastCallTime,66.66666666666667):Q;return this.lastCallTime=t,i}gt(t){this.timeAccumulated+=t;let i=0;for(;Q<=this.timeAccumulated&&(this.totalTime+=Q,this.timeAccumulated-=Q,this.scene.fixedUpdate(this.scene,Q,this.totalTime),i++,!(Math.ceil(t/Q)<=i)););return this.timeAccumulated%=Q,this.timeAccumulated/Q}enablePointerLock(){this.canvas.requestPointerLock({unadjustedMovement:!0}),this.canPointerLock=!0}disablePointerLock(){document.exitPointerLock(),this.canPointerLock=!1}applyGraphicSettings(t){this.renderingPipeline.applyGraphicSettings(t),this.scene&&this.scene.applyGraphicSettings(t)}applyAudioSettings(t){this.audioSettings=t}setMasterGain(t){this.gain=t}fadeout(t){this.isFadingin=!1,this.isFadingout=!0,this.onFadeout=t}fadein(t){this.isFadingin=!0,this.isFadingout=!1,this.onFadein=t}}},7737:(t,i,s)=>{s.d(i,{A:()=>n});class n{constructor(){this.parent=null,this.children=[]}add(t){0<=this.children.indexOf(t)||(this.children.push(t),t.parent=this)}remove(t){const i=this.children.indexOf(t);i<0||(this.children.splice(i,1),t.parent=null)}async load(){for(const t of this.children)await t.load()}copy(t,i=!0){if(i)for(const s of t.children)this.add(s.clone(i));return this}clone(t=!0){return(new this.constructor).copy(this,t)}}},7975:(t,i,s)=>{s.d(i,{A:()=>o});var n=s(1447);var e=s(7830),h=s(6101);class o{constructor(t){this.mouseMode=!1,this.keyboardMode=!0,this.gamepadMode=!1,this.gamepad=null,this.lastAxes=[],this.lastButtons=[],this.buttonHoldTimes=[],this.mousePosition=new e.A,this.initControls(),this.initDebugControls(),this.initKeyControls(),this.createMouseEvents(),this.selectDirection=new h.A,this.selectDirectionReleased=!0,this.invertPitch=!1,this.swapThrottleAndYaw=!1,this.applySettings(t)}initControls(){this.aileron=0,this.elevator=0,this.rudder=0,this.throttle=0,this.throttleUp=0,this.throttleDown=0,this.afterBurner=0,this.brake=0,this.fireGun=!1,this.fireMissile=!1,this.chaseMissile=!1,this.keepFiring=!1,this.changeWeapon=!1,this.changeTarget=!1,this.chaseTarget=!1,this.lookHorizontal=0,this.lookVertical=0,this.rotateHorizontal=0,this.rotateVertical=0,this.changeView=!1,this.changeVehicle=!1,this.toggleGear=!1,this.toggleAoALimitter=!1,this.eject=!1,this.selectDirection=new h.A,this.select=!1,this.cancel=!1,this.dragged=!1,this.pause=!1,this.toggleHud=!1,this.steering=0,this.toggleLogo=!1}initDebugControls(){this.moveFrontAndBack=0,this.moveRightAndLeft=0,this.moveUpAndDown=0,this.decreaseMoveSpeed=!1,this.increaseMoveSpeed=!1}initKeyControls(){this.pitchUpKey=0,this.pitchDownKey=0,this.rollRightKey=0,this.rollLeftKey=0,this.yawRightKey=0,this.yawLeftKey=0,this.throttleUpKey=0,this.throttleDownKey=0,this.moveRightKey=0,this.moveLeftKey=0,this.moveForwardKey=0,this.moveBackwardKey=0,this.moveUpKey=0,this.moveDownKey=0,this.moveFastKey=0,this.moveSlowKey=0,this.rotateUpKey=0,this.rotateDownKey=0,this.rotateRightKey=0,this.rotateLeftKey=0}onMouseMove(t){}createMouseEvents(){window.addEventListener("mousemove",function(t){this.mouseMode=!0;const i=t.currentTarget,s=i.innerWidth/i.innerHeight,n=t.clientX,e=t.clientY,h=i.innerWidth,o=i.innerHeight;this.mousePosition.x=n/h*2-1,this.mousePosition.x*=s,this.mousePosition.y=-e/o*2+1}.bind(this)),window.addEventListener("mousedown",function(t){switch(this.mouseMode=!0,t.button){case 0:this.select=!0,this.dragged=!0;break;case 2:break;case 3:this.cancel=!0}}.bind(this)),window.addEventListener("mouseup",function(t){switch(t.button){case 0:this.select=!1,this.dragged=!1;break;case 2:break;case 3:this.cancel=!1}}.bind(this)),window.addEventListener("keydown",function(t){switch(0<=[32,37,38,39,40].indexOf(t.keyCode)&&t.preventDefault(),this.mouseMode=!1,this.keyboardMode=!0,this.gamepadMode=!1,t.key){case"ArrowDown":this.pitchUpKey=1,this.rotateDownKey=1;break;case"ArrowUp":this.pitchDownKey=1,this.rotateUpKey=1;break;case"ArrowRight":this.rollRightKey=1,this.rotateRightKey=1;break;case"ArrowLeft":this.rollLeftKey=1,this.rotateLeftKey=1;break;case"D":case"d":this.yawRightKey=1,this.moveRightKey=1;break;case"A":case"a":this.yawLeftKey=1,this.moveLeftKey=1;break;case"W":case"w":this.throttleUpKey=1,this.moveForwardKey=1;break;case"S":case"s":this.throttleDownKey=1,this.moveBackwardKey=1;break;case" ":this.fireGun=!0,this.moveSlowKey=1;break;case"G":case"g":this.toggleGear=!0;break;case"Q":case"q":this.changeWeapon=!0,this.moveDownKey=1;break;case"Shift":this.fireMissile=!0,this.keepFiring=!0,this.moveFastKey=1;break;case"E":case"e":this.changeTarget=!0,this.moveUpKey=1;break;case"R":case"r":this.changeRadarScale=!0;break;case"C":case"c":this.changeView=!0;break;case"L":case"l":this.toggleLogo=!0}switch(t.key){case"ArrowUp":this.selectDirection.x=0,this.selectDirection.y=1;break;case"ArrowDown":this.selectDirection.x=0,this.selectDirection.y=-1;break;case"ArrowLeft":this.selectDirection.x=-1,this.selectDirection.y=0;break;case"ArrowRight":this.selectDirection.x=1,this.selectDirection.y=0;break;case"Enter":case" ":this.select=!0;break;case"Backspace":case"Escape":this.pause=!0,this.cancel=!0;break;case"f":this.toggleFreeCamera=!0;break;case"v":this.changeVehicle=!0;break;case"h":this.toggleHud=!0}}.bind(this)),window.addEventListener("keyup",function(t){switch(t.key){case"ArrowDown":this.pitchUpKey=0,this.rotateDownKey=0;break;case"ArrowUp":this.pitchDownKey=0,this.rotateUpKey=0;break;case"ArrowRight":this.rollRightKey=0,this.rotateRightKey=0;break;case"ArrowLeft":this.rollLeftKey=0,this.rotateLeftKey=0;break;case"D":case"d":this.yawRightKey=0,this.moveRightKey=0;break;case"A":case"a":this.yawLeftKey=0,this.moveLeftKey=0;break;case"W":case"w":this.throttleUpKey=0,this.moveForwardKey=0;break;case"S":case"s":this.throttleDownKey=0,this.moveBackwardKey=0;break;case"Q":case"q":this.moveDownKey=0;break;case"E":case"e":this.moveUpKey=0;break;case" ":this.fireGun=!1,this.moveSlowKey=0;break;case"Shift":this.fireMissile=!1,this.keepFiring=!1,this.moveFastKey=0}}.bind(this))}update(t){this.keyboardMode&&this.handleKeyboard(t);const i=navigator.getGamepads();0<i.length&&(this.gamepad=i[0]),this.gamepad&&this.handleGamepad(t),this.selectDirection.normalize()}handleKeyboard(t){const i=1-Math.exp(10*-t);this.invertPitch?this.elevator=(0,n.Cc)(this.elevator,this.pitchDownKey-this.pitchUpKey,i):this.elevator=(0,n.Cc)(this.elevator,this.pitchUpKey-this.pitchDownKey,i),this.aileron=(0,n.Cc)(this.aileron,this.rollRightKey-this.rollLeftKey,i),this.rudder=(0,n.Cc)(this.rudder,this.yawRightKey-this.yawLeftKey,i),this.throttle=(0,n.Cc)(this.throttle,this.throttleUpKey-this.throttleDownKey,i),this.throttleUp=(0,n.Cc)(this.throttleUp,this.throttleUpKey,i),this.throttleDown=(0,n.Cc)(this.throttleDown,this.throttleDownKey,i),this.moveRightAndLeft=(0,n.Cc)(this.moveRightAndLeft,this.moveRightKey-this.moveLeftKey,i),this.moveFrontAndBack=(0,n.Cc)(this.moveFrontAndBack,this.moveForwardKey-this.moveBackwardKey,i),this.moveUpAndDown=(0,n.Cc)(this.moveUpAndDown,this.moveUpKey-this.moveDownKey,i),this.decreaseMoveSpeed=(0,n.Cc)(this.decreaseMoveSpeed,this.moveSlowKey,i),this.increaseMoveSpeed=(0,n.Cc)(this.increaseMoveSpeed,this.moveFastKey,i),this.rotateHorizontal=(0,n.Cc)(this.rotateHorizontal,this.rotateRightKey-this.rotateLeftKey,i),this.rotateVertical=(0,n.Cc)(this.rotateVertical,this.rotateUpKey-this.rotateDownKey,i)}handleGamepad(t){if((this.gamepad.buttons.some(t=>.5<=Math.abs(t.value))||this.gamepad.axes.some(t=>.5<=Math.abs(t)))&&(this.mouseMode=!1,this.keyboardMode=!1,this.gamepadMode=!0),!this.gamepadMode)return;const i=1-Math.exp(20*-t);this.elevator=(0,n.Cc)(this.elevator,this.getAxisValue(1),i),this.invertPitch&&(this.elevator*=-1),this.aileron=(0,n.Cc)(this.aileron,this.getAxisValue(0),i),this.swapThrottleAndYaw?(this.throttle=(0,n.Cc)(this.throttle,(0,n.qE)(this.getButtonValue(7)-this.getButtonValue(6)),i),this.throttleUp=(0,n.Cc)(this.throttleUp,this.getButtonValue(7),i),this.throttleDown=(0,n.Cc)(this.throttleDown,this.getButtonValue(6),i),this.rudder=(0,n.Cc)(this.rudder,(0,n.qE)(this.getButtonValue(5)-this.getButtonValue(4)),i)):(this.throttle=(0,n.Cc)(this.throttle,(0,n.qE)(this.getButtonValue(5)-this.getButtonValue(4)),i),this.throttleUp=(0,n.Cc)(this.throttleUp,this.getButtonValue(5),i),this.throttleDown=(0,n.Cc)(this.throttleDown,this.getButtonValue(4),i),this.rudder=(0,n.Cc)(this.rudder,(0,n.qE)(this.getButtonValue(7)-this.getButtonValue(6)),i)),this.fireGun=this.getButtonValue(0),this.fireMissile=this.getButtonPressed(1),this.keepFiring=this.getButtonValue(1),this.changeWeapon=this.getButtonPressed(2),this.changeTarget=this.getButtonReleased(3),this.chaseTarget=this.getButtonHeld(3),this.changeView=this.getButtonPressed(11),this.lookHorizontal=this.getAxisValue(2),this.lookVertical=-this.getAxisValue(3),this.toggleGear=this.getButtonPressed(10),this.pause=this.getButtonPressed(9),this.toggleFreeCamera=this.getButtonPressed(8),this.moveFrontAndBack=(0,n.Cc)(this.moveFrontAndBack,-this.getAxisValue(1),i),this.moveRightAndLeft=(0,n.Cc)(this.moveRightAndLeft,this.getAxisValue(0),i),this.moveUpAndDown=(0,n.Cc)(this.moveUpAndDown,this.getButtonValue(7)-this.getButtonValue(6),i),this.decreaseMoveSpeed=(0,n.Cc)(this.decreaseMoveSpeed,this.getButtonValue(4),i),this.increaseMoveSpeed=(0,n.Cc)(this.increaseMoveSpeed,this.getButtonValue(5),i),this.rotateHorizontal=this.getAxisValue(2),this.rotateVertical=-this.getAxisValue(3),this.select=this.getButtonPressed(0),this.cancel=this.getButtonPressed(1),this.updateSelectDirection(),this.lastButtons.length=0;for(const t of this.gamepad.buttons)this.lastButtons.push(t.value);this.lastAxes.length=0;for(const t of this.gamepad.axes)this.lastAxes.push(t);this.updateButtonHoldTimes(t)}reset(){this.select=!1,this.cancel=!1,this.pause=!1,this.fireMissile=!1,this.exposurePlus=!1,this.exposureMinus=!1,this.changeVehicle=!1,this.changeTarget=!1,this.changeView=!1,this.toggleFreeCamera=!1,this.changeRadarScale=!1,this.toggleAoALimitter=!1,this.toggleHud=!1,this.changeWeapon=!1,this.toggleLogo=!1,this.selectDirection.x=0,this.selectDirection.y=0,this.selectDirection.z=0}updateButtonHoldTimes(t){for(let i=0;i<this.gamepad.buttons.length;i++){void 0===this.buttonHoldTimes[i]&&(this.buttonHoldTimes[i]=0);this.gamepad.buttons[i].pressed?this.buttonHoldTimes[i]+=t:this.buttonHoldTimes[i]=0}}resetControl(){this.select=!1,this.cancel=!1,this.pause=!1,this.selectDirection.x=0,this.selectDirection.y=0,this.changeSubWeapon=!1}squareInput(t){if(!t.length())return t;const i=new e.A(Math.abs(t.x),Math.abs(t.y)),s=t.length()/(i.x<i.y?i.y:i.x);return t.multiplyScalar(s),t}getAxisValue(t){return(0,n.qE)(this.applyDeadzone(this.gamepad.axes[t]))}getButtonValue(t){return(0,n.qE)(this.applyDeadzone(this.gamepad.buttons[t].value))}getAxisPressed(t){return!this.applyThreshould(this.lastAxes[t])&&this.applyThreshould(this.gamepad.axes[t])}getButtonPressed(t){return!this.applyThreshould(this.lastButtons[t])&&this.applyThreshould(this.gamepad.buttons[t].value)}getButtonHeld(t){return this.buttonHoldTimes[t]&&.25<this.buttonHoldTimes[t]}getButtonReleased(t){return!this.getButtonHeld(t)&&this.applyThreshould(this.lastButtons[t])&&!this.applyThreshould(this.gamepad.buttons[t].value)}updateSelectDirection(){this.selectDirection.set(0,0,0),this.getAxisPressed(0)&&(this.selectDirection.x+=this.getAxisValue(0)),this.getAxisPressed(1)&&(this.selectDirection.y-=this.getAxisValue(1)),this.getAxisPressed(2)&&(this.selectDirection.x+=this.getAxisValue(2)),this.getAxisPressed(3)&&(this.selectDirection.y-=this.getAxisValue(3)),this.getButtonPressed(12)&&(this.selectDirection.y+=1),this.getButtonPressed(13)&&(this.selectDirection.y-=1),this.getButtonPressed(14)&&(this.selectDirection.x-=1),this.getButtonPressed(15)&&(this.selectDirection.x+=1)}applyDeadzone(t,i=.1,s=.1){if(!t)return 0;const n=Math.max(Math.abs(t)-i,0)/(1-i);return Math.min(n*(1+s),1)*Math.sign(t)}applyThreshould(t,i=.5){return!!t&&i<=Math.abs(t)}resetWings(){this.elevator=0,this.rudder=0,this.aileron=0}applySettings(t){this.invertPitch=t.invertPitch,this.swapThrottleAndYaw=t.swapThrottleAndYaw}}},261:(t,i,s)=>{s.d(i,{A:()=>S});var n=s(6389),e=(s(2192),s(1447)),h=(s(1296),s(9262)),o=s(9146),r=s(4857),a=s(2638),c=s(813),l=(s(1744),s(6101)),u=s(7737),f=s(8481),d=(s(7975),s(3739),s(8983));s(7133);new l.A,new l.A;const v=new l.A,m=new l.A,w=new l.A,p=new l.A,g=new l.A,x=new r.A,M=new r.A;class S extends u.A{constructor(t){super(),this.main=t,this.playerController=this.main.playerController,this.updates=[],this.fixedUpdates=[],this.lateUpdates=[],this.isPaused=!1,this.meshes=[],this.audios=[],this.world=new f.A({scene:this}),this.createCameras(),this.uiComponents=[],this.focusedComponent=null,this.draggedComponent=null,this.xt=0,this.Mt=null,this.actorBackups=[],this.parentComponentPosition=new l.A}createCameras(){this.mainCamera=new d.A({near:o.l2,far:o.Eh,fov:o.Ue})}async load(){for(const t of this.children)await t.load()}getLoadTasks(){return[new a.A("Loading game objects...",this.load.bind(this))]}update(t,i){for(const s of this.updates)s(t,i);this.St(),this.playerController.select&&this.focusedComponent?.onClicked&&this.focusedComponent.onClicked()}fixedUpdate(t,i,s){this.world.step(i);for(const n of this.fixedUpdates)n(t,i,s);this.lastFade=this.fade,this.isFadingout?(this.fade+=i,1<=this.fade&&(this.isFadingout=!1)):this.isFadingin&&(this.fade-=i,this.fade<=0&&(this.isFadingin=!1)),this.fade=(0,e.qE)(this.fade,0,1)}lateUpdate(t,i,s){for(const t of this.world.movableBodies)t.previousPosition.lerp(t.position,s,t.interpolatedPosition),t.previousVelocity.lerp(t.velocity,s,t.interpolatedVelocity),t.previousQuaternion.slerp(t.quaternion,s,t.interpolatedQuaternion);for(const n of this.lateUpdates)n(t,i,s);if(!this.isPaused){for(const t of this.audios)t.update(this.mainCamera.position,this.mainCamera.velocity,i);{this.mainCamera.quaternion.vmult(n.OX,v).normalize(),this.mainCamera.quaternion.vmult(n.UP,m).normalize(),this.mainCamera.quaternion.vmult(n.IU,w).normalize();const t=c.p8.currentTime+i,s=c.p8.listener;s.positionX?(s.positionX.linearRampToValueAtTime(this.mainCamera.position.x,t),s.positionY.linearRampToValueAtTime(this.mainCamera.position.y,t),s.positionZ.linearRampToValueAtTime(this.mainCamera.position.z,t),s.forwardX.linearRampToValueAtTime(v.x,t),s.forwardY.linearRampToValueAtTime(v.y,t),s.forwardZ.linearRampToValueAtTime(v.z,t),s.upX.linearRampToValueAtTime(m.x,t),s.upY.linearRampToValueAtTime(m.y,t),s.upZ.linearRampToValueAtTime(m.z,t)):(s.setPosition(this.mainCamera.position.x,this.mainCamera.position.y,this.mainCamera.position.z),s.setOrientation(v.x,v.y,v.z,m.x,m.y,m.z))}}this.isClicked=!1}St(t){this.yt(),this.playerController.mouseMode?this._t():this.Pt()}yt(){for(const t of this.uiComponents)this.At(n.VT,t)}At(t,i){t.add(i.position,i.absolutePosition);for(const t of i.children)this.At(i.absolutePosition,t)}_t(){this.focusedComponent=null;for(const t of this.uiComponents)this.Dt(t)}Dt(t){if(t.visible&&t.enabled)if(t.focusable&&t.absolutePosition.x-.5*t.size.x<this.playerController.mousePosition.x&&t.absolutePosition.y-.5*t.size.y<this.playerController.mousePosition.y&&t.absolutePosition.x+.5*t.size.x>this.playerController.mousePosition.x&&t.absolutePosition.y+.5*t.size.y>this.playerController.mousePosition.y)this.focusedComponent=t;else for(const i of t.children)this.Dt(i)}Pt(){if(this.focusedComponent).5<this.playerController.selectDirection.length()&&this.qt();else for(const t of this.uiComponents)if(this.Tt(t),this.focusedComponent)break}Tt(t){if(!this.focusedComponent&&t.visible&&t.enabled)if(t.focusable)this.focusedComponent=t;else for(const i of t.children)this.Tt(i)}qt(){this.Mt=this.focusedComponent,x.min.set(this.Mt.absolutePosition.x-.5*this.Mt.size.x,this.Mt.absolutePosition.y-.5*this.Mt.size.y,-1),x.max.set(this.Mt.absolutePosition.x+.5*this.Mt.size.x,this.Mt.absolutePosition.y+.5*this.Mt.size.y,1),this.playerController.selectDirection.scale(100,g),this.Mt.absolutePosition.add(g,g),x.extend(g),this.xt=1/0;for(const t of this.uiComponents)this.Et(t)}Et(t){if(t.visible&&t.enabled){if(t.focusable&&this.Mt!==t&&(M.min.set(t.absolutePosition.x-.5*t.size.x,t.absolutePosition.y-.5*t.size.y,-1),M.max.set(t.absolutePosition.x+.5*t.size.x,t.absolutePosition.y+.5*t.size.y,1),x.overlaps(M))){t.absolutePosition.sub(this.Mt.absolutePosition,p);const i=p.length(),s=p.dot(this.playerController.selectDirection)/i;i<this.xt&&0<s&&(this.focusedComponent=t,this.xt=i)}for(const i of t.children)this.Et(i)}}Ct(t,i){if(t.add(i.position,i.absolutePosition),i.visible&&i.enabled){if(i.focusable&&this.Mt!==i){i.absolutePosition.sub(this.Mt.absolutePosition,p);const t=p.length(),s=p.dot(this.playerController.selectDirection)/t;.1<s&&t<this.xt&&(this.xt=t,this.focusedComponent=i)}for(const t of i.children)this.Ct(i.absolutePosition,t)}}bt(t,i){return t.boundingBoxNeedsUpdate&&t.calculateBoundingBox(),i.add(t.position),this.playerController.mousePosition.x<boundingBox.min.x&&this.playerController.mousePosition.y<boundingBox.min.y&&this.playerController.mousePosition.x>boundingBox.max.x&&this.playerController.mousePosition.y>boundingBox.max.y}add(t){t&&(super.add(t),t.isUIComponent&&this.Ut(t),t.mesh&&this.addMesh(t.mesh),this.addComponents(t))}Ut(t){(0,e.EY)(t,this.uiComponents)}addMesh(t){this.meshes.indexOf(t)<0&&this.meshes.push(t)}addComponents(t){t.onBeforeAdd&&t.onBeforeAdd(this),t.game=this,t.scene=this,this.Nt(t),this.Rt(t),this.It(t);for(const i of t.children)this.addComponents(i);t.onAdded&&t.onAdded()}Nt(t){for(const i of t.audios)this.zt(i)}zt(t){0<=this.audios.indexOf(t)||(this.audios.push(t),t.type===h.bz?t.outputNode.connect(this.main.musicGain):t.outputNode.connect(this.main.effectGain))}Rt(t){if(t.body&&this.world.addBody(t.body),t.bodies)for(const i of t.bodies)this.world.addBody(i);t.raycastVehicle&&this.world.addRaycastVehicle(t.raycastVehicle)}It(t,i){(i|=t.isStatic)||t.isStatic||(t.update&&(t.updateBound=t.update.bind(t),this.updates.push(t.updateBound)),t.fixedUpdate&&(t.fixedUpdateBound=t.fixedUpdate.bind(t),this.fixedUpdates.push(t.fixedUpdateBound)),t.lateUpdate&&(t.lateUpdateBound=t.lateUpdate.bind(t),this.lateUpdates.push(t.lateUpdateBound)))}remove(t){t&&(super.remove(t),t.isUIComponent&&this.Lt(t),t.mesh&&this.removeMesh(t.mesh),this.removeComponents(t))}Lt(t){(0,e.E6)(t,this.uiComponents)}removeMesh(t){const i=this.meshes.indexOf(t);0<=i&&this.meshes.splice(i,1)}removeComponents(t){this.Ft(t),this.Ot(t),this.Vt(t);for(const i of t.children)this.removeComponents(i);t.onRemoved&&t.onRemoved()}Ft(t){for(const i of t.audios)this.kt(i)}kt(t){const i=this.audios.indexOf(t);i<0||(t.outputNode.disconnect(),this.audios.splice(i,1))}Ot(t){if(t.body&&this.world.removeBody(t.body),t.bodies)for(const i of t.bodies)this.world.removeBody(i);t.raycastVehicle&&this.world.removeRaycastVehicle(t.raycastVehicle)}Vt(t){if(t.updateBound){const i=this.updates.indexOf(t.updateBound);0<=i&&this.updates.splice(i,1)}if(t.lateUpdateBound){const i=this.lateUpdates.indexOf(t.lateUpdateBound);0<=i&&this.lateUpdates.splice(i,1)}if(t.fixedUpdateBound){const i=this.fixedUpdates.indexOf(t.fixedUpdateBound);0<=i&&this.fixedUpdates.splice(i,1)}}pause(){}continue(){}getGravity(){return this.world.gravity}applyGraphicSettings(t){}dispose(){this.atmosphereProfile.dispose(this.main.renderer),this.cloudsProfile.dispose(this.main.renderer)}}},9262:(t,i,s)=>{s.d(i,{Ay:()=>o,bz:()=>h});var n=s(6389),e=s(813);const h=1;class o{constructor(t,i={}){this.buffer=t,this.type=i.type??0,this.loop=i.loop??!1,this.loopStart=i.loopStart??0,this.loopEnd=i.loopEnd??-1,this.source=null,this.isPlaying=!1,this.gain=(0,e.eF)(this.source),this.outputNode=this.gain,this.volume=i.volume??1,this.playbackRate=i.playbackRate??1,this.destination=null,this.hasToStart=!1,this.ended=!1}update(){this.hasToStart&&!this.isPlaying&&this.createAndStartSource(),this.gain.gain.setTargetAtTime(this.volume,e.p8.currentTime,n.HI),this.source&&this.source.playbackRate.setTargetAtTime(this.playbackRate,e.p8.currentTime,n.HI)}createAndStartSource(){this.source=(0,e.IZ)(this.buffer),this.loop&&(this.source.loop=this.loop,this.source.loopStart=this.loopStart,this.source.loopEnd=this.loopEnd),this.source.connect(this.gain),this.source.playbackRate.value=this.playbackRate,this.source.start(0,this.loopStart),this.source.onended=()=>{this.ended=!0},this.isPlaying=!0,this.hasToStart=!1}start(t=0,i=0){this.hasToStart=!0,this.ended=!1}restart(){this.source&&this.source.disconnect(),this.isPlaying=!1,this.hasToStart=!0}stop(){this.source&&(this.source.stop(),this.source=null),this.isPlaying=!1}setVolume(t){this.volume=t,this.gain&&(this.gain.gain.value=this.volume)}setPlaybackRate(t){this.playbackRate=t,this.source&&(this.source.playbackRate.value=this.playbackRate)}}},4857:(t,i,s)=>{s.d(i,{A:()=>h});var n=s(6101);const e=new n.A;class h{constructor(t,i){this.min=new n.A,t&&this.min.copy(t),this.max=new n.A,i&&this.max.copy(i),this.surfaceArea=0}init(){this.min.set(1/0,1/0,1/0),this.max.set(-1/0,-1/0,-1/0)}updateSurfaceArea(){return this.max.sub(this.min,e),this.surfaceArea=2*e.x*e.y+2*e.z*e.y+2*e.x*e.z,this.surfaceArea}contains(t){return this.min.x<=t.min.x&&this.min.y<=t.min.y&&this.min.z<=t.min.z&&t.max.x<=this.max.x&&t.max.y<=this.max.y&&t.max.z<=this.max.z}overlaps(t){return!(t.max.x<this.min.x||this.max.x<t.min.x)&&(!(t.max.y<this.min.y||this.max.y<t.min.y)&&!(t.max.z<this.min.z||this.max.z<t.min.z))}copy(t){return this.max.copy(t.max),this.min.copy(t.min),this.updateSurfaceArea(),this}merge(t){n.A.min(this.min,t.min,this.min),n.A.max(this.max,t.max,this.max)}extend(t){this.max.max(t,this.max),this.min.min(t,this.min)}setZero(){this.max.setZero(),this.min.setZero()}getCenter(t=new n.A){return this.min.add(this.max,t),t.scale(.5,t),t}static merge(t,i,s=new h){return n.A.min(t.min,i.min,s.min),n.A.max(t.max,i.max,s.max),s.updateSurfaceArea(),s}}},2638:(t,i,s)=>{s.d(i,{A:()=>n});class n{constructor(t,i,s=1){this.label=t,this.func=i,this.weight=s}}},813:(t,i,s)=>{s.d(i,{p8:()=>P,eF:()=>E,BM:()=>C,IZ:()=>T,F3:()=>q,i0:()=>D,kv:()=>b});var n=s(6389),e=s(7133),h=s(1649);s(1296);class o extends h.A{constructor(t={}){super(t),this.isDefaultTexture=!0,this.width=t.width??1,this.height=t.height??1,this.pixels=t.pixels??new Uint8Array([255,255,255,255])}}var r=s(2780),a=s(6585),c=s(649),l=s(1992),u=s(6101),f=s(832),d=s(611),v=s(4867);class m extends c.Ay{constructor(t={}){super(t),this.config=t,this.colorFactor=new f.A(1,1,1,1),Array.isArray(t.colorFactor)?this.colorFactor.copyFromArray(t.colorFactor):t.colorFactor&&this.colorFactor.copy(t.colorFactor),this.emissiveFactor=new f.A,Array.isArray(t.emissiveFactor)?this.emissiveFactor.copyFromArray(t.emissiveFactor):t.emissiveFactor&&this.emissiveFactor.copy(t.emissiveFactor),this.roughness=t.roughness??0,this.metalness=t.metalness??0,this.colorTexture=t.colorTexture,this.emissiveTexture=t.emissiveTexture,this.alphaTest=t.alphaTest??!1,this.transparent=!0,this.blending=c.vU,this.renderingPass=n.xF,this.depthWrite=!1,this.uniforms=this.getUniforms(t)}getVertSource(){return`#version 300 es\n\n            // #define METERS_TO_KMS 0.001s\n        \n            precision mediump float;\n            \n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec3 normal;\n            layout (location = 2) in vec2 uv;\n            \n            uniform mat4 modelMatrix;\n            uniform mat4 viewMatrix;\n            // uniform mat4 modelViewMatrix;\n            uniform mat4 projectionMatrix;\n\n            uniform vec3 cameraPosition;\n            uniform vec3 sunDirection;\n            \n            out vec2 vUv;\n            out vec3 vNormal;\n            out vec3 vWorldNormal;\n            out vec3 vWorldPosition;\n            out vec3 vViewDirection;\n            out vec3 vDirectIrradiance;\n\n            out vec3 vInScatter;\n            out vec3 vTransmittance;\n\n            float saturate(float a) {\n                return clamp(a, 0.0, 1.0);\n            }\n\n            ${v.mz}\n\n            ${v.SY}\n\n            void main() {\n                vUv = uv;\n\n                vec4 worldNormal = modelMatrix * vec4(normal, 0.0);\n                vWorldNormal = normalize(worldNormal.xyz);\n\n                vWorldPosition = (modelMatrix * vec4(position, 1.0)).xyz;\n                vec3 delta = vWorldPosition - cameraPosition;\n                float vertDistance = length(delta);\n                vViewDirection = normalize(delta);\n                vDirectIrradiance = getSunIrradiance(vWorldPosition.y / 1000.0);\n\n                getAirealScattering(vViewDirection.y, cameraPosition.y * METERS_TO_KMS, vertDistance * METERS_TO_KMS, vInScatter, vTransmittance);\n\n                gl_Position = projectionMatrix * viewMatrix * vec4(vWorldPosition, 1.0);\n            }\n        `}getFragSource(){return`#version 300 es\n            \n            precision mediump float;\n\n            #define saturate(x) clamp(x, 0.0, 1.0);\n\n            // const float PI = 3.14159265358979323846;\n\n            ${v.mz}\n\n            ${v.SY}\n\n            in vec2 vUv;\n            in vec3 vWorldNormal;\n            in vec3 vWorldPosition;\n            in vec3 vViewDirection;\n            in vec3 vDirectIrradiance;\n\n            in vec3 vInScatter;\n            in vec3 vTransmittance;\n\n            ${this.colorTexture?"#define USE_COLOR_MAP":""}\n            ${this.emissiveTexture?"#define USE_EMISSIVE_MAP":""}\n            ${this.alphaTest?"#define ALPHA_TEST":""}\n\n            uniform sampler2D tColor;\n            uniform vec4 colorFactor;\n\n            uniform sampler2D tEmissive;\n            uniform vec4 emissiveFactor;\n\n            uniform float roughness;\n            uniform float metalness;\n\n            uniform vec3 cameraPosition;\n\n            uniform vec3 sunDirection;\n\n            uniform sampler2D tBRDF;\n\n            out vec4 gDiffuse;\n\n            ${d.A}\n\n            void main() {\n                vec4 albedo = colorFactor;\n                #ifdef USE_COLOR_MAP\n                albedo *= texture(tColor, vUv);\n                #endif\n                \n                #ifdef ALPHA_TEST\n                // if (albedo.a < 0.5) discard;\n                #endif\n\n                vec3 N = normalize(vWorldNormal);\n                vec3 V = normalize(-vViewDirection);\n                vec3 L = normalize(atmosphereProfile.sunDirection);\n\n                vec3 indirectDiffuse = getSkyIrradiance(N.y, vWorldPosition.y * METERS_TO_KMS);\n                vec3 reflectionDirection = normalize(reflect(-V, N));\n                vec3 indirectSpecular = getSkyReflection(reflectionDirection.y, vWorldPosition.y * METERS_TO_KMS, roughness);\n                vec3 color = BRDF(albedo.rgb, metalness, roughness, N, V, L, vDirectIrradiance, indirectDiffuse, indirectSpecular);\n                \n                float density = -log(1.0 - clamp(albedo.a, 0.001, 0.999));\n                gDiffuse.rgb = (color + emissiveFactor.rgb * 100.0 + vInScatter) * vTransmittance * density;\n                gDiffuse.a = density;\n            }\n        `}getUniforms(t){return{modelMatrix:new l.A,viewMatrix:new l.A,modelViewMatrix:new l.A,projectionMatrix:new l.A,tColor:this.colorTexture,colorFactor:this.colorFactor,tEmissive:this.emissiveTexture,emissiveFactor:this.emissiveFactor,roughness:this.roughness,metalness:this.metalness,cameraPosition:new u.A,sunDirection:new u.A,atmosphereProfile:{}}}}var w=s(5284),p=s(1235);const g={POSITION:"position",NORMAL:"normal",TEXCOORD_0:"uv"},x={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5124:Int32Array,5125:Uint32Array,5126:Float32Array,5130:Float64Array},M={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},S="alphaMode";class y{constructor(){this.textDecoder=new TextDecoder,this.json=null,this.buffer=null}parse(t){const i=new DataView(t,0,12);if(1179937895!=i.getUint32(0,!0))throw new Error("Unsupported format.");if(i.getUint32(4,!0)<2)throw new Error("Unsupported glTF version.");const s=i.getUint32(8,!0)-12;if(this.Gt(t,s),1<this.json.scenes.length)throw new Error("Multiple scenes are not supported.");const n=this.json.scenes[0];if(1<n.nodes.length)throw new Error("Multiple root nodes are not supported.");const e=n.nodes[0],h=this.json.nodes[e];return this.Bt(h)}Gt(t,i){const s=new DataView(t,12);let n=0;for(;n<i;){const i=s.getUint32(n,!0);n+=4;const e=s.getUint32(n,!0);if(n+=4,1313821514==e){const s=new Uint8Array(t,12+n,i);this.json=JSON.parse(this.textDecoder.decode(s))}else if(5130562==e){const s=12+n;this.buffer=t.slice(s,s+i)}n+=i}}async Bt(t){let i;if(null!=t.mesh){const s=this.json.meshes[t.mesh];if(1==s.primitives.length)i=await this.Ht(s.primitives[0]);else{i=new a.A;for(const t of s.primitives){const s=await this.Ht(t);i.add(s)}}}if(t.name&&(i.name=t.name),t.translation&&i.position.copyFromArray(t.translation),t.rotation&&i.quaternion.copyFromArray(t.rotation),t.scale&&i.scale.copyFromArray(t.scale),t.children)for(const s of t.children){const t=await this.Bt(this.json.nodes[s]);i.add(t)}return i}async Ht(t){const i=this.nt(t),s=await this.jt(t.material);return new e.A(i,s)}nt(t){const i=new r.A,s=t.attributes;for(const t in s){const n=this.Wt(s[t]);i.setAttribute(g[t],n)}const n=t.indices;if(null!=n){const t=this.Wt(n);i.setIndices(t)}return i}Wt(t){const i=this.json.accessors[t],s=i.count,n=M[i.type],e=i.componentType,h=this.json.bufferViews[i.bufferView].byteOffset+i.byteOffset,o=new(0,x[e])(this.buffer,h,n*s);return new p.A(o,n,e)}async jt(t){if(null==t)return new w.A;const i=this.json.materials[t];if(!i)throw new Error("Target material is not defined.");const s=i.pbrMetallicRoughness;if(!s)throw new Error("pbrMetallicRoughness is not defined.");const n=null!=s.baseColorTexture?await this.$t(s.baseColorTexture.index):null;n&&(n.anisotropy=8);const e={colorFactor:s.baseColorFactor,emissiveFactor:i.emissiveFactor,metalness:s.metallicFactor,roughness:s.roughnessFactor,colorTexture:n,emissiveTexture:new o,alphaTest:"MASK"===i[S]};return"BLEND"==i[S]?new m(e):new w.A(e)}async $t(t){const i=this.json.textures[t],s=this.json.samplers[i.sampler],e=this.json.images[i.source],o=this.json.bufferViews[e.bufferView],r=this.buffer.slice(o.byteOffset,o.byteOffset+o.byteLength),a=await this.Xt(r,e.mimeType);return new h.A({wrapS:s.wrapS,wrapT:s.wrapT,image:a,generateMipmap:!0,anisotropy:n.De})}async Xt(t,i){const s=new Blob([t],{type:i});return await createImageBitmap(s,{premultiplyAlpha:"none"})}}const _=WebGL2RenderingContext,P=new AudioContext;async function A(t){return await fetch(t).then(t=>{if(!t.ok)throw new Error(`${t.status} ${t.statusText}`);return t.arrayBuffer()})}async function D(t){const i=await A(t);return(new y).parse(i)}async function q(t){const i=await A(t);return await P.decodeAudioData(i)}function T(t){const i=P.createBufferSource(t);return i.buffer=t,i}function E(t){return P.createGain()}function C(){return P.createPanner()}async function b(t,i={}){const s=await function(t){return new Promise(i=>{const s=new Image;s.src=t,s.onload=()=>{i(s)}})}(t);return new h.A({format:i.format??_.RGBA,internalFormat:i.internalFormat??_.RGBA,image:s,anisotropy:n.De,...i})}},6839:(t,i,s)=>{function n(t,i,s=2){const n=i&&i.length,h=n?i[0]*s:t.length;let r=e(t,0,h,s,!0);const a=[];if(!r||r.next===r.prev)return a;let c,l,d;if(n&&(r=function(t,i,s,n){const h=[];for(let s=0,o=i.length;s<o;s++){const r=e(t,i[s]*n,s<o-1?i[s+1]*n:t.length,n,!1);r===r.next&&(r.steiner=!0),h.push(m(r))}h.sort(u);for(let t=0;t<h.length;t++)s=f(h[t],s);return s}(t,i,r,s)),t.length>80*s){c=1/0,l=1/0;let i=-1/0,n=-1/0;for(let e=s;e<h;e+=s){const s=t[e],h=t[e+1];s<c&&(c=s),h<l&&(l=h),s>i&&(i=s),h>n&&(n=h)}d=Math.max(i-c,n-l),d=0!==d?32767/d:0}return o(r,a,s,c,l,d,0),a}function e(t,i,s,n,e){let h;if(e===E(t,i,s,n)>0)for(let e=i;e<s;e+=n)h=D(e/n|0,t[e],t[e+1],h);else for(let e=s-n;e>=i;e-=n)h=D(e/n|0,t[e],t[e+1],h);return h&&M(h,h.next)&&(q(h),h=h.next),h}function h(t,i){if(!t)return t;i||(i=t);let s,n=t;do{if(s=!1,n.steiner||!M(n,n.next)&&0!==x(n.prev,n,n.next))n=n.next;else{if(q(n),n=i=n.prev,n===n.next)break;s=!0}}while(s||n!==i);return i}function o(t,i,s,n,e,u,f){if(!t)return;!f&&u&&function(t,i,s,n){let e=t;do{0===e.z&&(e.z=v(e.x,e.y,i,s,n)),e.prevZ=e.prev,e.nextZ=e.next,e=e.next}while(e!==t);e.prevZ.nextZ=null,e.prevZ=null,function(t){let i,s=1;do{let n,e=t;t=null;let h=null;for(i=0;e;){i++;let o=e,r=0;for(let t=0;t<s&&(r++,o=o.nextZ,o);t++);let a=s;for(;r>0||a>0&&o;)0!==r&&(0===a||!o||e.z<=o.z)?(n=e,e=e.nextZ,r--):(n=o,o=o.nextZ,a--),h?h.nextZ=n:t=n,n.prevZ=h,h=n;e=o}h.nextZ=null,s*=2}while(i>1)}(e)}(t,n,e,u);let d=t;for(;t.prev!==t.next;){const v=t.prev,m=t.next;if(u?a(t,n,e,u):r(t))i.push(v.i,t.i,m.i),q(t),t=m.next,d=m.next;else if((t=m)===d){f?1===f?o(t=c(h(t),i),i,s,n,e,u,2):2===f&&l(t,i,s,n,e,u):o(h(t),i,s,n,e,u,1);break}}}function r(t){const i=t.prev,s=t,n=t.next;if(x(i,s,n)>=0)return!1;const e=i.x,h=s.x,o=n.x,r=i.y,a=s.y,c=n.y,l=Math.min(e,h,o),u=Math.min(r,a,c),f=Math.max(e,h,o),d=Math.max(r,a,c);let v=n.next;for(;v!==i;){if(v.x>=l&&v.x<=f&&v.y>=u&&v.y<=d&&p(e,r,h,a,o,c,v.x,v.y)&&x(v.prev,v,v.next)>=0)return!1;v=v.next}return!0}function a(t,i,s,n){const e=t.prev,h=t,o=t.next;if(x(e,h,o)>=0)return!1;const r=e.x,a=h.x,c=o.x,l=e.y,u=h.y,f=o.y,d=Math.min(r,a,c),m=Math.min(l,u,f),w=Math.max(r,a,c),g=Math.max(l,u,f),M=v(d,m,i,s,n),S=v(w,g,i,s,n);let y=t.prevZ,_=t.nextZ;for(;y&&y.z>=M&&_&&_.z<=S;){if(y.x>=d&&y.x<=w&&y.y>=m&&y.y<=g&&y!==e&&y!==o&&p(r,l,a,u,c,f,y.x,y.y)&&x(y.prev,y,y.next)>=0)return!1;if(y=y.prevZ,_.x>=d&&_.x<=w&&_.y>=m&&_.y<=g&&_!==e&&_!==o&&p(r,l,a,u,c,f,_.x,_.y)&&x(_.prev,_,_.next)>=0)return!1;_=_.nextZ}for(;y&&y.z>=M;){if(y.x>=d&&y.x<=w&&y.y>=m&&y.y<=g&&y!==e&&y!==o&&p(r,l,a,u,c,f,y.x,y.y)&&x(y.prev,y,y.next)>=0)return!1;y=y.prevZ}for(;_&&_.z<=S;){if(_.x>=d&&_.x<=w&&_.y>=m&&_.y<=g&&_!==e&&_!==o&&p(r,l,a,u,c,f,_.x,_.y)&&x(_.prev,_,_.next)>=0)return!1;_=_.nextZ}return!0}function c(t,i){let s=t;do{const n=s.prev,e=s.next.next;!M(n,e)&&S(n,s,s.next,e)&&P(n,e)&&P(e,n)&&(i.push(n.i,s.i,e.i),q(s),q(s.next),s=t=e),s=s.next}while(s!==t);return h(s)}function l(t,i,s,n,e,r){let a=t;do{let t=a.next.next;for(;t!==a.prev;){if(a.i!==t.i&&g(a,t)){let c=A(a,t);return a=h(a,a.next),c=h(c,c.next),o(a,i,s,n,e,r,0),void o(c,i,s,n,e,r,0)}t=t.next}a=a.next}while(a!==t)}function u(t,i){let s=t.x-i.x;if(0===s&&(s=t.y-i.y,0===s)){s=(t.next.y-t.y)/(t.next.x-t.x)-(i.next.y-i.y)/(i.next.x-i.x)}return s}function f(t,i){const s=function(t,i){let s=i;const n=t.x,e=t.y;let h,o=-1/0;if(M(t,s))return s;do{if(M(t,s.next))return s.next;if(e<=s.y&&e>=s.next.y&&s.next.y!==s.y){const t=s.x+(e-s.y)*(s.next.x-s.x)/(s.next.y-s.y);if(t<=n&&t>o&&(o=t,h=s.x<s.next.x?s:s.next,t===n))return h}s=s.next}while(s!==i);if(!h)return null;const r=h,a=h.x,c=h.y;let l=1/0;s=h;do{if(n>=s.x&&s.x>=a&&n!==s.x&&w(e<c?n:o,e,a,c,e<c?o:n,e,s.x,s.y)){const i=Math.abs(e-s.y)/(n-s.x);P(s,t)&&(i<l||i===l&&(s.x>h.x||s.x===h.x&&d(h,s)))&&(h=s,l=i)}s=s.next}while(s!==r);return h}(t,i);if(!s)return i;const n=A(s,t);return h(n,n.next),h(s,s.next)}function d(t,i){return x(t.prev,t,i.prev)<0&&x(i.next,t,t.next)<0}function v(t,i,s,n,e){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-s)*e|0)|t<<8))|t<<4))|t<<2))|t<<1))|(i=1431655765&((i=858993459&((i=252645135&((i=16711935&((i=(i-n)*e|0)|i<<8))|i<<4))|i<<2))|i<<1))<<1}function m(t){let i=t,s=t;do{(i.x<s.x||i.x===s.x&&i.y<s.y)&&(s=i),i=i.next}while(i!==t);return s}function w(t,i,s,n,e,h,o,r){return(e-o)*(i-r)>=(t-o)*(h-r)&&(t-o)*(n-r)>=(s-o)*(i-r)&&(s-o)*(h-r)>=(e-o)*(n-r)}function p(t,i,s,n,e,h,o,r){return!(t===o&&i===r)&&w(t,i,s,n,e,h,o,r)}function g(t,i){return t.next.i!==i.i&&t.prev.i!==i.i&&!function(t,i){let s=t;do{if(s.i!==t.i&&s.next.i!==t.i&&s.i!==i.i&&s.next.i!==i.i&&S(s,s.next,t,i))return!0;s=s.next}while(s!==t);return!1}(t,i)&&(P(t,i)&&P(i,t)&&function(t,i){let s=t,n=!1;const e=(t.x+i.x)/2,h=(t.y+i.y)/2;do{s.y>h!=s.next.y>h&&s.next.y!==s.y&&e<(s.next.x-s.x)*(h-s.y)/(s.next.y-s.y)+s.x&&(n=!n),s=s.next}while(s!==t);return n}(t,i)&&(x(t.prev,t,i.prev)||x(t,i.prev,i))||M(t,i)&&x(t.prev,t,t.next)>0&&x(i.prev,i,i.next)>0)}function x(t,i,s){return(i.y-t.y)*(s.x-i.x)-(i.x-t.x)*(s.y-i.y)}function M(t,i){return t.x===i.x&&t.y===i.y}function S(t,i,s,n){const e=_(x(t,i,s)),h=_(x(t,i,n)),o=_(x(s,n,t)),r=_(x(s,n,i));return e!==h&&o!==r||(!(0!==e||!y(t,s,i))||(!(0!==h||!y(t,n,i))||(!(0!==o||!y(s,t,n))||!(0!==r||!y(s,i,n)))))}function y(t,i,s){return i.x<=Math.max(t.x,s.x)&&i.x>=Math.min(t.x,s.x)&&i.y<=Math.max(t.y,s.y)&&i.y>=Math.min(t.y,s.y)}function _(t){return t>0?1:t<0?-1:0}function P(t,i){return x(t.prev,t,t.next)<0?x(t,i,t.next)>=0&&x(t,t.prev,i)>=0:x(t,i,t.prev)<0||x(t,t.next,i)<0}function A(t,i){const s=T(t.i,t.x,t.y),n=T(i.i,i.x,i.y),e=t.next,h=i.prev;return t.next=i,i.prev=t,s.next=e,e.prev=s,n.next=s,s.prev=n,h.next=n,n.prev=h,n}function D(t,i,s,n){const e=T(t,i,s);return n?(e.next=n.next,e.prev=n,n.next.prev=e,n.next=e):(e.prev=e,e.next=e),e}function q(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function T(t,i,s){return{i:t,x:i,y:s,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function E(t,i,s,n){let e=0;for(let h=i,o=s-n;h<s;h+=n)e+=(t[o]-t[h])*(t[h+1]+t[o+1]),o=h;return e}s.d(i,{Ay:()=>n})},1992:(t,i,s)=>{s.d(i,{A:()=>h});var n=s(6101);const e=Math.sqrt(16);class h{constructor(t){h.prototype.isMat4=!0,this.elements=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t&&this.setFromArray(t)}setFromArray(t){for(let i=0;i<16;i++)this.elements[i]=t[i];return this}copy(t){for(let i=0;i<16;i++)this.elements[i]=t.elements[i];return this}setZero(){for(let t=0;t<16;t++)this.elements[t]=0;return this}compose(t,i,s){const n=this.elements,e=i.x,h=i.y,o=i.z,r=i.w,a=e+e,c=h+h,l=o+o,u=e*a,f=e*c,d=e*l,v=h*c,m=h*l,w=o*l,p=r*a,g=r*c,x=r*l,M=s.x,S=s.y,y=s.z;n[0]=(1-(v+w))*M,n[1]=(f+x)*M,n[2]=(d-g)*M,n[3]=0,n[4]=(f-x)*S,n[5]=(1-(u+w))*S,n[6]=(m+p)*S,n[7]=0,n[8]=(d+g)*y,n[9]=(m-p)*y,n[10]=(1-(u+v))*y,n[11]=0,n[12]=t.x,n[13]=t.y,n[14]=t.z,n[15]=1}invert(t=new h){const i=this.elements,s=i[0],n=i[1],e=i[2],o=i[3],r=i[4],a=i[5],c=i[6],l=i[7],u=i[8],f=i[9],d=i[10],v=i[11],m=i[12],w=i[13],p=i[14],g=i[15],x=d*g-v*p,M=f*g-v*w,S=f*p-d*w,y=u*g-v*m,_=u*p-d*m,P=u*w-f*m,A=c*g-l*p,D=a*g-l*w,q=a*p-c*w,T=c*v-l*d,E=a*v-l*f,C=a*d-c*f,b=r*g-l*m,U=r*p-c*m,N=r*v-l*u,R=r*d-c*u,I=r*w-a*m,z=r*f-a*u,L=+s*(a*x-c*M+l*S)-n*(r*x-c*y+l*_)+e*(r*M-a*y+l*P)-o*(r*S-a*_+c*P);if(!L)return t.setZero();const F=1/L;return t.setFromArray([+(a*x-c*M+l*S)*F,-(n*x-e*M+o*S)*F,+(n*A-e*D+o*q)*F,-(n*T-e*E+o*C)*F,-(r*x-c*y+l*_)*F,+(s*x-e*y+o*_)*F,-(s*A-e*b+o*U)*F,+(s*T-e*N+o*R)*F,+(r*M-a*y+l*P)*F,-(s*M-n*y+o*P)*F,+(s*D-n*b+o*I)*F,-(s*E-n*N+o*z)*F,-(r*S-a*_+c*P)*F,+(s*S-n*_+e*P)*F,-(s*q-n*U+e*I)*F,+(s*C-n*R+e*z)*F])}mult(t,i=new h){const s=this.elements,n=t.elements,o=i.elements;for(let t=0;t<e;t++){const i=t*e,h=n[i+0],r=n[i+1],a=n[i+2],c=n[i+3];for(let i=0;i<e;i++)o[e*t+i]=+s[0*e+i]*h+s[1*e+i]*r+s[2*e+i]*a+s[3*e+i]*c}return i}perspective(t,i,s,n){const e=this.elements,h=t*Math.tan(.5*s),o=i-t,r=2*t/(2*(h*n)),a=2*t/(2*h),c=-(i+t)/o,l=-i*t*2/o;return e[0]=r,e[4]=0,e[8]=0,e[12]=0,e[1]=0,e[5]=a,e[9]=0,e[13]=0,e[2]=0,e[6]=0,e[10]=c,e[14]=l,e[3]=0,e[7]=0,e[11]=-1,e[15]=0,this}orthographic(t,i,s,n){const e=n-s,h=this.elements;return h[0]=2/t,h[4]=0,h[8]=0,h[12]=0,h[1]=0,h[5]=2/i,h[9]=0,h[13]=0,h[2]=0,h[6]=0,h[10]=-2/e,h[14]=-(n+s)/e,h[3]=0,h[7]=0,h[11]=0,h[15]=1,this}equals(t){if(!t||!t.elements)return!1;for(let i=0;i<16;i++)if(this.elements[i]!=t.elements[i])return!1;return!0}lookAtFromPosition(t,i,s=new n.A(0,1,0)){const e=t.sub(i).normalize(),h=s.cross(e).normalize(),o=e.cross(h).normalize();return this.setFromArray([h.x,h.y,h.z,0,o.x,o.y,o.z,0,e.x,e.y,e.z,0,t.x,t.y,t.z,1]),this}makeRotation(t,i){let s=t.x,n=t.y,e=t.z;if(t.isZero())return console.warn("Mat4.makeRotation: axis length is zero"),this.identity();t.normalize();const h=Math.cos(i),o=Math.sin(i),r=1-h,a=this.elements;return a[0]=s*s*r+h,a[1]=n*s*r+e*o,a[2]=e*s*r-n*o,a[3]=0,a[4]=s*n*r-e*o,a[5]=n*n*r+h,a[6]=e*n*r+s*o,a[7]=0,a[8]=s*e*r+n*o,a[9]=n*e*r-s*o,a[10]=e*e*r+h,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,this}}},9246:(t,i,s)=>{s.d(i,{A:()=>e});var n=s(6101);class e{constructor(t=0,i=0,s=0,n=1){this.x=t,this.y=i,this.z=s,this.w=n}set(t,i,s,n){return this.x=t,this.y=i,this.z=s,this.w=n,this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}copyFromArray(t){return this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3],this}clone(){return(new e).copy(this)}conjugate(t=new e){return t.set(-this.x,-this.y,-this.z,this.w)}setFromAxisAngle(t,i){const s=.5*i,n=Math.sin(s);return this.set(t.x*n,t.y*n,t.z*n,Math.cos(s))}normalize(){const t=this.getLength();return t?this.set(this.x/t,this.y/t,this.z/t,this.w/t):this.setZero()}setZero(){return this.set(0,0,0,0)}getLength(){return Math.sqrt(this.x**2+this.y**2+this.z**2+this.w**2)}mult(t,i=new e){const s=this.x,n=this.y,h=this.z,o=this.w,r=t.x,a=t.y,c=t.z,l=t.w;return i.set(o*r+s*l+n*c-h*a,o*a+n*l+h*r-s*c,o*c+h*l+s*a-n*r,o*l-s*r-n*a-h*c)}vmult(t,i=new n.A){const s=t.x,e=t.y,h=t.z,o=this.x,r=this.y,a=this.z,c=this.w,l=2*(r*h-a*e),u=2*(a*s-o*h),f=2*(o*e-r*s);return i.set(s+c*l+r*f-a*u,e+c*u+a*l-o*f,h+c*f+o*u-r*l)}slerp(t,i,s=new e){const n=1-i,h=this.x,o=this.y,r=this.z,a=this.w,c=this.dot(t),l=Math.sign(c),u=t.x*l,f=t.y*l,d=t.z*l,v=t.w*l,m=c*l;let w,p;if(m<.999999){const t=Math.acos(m),s=Math.sin(t);w=Math.sin(n*t)/s,p=Math.sin(i*t)/s}else w=n,p=i;return s.set(w*h+p*u,w*o+p*f,w*r+p*d,w*a+p*v),s.normalize()}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}setFromEuler(t,i,s,n="XYZ"){const e=Math.cos(t/2),h=Math.cos(i/2),o=Math.cos(s/2),r=Math.sin(t/2),a=Math.sin(i/2),c=Math.sin(s/2);switch(n){case"XYZ":this.x=r*h*o+e*a*c,this.y=e*a*o-r*h*c,this.z=e*h*c+r*a*o,this.w=e*h*o-r*a*c;break;case"YXZ":this.x=r*h*o+e*a*c,this.y=e*a*o-r*h*c,this.z=e*h*c-r*a*o,this.w=e*h*o+r*a*c;break;case"ZXY":this.x=r*h*o-e*a*c,this.y=e*a*o+r*h*c,this.z=e*h*c+r*a*o,this.w=e*h*o-r*a*c;break;case"ZYX":this.x=r*h*o-e*a*c,this.y=e*a*o+r*h*c,this.z=e*h*c-r*a*o,this.w=e*h*o+r*a*c;break;case"YZX":this.x=r*h*o+e*a*c,this.y=e*a*o+r*h*c,this.z=e*h*c-r*a*o,this.w=e*h*o-r*a*c;break;case"XZY":this.x=r*h*o-e*a*c,this.y=e*a*o-r*h*c,this.z=e*h*c+r*a*o,this.w=e*h*o+r*a*c;break;default:throw new Error(`Unknown order: ${n}`)}return this}fromBasis(t,i,s){const n=t.x,e=i.x,h=s.x,o=t.y,r=i.y,a=s.y,c=t.z,l=i.z,u=s.z,f=n+r+u;if(f>0){const t=.5/Math.sqrt(f+1);this.w=.25/t,this.x=(l-a)*t,this.y=(h-c)*t,this.z=(o-e)*t}else if(n>r&&n>u){const t=2*Math.sqrt(1+n-r-u);this.w=(l-a)/t,this.x=.25*t,this.y=(e+o)/t,this.z=(h+c)/t}else if(r>u){const t=2*Math.sqrt(1+r-n-u);this.w=(h-c)/t,this.x=(e+o)/t,this.y=.25*t,this.z=(a+l)/t}else{const t=2*Math.sqrt(1+u-n-r);this.w=(o-e)/t,this.x=(h+c)/t,this.y=(a+l)/t,this.z=.25*t}return this}integrate(t,i,s=new e){const n=t.x,h=t.y,o=t.z,r=this.x,a=this.y,c=this.z,l=this.w,u=.5*i;return s.x+=u*(n*l+h*c-o*a),s.y+=u*(h*l+o*r-n*c),s.z+=u*(o*l+n*a-h*r),s.w+=u*(-n*r-h*a-o*c),s}toEuler(t="XYZ",i=new n.A){const s=this.x,e=this.y,h=this.z,o=this.w,r=s*s,a=e*e,c=h*h,l=s*e,u=s*h,f=e*h,d=o*s,v=o*e,m=o*h;let w,p,g;switch(t){case"XYZ":p=Math.asin(Math.min(Math.max(2*(d+f),-1),1)),Math.abs(p)<Math.PI/2-1e-6?(w=Math.atan2(2*(m-l),1-2*(a+c)),g=Math.atan2(2*(v-u),1-2*(r+c))):(w=Math.atan2(2*(m+l),1-2*(a+c)),g=0);break;case"YXZ":w=Math.asin(Math.min(Math.max(2*(v-u),-1),1)),Math.abs(w)<Math.PI/2-1e-6?(p=Math.atan2(2*(d+f),1-2*(a+c)),g=Math.atan2(2*(v+u),1-2*(r+a))):(p=Math.atan2(2*(d-f),1-2*(a+c)),g=0);break;case"ZXY":w=Math.asin(Math.min(Math.max(2*(v+u),-1),1)),Math.abs(w)<Math.PI/2-1e-6?(p=Math.atan2(2*(f-d),1-2*(r+c)),g=Math.atan2(2*(l-m),1-2*(a+c))):(p=Math.atan2(2*(f+d),1-2*(r+c)),g=0);break;case"ZYX":p=Math.asin(Math.min(Math.max(2*(d-f),-1),1)),Math.abs(p)<Math.PI/2-1e-6?(w=Math.atan2(2*(v+u),1-2*(r+c)),g=Math.atan2(2*(m+l),1-2*(a+c))):(w=Math.atan2(2*(v-u),1-2*(r+c)),g=0);break;case"YZX":g=Math.asin(Math.min(Math.max(2*(m+l),-1),1)),Math.abs(g)<Math.PI/2-1e-6?(w=Math.atan2(2*(v-u),1-2*(c+r)),p=Math.atan2(2*(f-d),1-2*(a+r))):(w=Math.atan2(2*(v+u),1-2*(c+r)),p=0);break;case"XZY":g=Math.asin(Math.min(Math.max(2*(m-l),-1),1)),Math.abs(g)<Math.PI/2-1e-6?(w=Math.atan2(2*(v+u),1-2*(a+c)),p=Math.atan2(2*(f+d),1-2*(r+c))):(w=Math.atan2(2*(v-u),1-2*(a+c)),p=0);break;default:throw new Error("Unknown Euler order: "+t)}return i.set(w,p,g)}makeBasis(t,i,s){const n=t.x,e=t.y,h=t.z,o=i.x,r=i.y,a=i.z,c=o,l=s.x,u=n,f=r,d=s.y,v=e,m=a,w=s.z,p=h,g=c+d+p;let x,M,S,y;if(g>0){const t=.5/Math.sqrt(g+1);y=.25/t,x=(w-v)*t,M=(u-m)*t,S=(f-l)*t}else if(c>d&&c>p){const t=2*Math.sqrt(1+c-d-p);y=(w-v)/t,x=.25*t,M=(l+f)/t,S=(u+m)/t}else if(d>p){const t=2*Math.sqrt(1+d-c-p);y=(u-m)/t,x=(l+f)/t,M=.25*t,S=(v+w)/t}else{const t=2*Math.sqrt(1+p-c-d);y=(f-l)/t,x=(u+m)/t,M=(v+w)/t,S=.25*t}return this.set(x,M,S,y)}}},7830:(t,i,s)=>{s.d(i,{A:()=>n});class n{constructor(t,i){n.prototype.isVec2=!0,this.x=t??0,this.y=i??0}set(t,i){return this.x=t,this.y=i,this}add(t,i=new n){return i.x=this.x+t.x,i.y=this.y+t.y,i}sub(t,i=new n){return i.x=this.x-t.x,i.y=this.y-t.y,i}mult(t,i=new n){return i.x=this.x*t.x,i.y=this.y*t.y,i}divide(t,i=new n){return i.x=this.x/t.x,i.y=this.y/t.y,i}scale(t,i=new n){return i.x=this.x*t,i.y=this.y*t,i}dot(t){return this.x*t.x+this.y*t.y}cross(t,i=new n){return i.x=this.y*t.z-this.z*t.y,i.x=this.z*t.x-this.x*t.z,i.x=this.x*t.y-this.y*t.x,i}length(){return Math.sqrt(this.x**2+this.y**2)}isZero(){return 0===this.x&&0===this.y}clone(){return new n(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}copyFromArray(t){return this.x=t[0],this.y=t[1],this}normalize(){const t=this.length()??1;return this.x/=t,this.y/=t,this}negate(t=new n){return t.x=-this.x,t.y=-this.y,t}lerp(t,i,s=new n){return s.set(this.x+(t.x-this.x)*i,this.y+(t.y-this.y)*i)}equals(t){return!!t&&(this.x==t.x&&this.y==t.y)}invert(t=new n){return t.x=1/this.x,t.y=1/this.y,t}}},6101:(t,i,s)=>{s.d(i,{A:()=>n});s(1992);class n{constructor(t,i,s){n.prototype.isVec3=!0,this.x=t??0,this.y=i??0,this.z=s??0}set(t,i,s){return this.x=t,this.y=i,this.z=s,this}add(t,i=new n){return i.x=this.x+t.x,i.y=this.y+t.y,i.z=this.z+t.z,i}addScalar(t,i=new n){return i.x=this.x+t,i.y=this.y+t,i.z=this.z+t,i}sub(t,i=new n){return i.x=this.x-t.x,i.y=this.y-t.y,i.z=this.z-t.z,i}subScalar(t,i=new n){return i.x=this.x-t,i.y=this.y-t,i.z=this.z-t,i}vsub(t,i=new n){return this.sub(t,i)}mult(t,i=new n){return i.x=this.x*t.x,i.y=this.y*t.y,i.z=this.z*t.z,i}divide(t,i=new n){return i.x=this.x/t.x,i.y=this.y/t.y,i.z=this.z/t.z,i}scale(t,i=new n){return i.x=this.x*t,i.y=this.y*t,i.z=this.z*t,i}mod(t,i=new n){return i.x=this.x%t,i.y=this.y%t,i.z=this.z%t,i}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t,i=new n){const s=this.x,e=this.y,h=this.z,o=t.x,r=t.y,a=t.z;return i.x=e*a-h*r,i.y=h*o-s*a,i.z=s*r-e*o,i}length(){return Math.sqrt(this.lengthSquared())}lengthSquared(){return this.x**2+this.y**2+this.z**2}isZero(){return 0===this.x&&0===this.y&&0===this.z}clone(){return new n(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}copyFromArray(t){return this.x=t[0],this.y=t[1],this.z=t[2],this}normalize(){const t=this.length(),i=0==t?1:t;return this.x/=i,this.y/=i,this.z/=i,this}negate(t=new n){return t.x=-this.x,t.y=-this.y,t.z=-this.z,t}lerp(t,i,s=new n){return s.set(this.x+(t.x-this.x)*i,this.y+(t.y-this.y)*i,this.z+(t.z-this.z)*i)}equals(t){return!!t&&(this.x==t.x&&this.y==t.y&&this.z==this.vector.z)}distanceTo(t){const i=this.getDistanceSquared(t);return Math.sqrt(i)}getDistanceSquared(t){return(t.x-this.x)**2+(t.y-this.y)**2+(t.z-this.z)**2}abs(t=new n){return t.x=Math.abs(this.x),t.y=Math.abs(this.y),t.z=Math.abs(this.z),t}sign(t=new n){return t.x=Math.sign(this.x),t.y=Math.sign(this.y),t.z=Math.sign(this.z),t}min(t,i=new n){return i.x=Math.min(t.x,this.x),i.y=Math.min(t.y,this.y),i.z=Math.min(t.z,this.z),i}max(t,i=new n){return i.x=Math.max(t.x,this.x),i.y=Math.max(t.y,this.y),i.z=Math.max(t.z,this.z),i}setZero(){this.x=0,this.y=0,this.z=0}invert(t=new n){return t.x=1/this.x,t.y=1/this.y,t.z=1/this.z,t}applyMat4(t,i=new n){const s=this.x,e=this.y,h=this.z,o=t.elements,r=1/(o[3]*s+o[7]*e+o[11]*h+o[15]);return i.x=(o[0]*s+o[4]*e+o[8]*h+o[12])*r,i.y=(o[1]*s+o[5]*e+o[9]*h+o[13])*r,i.z=(o[2]*s+o[6]*e+o[10]*h+o[14])*r,i}unit(t=new n){return t.copy(this),t.normalize()}static min(t,i,s=new n){return s.x=Math.min(t.x,i.x),s.y=Math.min(t.y,i.y),s.z=Math.min(t.z,i.z),s}static max(t,i,s=new n){return s.x=Math.max(t.x,i.x),s.y=Math.max(t.y,i.y),s.z=Math.max(t.z,i.z),s}static Zt=new n;static Yt=new n;static tripleProduct(t,i,s,e=new n){const h=t.dot(s),o=i.dot(s);return i.scale(h,this.Yt),t.scale(o,this.Zt),this.Yt.sub(this.Zt,e)}static projectOnPlane(t,i,s=new n){const e=t.dot(i);return i.scale(e,s),t.sub(s,s),s}static ZERO=new n}n.serialize=function(t){const i=[];for(const s of t)i.push(s.x),i.push(s.y),i.push(s.z);return i}},832:(t,i,s)=>{s.d(i,{A:()=>n});class n{constructor(t,i,s,e){n.prototype.isVec4=!0,this.x=t??0,this.y=i??0,this.z=s??0,this.w=e??0}set(t,i,s,n){return this.x=t,this.y=i,this.z=s,this.w=n,this}add(t,i=new n){return i.x=this.x+t.x,i.y=this.y+t.y,i.z=this.z+t.z,i.w=this.w+t.w,i}sub(t,i=new n){return i.x=this.x-t.x,i.y=this.y-t.y,i.z=this.z-t.z,i.w=this.w-t.w,i}mult(t,i=new n){return i.x=this.x*t.x,i.y=this.y*t.y,i.z=this.z*t.z,i.w=this.w*t.w,i}divide(t,i=new n){return i.x=this.x/t.x,i.y=this.y/t.y,i.z=this.z/t.z,i.w=this.w/t.w,i}scale(t,i=new n){return i.x=this.x*t,i.y=this.y*t,i.z=this.z*t,i.w=this.w*t,i}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}equals(t){return!!t&&(this.x==t.x&&this.y==t.y&&this.z==t.z)}lerp(t,i,s=new n){return s.set(this.x+(t.x-this.x)*i,this.y+(t.y-this.y)*i,this.z+(t.z-this.z)*i,this.w+(t.w-this.w)*i)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}copyFromArray(t){return this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3],this}clone(){return new n(this.x,this.y,this.z,this.w)}}},5639:(t,i,s)=>{s.d(i,{A:()=>u});var n=s(6389),e=s(4857),h=s(9246),o=s(6101),r=(s(6478),s(4598));s(20);const a=new o.A,c=new o.A,l=new o.A;class u{constructor(t={}){this.isBody=!0,this.type=t.type??r.Bi,this.shape=t.shape??null,this.mass=this.type===r.Bi?0:t.mass??1,this.invMass=this.mass?1/this.mass:0,this.inertia=this.type===r.Bi?0:t.inertia??1,this.invInertia=0===this.inertia?0:1/this.inertia,this.centerOfMassLocal=(new o.A).copy(t.centerOfMassLocal??n.VT),this.centerOfMass=new o.A,this.position=(new o.A).copy(t.position??n.VT),this.previousPosition=new o.A,this.interpolatedPosition=new o.A,this.quaternion=(new h.A).copy(t.quaternion??n.zN),this.invQuaternion=this.quaternion.conjugate(),this.previousQuaternion=new h.A,this.interpolatedQuaternion=new h.A,this.velocity=(new o.A).copy(t.velocity??o.A.ZERO),this.previousVelocity=new o.A,this.interpolatedVelocity=new o.A,this.angularVelocity=(new o.A).copy(t.angularVelocity??o.A.ZERO),this.previousAngularVelocity=new o.A,this.interpolatedAngularVelocity=new o.A,this.collisionFilterGroup=t.collisionFilterGroup??-1,this.collisionFilterMask=t.collisionFilterMask??-1,this.aabb=t.aabb??new e.A,this.constraints=[]}updateAABB(){this.shape&&this.shape.calculateAABB(this.position,this.quaternion,this.aabb)}addEventListener(){}applyImpulse(t,i,s){t.scale(this.invMass,a),this.velocity.add(a,this.velocity),i.cross(t,c),c.scale(1e-6,c),this.angularVelocity.add(c,this.angularVelocity)}addConstraint(t){this.constraints.push(t)}onCollision(t){}updateCenterOfMass(){this.quaternion.vmult(this.centerOfMassLocal,this.centerOfMass),this.centerOfMass.add(this.position,this.centerOfMass)}getVelocityAtPoint(t,i=new o.A){return t.sub(this.centerOfMass,l),this.angularVelocity.cross(l,i),this.velocity.add(i,i),i}copy(t){return this.type=t.type,this.shape=t.shape,this.mass=t.mass,this.invMass=t.invMass,this.inertia=t.inertia,this.invInertia=t.invInertia,this.centerOfMassLocal.copy(t.centerOfMassLocal),this.position.copy(t.position),this.quaternion.copy(t.quaternion),this.velocity.copy(t.velocity),this.angularVelocity.copy(t.angularVelocity),this.collisionFilterGroup=t.collisionFilterGroup,this.collisionFilterMask=t.collisionFilterMask,this.aabb=t.aabb,this.onCollision=t.onCollision.bind(this),this}clone(){return(new u).copy(this)}}},6783:(t,i,s)=>{s.d(i,{A:()=>n});class n{constructor(t,i,s,n,e,h,o){this.body1=t,this.body2=i,this.shape1=s,this.shape2=n,this.position=e,this.normal=h,this.depth=o,this.position1=null,this.position2=null,this.quaternion1=null,this.quaternion2=null,this.maxImpulse=1/0}}},2627:(t,i,s)=>{s.d(i,{A:()=>n});s(9246),s(6101),s(20);class n{constructor(t,i,s,n,e,h,o,r,a,c){this.thisBody=t,this.otherBody=i,this.thisShape=s,this.otherShape=n,this.thisPosition=e,this.otherPosition=h,this.thisQuaternion=o,this.otherQuaternion=r,this.normal=a,this.impulse=c}init(t,i,s,n,e,h,o,r,a,c){return this.thisBody=t,this.otherBody=i,this.thisShape=s,this.otherShape=n,this.thisPosition=e,this.otherPosition=h,this.thisQuaternion=o,this.otherQuaternion=r,this.normal=a,this.impulse=c,this}}},8481:(t,i,s)=>{s.d(i,{A:()=>A});var n=s(6389),e=s(6101),h=(s(261),s(5639),s(9248),s(1471)),o=(s(6478),s(7393)),r=s(2627),a=s(4857),c=(s(9246),s(6783)),l=s(4598),u=s(5137);u.A;s(9691);var f=s(20);f.A;s(5177),s(5172);var d=s(5206),v=s(1184);class m{constructor(){}static sphereSphere(){}static sphereConvex(){}static sphereTimesh(){}static gjk=new v.A;static epa=new d.A;static convexConvex(t,i,s,n,e,h){const o=[];if(!m.gjk.run(t,i,s,n,e,h))return o;const r=m.epa.run(m.gjk.simplex,t,i,s,n,e,h);return r&&(r.position1=t,r.position2=i,r.quaternion1=s,r.quaternion2=n,o.push(r)),o}static Kt=new a.A;static Jt=new e.A;static convexConcave(t,i,s,n,e,h){e.calculateAABB(t,s,m.Kt),m.Kt.max.sub(i,m.Kt.max),m.Kt.min.sub(i,m.Kt.min);const o=h.bvh.aabbTest(m.Kt),r=[];for(const h of o){if(!m.gjk.run(t,i,s,n,e,h.object))continue;const o=m.epa.run(m.gjk.simplex,t,i,s,n,e,h.object);o&&r.push(o)}return r}static convexShapeGroup(t,i,s,n,e,h){e.calculateAABB(t,s,m.Kt),m.Kt.max.sub(i,m.Kt.max),m.Kt.min.sub(i,m.Kt.min);const o=h.bvh.aabbTest(m.Kt),r=[];for(const h of o){const o=h.object,a=o.type<e.type,c=a?i:t,l=a?t:i,u=a?n:s,f=a?s:n,d=a?o:e,v=a?e:o,w=m.detectionMethods[d.type|v.type];r.push(...w(c,l,u,f,d,v))}return r}static convexInstancedShape(t,i,s,n,e,h){if(!h.active)return[];const o=h.shape,r=o.type<e.type,a=i.add(h.position),c=n.mult(h.quaternion),l=r?a:t,u=r?t:a,f=r?c:s,d=r?s:c,v=r?o:e,w=r?e:o,p=(0,m.detectionMethods[v.type|w.type])(l,u,f,d,v,w);for(const t of p)t.shape1=r?h:t.shape1,t.shape2=r?t.shape2:h,t.maxImpulse=h.maxImpulse;return p}static sphereBox(t,i,s,n){const e=t.position.x-s.radius<i.position.x+n.size.x,h=t.position.y-s.radius<i.position.y+n.size.y,o=t.position.z-s.radius<i.position.z+n.size.z,r=t.position.x+s.radius>i.position.x-n.size.x,a=t.position.y+s.radius>i.position.y-n.size.y,c=t.position.z+s.radius>i.position.z-n.size.z;return e&&h&&o&&r&&a&&c}static convexPlane(t,i,s,n){const e=[],h=s.support(t,n.normal.negate()),o=n.normal.dot(h)-n.distance,r=h.add(n.normal.scale(-o));if(o<=0){const a=h.lerp(r,.5),l=new c.A(t,i,s,n,a,n.normal.negate(),Math.abs(.5*o));e.push(l)}return e}static getContacts(t,i){if(i.shape.type<t.shape.type){const s=t;t=i,i=s}const s=t.shape,n=i.shape,e=(0,m.detectionMethods[s.type|n.type])(t.position,i.position,t.quaternion,i.quaternion,s,n);for(const s of e)s.body1=t,s.body2=i;return t.updateCenterOfMass(),i.updateCenterOfMass(),e}static detectionMethods={[l.kH.SPHERE|l.kH.SPHERE]:m.sphereSphere,[l.kH.SPHERE|l.kH.CONVEX]:m.sphereSphere,[l.kH.SPHERE|l.kH.CONCAVE]:m.sphereSphere,[l.kH.CONVEX|l.kH.CONVEX]:m.convexConvex,[l.kH.CONVEX|l.kH.CONCAVE]:m.convexConcave,[l.kH.CONVEX|l.kH.PLANE]:m.convexPlane,[l.kH.CONVEX|l.kH.SHAPE_GROUP]:m.convexShapeGroup,[l.kH.CONVEX|l.kH.INSTANCED_SHAPE]:m.convexInstancedShape}}s(7764);const w=new e.A,p=(new e.A,new e.A),g=(new e.A,new e.A),x=new e.A,M=(new e.A,new e.A,new e.A),S=new e.A,y=new e.A,_=new e.A,P=new e.A;new e.A;class A{constructor(t={}){this.scene=t.scene,this.gravity=t.gravity??new e.A(0,-10,0),this.bodies=[],this.movableBodies=[],this.dynamicBodies=[],this.broadphase=t.broadphase??new h.Ay,this.bvh=this.broadphase,this.raycastVehicles=[],this.constraints=[],this.collisions=[],this.contactConstraints=[],this.frictionConstraints=[];for(let t=0;t<100;t++)this.contactConstraints.push(new o.A),this.frictionConstraints.push(new o.A);this.originalContactConstraints=[],this.originalFrictionConstraints=[],this.randomizedContactConstraints=[],this.randomizedFrictionConstraints=[],this.contactInfos=[];for(let t=0;t<200;t++)this.contactInfos.push(new r.A);this.hertz=20,this.damping=10,this.accumulatedDebris=0,this.accumulatedSparks=0,this.effectTimer=.1}addBody(t){if(!(0<=this.bodies.indexOf(t))){if(this.bodies.push(t),t.type!==l.Bi){this.movableBodies.indexOf(t)<0&&this.movableBodies.push(t)}if(t.type===l.E3){this.dynamicBodies.indexOf(t)<0&&this.dynamicBodies.push(t)}t.previousPosition.copy(t.position),t.previousQuaternion.copy(t.quaternion),t.interpolatedPosition.copy(t.position),t.interpolatedQuaternion.copy(t.quaternion),t.updateAABB(),this.broadphase.insertObject(t),t.updateCenterOfMass(),this.constraints.push(t.constraints)}}removeBody(t){const i=this.bodies.indexOf(t);if(!(i<0)){if(this.bodies.splice(i,1),t.type!==l.Bi){const i=this.movableBodies.indexOf(t);this.movableBodies.splice(i,1)}if(t.type===l.E3){const i=this.dynamicBodies.indexOf(t);this.dynamicBodies.splice(i,1)}this.broadphase.removeObject(t)}}addRaycastVehicle(t){0<=this.raycastVehicles.indexOf(t)||this.raycastVehicles.push(t)}removeRaycastVehicle(t){const i=this.raycastVehicles.indexOf(t);i<0||this.raycastVehicles.splice(i,1)}step(t=1/60){for(const t of this.movableBodies)t.previousVelocity.copy(t.velocity),t.previousPosition.copy(t.position),t.previousQuaternion.copy(t.quaternion);this.getCollisions();for(let i=0;i<this.collisions.length;i++){const s=this.collisions[i];s.position.sub(s.body1.centerOfMass,g),s.position.sub(s.body2.centerOfMass,x),s.body2.angularVelocity.cross(g,_),s.body1.angularVelocity.cross(x,P),_.add(s.body1.velocity,_),P.add(s.body2.velocity,P),P.sub(_,M);{const n=this.contactConstraints[i];n.active=!0,n.prepare(s.body1,s.body2,g,x,s.normal,this.hertz,this.damping,-s.depth,t),n.maxImpulse=s.maxImpulse}{s.normal.scale(s.normal.dot(M),S),M.add(S,y),p.copy(y).normalize(),p.negate(p);const t=this.frictionConstraints[i];t.active=!0,t.prepare(s.body1,s.body2,g,x,p)}s.body1.onCollision}for(const i of this.dynamicBodies)i.velocity.y-=n.ZQ*t;this.stepRaycastVehicles(t),this.solveConstraints(t);for(const i of this.movableBodies)i.velocity.scale(t,w),i.position.add(w,i.position),i.quaternion.integrate(i.angularVelocity,t,i.quaternion),i.quaternion.normalize(),i.updateAABB(),i.updateCenterOfMass()}getCollisions(){this.broadphase.update();const t=this.broadphase.getCollisionPairs();this.collisions.length=0;for(const i of t){if(0===(i[0].object.collisionFilterGroup&i[1].object.collisionFilterMask)||0===(i[1].object.collisionFilterGroup&i[0].object.collisionFilterMask))continue;const t=m.getContacts(i[0].object,i[1].object);this.collisions.push(...t)}}solveConstraints(t){this.originalContactConstraints.length=0,this.originalFrictionConstraints.length=0;for(let t=0;t<this.collisions.length;t++)this.originalContactConstraints.push(this.contactConstraints[t]),this.originalFrictionConstraints.push(this.frictionConstraints[t]);for(this.randomizedContactConstraints.length=0,this.randomizedFrictionConstraints.length=0;0<this.originalContactConstraints.length;){const t=Math.random()*this.originalContactConstraints.length;this.randomizedContactConstraints.push(this.originalContactConstraints.splice(t,1)[0]),this.randomizedFrictionConstraints.push(this.originalFrictionConstraints.splice(t,1)[0])}for(let t=0;t<4;t++)for(let t=0;t<this.collisions.length;t++)this.randomizedContactConstraints[t].solveSoft(),this.randomizedFrictionConstraints[t].minImpulse=.5*-this.randomizedContactConstraints[t].accumulatedImpulse,this.randomizedFrictionConstraints[t].maxImpulse=.5*+this.randomizedContactConstraints[t].accumulatedImpulse,this.randomizedFrictionConstraints[t].solve();for(let t=0;t<this.collisions.length;t+=2){const i=this.collisions[t],s=this.contactConstraints[t];i.body1.onCollision(this.contactInfos[t+0].init(i.body1,i.body2,i.shape1,i.shape2,i.position1,i.position2,i.quaternion1,i.quaternion2,s.normal,s.accumulatedImpulse)),i.body2.onCollision(this.contactInfos[t+1].init(i.body2,i.body1,i.shape2,i.shape1,i.position2,i.position1,i.quaternion2,i.quaternion1,s.normal,s.accumulatedImpulse))}}updateInterpolated(t){for(const i of this.movableBodies)i.previousPosition.lerp(i.position,t,i.interpolatedPosition),i.previousQuaternion.slerp(i.quaternion,t,i.interpolatedQuaternion),i.previousVelocity.lerp(i.velocity,t,i.interpolatedVelocity)}stepRaycastVehicles(t){for(const i of this.raycastVehicles)i.step(this,t)}}},4598:(t,i,s)=>{s.d(i,{Bi:()=>e,E3:()=>n,eS:()=>h,kH:()=>o});const n=1,e=2,h=4,o={SPHERE:1,CONVEX:2,CONCAVE:4,TRIANGLE:8,BOX:16,PLANE:32,SHAPE_GROUP:64,INSTANCED_SHAPE:128}},2319:(t,i,s)=>{s.d(i,{A:()=>S});var n=s(6389),e=s(9246),h=s(6101),o=s(5639),r=(s(1471),s(8481),s(5206)),a=s(1184),c=s(4598),l=s(3449);s(9691),s(5137),s(5177),s(5172),s(5181);new h.A;const u=new h.A,f=(new e.A,new o.A,new l.A),d=new h.A,v=new h.A,m=new h.A,w=new h.A,p=new h.A,g=new h.A,x=new h.A,M=new h.A;class S{constructor(t={}){this.start=new h.A,t.start&&this.start.copy(t.start),this.end=new h.A,t.end&&this.end.copy(t.end),this.direction=new h.A,this.length=-1,this.updateDirectionAndLength(),this.gjk=new a.A,this.epa=new r.A,this.intersectMethods={[c.kH.SPHERE]:this.Qt,[c.kH.CONVEX]:this.ti,[c.kH.CONCAVE]:this.ii,[c.kH.TRIANGLE]:this.si,[c.kH.PLANE]:this.ni,[c.kH.SHAPE_GROUP]:this.ei,[c.kH.INSTANCED_SHAPE]:this.hi},this.vertices=[this.start,this.end],this.collisionFilterGroup=void 0!==t.collisionFilterGroup?t.collisionFilterGroup:-1,this.collisionFilterMask=void 0!==t.collisionFilterMask?t.collisionFilterMask:-1}updateDirectionAndLength(){this.end.sub(this.start,this.direction),this.direction.normalize(),this.length=this.start.distanceTo(this.end)}updateEnd(){this.direction.scale(this.length,this.end),this.start.add(this.end,this.end)}intersectsWorldAlt(t,i,s,n=new l.A){return this.start.copy(i),this.end.copy(s),this.updateDirectionAndLength(),this.intersectsWorld(t,n)}intersectsWorld(t,i){i.init();let s=1/0;for(const n of this.oi(t.bvh))if(0!==(this.collisionFilterGroup&n.collisionFilterMask)&&0!==(n.collisionFilterGroup&this.collisionFilterMask)&&(f.init(),this.ri(n,f),f.hasHit)){const t=this.start.distanceTo(f.hitPoint);t<s&&(s=t,i.copy(f))}return i}oi(t){const i=[];return this.ai(t.root,i),i}ai(t,i){const s=(t.aabb.min.x-this.start.x)/(this.direction.x+n.HV),e=(t.aabb.max.x-this.start.x)/(this.direction.x+n.HV),h=(t.aabb.min.y-this.start.y)/(this.direction.y+n.HV),o=(t.aabb.max.y-this.start.y)/(this.direction.y+n.HV),r=(t.aabb.min.z-this.start.z)/(this.direction.z+n.HV),a=(t.aabb.max.z-this.start.z)/(this.direction.z+n.HV),c=Math.max(Math.max(Math.min(s,e),Math.min(h,o)),Math.min(r,a)),l=Math.min(Math.min(Math.max(s,e),Math.max(h,o)),Math.max(r,a));l<0||l<c||this.length<c||(t.isLeaf?i.push(t.object):(this.ai(t.child1,i),this.ai(t.child2,i)))}ri(t,i){i.init();const s=t.shape;return this.intersectMethods[s.type].bind(this)(t.position,t.quaternion,s,i),i.hasHit&&(i.hitBody=t),i}Qt(t,i,s,n){n.init(),this.start.sub(t,u);const e=u.dot(this.direction),h=u.lengthSquared(),o=s.radius,r=e*e-(h-o*o);if(r<0)return n;const a=-e-Math.sqrt(r);return a<0||a>this.length||(n.hasHit=!0,n.distance=a,this.direction.scale(a,u),this.start.add(u,n.hitPoint),n.hitPoint.sub(t,n.hitNormal),n.hitNormal.normalize(),n.hitShape=s),n}ti(t,i,s,n){const e=s.triangles;for(const s of e)this.si(t,i,s,n);return n.hasHit&&(n.shapePosition.copy(t),n.shapeQuaternion.copy(i),n.hitShape=s),n}ii(t,i,s,n){this.start.sub(t,y.start),this.end.sub(t,y.end),y.updateDirectionAndLength();const e=y.oi(s.bvh);for(const s of e)this.si(t,i,s,n);return n}ei(t,i,s,n){this.start.sub(t,y.start),this.end.sub(t,y.end),y.updateDirectionAndLength();const e=y.oi(s.bvh);for(const s of e){if(this.intersectMethods[s.type].bind(this)(t,i,s,n),n.hasHit)break}return n}hi(t,i,s,n){if(!s.active)return n;const e=t.add(s.position),h=i.mult(s.quaternion);return this.intersectMethods[s.shape.type].bind(this)(e,h,s.shape,n),n.hasHit&&(n.hitShape=s),n}si(t,i,s,n){i.vmult(s.vertices[0],d),i.vmult(s.vertices[1],v),i.vmult(s.vertices[2],m),d.add(t,d),v.add(t,v),m.add(t,m);v.sub(d,w),m.sub(d,p),this.direction.cross(p,g);const e=w.dot(g);if(Math.abs(e)<1e-6)return n;const h=1/e;this.start.sub(d,x);const o=x.dot(g)*h;if(o<0||1<o)return null;x.cross(w,M);const r=this.direction.dot(M)*h;if(r<0||1<o+r)return null;const a=p.dot(M)*h;return a<0||this.length<a||(n.hitDistance<0||a<n.hitDistance)&&(n.hasHit=!0,n.hitShape=s,this.direction.scale(a,n.hitPoint),n.hitPoint.add(this.start,n.hitPoint),w.cross(p,n.hitNormal).normalize(),n.hitDistance=a),n}ni(t,i,s=new l.A){return s}support(t,i,s=new h.A){const n=this.start.dot(i),e=this.end.dot(i);return s.copy(e<n?this.start:this.end)}}const y=new S},3449:(t,i,s)=>{s.d(i,{A:()=>o});var n=s(6389),e=s(9246),h=s(6101);s(5639);class o{constructor(t,i,s,o,r,a,c){this.hasHit=!1,this.hitBody=t??null,this.hitShape=i??null,this.hitPoint=(new h.A).copy(s??n.VT),this.hitNormal=(new h.A).copy(o??n.VT),this.hitDistance=r??-1,this.shapePosition=(new h.A).copy(a??n.VT),this.shapeQuaternion=(new e.A).copy(c??n.zN)}init(){this.hasHit=!1,this.hitBody=null,this.hitShape=null,this.hitPoint.setZero(),this.hitNormal.setZero(),this.hitDistance=-1}copy(t){return this.hasHit=t.hasHit,this.hitBody=t.hitBody,this.hitShape=t.hitShape,this.hitPoint.copy(t.hitPoint),this.hitNormal.copy(t.hitNormal),this.hitDistance=t.hitDistance,this.shapePosition.copy(t.shapePosition),this.shapeQuaternion.copy(t.shapeQuaternion),this}}},7764:(t,i,s)=>{s.d(i,{A:()=>p});s(5639),s(8481);var n=s(6389),e=s(7389),h=s(9246),o=s(6101),r=s(6478),a=s(7393),c=s(2319),l=s(3449);const u=new o.A,f=new h.A,d=new o.A,v=new o.A,m=new o.A;class w extends r.A{constructor(t,i){super(),this.body=t,this.active=i.active??!0,this.anchorPointLocal=new o.A,this.anchorPointLocal.copy(i.anchorPointLocal??n.VT),this.suspensionDirectionLocal=new o.A,this.suspensionDirectionLocal.copy(i.direction??n.PX),this.suspensionDirection=new o.A,this.wheelAxleLocal=new o.A,this.wheelAxleLocal.copy(i.wheelAxleLocal??n.NS),this.suspensionRestLength=i.suspensionRestLength??1,this.suspensionHertz=2,this.suspensionDampingRatio=1,this.wheelRadius=i.wheelRadius??1,this.wheelFriction=i.wheelFriction??1,this.totalLength=this.suspensionRestLength+this.wheelRadius,this.suspensionSpringConstraint=new a.A,this.body.addConstraint(this.suspensionSpringConstraint),this.forwardConstraint=new a.A,this.body.addConstraint(this.forwardConstraint),this.lateralConstraint=new a.A,this.body.addConstraint(this.lateralConstraint),this.vehicle=t.actor.isPlayerAircraft?t.actor:null,this.ray=new c.A({collisionFilterMask:e.N7.TERRAIN,collisionFilterGroup:e.N7.VEHICLE}),this.raycastResult=new l.A,this.drive=i.drive??!1,this.brake=i.brake??!0,this.steer=i.steer??!1,this.handbrake=i.handbrake??!1,this.driveTorque=15,this.brakeTorque=0,this.steerAngle=0,this.brakeInput=0,this.angularSpeed=0,this.wheelAxle=new o.A,this.wheelForward=new o.A,this.projectedLateralDirection=new o.A,this.projectedForwardDirection=new o.A,this.wheelSpeed=0,this.maxWheelSpeed=400,this.forwardAccumulatedImpulse=0,this.lateralAccumulatedImpulse=0,this.body1=null,this.body2=null,this.relativePosition1=new o.A,this.relativePosition2=new o.A,this.maxSteerAngle=void 0!==i.maxSteerAngle?i.maxSteerAngle:.5,this.maxBrakeTorque=void 0!==i.maxBrakeTorque?i.maxBrakeTorque:1,this.mesh=null,this.vehicle&&i.model&&(this.mesh=this.findMeshByName(this.vehicle.mesh,i.model),this.mesh&&(this.initialMeshPosition=this.mesh.position.clone(),this.initialMeshQuaternion=this.mesh.quaternion.clone(),this.initialMeshQuaternion.getLength()||(this.initialMeshQuaternion.setFromAxisAngle(n.UP,0),this.initialMeshQuaternion.normalize()))),this.frictionAccumulatedImpulse=new o.A}setSteer(t){this.steer&&(this.steerAngle=this.maxSteerAngle*t)}setBrake(t){this.brake&&(this.brakeTorque=this.maxBrakeTorque*t,this.brakeInput=t)}prepare(t,i){if(this.body.quaternion.vmult(this.anchorPointLocal,this.ray.start),this.ray.start.add(this.body.position,this.ray.start),this.body.quaternion.vmult(this.suspensionDirectionLocal,this.suspensionDirection),this.ray.direction.copy(this.suspensionDirection),this.ray.length=this.totalLength,this.ray.updateEnd(),this.ray.intersectsWorld(t,this.raycastResult),this.suspensionSpringConstraint.active=this.raycastResult.hasHit,this.raycastResult.hasHit){this.body1=this.raycastResult.hitBody,this.body2=this.body,this.raycastResult.hitPoint.sub(this.body1.centerOfMass,this.relativePosition1),this.raycastResult.hitPoint.sub(this.body2.centerOfMass,this.relativePosition2);{const t=this.raycastResult.hitDistance-this.totalLength;this.suspensionSpringConstraint.prepare(this.body1,this.body2,this.relativePosition1,this.relativePosition2,this.raycastResult.hitNormal,this.suspensionHertz,this.suspensionDampingRatio,t,i),this.bias=this.biasCoeff*t}f.setFromAxisAngle(n.UP,this.steerAngle),f.normalize(),f.vmult(this.wheelAxleLocal,this.wheelAxle),this.body.quaternion.vmult(this.wheelAxle,this.wheelAxle),this.wheelAxle.normalize(),this.wheelAxle.cross(this.suspensionDirection,this.wheelForward),this.wheelForward.normalize(),o.A.projectOnPlane(this.wheelAxle,this.raycastResult.hitNormal,this.projectedLateralDirection),this.projectedLateralDirection.normalize(),this.body1.getVelocityAtPoint(this.raycastResult.hitPoint,d),this.body2.getVelocityAtPoint(this.raycastResult.hitPoint,v),d.sub(v,m),m.isZero()&&m.copy(n.UP),o.A.projectOnPlane(m,this.raycastResult.hitNormal,this.projectedForwardDirection),this.projectedForwardDirection.normalize(),this.lateralConstraint.prepare(this.body1,this.body2,this.relativePosition1,this.relativePosition2,this.projectedLateralDirection),this.forwardConstraint.prepare(this.body1,this.body2,this.relativePosition1,this.relativePosition2,this.projectedForwardDirection),this.frictionAccumulatedImpulse.setZero(),this.deltaTime=i}else this.suspensionSpringConstraint.accumulatedImpulse=0}getMaxFriction(t){return 10*this.wheelFriction}getMaxFrictionAlt(t,i){const s=this.wheelFriction*t*20;if(0==s)return 0;const n=i/s;return(1-Math.exp(-n))*s*.5}solve(){if(!this.active||!this.suspensionSpringConstraint.active)return;this.suspensionSpringConstraint.solveSoft();const t=1-Math.exp(-this.suspensionSpringConstraint.accumulatedImpulse/(.05*this.vehicle.body.mass)),i=this.wheelFriction*this.deltaTime*t;this.forwardConstraint.minImpulse=-i*this.brakeInput,this.forwardConstraint.maxImpulse=i*this.brakeInput,this.lateralConstraint.minImpulse=-i,this.lateralConstraint.maxImpulse=i,this.forwardConstraint.solve(),this.lateralConstraint.solve()}findMeshByName(t,i){if(t.name===i)return t;for(const s of t.children){const t=this.findMeshByName(s,i);if(t)return t}return null}updateVisual(){if(!this.active||!this.mesh)return;let t=this.totalLength-this.wheelRadius;this.raycastResult.hasHit&&(t=this.raycastResult.hitDistance-this.wheelRadius),this.suspensionDirectionLocal.scale(t-this.suspensionRestLength,u),this.mesh.position.add(u,this.mesh.position),f.setFromAxisAngle(n.UP,this.steerAngle),f.normalize(),this.mesh.quaternion.mult(f,this.mesh.quaternion)}}class p{constructor(t,i=[]){this.body=t,this.wheels=[];for(const t of i)this.addWheel(t)}addWheel(t){const i=new w(this.body,t);this.wheels.push(i)}setSteer(t){for(const i of this.wheels)i.setSteer(t)}setBrake(t){for(const i of this.wheels)i.setBrake(t)}updateVisual(t){for(const i of this.wheels)i.updateVisual(t)}step(t,i){for(const s of this.wheels)s.prepare(t,i);const s=[...this.wheels],n=[];for(;0<s.length;){const t=Math.random()*s.length;n.push(s.splice(t,1)[0])}for(let t=0;t<32;t++)for(const t of n)t.solve()}}},1471:(t,i,s)=>{s.d(i,{Ay:()=>u});var n=s(4857),e=s(6101),h=s(5931),o=s(4598),r=s(9248);const a=new n.A,c=(new e.A,new n.A),l=new n.A;class u extends r.A{constructor(){super(),this.root=null,this.leaves=new Map,this.movableLeaves=new Map;this.queue=new h.A(function(t,i){return t.inheritedCost<i.inheritedCost})}insertObject(t){t.updateAABB&&t.updateAABB();const i=new f(t);i.updateAABB(),this.leaves.set(t,i),t.isBody&&t.type!==o.Bi&&this.movableLeaves.set(t,i),this.ci(i)}removeObject(t){const i=this.leaves.get(t);this.leaves.delete(i),t.isBody&&!t.type!==o.Bi&&this.movableLeaves.delete(t),this.li(i)}ci(t){if(!this.root)return void(this.root=t);let i,s=null,e=1/0;{const i=new d(this.root,0);for(this.queue.push(i);0<this.queue.length;){const i=this.queue.pop(),h=i.node,o=i.inheritedCost;n.A.merge(h.aabb,t.aabb,a);const r=a.surfaceArea,c=r+o;if(c<e&&(e=c,s=h),h.isLeaf)continue;const l=o+(r-h.aabb.surfaceArea);t.aabb.surfaceArea+l<e&&(this.queue.push(new d(h.child1,l)),this.queue.push(new d(h.child2,l)))}}{const e=s.parent;i=new f,i.parent=e,n.A.merge(s.aabb,t.aabb,i.aabb),e?e.child1==s?e.child1=i:e.child2=i:this.root=i,i.child1=s,i.child2=t,s.parent=i,t.parent=i}{let t=i;for(;t;)n.A.merge(t.child1.aabb,t.child2.aabb,t.aabb),f.rotate(t),t=t.parent}}li(t){const i=t.parent;if(!i)return void(this.root=null);const s=i.parent,e=t==i.child1?i.child2:i.child1;if(s){e.parent=s,i==s.child1?s.child1=e:s.child2=e;let t=s;for(;t;)n.A.merge(t.child1.aabb,t.child2.aabb,t.aabb),f.rotate(t),t=t.parent}else this.root=e,e.parent=null}update(){this.movableLeaves.forEach((t,i)=>{t.aabb.contains(t.object.aabb)||(this.li(t),t.updateAABB(),this.ci(t))})}getCollisionPairs(){const t=[];return this.movableLeaves.forEach(i=>{i.object.type===o.E3&&this.ui(i,this.root,t,i)}),t}ui(t,i,s){i.aabb.overlaps(t.aabb)&&(i.isLeaf?t!==i&&s.push([t,i]):(this.ui(t,i.child1,s),this.ui(t,i.child2,s)))}aabbTest(t){const i=[];return this.fi(t,this.root,i),i}fi(t,i,s){t.overlaps(i.aabb)&&(i.isLeaf?s.push(i):(this.fi(t,i.child1,s),this.fi(t,i.child2,s)))}}class f{constructor(t){this.aabb=new n.A,t?.aabb&&this.aabb.copy(t.aabb),this.isLeaf=void 0!==t,this.parent=null,this.child1=null,this.child2=null,this.object=t}updateAABB(){if(this.object&&(this.object.aabb&&(this.aabb.copy(this.object.aabb),this.aabb.updateSurfaceArea()),this.object.isBody&&this.object.type!==o.Bi)){const t=0*this.object.velocity.length();this.aabb.min.subScalar(t,this.aabb.min),this.aabb.max.addScalar(t,this.aabb.max),this.aabb.updateSurfaceArea()}}static rotate(t){if(t.isLeaf)return;const i=t.child1,s=t.child2,e=[0,0,0,0];if(!i.isLeaf){const t=i.aabb.surfaceArea;e[0]=n.A.merge(i.child1.aabb,s.aabb,c).surfaceArea-t,e[1]=n.A.merge(i.child2.aabb,s.aabb,l).surfaceArea-t}if(!s.isLeaf){const t=s.aabb.surfaceArea;e[2]=n.A.merge(s.child1.aabb,i.aabb,c).surfaceArea-t,e[3]=n.A.merge(s.child2.aabb,i.aabb,l).surfaceArea-t}let h=0;for(let t=0;t<4;t++)e[t]<e[h]&&(h=t);if(!(0<=e[h]))switch(h){case 0:i.child2.parent=t,t.child2=i.child2,i.child2=s,s.parent=i,n.A.merge(i.child1.aabb,i.child2.aabb,i.aabb);break;case 1:i.child1.parent=t,t.child2=i.child1,i.child1=s,s.parent=i,n.A.merge(i.child1.aabb,i.child2.aabb,i.aabb);break;case 2:s.child2.parent=t,t.child1=s.child2,s.child2=i,i.parent=s,n.A.merge(s.child1.aabb,s.child2.aabb,s.aabb);break;case 3:s.child1.parent=t,t.child1=s.child1,s.child1=i,i.parent=s,n.A.merge(s.child1.aabb,s.child2.aabb,s.aabb)}}static rotrateAlt(t){if(t.isLeaf)return;const i=t.child1,s=t.child2,e=[-1,-1,-1,-1];i.isLeaf||(e[0]=n.A.merge(s.aabb,i.child1.aabb).surfaceArea+i.child2.aabb.surfaceArea,e[1]=n.A.merge(s.aabb,i.child2.aabb).surfaceArea+i.child1.aabb.surfaceArea),s.isLeaf||(e[2]=n.A.merge(i.aabb,s.child1.aabb).surfaceArea+s.child2.aabb.surfaceArea,e[3]=n.A.merge(i.aabb,s.child2.aabb).surfaceArea+s.child1.aabb.surfaceArea);let h=0;for(let t=0;t<4;t++)e[t]<e[h]&&(h=t);if(e[h]<0)return;const o=t.child1.aabb.surfaceArea+t.child2.aabb.surfaceArea;if(!(e[h]<=o))switch(h){case 0:i.child2.parent=t,t.child2=i.child2,i.child2=s,s.parent=i,n.A.merge(i.child1.aabb,i.child2.aabb,i.aabb);break;case 1:i.child1.parent=t,t.child2=i.child1,i.child1=s,s.parent=i,n.A.merge(i.child1.aabb,i.child2.aabb,i.aabb);break;case 2:s.child2.parent=t,t.child1=s.child2,s.child2=i,i.parent=s,n.A.merge(s.child1.aabb,s.child2.aabb,s.aabb);break;case 3:s.child1.parent=t,t.child1=s.child1,s.child1=i,i.parent=s,n.A.merge(s.child1.aabb,s.child2.aabb,s.aabb)}}}class d{constructor(t,i){this.node=t,this.inheritedCost=i}}},9248:(t,i,s)=>{s.d(i,{A:()=>n});s(5639);class n{constructor(){}aabbTest(t){}rayTest(t){}insertObject(t){}removeObject(t){}getCollisionPairs(){}}},6478:(t,i,s)=>{s.d(i,{A:()=>h});var n=s(6101);class e{constructor(t,i){this.linear=new n.A,this.angular=new n.A}update(t,i){this.linear.copy(t),this.angular.copy(i)}copy(t){this.linear.copy(t.linear),this.angular.copy(t.angular)}}new e,new e;class h{constructor(){this.active=!1}prepare(){}solve(){}}},7393:(t,i,s)=>{s.d(i,{A:()=>v});var n=s(1447),e=s(6101),h=(s(5639),s(6478));const o=new e.A,r=new e.A,a=new e.A,c=new e.A,l=new e.A,u=new e.A,f=new e.A,d=new e.A;class v extends h.A{constructor(){super(),this.body1=null,this.body2=null,this.normal=new e.A,this.relativePosition1=new e.A,this.relativePosition2=new e.A,this.effectiveMass=0,this.accumulatedImpulse=0,this.massCoeff=1,this.impulseCoeff=0,this.bias=0,this.minImpulse=0,this.maxImpulse=1/0}prepare(t,i,s,n,e,h,o,r,a){this.body1=t,this.body2=i,this.relativePosition1.copy(s),this.relativePosition2.copy(n),this.normal.copy(e),this.relativePosition1.cross(e,c),this.relativePosition2.cross(e,l);const u=c.length(),f=l.length(),d=t.invMass+i.invMass+t.invInertia*u*u+i.invInertia*f*f;if(this.effectiveMass=d?1/d:0,void 0!==h&&void 0!==o&&void 0!==r&&void 0!==a){const t=a,i=o,s=2*Math.PI*h,n=t*s*(2*i+t*s);this.biasCoeff=s/(2*i+t*s),this.impulseCoeff=1/(1+n),this.massCoeff=n*this.impulseCoeff,this.bias=this.biasCoeff*r}this.accumulatedImpulse=0}updateSoftness(t,i,s){this.massCoeff=t,this.impulseCoeff=i,this.bias=s}getRelativeSpeed(){return this.body1.angularVelocity.cross(this.relativePosition1,o),this.body2.angularVelocity.cross(this.relativePosition2,r),o.add(this.body1.velocity,o),r.add(this.body2.velocity,r),r.sub(o,a).dot(this.normal)}solve(){const t=-this.effectiveMass*this.getRelativeSpeed(),i=(0,n.qE)(this.accumulatedImpulse+t,this.minImpulse,this.maxImpulse),s=i-this.accumulatedImpulse;this.accumulatedImpulse=i,this.applyImpulse(s)}solveSoft(){const t=-this.effectiveMass*this.massCoeff*(this.getRelativeSpeed()+this.bias)-this.accumulatedImpulse*this.impulseCoeff,i=(0,n.qE)(this.accumulatedImpulse+t,this.minImpulse,this.maxImpulse),s=i-this.accumulatedImpulse;this.accumulatedImpulse=i,this.applyImpulse(s)}applyImpulse(t){this.normal.scale(t,u),this.body1.velocity.sub(u.scale(this.body1.invMass,f),this.body1.velocity),this.body1.angularVelocity.sub(this.relativePosition1.cross(u,f).scale(this.body1.invInertia,f),this.body1.angularVelocity),this.body2.velocity.add(u.scale(this.body2.invMass,d),this.body2.velocity),this.body2.angularVelocity.add(this.relativePosition2.cross(u,d).scale(this.body2.invInertia,d),this.body2.angularVelocity)}dot(t){return this.normal.dot(t)}scale(t,i){return this.normal.scale(t,i)}}},5206:(t,i,s)=>{s.d(i,{A:()=>f});var n=s(6389),e=(s(9246),s(6101)),h=s(6783);s(20);class o{constructor(t,i,s){this.a=t,this.b=i,this.c=s;const n=i.sub(t),e=s.sub(t);this.normal=n.cross(e).normalize();const h=this.a.negate();0<this.normal.dot(h)&&this.normal.negate(this.normal),this.distance=this.normal.dot(this.a)}}class r{constructor(t,i){this.a=t,this.b=i}}var a=s(4415);const c=new e.A,l=new e.A,u=new e.A;class f{constructor(t={}){this.maxIterations=t.maxIterations??50}run(t,i,s,n,e,o,r){const a=this.di(t);for(let t=0;t<this.maxIterations;t++){const t=this.mi(a),c=this.wi(i,s,n,e,o,r,t.normal),l=t.normal.dot(c);if(Math.abs(l-t.distance)<1e-6){const i=this.pi(t);return new h.A(null,null,o,r,i,t.normal,t.distance)}this.gi(a,c)}return null}di(t){if(4!==t.length)throw new Error(`Illegal vertices size: ${v.length}`);const i=t[0],s=t[1],n=t[2],e=t[3];return[new o(i,s,n),new o(i,n,e),new o(i,e,s),new o(s,e,n)]}mi(t){let i=null,s=1/0;for(const n of t)n.distance<s&&(s=n.distance,i=n);return i}wi(t,i,s,n,e,h,o){return e.support(t,s,o,l),o.negate(c),h.support(i,n,c,u),new a.A(l,u)}gi(t,i){const s=[];for(let n=t.length-1;n>=0;n--){const e=t[n];0<e.normal.dot(i.sub(e.a))&&(this.xi(s,new r(e.a,e.b)),this.xi(s,new r(e.b,e.c)),this.xi(s,new r(e.c,e.a)),t.splice(n,1))}for(const n of s)t.push(new o(i,n.a,n.b))}xi(t,i){for(let s=0;s<t.length;s++){const n=t[s];if(i.a===n.a&&i.b===n.b||i.a===n.b&&i.b===n.a)return void t.splice(s,1)}t.push(i)}pi(t){const i=t.a,s=t.b,e=t.c,h=this.Mi(n.VT,i,s,e),{u:o,v:r,w:a}=h.bary,c=i.p1.scale(o).add(s.p1.scale(r)).add(e.p1.scale(a)),l=i.p2.scale(o).add(s.p2.scale(r)).add(e.p2.scale(a));return c.add(l).scale(.5)}Mi(t,i,s,n){const e=s.sub(i),h=n.sub(i),o=t.sub(i),r=e.dot(o),a=h.dot(o);if(r<=0&&a<=0)return{point:i.clone(),bary:{u:1,v:0,w:0}};const c=t.sub(s),l=e.dot(c),u=h.dot(c);if(l>=0&&u<=l)return{point:s.clone(),bary:{u:0,v:1,w:0}};const f=r*u-l*a;if(f<=0&&r>=0&&l<=0){const t=r/(r-l);return{point:i.add(e.scale(t)),bary:{u:1-t,v:t,w:0}}}const d=t.sub(n),v=e.dot(d),m=h.dot(d);if(m>=0&&v<=m)return{point:n.clone(),bary:{u:0,v:0,w:1}};const w=v*a-r*m;if(w<=0&&a>=0&&m<=0){const t=a/(a-m);return{point:i.add(h.scale(t)),bary:{u:1-t,v:0,w:t}}}const p=l*m-v*u;if(p<=0&&u-l>=0&&v-m>=0){const t=(u-l)/(u-l+(v-m));return{point:s.add(n.clone().sub(s).scale(t)),bary:{u:0,v:1-t,w:t}}}const g=1/(p+w+f),x=w*g,M=f*g,S=1-x-M;return{point:i.scale(S).add(s.scale(x)).add(n.scale(M)),bary:{u:S,v:x,w:M}}}}},1184:(t,i,s)=>{s.d(i,{A:()=>l});var n=s(6389),e=s(6101),h=(s(5639),s(5137),s(20),s(4415));const o=new e.A,r=new e.A,a=new e.A,c=new e.A;class l{constructor(){this.direction=new e.A,this.simplex=[]}run(t,i,s,e,h,o){this.simplex=[],t.sub(i,this.direction),this.direction.isZero()&&this.direction.copy(n.NS),this.direction.normalize();for(let n=0;n<50;n++){if(!this.Si(t,i,s,e,h,o))return!1;if(this.yi())return!0}return!1}Si(t,i,s,n,e,c){e.support(t,s,this.direction,o),this.direction.negate(a),c.support(i,n,a,r);const l=new h.A(o,r);return this.simplex.unshift(l),0<this.direction.dot(l)}yi(){const t=this.simplex.length;switch(t){case 1:return this.simplex[0].negate(this.direction),!1;case 2:return this._i();case 3:return this.Pi();case 4:return this.Ai();default:throw new Error(`Illegal simplex size: ${t}`)}}_i(){const t=this.simplex[0],i=this.simplex[1].sub(t),s=t.negate();return i.cross(s,c),c.cross(i,this.direction),this.direction.isZero()&&this.direction.copy(s),!1}Pi(){const t=this.simplex[0],i=this.simplex[1],s=this.simplex[2],n=i.sub(t),e=s.sub(t),h=t.negate();n.cross(e,c);if(c.cross(n).dot(h)<0)return this.simplex.splice(1,1),this._i();if(e.cross(c).dot(h)<0)return this.simplex.splice(2,1),this._i();if(0<=c.dot(h))this.direction.copy(c);else{c.negate(this.direction);const t=this.simplex[1];this.simplex[1]=this.simplex[2],this.simplex[2]=t}return!1}Ai(){const t=this.simplex[0],i=this.simplex[1],s=this.simplex[2],n=this.simplex[3],e=i.sub(t),h=s.sub(t),o=n.sub(t),r=e.cross(h),a=h.cross(o),c=o.cross(e),l=t.negate();let u=0,f=-1;return u<r.dot(l)&&(u=r.dot(l),f=3,this.direction.copy(r)),u<a.dot(l)&&(u=a.dot(l),f=1,this.direction.copy(a)),u<c.dot(l)&&(u=c.dot(l),f=2,this.direction.copy(c)),!(0<=f)||(this.simplex.splice(f,1),!1)}}},4415:(t,i,s)=>{s.d(i,{A:()=>e});var n=s(6101);class e extends n.A{constructor(t,i){super(),this.p1=(new n.A).copy(t),this.p2=(new n.A).copy(i),this.p1.sub(this.p2,this)}}},9691:(t,i,s)=>{s.d(i,{A:()=>a});var n=s(4857),e=(s(6101),s(9248),s(1471)),h=s(4598),o=s(20),r=s(5181);class a extends o.A{constructor(t,i,s={}){super(),this.type=h.kH.CONCAVE,this.triangleCount=i.length/3,this.vertices=t,this.indices=i,this.bvh=new e.Ay;for(let t=0;t<this.triangleCount;t++){const i=new r.A([this.vertices[this.indices[3*t+0]],this.vertices[this.indices[3*t+1]],this.vertices[this.indices[3*t+2]]]);this.bvh.insertObject(i)}}updateAABB(){this.aabb.init(),this.aabb.min.min(this.bvh.root.aabb.min,this.aabb.min),this.aabb.max.max(this.bvh.root.aabb.max,this.aabb.max),this.aabb.updateSurfaceArea()}calculateAABB(t,i,s=new n.A){s.init(),t.add(this.bvh.root.aabb.max,s.max),t.add(this.bvh.root.aabb.min,s.min),s.updateSurfaceArea()}}},5137:(t,i,s)=>{s.d(i,{A:()=>c});var n=s(4857),e=(s(9246),s(6101)),h=s(4598),o=s(20),r=s(5181);const a=new e.A;class c extends o.A{constructor(t,i){super(),this.type=h.kH.CONVEX,this.vertices=t,this.faces=i,this.triangles=[];for(const t of this.faces)this.triangles.push(new r.A([this.vertices[t[0]],this.vertices[t[1]],this.vertices[t[2]]]))}calculateAABB(t,i,s=new n.A){s.max.set(-1/0,-1/0,-1/0),s.min.set(1/0,1/0,1/0);for(const n of this.vertices)i.vmult(n,a),a.add(t,a),s.max.max(a,s.max),s.min.min(a,s.min);return s.updateSurfaceArea(),this.aabb.copy(s),s}support(t,i,s,n=new e.A){let h=-1/0;for(const e of this.vertices){i.vmult(e,a),t.add(a,a);const o=s.dot(a);h<o&&(n.copy(a),h=o)}return n}}},20:(t,i,s)=>{s.d(i,{A:()=>e});var n=s(4857);class e{constructor(){this.type=void 0,this.aabb=new n.A}calculateAABB(t,i,s=new n.A){}}},5177:(t,i,s)=>{s.d(i,{A:()=>u,r:()=>f});var n=s(4857),e=s(9246),h=s(6101),o=s(1471),r=s(4598),a=s(20);new h.A;const c=new h.A,l=new e.A;class u extends a.A{constructor(t={}){super(),this.type=r.kH.SHAPE_GROUP,this.options=t,this.shapes=this.options.shapes??[],this.bvh=new o.Ay;for(const t of this.shapes)this.bvh.insertObject(t)}addShape(t){this.shapes.push(t),this.bvh.insertObject(t)}calculateAABB(t,i,s=new n.A){s.init(),this.bvh.root?(t.add(this.bvh.root.aabb.max,s.max),t.add(this.bvh.root.aabb.min,s.min)):s.setZero(),s.updateSurfaceArea()}}class f extends a.A{constructor(t,i,s,n,o=!0){super(),this.type=r.kH.INSTANCED_SHAPE,this.shape=t,this.position=(new h.A).copy(i),this.quaternion=(new e.A).copy(s),this.scale=n,this.active=!0,this.health=100,this.maxImpulse=4e4,this.destructive=o}updateAABB(){this.shape.calculateAABB(this.position,this.quaternion,this.aabb)}support(t,i,s,n=new h.A){return this.position.add(t,c),this.quaternion.mult(i,l),this.shape.support(c,l,s,n)}}},5172:(t,i,s)=>{s.d(i,{A:()=>o});var n=s(4857),e=(s(6101),s(4598)),h=s(20);class o extends h.A{constructor(t={}){super(),this.type=e.kH.SPHERE,this.radius=t.radius??1}calculateAABB(t,i,s=new n.A){return s.min.set(-this.radius,-this.radius,-this.radius),s.max.set(this.radius,this.radius,this.radius),s.min.add(t,s.min),s.max.add(t,s.max),s.updateSurfaceArea(),s}}},5181:(t,i,s)=>{s.d(i,{A:()=>o});s(9246);var n=s(6101),e=s(20);const h=new n.A;class o extends e.A{constructor(t){super(),this.vertices=t}updateAABB(){this.aabb.init();for(const t of this.vertices)this.aabb.extend(t);this.aabb.updateSurfaceArea()}support(t,i,s,e=new n.A){let o=-1/0;for(const n of this.vertices){i.vmult(n,h),t.add(h,h);const r=s.dot(h);o<r&&(e.copy(h),o=r)}return e}}},4801:(t,i,s)=>{s.d(i,{A:()=>n});class n{constructor(t={}){this.sfxVolume=t.sfxVolume??1,this.bgmVolume=t.bgmVolume??1}}},8871:(t,i,s)=>{s.d(i,{A:()=>h});var n=s(6101);s(2780);const e=new n.A;class h{constructor(t,i){this.min=new n.A,t&&this.min.copy(t),this.max=new n.A,i&&this.max.copy(i)}init(){this.min.set(1/0,1/0,1/0),this.max.set(-1/0,-1/0,-1/0)}calculate(t){this.min.set(1/0,1/0,1/0),this.max.set(-1/0,-1/0,-1/0);const i=t.getAttribute("position");if(i)for(let t=0;t<i.count;t++)i.getValue(t,e),this.min.min(e,this.min),this.max.max(e,this.max)}translate(t){return this.min.add(t,this.min),this.max.add(t,this.max),this}expand(t){return this.min.min(t.min,this.min),this.max.max(t.max,this.max),this}copy(t){this.min.copy(t.min),this.max.copy(t.max)}clone(){return(new this.constructor).copy(this)}}},2318:(t,i,s)=>{s.d(i,{A:()=>n});class n{constructor(t={}){this.invertPitch=t.invertPitch??!1,this.swapThrottleAndYaw=t.swapThrottleAndYaw??!1}}},2577:(t,i,s)=>{s.d(i,{A:()=>o});var n=s(9794);const e=WebGL2RenderingContext;class h extends n.P{constructor(t={}){super(t),this.isDepthTexture=!0,this.internalFormat=t.internalFormat??e.DEPTH_COMPONENT32F,this.format=t.format??e.DEPTH_COMPONENT,this.type=t.type??e.FLOAT,this.generateMipmap=t.generateMipmap??!1,this.needsUpdate=!0}}class o{constructor(t={}){this.config=t,this.count=t.count??1,this.width=t.width??1,this.height=t.height??1,this.currentLevel=0,this.maxLevel=Math.log2(this.width)+1,this.useDepthBuffer=t.useDepthBuffer??!0,this.depthTexture=null,this.Di(t),this.frameBuffer=null,this.drawBuffers=null,this.multisampling=t.multisampling??!1,this.needsUpdate=!0}Di(t){this.et(t),this.ht(t)}et(t){this.textures=[];for(let i=0;i<(t.count??1);i++)this.textures.push(new n.P(t));this.texture=this.textures[0]}ht(t){this.useDepthBuffer&&(this.depthTextureConfig=t.depthTexture??{},this.depthTextureConfig.width=this.depthTextureConfig.width??this.width,this.depthTextureConfig.height=this.depthTextureConfig.height??this.height,this.depthTexture=new h(this.depthTextureConfig))}addTexture(t){this.textures.push(t)}setSize(t,i){this.width=t,this.height=i;for(const s of this.textures)s.width=t,s.height=i;this.depthTexture&&(this.depthTexture.width=t,this.depthTexture.height=i),this.needsUpdate=!0}}},9794:(t,i,s)=>{s.d(i,{P:()=>h});var n=s(1649);const e=WebGL2RenderingContext;class h extends n.A{constructor(t={}){super(t),this.isFramebufferTexture=!0,this.magFilter=t.magFilter??e.NEAREST,this.minFilter=t.minFilter??e.NEAREST,this.wrapS=t.wrapS??e.CLAMP_TO_EDGE,this.wrapT=t.wrapT??e.CLAMP_TO_EDGE,this.internalFormat=t.internalFormat??e.RGBA32F,this.format=t.format??e.RGBA,this.type=t.type??e.FLOAT,this.generateMipmap=t.generateMipmap??!1,this.needsUpdate=!0}}},2780:(t,i,s)=>{s.d(i,{A:()=>o});var n=s(6101),e=s(8871);s(1235);const h=new n.A;class o{constructor(t,i){this.attributes=t??{},this.indices=i,this.boundingRadius=-1,this.vertexArrays=new Map,this.boundingBox=new e.A,this.needsUpdate=!1}setAttribute(t,i){this.attributes[t]=i}getAttribute(t){return this.attributes[t]}setIndices(t){this.indices=t}getIndices(){return this.indices}computeBoundingRadius(){const t=this.attributes.position;if(!t)return;let i=0;for(let s=0;s<t.count;s++){t.getValue(s,h);const n=h.length();i<n&&(i=n)}return this.boundingRadius=i,this.boundingRadius}translate(t,i,s){const n=this.attributes.position;if(n)for(let e=0;e<n.count;e++)n.getValue(e,h),n.setXYZ(e,h.x+t,h.y+i,h.z+s)}calculateBoundingBox(){this.boundingBox.calculate(this)}}},6527:(t,i,s)=>{s.d(i,{Ay:()=>r,cj:()=>h,hw:()=>e,uG:()=>o});var n=s(6389);const e=8e3,h=16e3,o=32e3;class r{constructor(t={}){this.shaderType=t.shaderType??n.$g,this.useCSM=t.useCSM??!0,this.useGTAO=t.useGTAO??!0,this.terrainQuality=t.terrainQuality??n.Ls,this.groundObjectsDrawDistance=t.groundObjectsDrawDistance??n.GK,this.drawGrasses=t.drawGrasses??!0,this.volumetricCloudsQuality=t.volumetricCloudsQuality??n.$o,this.useBloom=t.useBloom??!0,this.viewDistance=t.viewDistance??h}}},6585:(t,i,s)=>{s.d(i,{A:()=>c});var n=s(6389),e=s(1992),h=s(9246),o=s(6101),r=s(8871);s(2780),s(649);const a=new r.A;class c{constructor(t={}){this.isStatic=t.isStatic??!1,this.name=t.name,this.position=new o.A,t.position&&this.position.copy(t.position),this.quaternion=new h.A,t.quaternion?this.quaternion.copy(t.quaternion):this.quaternion.setFromAxisAngle(n.OX,0),this.scale=new o.A(1,1,1),t.scale&&this.scale.copy(t.scale),this.worldPosition=new o.A,this.frustumCulled=t.frustumCulled??!0,this.boundingRadius=t.boundingRadius??-1,this.renderDistance=t.renderDistance??1/0,this.matrix=new e.A,this.modelMatrix=new e.A,this.parent=null,this.children=[],this.visible=t.visible??!0,this.boundingBox=new r.A,this.boundingBoxNeedsUpdate=!0,this.lods=[],this.drawDistance=t.drawDistance??1/0}updateModelMatrix(){if(!this.isStatic||!this.modelMatrixUpdated){this.matrix.compose(this.position,this.quaternion,this.scale),this.parent?this.parent.modelMatrix.mult(this.matrix,this.modelMatrix):this.modelMatrix.copy(this.matrix),this.worldPosition.set(this.modelMatrix.elements[12],this.modelMatrix.elements[13],this.modelMatrix.elements[14]);for(const t of this.children)t.updateModelMatrix();this.modelMatrixUpdated=!0}}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale)}add(t){0<=this.children.indexOf(t)||(t.parent&&t.parent.remove(t),this.computeBoundingRadius(t),this.children.push(t),t.parent=this)}computeBoundingRadius(t){t.geometry?.boundingRadius<0&&t.geometry.computeBoundingRadius();for(const i of t.children)this.computeBoundingRadius(i)}addLod(t){this.lods.push(t)}remove(t){const i=this.children.indexOf(t);i<0||(this.children.splice(i,1),t.parent=null)}copy(t,i=!0){this.isStatic=t.isStatic,this.name=t.name,this.position.copy(t.position),this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.worldPosition.copy(t.worldPosition),this.frustumCulled=t.frustumCulled,this.boundingRadius=t.boundingRadius,this.renderDistance=t.renderDistance,this.castShadow=t.castShadow,this.matrix.copy(t.matrix),this.modelMatrix.copy(t.modelMatrix),this.visible=t.visible,this.boundingBox.copy(t.boundingBox),this.drawDistance=t.drawDistance;for(const i of t.lods)this.addLod(i);if(i)for(const i of t.children)this.add(i.clone());return this}calculateBoundingBox(){this.boundingBox.init(),this.geometry&&(this.geometry.calculateBoundingBox(),this.boundingBox.copy(this.geometry.boundingBox),this.boundingBox.translate(this.position));for(const t of this.children)t.calculateBoundingBox(),a.copy(t.boundingBox),a.translate(this.position),this.boundingBox.expand(a)}clone(t=!0){return(new this.constructor).copy(this,t)}}},649:(t,i,s)=>{s.d(i,{Ay:()=>a,Q3:()=>o,c0:()=>h,gg:()=>e,vU:()=>r});var n=s(6389);const e=0,h=1,o=2,r=0;class a{constructor(t={}){this.options=t,this.name=t.name??"Material",this.init(t),this.vertSource=this.getVertSource(),this.fragSource=this.getFragSource(),this.uniforms=this.getUniforms(t),this.depthTest=t.depthTest??!0,this.depthWrite=t.depthWrite??!0,this.transparent=t.transparent??!1,this.polygonOffset=t.polygonOffset??0,this.renderingPass=t.renderingPass??n.he,this.blending=null,this.program=null,this.side=t.side??e}init(t){}getVertSource(){}getFragSource(){}getUniforms(){}clone(){const t=new this.constructor(this.options);return t.uniforms=structuredClone(this.uniforms),t}}},7133:(t,i,s)=>{s.d(i,{A:()=>h});s(2780);var n=s(6585),e=(s(649),s(8608));s(9459);class h extends n.A{constructor(t,i,s={}){super(s),this.isMesh=!0,this.geometry=t,this.material=i,this.shadowMaterial=s.shadowMaterial??new e.A(this.material.config)}copy(t,i=!0){return super.copy(t,i),this.geometry=t.geometry,this.material=t.material,this.shadowMaterial=t.shadowMaterial,this}clone(t=!0){return new this.constructor(this.geometry,this.material).copy(this,t)}draw(t,i){t.draw(this,i)}}},8633:(t,i,s)=>{s.d(i,{A:()=>a});var n=s(2780),e=(s(649),s(5284)),h=s(7133),o=s(1235);s(9459);const r=WebGL2RenderingContext;class a{constructor(t){this.geometry=function(t=1){const i=[-1*t,3*t,0,-1*t,-1*t,0,3*t,-1*t,0],s=[0,2,0,0,2,0],e={position:new o.A(new Float32Array(i),3,r.FLOAT),uv:new o.A(new Float32Array(s),2,r.FLOAT)};return new n.A(e,null)}(),this.material=t??new e.A,this.mesh=new h.A(this.geometry,this.material)}setMaterial(t){this.material=t,this.mesh.material=t}render(t){t.draw(this.mesh)}}},4867:(t,i,s)=>{s.d(i,{AH:()=>h,SY:()=>o,mz:()=>n});const n="\n    precision mediump sampler3D;\n    precision mediump sampler2DArray;\n    \n    const float PI = 3.14159265358979323846;\n\n    const float METERS_TO_KMS = 0.001;\n\n",e="\n    vec2 getUV(float cosTheta, float height) {\n        return vec2(\n            cosTheta * 0.5 + 0.5,\n            height / (atmosphereProfile.outerRadius - atmosphereProfile.innerRadius)\n        );\n    }\n\n    vec2 getAngleAndHeight(vec2 uv) {\n        return vec2(\n            uv.x * 2.0 - 1.0,\n            (atmosphereProfile.outerRadius - atmosphereProfile.innerRadius) * uv.y\n        );\n    }\n\n",h=`\n    const vec3 RAYLEIGH_SCATTERING = vec3(5.802, 13.558, 33.1) * METERS_TO_KMS;\n\n    const vec3 MIE_SCATTERING = vec3(3.996) * METERS_TO_KMS;\n    const vec3 MIE_ABSORPTION = vec3(4.4) * METERS_TO_KMS * 0.0;\n\n    const vec3 OZONE_ABSORPTION = vec3(0.650, 1.881, 0.085) * METERS_TO_KMS;\n    const float OZONE_CENTER_SCALE_HEIGHT = 0.25;\n\n    const int NUM_SAMPLE_STEPS = 128;\n    const float INV_NUM_SAMPLE_STEPS = 1.0 / float(NUM_SAMPLE_STEPS);\n\n    const int SQRT_NUM_SAMPLE_DIRECTIONS = 8;\n\n    const int NUM_SAMPLE_DIRECTIONS = SQRT_NUM_SAMPLE_DIRECTIONS * SQRT_NUM_SAMPLE_DIRECTIONS;\n    const float INV_NUM_SAMPLE_DIRECTIONS = 1.0 / float(NUM_SAMPLE_DIRECTIONS);\n\n    struct AtmosphereProfile {\n        float innerRadius;\n        float outerRadius;\n        float rayleighIntensity;\n        float mieIntensity;\n        float rayleighScaleHeight;\n        float mieScaleHeight;\n        vec3 sunDirection;\n        vec3 sunIrradiance;\n        vec3 groundAlbedo;\n\n        sampler2D tTransmittance;\n        sampler2D tInscattering;\n        sampler2D tAverageColor;\n        sampler2D tIrradiance;\n        sampler2D tReflection;\n\n        sampler3D tAirealScattering;\n        sampler3D tAirealTransmittance;\n        \n        float maxMipLevel;\n\n        vec3 invTextureResolution3D;\n    };\n\n    uniform AtmosphereProfile atmosphereProfile;\n\n    ${e}\n\n    struct IntegrationResult {\n        vec3 inScatter;\n        vec4 transmittance;\n        vec3 transferRate;\n    };\n\n    struct MediumProfile {\n        vec3 scattering;\n        vec3 extinction;\n    };\n\n    vec3 getPoissonSampleDirection(int i) {\n        int x = i / SQRT_NUM_SAMPLE_DIRECTIONS;\n        int y = i % SQRT_NUM_SAMPLE_DIRECTIONS;\n\n        vec2 coord = (vec2(float(x) + 0.5, float(y) + 0.5)) / float(SQRT_NUM_SAMPLE_DIRECTIONS);\n\n        float theta = 2.0 * PI * coord.x;\n        float z = 1.0 - 2.0 * coord.y;\n        float r = sqrt(max(0.0, 1.0 - z * z));\n\n        return vec3(r * cos(theta), r * sin(theta), z);\n    }\n\n    MediumProfile sampleMedium(float height) {\n        float scale = 1.0 / (atmosphereProfile.outerRadius - atmosphereProfile.innerRadius);\n\n        float rayleighDensity = exp(-height / atmosphereProfile.rayleighScaleHeight) * atmosphereProfile.rayleighIntensity;\n        float mieDensity = exp(-height / atmosphereProfile.mieScaleHeight) * atmosphereProfile.mieIntensity;\n        float ozoneDensity = max(0.0, 1.0 - abs((height * scale - OZONE_CENTER_SCALE_HEIGHT) / 0.15));\n        \n        vec3 scattering = RAYLEIGH_SCATTERING * rayleighDensity + MIE_SCATTERING * mieDensity;\n        vec3 extinction = RAYLEIGH_SCATTERING * rayleighDensity + (MIE_SCATTERING + MIE_ABSORPTION) * mieDensity + OZONE_ABSORPTION * ozoneDensity;\n        return MediumProfile(scattering, extinction);\n    }\n\n    vec4 getTransmittance(float cosTheta, float viewHeight) {\n        vec2 uv = getUV(cosTheta, viewHeight);\n        return texture(atmosphereProfile.tTransmittance, uv);\n    }\n\n    vec3 getSunIrradiance(float sunAngle, float viewHeight) {\n        vec4 transmittance = getTransmittance(sunAngle, viewHeight);\n        return atmosphereProfile.sunIrradiance * transmittance.rgb * transmittance.a;\n    }\n\n    vec3 getAverageColor(float viewAngle, float viewHeight) {\n        vec2 uv = getUV(viewAngle, viewHeight);\n        return texture(atmosphereProfile.tAverageColor, uv).rgb;\n    }\n\n    vec3 getIncattering(float sunAngle, float viewHeight) {\n        vec2 uv = getUV(sunAngle, viewHeight);\n        return texture(atmosphereProfile.tInscattering, uv).rgb;\n    }\n\n    float getDistanceToSphere(vec3 position, vec3 direction, float radius) {\n        float a = 2.0 * dot(position, direction);\n        float b = dot(position, position) - radius * radius;\n\n        float discriminant = a * a - 4.0 * b;\n        if (discriminant < 0.0) return -1.0;\n\n        float t1 = (-a - sqrt(discriminant)) / 2.0;\n        float t2 = (-a + sqrt(discriminant)) / 2.0;\n\n        return (0.0 < t1 && 0.0 < t2) ? min(t1, t2) : max(t1, t2);\n    }\n\n    float getBoundaryDistance(vec3 position, vec3 direction, out float skyVisibility) {\n        skyVisibility = 0.0;\n        float distance = getDistanceToSphere(position, direction, atmosphereProfile.innerRadius);\n        if (distance < 0.0) {\n            skyVisibility = 1.0;\n            distance = getDistanceToSphere(position, direction, atmosphereProfile.outerRadius);\n        }\n        return distance;\n    }\n\n    IntegrationResult integrate(vec3 viewPosition, vec3 viewDirection, vec3 sunDirection) {\n        float skyVisibility;\n        float boundaryDistance = getBoundaryDistance(viewPosition, viewDirection, skyVisibility);\n        \n        float sampleLength = boundaryDistance / float(NUM_SAMPLE_STEPS);\n\n        vec3 sampleRay = viewDirection * sampleLength;\n        vec3 samplePoint = viewPosition + sampleRay * 0.5;\n\n        vec3 totalInScatter = vec3(0.0);\n        vec3 transmittance = vec3(1.0);\n        vec3 transferRate = vec3(0.0);\n\n        for (int i = 0; i < NUM_SAMPLE_STEPS; i++) {\n            float r = length(samplePoint);\n            float sampleHeight = r - atmosphereProfile.innerRadius;\n\n            MediumProfile medium = sampleMedium(sampleHeight);\n\n            vec3 sampleTransmittance = exp(-medium.extinction * sampleLength);\n            vec3 sampleScattering = (medium.scattering / medium.extinction) * (1.0 - sampleTransmittance);\n            // vec3 sampleScattering = (medium.scattering - medium.scattering * sampleTransmittance) / medium.extinction;\n\n            float sunAngle = dot(samplePoint, sunDirection) / r;\n            float viewAngle = dot(samplePoint, viewDirection) / r;\n            \n            #ifdef SAMPLE_SINGLE_SCATTERING\n                vec4 sunTransmittance = getTransmittance(sunAngle, sampleHeight);\n                vec3 sunIrradianceReached = atmosphereProfile.sunIrradiance * sunTransmittance.rgb * sunTransmittance.a;\n                totalInScatter += sunIrradianceReached * sampleScattering * transmittance / (4.0 * PI);\n            #endif\n\n            #ifdef SAMPLE_STAR_LIGHTS\n                vec3 starIrradiance = getStarIrradiance(viewAngle, sampleHeight);\n                totalInScatter += starIrradiance * sampleScattering * transmittance;\n            #endif\n\n            #ifdef SAMPLE_MULTIPLE_SCATTERING\n                vec3 multipleScattering = getIncattering(sunAngle, sampleHeight);\n                totalInScatter += sampleScattering * multipleScattering * transmittance;\n            #endif\n\n            transferRate += sampleScattering * transmittance;\n            transmittance *= sampleTransmittance;\n            \n            samplePoint += sampleRay;\n        }\n\n        #ifdef SAMPLE_GROUND\n            if (skyVisibility < 1.0) {\n                vec3 groundPosition = viewPosition + viewDirection * boundaryDistance;\n                float sunCosTheta = dot(groundPosition, sunDirection) / length(groundPosition);\n\n                vec3 sunIrradiance = getSunIrradiance(sunCosTheta, 0.0) * max(sunCosTheta, 0.0) / PI;\n\n                totalInScatter += sunIrradiance * atmosphereProfile.groundAlbedo * transmittance.rgb;\n\n                #ifdef SAMPLE_MULTIPLE_SCATTERING\n                    vec3 multipleScattering = getIncattering(sunCosTheta, 0.0);\n                    totalInScatter += multipleScattering * atmosphereProfile.groundAlbedo * transmittance.rgb;\n                #endif\n            }\n        #endif\n\n        return IntegrationResult(\n            totalInScatter,\n            vec4(transmittance, skyVisibility),\n            transferRate\n        );\n    }\n\n    IntegrationResult integrate(vec3 viewPosition, vec3 viewDirection) {\n        return integrate(viewPosition, viewDirection, atmosphereProfile.sunDirection);\n    }\n\n`,o=`\n    struct AtmosphereProfile {\n        float innerRadius;\n        float outerRadius;\n        float rayleighIntensity;\n        float mieIntensity;\n        float rayleighScaleHeight;\n        float mieScaleHeight;\n        vec3 sunDirection;\n        vec3 sunIrradiance;\n        vec3 groundAlbedo;\n\n        sampler2DArray tAtmosphere;\n        sampler2D tReflection;\n\n        sampler3D tAirealScattering;\n        sampler3D tAirealTransmittance;\n        \n        float maxMipLevel;\n\n        vec3 invTextureResolution3D;\n    };\n\n    uniform AtmosphereProfile atmosphereProfile;\n\n    ${e}\n\n    void getAirealScattering(\n            float viewAngle,\n            float viewHeight,\n            float distance,\n            out vec3 totalInScatter,\n            out vec3 transmittance) {\n        vec2 uv = getUV(viewAngle, viewHeight);\n        uv.y += atmosphereProfile.invTextureResolution3D.y * 0.5;\n        totalInScatter = texture(atmosphereProfile.tAirealScattering, vec3(uv, distance / 30.0)).rgb;\n        transmittance = texture(atmosphereProfile.tAirealTransmittance, vec3(uv, distance / 30.0)).rgb;\n    }\n\n    vec4 getTransmittance(float cosTheta, float viewHeight) {\n        vec2 uv = getUV(cosTheta, viewHeight);\n        return texture(atmosphereProfile.tAtmosphere, vec3(uv, 0.0));\n    }\n\n    vec3 getSunIrradiance(float viewHeight) {\n        vec4 transmittance = getTransmittance(atmosphereProfile.sunDirection.y, viewHeight);\n        return atmosphereProfile.sunIrradiance * transmittance.rgb * transmittance.a;\n    }\n\n    vec3 getSkyIrradiance(float cosTheta, float viewHeight) {\n        vec2 uv = getUV(cosTheta, viewHeight);\n        return texture(atmosphereProfile.tAtmosphere, vec3(uv, 2.0)).rgb;\n    }\n\n    vec3 getInscattering(float viewHeight) {\n        vec2 uv = getUV(atmosphereProfile.sunDirection.y, viewHeight);\n        return texture(atmosphereProfile.tAtmosphere, vec3(uv, 1.0)).rgb;\n    }\n\n    vec3 getSkyReflection(float reflectionAngle, float viewHeight, float roughness) {\n        vec2 uv = getUV(reflectionAngle, viewHeight);\n        return textureLod(atmosphereProfile.tReflection, uv, roughness * atmosphereProfile.maxMipLevel).rgb;\n    }\n\n`},1649:(t,i,s)=>{s.d(i,{A:()=>e});const n=WebGL2RenderingContext;class e{constructor(t={}){this.isTexture=!0,this.target=n.TEXTURE_2D,this.width=t.width??1,this.height=t.height??1,this.magFilter=t.magFilter??n.LINEAR,this.minFilter=t.minFilter??n.LINEAR_MIPMAP_NEAREST,this.wrapS=t.wrapS??n.REPEAT,this.wrapT=t.wrapT??n.REPEAT,this.format=t.format??n.RGBA,this.internalFormat=t.internalFormat??n.SRGB8_ALPHA8,this.type=t.type??n.UNSIGNED_BYTE,this.image=t.image??null,this.pixels=t.pixels??null,this.generateMipmap=t.generateMipmap??!0,this.needsUpdate=!0,this.texture=null,this.multisampling=t.multisampling??!1,this.anisotropy=t.anisotropy??0}}},2036:(t,i,s)=>{s.d(i,{A:()=>h});var n=s(1649);const e=WebGL2RenderingContext;class h extends n.A{constructor(t={}){super(t),this.isTextureArray=!0,this.target=e.TEXTURE_2D_ARRAY,this.layers=t.layers??1}}},1235:(t,i,s)=>{s.d(i,{A:()=>n});s(6101);class n{constructor(t,i,s,n){this.array=t,this.stride=i,this.count=this.array.length/this.stride,this.type=s,this.divider=n,this.buffer=null,this.needsUpdate=!1}getValue(t,i){i.set(this.array[this.stride*t+0],this.array[this.stride*t+1],this.array[this.stride*t+2])}setValue(t,i){this.array[t]=i}setX(t,i){this.array[t]=i}getX(t){return this.array[t]}setXY(t,i,s){this.array[2*t+0]=i,this.array[2*t+1]=s}setVec2(t,i){this.setXY(t,i.x,i.y)}setXYZ(t,i,s,n){this.array[3*t+0]=i,this.array[3*t+1]=s,this.array[3*t+2]=n}setVec3(t,i){this.setXYZ(t,i.x,i.y,i.z)}setXYZW(t,i,s,n,e){this.array[4*t+0]=i,this.array[4*t+1]=s,this.array[4*t+2]=n,this.array[4*t+3]=e}setVec4(t,i){this.setXYZW(t,i.x,i.y,i.z,i.w)}}},9459:(t,i,s)=>{s.d(i,{A:()=>M});var n=s(1992),e=s(832);class h{constructor(t,i,s,n){this.name=t,this.type=i,this.size=s,this.location=n}}s(3739),s(2577),s(2780);var o=s(649);s(7133);class r{constructor(t,i,s,n){this.program=t,this.attributeLocations=i,this.attributes=s,this.uniforms=n}}class a{constructor(t,i,s){this.name=t,this.type=i,this.location=s,this.cache=null,this.keys=this.name.split(".")}setValue(t,i){}}class c extends a{constructor(t,i,s){super(t,i,s),this.cache=void 0}setValue(t,i){i!==this.cache&&(t.uniform1f(this.location,i),this.cache=i)}}class l extends c{constructor(t,i,s){super(t,i,s),this.elements=[]}setValue(t,i){let s=!0;this.elements.length!==i.length&&(s=!1,this.elements=[]);for(let t=0;t<i.length;t++)this.elements[t]!==i[t]&&(this.elements[t]=i[t],s=!1);s||t.uniform1fv(this.location,this.elements)}}class u extends a{constructor(t,i,s){super(t,i,s),this.cache=[]}setValue(t,i){this.canUseCache(i.elements)||t.uniformMatrix4fv(this.location,!1,i.elements)}canUseCache(t){let i=!0;for(let s=0;s<16;s++)t[s]!==this.cache[s]&&(this.cache[s]=t[s],i=!1);return i}}class f extends u{constructor(t,i,s){super(t,i,s),this.elements=[]}setValue(t,i){let s=!0;this.elements.length!==16*i.length&&(s=!1,this.elements=[]);for(let t=0;t<i.length;t++)for(let n=0;n<16;n++){const e=i[t].elements[n];this.elements[16*t+n]!==e&&(this.elements[16*t+n]=e,s=!1)}s||t.uniformMatrix4fv(this.location,!1,this.elements)}}class d extends a{constructor(t,i,s){super(t,i,s)}setValue(t,i){i!=this.cache&&(t.uniform1i(this.location,i),this.cache=i)}}class v extends a{constructor(t,i,s){super(t,i,s),this.cache={}}setValue(t,i){t.uniform2f(this.location,i.x,i.y)}}class m extends a{constructor(t,i,s){super(t,i,s),this.cache={}}setValue(t,i){t.uniform3f(this.location,i.x,i.y,i.z)}}class w extends a{constructor(t,i,s){super(t,i,s),this.cache={}}setValue(t,i){t.uniform3i(this.location,i.x,i.y,i.z)}}class p extends a{constructor(t,i,s){super(t,i,s),this.cache={}}setValue(t,i){i.x===this.cache.x&&i.y===this.cache.y&&i.z===this.cache.z&&i.w===this.cache.w||(t.uniform4f(this.location,i.x,i.y,i.z,i.w),this.cache.x=i.x,this.cache.y=i.y,this.cache.z=i.z,this.cache.w=i.w)}}s(1235);const g=WebGL2RenderingContext,x=new n.A;class M{constructor(t,i={}){this.gl=t,this.options=i,this.qi(),this.Ti(),this.Ei(),this.Ci(),this.activeTextureUnit=0,this.programs={},this.currentShaderId=0,this.shaderIds={},this.uniformCache=[],this.currentProgram=null,this.currentDepthTest=!0,this.currentDepthWrite=!0,this.currentTransparent=!1,this.currentBlending=null,this.currentPolygonOffset=0,this.currentSide=o.gg}qi(){const t=this.gl;t.getExtension("EXT_color_buffer_float")||window.debug("Error: EXT_color_buffer_float is not supported on your browser.");t.getExtension("OES_texture_float_linear")||window.debug("Error: OES_texture_float_linear is not supported on your browser.");t.getExtension("EXT_float_blend")||window.debug("Error: EXT_float_blend is not supported on your browser."),this.extAnisotropy=t.getExtension("EXT_texture_filter_anisotropic"),this.extAnisotropy?this.maxAnisotropy=t.getParameter(this.extAnisotropy.MAX_TEXTURE_MAX_ANISOTROPY_EXT):console.log("Warning: EXT_texture_filter_anisotropic is not supported on your browser.")}Ti(){const t=this.gl,i=(t.getParameter(t.MAX_TEXTURE_SIZE),t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),t.getParameter(t.MAX_3D_TEXTURE_SIZE),t.getParameter(t.MAX_ARRAY_TEXTURE_LAYERS),t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),t.getParameter(t.MAX_DRAW_BUFFERS));i<5&&window.debug(`Error: MAX_DRAW_BUFFERS (${i}) is less than 5`)}Ei(){this.clearColor=new e.A,this.options.clearColor&&this.clearColor.copy(this.options.clearColor),this.depthTest=this.options.depthTest??!0,this.depthFunc=this.options.depthFunc??g.LEQUAL,this.clearDepth=this.options.clearDepth??1}Ci(){const t=this.gl;t.clearColor(this.clearColor.x,this.clearColor.y,this.clearColor.z,this.clearColor.w),t.clearDepth(this.clearDepth),this.depthTest&&(t.enable(t.DEPTH_TEST),t.depthFunc(this.depthFunc)),t.enable(t.CULL_FACE)}draw(t,i,s=i?.position,n=!1){let e=null,h=1/0;if(s){const i=t.worldPosition.distanceTo(s);for(const s of t.lods)s.distance<i&&s.distance<h&&(e=s)}const o=e?.geometry??t.geometry,r=n?e?.shadowMaterial??t.shadowMaterial:e?.material??t.material,a=this.bi(r);this.currentProgram!=a&&(this.gl.useProgram(a.program),this.currentProgram=a);let c=o.vertexArrays.get(a);if(c||(c=this.Ui(o,a),o.vertexArrays.set(a,c)),this.gl.bindVertexArray(c),o.needsUpdate){for(const t in o.attributes){const i=o.attributes[t];i.needsUpdate&&(this.gl.bindBuffer(g.ARRAY_BUFFER,i.buffer),this.gl.bufferSubData(g.ARRAY_BUFFER,0,i.array),i.needsUpdate=!1)}o.needsUpdate=!1}this.Ni(r.uniforms,a.uniforms,t,i),this.Ri(r,t),o.indices?this.Ii(o):this.zi(o)}Ii(t){const i=t.indices;i.buffer||(i.buffer=this.Li(i,!0)),this.gl.bindBuffer(g.ELEMENT_ARRAY_BUFFER,i.buffer),t.isInstanced?this.gl.drawElementsInstanced(g.TRIANGLES,i.count,i.type,0,t.instanceCount):this.gl.drawElements(g.TRIANGLES,i.count,i.type,0)}zi(t){const i=t.attributes[Object.keys(t.attributes)[0]];if(!i)throw new Error("No attribute found.");const s=i.array.length/i.stride;t.isInstanced?this.gl.drawArraysInstanced(g.TRIANGLE_STRIP,0,s,t.instanceCount):this.gl.drawArrays(g.TRIANGLE_STRIP,0,s)}drawShadow(t,i,s){t.frustumCulled&&!i.frustum.test(t.worldPosition,t.geometry.boundingRadius)||this.draw(t,i,s,!0)}drawRecursive(t,i,s){if(t.visible){t.geometry&&t.material&&this.draw(t,i,s);for(const n of t.children)this.drawRecursive(n,i,s)}}Ui(t,i){const s=this.gl,n=s.createVertexArray();s.bindVertexArray(n);const e=i.attributes;for(const i of e){const n=t.attributes[i.name];n&&(n.buffer||this.Li(n),s.bindBuffer(g.ARRAY_BUFFER,n.buffer),s.enableVertexAttribArray(i.location),s.vertexAttribPointer(i.location,n.stride,n.type,!1,0,0),n.divider&&s.vertexAttribDivisor(i.location,n.divider))}return s.bindVertexArray(null),n}Ri(t,i){const s=this.gl;t.polygonOffset!==this.currentPolygonOffset&&(t.polygonOffset?(s.enable(g.POLYGON_OFFSET_FILL),s.polygonOffset(t.polygonOffset,0)):s.disable(g.POLYGON_OFFSET_FILL),this.currentPolygonOffset=t.polygonOffset),t.depthTest!==this.currentDepthTest&&(t.depthTest?s.enable(g.DEPTH_TEST):s.disable(g.DEPTH_TEST),this.currentDepthTest=t.depthTest),t.depthWrite!==this.currentDepthWrite&&(t.depthWrite?s.depthMask(1):s.depthMask(0),this.currentDepthWrite=t.depthWrite),t.transparent===this.currentTransparent&&t.blending===this.currentBlending||(t.transparent||t.blending?(s.enable(g.BLEND),t.blending===o.vU?s.blendFunc(g.ONE,g.ONE):s.blendFunc(g.SRC_ALPHA,g.ONE_MINUS_SRC_ALPHA)):s.disable(g.BLEND),this.currentBlending=t.blending,this.currentTransparent=t.transparent),t.side!==this.currentSide&&(t.side===o.c0?s.disable(g.CULL_FACE):s.enable(g.CULL_FACE),t.side===o.Q3?s.frontFace(g.CW):s.frontFace(g.CCW),this.currentSide=t.side)}clear(){this.gl.depthMask(1),this.gl.clear(g.COLOR_BUFFER_BIT|g.DEPTH_BUFFER_BIT|g.STENCIL_BUFFER_BIT)}flush(){this.gl.flush()}Ni(t,i,s,n){const e=this.gl;this.activeTextureUnit=0;for(const h of i){const i=h.keys;let o=t[i[0]];for(let t=1;t<i.length&&void 0!==o;t++){o=o[i[t]]}if(h.type==g.SAMPLER_2D||h.type==g.SAMPLER_2D_SHADOW||h.type==g.SAMPLER_2D_ARRAY||h.type==g.SAMPLER_2D_ARRAY_SHADOW||h.type==g.SAMPLER_3D){const t=this.Fi(o);h.setValue(e,t);continue}switch(h.name){case"modelViewMatrix":o=n.viewMatrix.mult(s.modelMatrix,x);break;case"modelMatrix":o=s.modelMatrix;break;case"viewMatrix":o=n.viewMatrix;break;case"projectionMatrix":o=n.projectionMatrix;break;case"invProjectionMatrix":o=n.invProjectionMatrix;break;case"cameraPosition":o=n.position;break;case"depthScale":o=n.far-n.near;break;case"aspectRatio":o=window.innerWidth/window.innerHeight}null!=o&&h.setValue(this.gl,o)}}Fi(t){if(t){const i=t.target,s=t.texture??this.Oi(t);this.gl.activeTexture(g.TEXTURE0+this.activeTextureUnit),this.gl.bindTexture(i,s),t.needsUpdate&&this.Vi(t,!1)}return this.activeTextureUnit++}Oi(t){const i=this.gl,s=i.createTexture();return t.texture=s,this.Vi(t,!0),i.bindTexture(t.target,null),s}Vi(t,i=!1){const s=this.gl,n=t.target,e=t.texture;if(s.bindTexture(n,e),i&&(n===g.TEXTURE_2D_ARRAY||n===g.TEXTURE_3D?s.texImage3D(n,0,t.internalFormat,t.width,t.height,t.layers,0,t.format,t.type,null):t.image?s.texImage2D(n,0,t.internalFormat,t.format,t.type,t.image):s.texImage2D(n,0,t.internalFormat,t.width,t.height,0,t.format,t.type,t.pixels)),s.texParameteri(n,g.TEXTURE_MIN_FILTER,t.minFilter),s.texParameteri(n,g.TEXTURE_MAG_FILTER,t.magFilter),s.texParameteri(n,g.TEXTURE_WRAP_S,t.wrapS),s.texParameteri(n,g.TEXTURE_WRAP_T,t.wrapT),n==g.TEXTURE_3D&&s.texParameteri(n,g.TEXTURE_WRAP_R,t.wrapR),t.isTextureArrayShadow&&(s.texParameteri(n,g.TEXTURE_COMPARE_MODE,g.COMPARE_REF_TO_TEXTURE),s.texParameteri(n,g.TEXTURE_COMPARE_FUNC,g.LEQUAL)),t.anisotropy&&this.extAnisotropy){const i=Math.min(this.maxAnisotropy,t.anisotropy);s.texParameteri(n,this.extAnisotropy.TEXTURE_MAX_ANISOTROPY_EXT,i)}t.generateMipmap&&s.generateMipmap(n),t.needsUpdate=!1}bi(t){if(t.program)return t.program;const i=t.getVertSource(),s=t.getFragSource(),n=[this.ki(i),this.ki(s)];let e=this.programs[n];return e&&e.program||(e=this.Gi(i,s),this.programs[n]=e),t.program=e,e}ki(t){let i=this.shaderIds[t];return i||(i=this.currentShaderId++,this.shaderIds[t]=i),i}Gi(t,i){const s=this.gl,n=this.Hi(g.VERTEX_SHADER,t),e=this.Hi(g.FRAGMENT_SHADER,i),o=s.createProgram();if(s.attachShader(o,n),s.attachShader(o,e),s.linkProgram(o),!s.getProgramParameter(o,g.LINK_STATUS))return console.error(s.getProgramInfoLog(o)),null;const a={},c=[],l=s.getProgramParameter(o,g.ACTIVE_ATTRIBUTES);for(let t=0;t<l;t++){const i=s.getActiveAttrib(o,t),n=s.getAttribLocation(o,i.name);a[i.name]=n;const e=new h(i.name,i.type,i.size,n);c.push(e)}const u=[],f=s.getProgramParameter(o,g.ACTIVE_UNIFORMS);for(let t=0;t<f;t++){const i=s.getActiveUniform(o,t),n=s.getUniformLocation(o,i.name),e=this.ji(i.name,i.type,n);u.push(e)}return new r(o,a,c,u)}Hi(t,i){const s=this.gl,n=s.createShader(t);return s.shaderSource(n,i),s.compileShader(n),s.getShaderParameter(n,s.COMPILE_STATUS)?n:(console.error(s.getShaderInfoLog(n)),console.error(i),s.deleteShader(n),null)}ji(t,i,s){const n=t.indexOf("[");if(-1!==n)switch(t=t.substring(0,n),i){case g.FLOAT_MAT4:return new f(t,i,s);case g.FLOAT:return new l(t,i,s);default:throw new Error}else switch(i){case g.FLOAT_MAT4:return new u(t,i,s);case g.INT:case g.BOOL:case g.FLOAT:return new c(t,i,s);case g.INT_VEC2:case g.BOOL_VEC2:case g.FLOAT_VEC2:return new v(t,i,s);case g.INT_VEC3:return new w(t,i,s);case g.BOOL_VEC3:case g.FLOAT_VEC3:return new m(t,i,s);case g.INT_VEC4:case g.BOOL_VEC4:case g.FLOAT_VEC4:return new p(t,i,s);case g.SAMPLER_2D:case g.SAMPLER_2D_SHADOW:case g.SAMPLER_2D_ARRAY:case g.SAMPLER_2D_ARRAY_SHADOW:case g.SAMPLER_3D:return new d(t,i,s);default:throw new Error}}Li(t,i){const s=i?g.ELEMENT_ARRAY_BUFFER:g.ARRAY_BUFFER,n=this.gl.createBuffer();return this.gl.bindBuffer(s,n),this.gl.bufferData(s,t.array,g.STATIC_DRAW),t.buffer=n,n}setFramebuffer(t,i=0,s=0){const n=this.gl;if(!t)return n.bindFramebuffer(n.FRAMEBUFFER,null),void n.viewport(0,0,window.innerWidth,window.innerHeight);t.needsUpdate&&(this.Wi(t),t.needsUpdate=!1),n.bindFramebuffer(n.FRAMEBUFFER,t.frameBuffer),n.drawBuffers(t.drawBuffers),this.$i(t,i,s),n.viewport(0,0,t.width*Math.pow(.5,t.currentLevel),t.height*Math.pow(.5,t.currentLevel))}copyDepthTexture(t,i){const s=this.gl;s.bindFramebuffer(s.READ_FRAMEBUFFER,t.frameBuffer),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,i.frameBuffer),s.blitFramebuffer(0,0,t.width,t.height,0,0,i.width,i.height,s.DEPTH_BUFFER_BIT,s.NEAREST),s.bindFramebuffer(s.READ_FRAMEBUFFER,null),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,null)}copyFramebufferToTextureLayer(t,i,s){const n=this.gl;n.bindFramebuffer(n.READ_FRAMEBUFFER,t.frameBuffer),i.texture||this.Oi(i),n.bindTexture(n.TEXTURE_2D_ARRAY,i.texture),n.copyTexSubImage3D(n.TEXTURE_2D_ARRAY,0,0,0,s,0,0,t.width,t.height)}setFramebufferLayer(t,i){this.setFramebuffer(t,0,i)}$i(t,i,s){if(t.currentLevel===i&&t.currentlayer===s)return;for(let n=0;n<t.textures.length;n++){const e=t.textures[n],h=g.COLOR_ATTACHMENT0+n;e.target===g.TEXTURE_2D_ARRAY||e.target===g.TEXTURE_3D?this.gl.framebufferTextureLayer(g.FRAMEBUFFER,h,e.texture,i,s):this.gl.framebufferTexture2D(g.FRAMEBUFFER,h,g.TEXTURE_2D,e.texture,i)}const n=t.depthTexture;n&&(n.target===g.TEXTURE_2D_ARRAY?this.gl.framebufferTextureLayer(g.FRAMEBUFFER,g.DEPTH_ATTACHMENT,n.texture,i,s):this.gl.framebufferTexture2D(g.FRAMEBUFFER,g.DEPTH_ATTACHMENT,g.TEXTURE_2D,n.texture,i)),t.currentLevel=i,t.currentlayer=s}Wi(t){t.frameBuffer&&this.gl.deleteFramebuffer(t.frameBuffer);const i=this.gl.createFramebuffer();t.frameBuffer=i,this.gl.bindFramebuffer(g.FRAMEBUFFER,i);const s=[];for(let i=0;i<t.textures.length;i++){const n=t.textures[i],e=this.Oi(n);if(t.isArrayFramebuffer||n.target===g.TEXTURE_3D){const t=g.COLOR_ATTACHMENT0+i;s.push(t),this.gl.framebufferTextureLayer(g.FRAMEBUFFER,t,e,0,0)}else{const t=g.COLOR_ATTACHMENT0+i;s.push(t),this.gl.framebufferTexture2D(g.FRAMEBUFFER,t,g.TEXTURE_2D,e,0)}}t.drawBuffers=s;const n=t.depthTexture;if(n){const t=this.Oi(n);n.target===g.TEXTURE_2D_ARRAY||n.target===g.TEXTURE_3D?this.gl.framebufferTextureLayer(g.FRAMEBUFFER,g.DEPTH_ATTACHMENT,t,0,0):this.gl.framebufferTexture2D(g.FRAMEBUFFER,g.DEPTH_ATTACHMENT,g.TEXTURE_2D,t,0)}const e=this.gl.checkFramebufferStatus(g.FRAMEBUFFER);if(e!==g.FRAMEBUFFER_COMPLETE)throw new Error("Framebuffer is not complete: "+e.toString());this.gl.bindFramebuffer(g.FRAMEBUFFER,null)}disposeFramebuffer(t){for(const i of t.textures)this.disposeTexture(i);this.gl.deleteFramebuffer(t.frameBuffer),t.frameBuffer=null}disposeTexture(t){this.gl.deleteTexture(t.texture),t.texture=null}disposeMesh(t,i=!0){if(this.disposeGeometry(t.geometry),this.disposeMaterial(t.material),i)for(const i of t.children)this.disposeMesh(i)}disposeGeometry(t){for(const i in t.attributes){const s=t.attributes[i];this.gl.deleteBuffer(s.buffer),s.buffer=null}t.indices&&(this.gl.deleteBuffer(t.indices.buffer),t.indices.buffer=null)}disposeMaterial(t){t.program&&(this.gl.deleteProgram(t.program.program),t.program.program=null)}}},8023:(t,i,s)=>{s.d(i,{A:()=>e});var n=s(649);class e extends n.Ay{constructor(){super(),this.name="FullscreenMaterial"}getVertSource(){return"#version 300 es\n\n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec2 uv;\n            \n            out vec2 vUv;\n\n            void main(void) {\n                vUv = uv;\n                gl_Position = vec4(position, 1.0);\n            }\n        "}}},3739:(t,i,s)=>{s.d(i,{A:()=>p});var n=s(1296),e=s(1992),h=s(9246),o=s(6101);class r{constructor(t,i){this.center=new o.A,t&&this.center.copy(t),this.normal=new o.A,i&&this.normal.copy(i),this.distance=this.normal.dot(this.center)}update(t,i){this.center.copy(t),this.normal.copy(i),this.normal.normalize(),this.distance=this.normal.dot(this.center)}getSignedDistanceToPoint(t){return this.normal.dot(t)-this.distance}}const a=new o.A(0,0,-1),c=new o.A(1,0,0),l=new o.A,u=new o.A,f=new o.A,d=new o.A,v=new o.A,m=new o.A;class w{constructor(){this.farPlane=new r,this.nearPlane=new r,this.rightPlane=new r,this.leftPlane=new r,this.topPlane=new r,this.bottomPlane=new r}updateFromPerspectiveCamera(t){const i=t.position,s=t.quaternion;s.vmult(a,d),s.vmult(c,v),v.cross(d,m),m.normalize();const n=t.near,e=t.far,h=t.aspect,o=t.fov,r=e*Math.tan(.5*o),w=r*h;d.scale(e,f),d.scale(n,l),i.add(l,l),this.nearPlane.update(l,d),i.add(f,l),d.negate(u),this.farPlane.update(l,u),v.scale(w,u),f.add(u,u),m.cross(u,u),this.rightPlane.update(i,u),v.scale(w,u),f.sub(u,u),u.cross(m,u),this.leftPlane.update(i,u),m.scale(r,u),f.add(u,u),u.cross(v,u),this.topPlane.update(i,u),m.scale(r,u),f.sub(u,u),v.cross(u,u),this.bottomPlane.update(i,u)}updateFromOrthographicCamera(t){const i=t.position,s=t.quaternion;s.vmult(a,d),s.vmult(c,v),v.cross(d,m),m.normalize();const n=t.near,e=t.far,h=t.width,o=t.height;d.scale(n,l),i.add(l,l),this.nearPlane.update(l,d),d.negate(u),d.scale(e,l),i.add(l,l),this.farPlane.update(l,u),v.negate(u),v.scale(.5*h,l),i.add(l,l),this.rightPlane.update(l,u),v.scale(.5*h,l),i.sub(l,l),this.leftPlane.update(l,v),m.negate(u),m.scale(.5*o,l),i.add(l,l),this.topPlane.update(l,u),m.scale(.5*o,l),i.sub(l,l),this.bottomPlane.update(l,m)}test(t,i){return this.isForwardPlane(this.nearPlane,t,i)&&this.isForwardPlane(this.farPlane,t,i)&&this.isForwardPlane(this.rightPlane,t,i)&&this.isForwardPlane(this.leftPlane,t,i)&&this.isForwardPlane(this.topPlane,t,i)&&this.isForwardPlane(this.bottomPlane,t,i)}isForwardPlane(t,i,s){return-s<t.getSignedDistanceToPoint(i)}}class p extends n.A{constructor(t={}){super(),this.position=new o.A,this.lastPosition=new o.A,this.quaternion=new h.A,this.lastQuaternion=new h.A,this.scale=new o.A(1,1,1),this.velocity=new o.A,this.matrix=new e.A,this.modelMatrix=new e.A,this.worldPosition=new o.A,this.viewMatrix=new e.A,this.projectionMatrix=new e.A,this.invProjectionMatrix=new e.A,this.updateAspect(),window.addEventListener("resize",this.updateAspect.bind(this)),this.frustumTest=t.frustumTest??!0,this.frustum=new w,this.updateFrustum(),this.overrideMaterial=t.overrideMaterial??null,this.cameraVelocity=new o.A}updateModelMatrix(){this.modelMatrix.compose(this.position,this.quaternion,this.scale)}updateViewMatrix(){this.worldPosition.set(this.modelMatrix.elements[12],this.modelMatrix.elements[13],this.modelMatrix.elements[14]),this.modelMatrix.invert(this.viewMatrix)}updateProjectionMatrix(){}updateFrustum(){}updateAspect(){this.aspect=window.innerWidth/window.innerHeight,this.updateProjectionMatrix()}lateUpdate(t,i,s){}copy(t){this.position.copy(t.position),this.quaternion.copy(t.quaternion),this.worldPosition.copy(t.worldPosition),this.updateModelMatrix(),this.updateViewMatrix()}}},7907:(t,i,s)=>{s.d(i,{A:()=>e});var n=s(3739);class e extends n.A{constructor(t={}){super(t),this.width=t.width??1,this.height=t.height??1,this.near=t.near??0,this.far=t.far??1}updateDimensions(t,i,s,n){this.width=t,this.height=i,this.near=s,this.far=n,this.updateProjectionMatrix()}updateProjectionMatrix(){this.projectionMatrix.orthographic(this.width,this.height,this.near,this.far),this.projectionMatrix.invert(this.invProjectionMatrix)}updateFrustum(){this.frustum.updateFromOrthographicCamera(this)}}},8983:(t,i,s)=>{s.d(i,{A:()=>h});const n=Math.PI/180;var e=s(3739);class h extends e.A{constructor(t={}){super(t),this.near=t.near??1,this.far=t.far??1e4,this.fov=(t.fov??90)*n,this.updateProjectionMatrix()}updateProjectionMatrix(){this.projectionMatrix.perspective(this.near,this.far,this.fov,this.aspect),this.projectionMatrix.invert(this.invProjectionMatrix)}updateFrustum(){this.frustum.updateFromPerspectiveCamera(this)}copy(t){return super.copy(t),this.near=t.near,this.far=t.far,this.fov=t.fov,this}}},611:(t,i,s)=>{s.d(i,{A:()=>n});const n="\n    #define _DielectricF0 0.04\n\n    #define pow2(x) (x * x)\n\n    float Fd_Burley(float dotNV, float dotNL, float dotLH, float roughness) {\n        float fd90 = 0.5 + 2.0 * dotLH * dotLH * roughness;\n        float lightScatter = (1.0 + (fd90 - 1.0) * pow(1.0 - dotNL, 5.0));\n        float viewScatter = (1.0 + (fd90 - 1.0) * pow(1.0 - dotNV, 5.0));\n\n        float diffuse = lightScatter * viewScatter;\n        return diffuse;\n    }\n\n    // float V_GGX_SmithCorrelated(float dotNL, float dotNV, float alpha) {\n    //     float lambdaV = dotNL * (dotNV * (1.0 - alpha) + alpha);\n    //     float lambdaL = dotNV * (dotNL * (1.0 - alpha) + alpha);\n\n    //     return 0.5 / (lambdaV + lambdaL + 0.0001);\n    // }\n\n    // float D_GGX(const float dotNH, const float alpha) {\n    //     float a2 = alpha * alpha;\n    //     float denom = (dotNH * a2 - dotNH) * dotNH + 1.0;\n    //     return a2 / (denom * denom + 0.0000001) / PI;\n    // }\n\n    // from old rendering pipeline\n    float V_GGX_SmithCorrelated(float dotNL, float dotNV, float alpha) {\n        float a2 = alpha * alpha;\n        float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n        float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n        return 0.5 / max( gv + gl, 1e-6 );\n    }\n\n    // from old renderring pipeline\n    float D_GGX(const float dotNH, const float alpha) {\n        float a2 = alpha * alpha;\n        float denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n        return a2 / pow2(PI * denom);\n    }\n\n    vec3 F_Schlick(vec3 f0, vec3 f90, float cos) {\n        float x = clamp(1.0 - cos, 0.0, 1.0);\n        float x2 = x * x;\n        float x5 = x * x2 * x2;\n        return f0 + (f90 - f0) * x5;\n    }\n\n    vec3 F_Schlick(vec3 f0, float cos) {\n        return F_Schlick(f0, vec3(1.0), cos);\n        // return f0 + (1.0 - f0) * pow(1.0 - cos, 5.0);\n    }\n\n\n    float SchlickFresnel(float u, float f0, float f90) {\n        return f0 + (f90-f0)*pow(1.0-u,5.0);\n    }\n\n    float NormalizedDisneyDiffuse(float dotNV, float dotNL, float dotLH, float roughness) {\n        float energyBias = mix(0.0, 0.5, roughness);\n        float energyFactor = mix(1.0, 1.0 / 1.51, roughness);\n        float Fd90 = energyBias + 2.0 * dotLH * dotLH * roughness;\n        float FL = SchlickFresnel(1.0, Fd90, dotNL);\n        float FV = SchlickFresnel(1.0, Fd90, dotNV);\n        return FL * FV * energyFactor;\n    }\n\n    vec3 BRDF(vec3 albedo, float metallic, float roughness, vec3 N, vec3 V, vec3 L, vec3 directLight, vec3 indirectDiffuse, vec3 indirectSpecular) {\n        vec3 halfLV = normalize(L + V);\n        float dotNV = saturate(abs(dot(N, V)));\n        // float dotNV = saturate(dot(N, V));\n        float dotNL = saturate(dot(N, L));\n        float dotNH = saturate(dot(N, halfLV));\n        float dotLH = saturate(dot(L, halfLV));\n\n        vec3 f0 = mix(vec3(_DielectricF0), albedo, metallic);\n        float reflectivity = mix(_DielectricF0, 1.0, metallic);\n        float alpha = roughness * roughness;\n\n        // direct diffuse\n        float diffuseTerm = Fd_Burley(dotNV, dotNL, dotLH, roughness) * dotNL / PI;\n        // float diffuseTerm = NormalizedDisneyDiffuse(dotNV, dotNL, dotLH, roughness) * dotNL / PI;\n        // float diffuseTerm = dotNL / PI;\n        vec3 diffuse = albedo * (1.0 - reflectivity) * directLight * diffuseTerm;\n        \n        // Indirect Diffuse\n        diffuse += albedo * (1.0 - reflectivity) * indirectDiffuse;\n\n        // specular\n        float v = V_GGX_SmithCorrelated(dotNL, dotNV, alpha);\n        float D = D_GGX(dotNH, alpha);\n        vec3 F = F_Schlick(f0, dotLH);\n        vec3 specular = v * D * F * dotNL * directLight;\n        specular = max(vec3(0.0), specular);\n\n        // Indirect Specular\n        float surfaceReduction = 1.0 / (alpha * alpha + 1.0);\n        float f90 = saturate((1.0 - roughness) + reflectivity);\n        specular += surfaceReduction * indirectSpecular * mix(f0, vec3(f90), pow(1.0 - dotNV, 5.0));\n\n        return diffuse + specular;\n    }\n"},8161:(t,i,s)=>{s.d(i,{A:()=>o});var n=s(2780),e=s(1235);const h=WebGL2RenderingContext;class o extends n.A{constructor(t,i){super();const s=[-.5*t,.5*i,0,.5*t,.5*i,0,-.5*t,-.5*i,0,.5*t,-.5*i,0];this.attributes={position:new e.A(new Float32Array(s),3,h.FLOAT),normal:new e.A(new Float32Array([0,0,1,0,0,1,0,0,1,0,0,1]),3,h.FLOAT),uv:new e.A(new Float32Array([0,1,1,1,0,0,1,0]),2,h.FLOAT)},this.indices=new e.A(new Uint16Array([0,3,1,0,2,3]),1,h.UNSIGNED_SHORT)}}},5284:(t,i,s)=>{s.d(i,{A:()=>r});var n=s(6389),e=s(1992),h=s(832),o=s(649);class r extends o.Ay{constructor(t={}){super(t),this.config=t,this.colorFactor=new h.A(1,1,1,1),Array.isArray(t.colorFactor)?this.colorFactor.copyFromArray(t.colorFactor):t.colorFactor&&this.colorFactor.copy(t.colorFactor),this.emissiveFactor=new h.A,Array.isArray(t.emissiveFactor)?this.emissiveFactor.copyFromArray(t.emissiveFactor):t.emissiveFactor&&this.emissiveFactor.copy(t.emissiveFactor),this.roughness=t.roughness??0,this.metalness=t.metalness??0,this.colorTexture=t.colorTexture,this.emissiveTexture=t.emissiveTexture,this.alphaTest=t.alphaTest??!1,this.transparent=t.transparent??!1,this.renderingPass=t.renderingPass??n.he,this.uniforms=this.getUniforms(t)}getVertSource(){return"#version 300 es\n        \n            precision mediump float;\n            \n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec3 normal;\n            layout (location = 2) in vec2 uv;\n            \n            uniform mat4 modelMatrix;\n            // uniform mat4 viewMatrix;\n            uniform mat4 modelViewMatrix;\n            uniform mat4 projectionMatrix;\n            \n            out vec2 vUv;\n            out vec3 vNormal;\n            out vec3 vPosition;\n\n            void main() {\n                vUv = uv;\n\n                vec4 worldNormal = modelMatrix * vec4(normal, 0.0);\n                vNormal = normalize(worldNormal.xyz);\n\n                vPosition = (modelViewMatrix * vec4(position, 1.0)).xyz;\n                gl_Position = projectionMatrix * vec4(vPosition, 1.0);\n            }\n        "}getFragSource(){return`#version 300 es\n            \n            precision mediump float;\n\n            in vec2 vUv;\n            in vec3 vNormal;\n            in vec3 vPosition;\n\n            ${this.colorTexture?"#define USE_COLOR_MAP":""}\n            ${this.emissiveTexture?"#define USE_EMISSIVE_MAP":""}\n            ${this.alphaTest?"#define ALPHA_TEST":""}\n\n            #ifdef USE_COLOR_MAP\n            uniform sampler2D tColor;\n            #endif\n            uniform vec4 colorFactor;\n\n            uniform sampler2D tEmissive;\n            uniform vec4 emissiveFactor;\n\n            uniform float roughness;\n            uniform float metalness;\n\n            layout(location = 0) out vec4 gColor;\n            layout(location = 1) out vec4 gNormal;\n            layout(location = 2) out vec4 gSurface;\n            layout(location = 3) out vec4 gEmissive;\n            layout(location = 4) out vec4 gFlatNormal;\n\n            void main() {\n                #ifdef USE_COLOR_MAP\n                vec4 albedo = texture(tColor, vUv);\n                #ifdef ALPHA_TEST\n                if (albedo.a < 0.5) discard;\n                #endif\n                gColor = albedo * colorFactor;\n                // gColor = albedo;\n                #else\n                gColor = colorFactor;\n                #endif\n\n                gNormal = vec4(normalize(vNormal), 0.0);\n                gSurface = vec4(0.0, roughness, metalness, 0.0);\n                gEmissive = texture(tEmissive, vUv) * emissiveFactor;\n\n                vec3 dx = dFdx(vPosition);\n                vec3 dy = dFdy(vPosition);\n                gFlatNormal = vec4(normalize(cross(normalize(dx), normalize(dy))), 1.0);\n            }\n        `}getUniforms(t){return{modelMatrix:new e.A,modelViewMatrix:new e.A,projectionMatrix:new e.A,colorFactor:this.colorFactor,tColor:this.colorTexture,emissiveFactor:this.emissiveFactor,tEmissive:this.emissiveTexture,roughness:this.roughness,metalness:this.metalness}}}},8608:(t,i,s)=>{s.d(i,{A:()=>h});var n=s(1992),e=s(649);class h extends e.Ay{constructor(t={}){super(t),this.colorTexture=t.colorTexture,this.uniforms=this.getUniforms()}getVertSource(){return"#version 300 es\n        \n            precision mediump float;\n            \n            layout (location = 0) in vec3 position;\n\n            uniform mat4 modelViewMatrix;\n            uniform mat4 projectionMatrix;\n            \n            void main() {\n                gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n            }\n        "}getFragSource(){return"#version 300 es\n\n            void main() {\n            }\n        "}getUniforms(){return{modelMatrix:new n.A,modelViewMatrix:new n.A,projectionMatrix:new n.A,tColor:this.colorTexture}}}},8968:(t,i,s)=>{s.d(i,{EZ:()=>h,Gh:()=>a,MX:()=>l,QE:()=>o,ZZ:()=>r,uL:()=>c,wg:()=>e});var n=s(832);const e=new n.A(0,0,0,.75),h=(new n.A(.9,.9,.9,.8),new n.A(.3,.3,.3,.8),new n.A(.9,.9,.9,1)),o=(new n.A(0,0,0,1),new n.A(.9,.9,.9,1),new n.A(.3,1,.6,1)),r=new n.A(0,.5,1,1),a=(new n.A(.25,1,.25,1),new n.A(1,.9,.3,1),new n.A(1,1,0,1),new n.A(1,.1,.2,1)),c=(new n.A(1,.95,.3,1),new n.A(.95,1,1,1),new n.A(1,1,1,1)),l=.004},9633:(t,i,s)=>{s.d(i,{A:()=>a});var n=s(6389),e=s(1992),h=s(7830),o=s(649),r=s(8968);class a extends o.Ay{constructor(t={}){super(),this.props=t,this.depthTest=t.depthTest??!1,this.depthWrite=t.depthWrite??!1,this.transparent=t.transparent??!1,this.useScissor=t.useScissor??!1,this.scissorMin=t.scissorMin??new h.A,this.scissorMax=t.scissorMax??new h.A,this.vertexShader=this.getVertSource(),this.fragmentShader=this.getFragSource(),this.uniforms=this.getUniforms(t),this.renderingPass=t.renderingPass??n.uk}setColor(t){this.uniforms.color.value.copy(t)}getVertSource(){return"#version 300 es\n        \n            precision mediump float;\n\n            layout (location = 0) in vec3 position;\n            layout (location = 2) in vec2 uv;\n\n            uniform mat4 modelMatrix;\n\n            uniform float aspectRatio;\n\n            out vec2 vUv;\n            out vec2 vCoord;\n            out vec3 vPosition;\n\n            void main() {\n                vUv = uv;\n                vPosition = position;\n                gl_Position = modelMatrix * vec4(position, 1.0);\n                // gl_Position = vec4(position, 1.0);\n                gl_Position.x /= aspectRatio;\n\n                vCoord = vec2(gl_Position.xy / gl_Position.w);\n                vCoord.x *= aspectRatio;\n            }\n        "}getFragSource(){return`#version 300 es\n\n            ${this.useScissor?"#define SCISSOR":""}\n            \n            precision mediump float;\n\n            uniform vec4 color;\n\n            #ifdef SCISSOR\n            uniform vec2 scissorMin;\n            uniform vec2 scissorMax;\n            #endif\n\n            uniform float aspectRatio;\n\n            in vec2 vUv;\n            in vec3 vPosition;\n            in vec2 vCoord;\n\n            out vec4 gDiffuse;\n\n            void main() {\n                #ifdef SCISSOR\n                vec2 coord = vec2(vUv.x * aspectRatio, vUv.y);\n                // if (vCoord.x < 0.1) discard;\n                if (vCoord.x < scissorMin.x || vCoord.y < scissorMin.y\n                        || scissorMax.x < vCoord.x || scissorMax.y < vCoord.y) discard;\n                #endif\n                \n                gDiffuse = color;\n            }\n        `}getUniforms(t={}){return{modelMatrix:new e.A,viewMatrix:new e.A,projectionMatrix:new e.A,aspectRatio:1,color:t.color?t.color.clone():r.QE.clone(),scissorMin:this.scissorMin??new h.A,scissorMax:this.scissorMax??new h.A}}}},5931:(t,i,s)=>{s.d(i,{A:()=>n});class n{constructor(t){this.items=[],this.length=this.items.length,this.compare=t}push(t){this.items.push(t);let i=this.items.length-1;for(;0<i;){const t=Math.floor((i-1)/2),s=this.items[t],n=this.items[i];this.compare(n,s)&&(this.items[t]=n,this.items[i]=s),i=t}this.length=this.items.length}pop(){const t=this.items[0];this.items[0]=this.items[this.items.length-1],this.items.pop();const i=this.items.length;let s=0;for(;s<i;){let t=s;const n=2*s+1,e=2*s+2;if(n<i&&this.compare(this.items[n],this.items[t])&&(t=n),e<i&&this.compare(this.items[e],this.items[t])&&(t=e),s===t)break;const h=this.items[s];this.items[s]=this.items[t],this.items[t]=h,s=t}return this.length=this.items.length,t}clear(){this.items.splice(0),this.length=this.items.length}getLength(){return this.items.length}compare(t,i){}}},9120:(t,i,s)=>{s.d(i,{A:()=>Va});var n=s(6389),e=s(9146),h=s(2638),o=s(813),r=s(9246),a=s(6101),c=s(8983),l=s(1447);const u=new r.A,f=new a.A(0,-10,0),d=new a.A,v=new a.A,m=new a.A;new a.A;class w{constructor(t,i,s,n,e){this.center=(new a.A).copy(t),this.axis=(new a.A).copy(i),this.axis.normalize(),this.tangent=(new a.A).copy(s),this.tangent.normalize(),this.startDirection=this.axis.cross(this.tangent),this.startDirection.normalize(),this.radius=n,this.speed=e,this.lastPosition=new a.A,this.t=0}getTransform(t,i=new a.A,s=new r.A,e=new a.A){this.t+=t;let h=this.speed/this.radius*this.t;u.setFromAxisAngle(this.axis,h),u.normalize();const o=u.vmult(this.startDirection);o.scale(this.radius,i),i.add(this.center,i);{this.axis.cross(o,v),v.normalize(),n.OX.cross(v,d),d.normalize(),h=Math.acos((0,l.qE)(n.OX.dot(v))),s.setFromAxisAngle(d,h),s.normalize();const t=o.scale(-(e.length()**2)/this.radius),i=f.scale(-1);t.add(i,m),m.normalize(),s.conjugate(u);const r=u.vmult(m);r.normalize(),n.UP.cross(r,d),d.normalize(),h=Math.acos((0,l.qE)(n.UP.dot(r))),u.setFromAxisAngle(d,h),u.normalize(),s.mult(u,s),s.normalize()}return v.scale(this.speed,e),{position:i,quaternion:s,velocity:e}}}const p=new r.A;new a.A(0,-10,0),new a.A;new a.A,new a.A,new a.A;const g=new a.A;class x{constructor(t,i,s){this.position=(new a.A).copy(t),this.direction=(new a.A).copy(i).normalize(),this.speed=s,this.velocity=this.direction.scale(this.speed),this.mode=0,this.rollAngle=0,this.maxRollAngle=1.5,this.desiredRollAngle=0,this.maxRollRate=1.5,this.turnRate=0,this.desiredRollAngleChangeInterval=7.5,this.desiredRollAngleChangeTimer=.5*(.5*this.desiredRollAngleChangeInterval+Math.random()*this.desiredRollAngleChangeInterval)}getTransform(t,i=new a.A,s=new r.A,e=new a.A){this.desiredRollAngleChangeTimer-=t,this.desiredRollAngleChangeTimer<=0&&(1===this.mode?Math.random()<.5?(this.mode=0,this.desiredRollAngle=0):(this.mode=-1,this.desiredRollAngle=-this.maxRollAngle):-1===this.mode?Math.random()<.5?(this.mode=0,this.desiredRollAngle=0):(this.mode=1,this.desiredRollAngle=this.maxRollAngle):Math.random()<.5?(this.mode=-1,this.desiredRollAngle=-this.maxRollAngle):(this.mode=1,this.desiredRollAngle=this.maxRollAngle),this.desiredRollAngleChangeTimer=.5*this.desiredRollAngleChangeInterval+Math.random()*this.desiredRollAngleChangeInterval),this.rollAngle+=(0,l.qE)(this.desiredRollAngle-this.rollAngle,-this.maxRollRate*t,this.maxRollRate*t),this.turnRate=-10*Math.tan(this.rollAngle)/this.speed,p.setFromAxisAngle(n.UP,this.turnRate*t),p.normalize(),p.vmult(this.direction,this.direction),this.direction.y=0,this.direction.normalize(),this.direction.scale(this.speed,this.velocity),this.position.add(this.velocity.scale(t),this.position),e.copy(this.velocity),i.copy(this.position),g.set(this.direction.x,0,this.direction.z),g.normalize();const h=Math.acos((0,l.qE)(n.OX.dot(g)))*Math.sign(n.OX.cross(this.direction).y);return s.setFromAxisAngle(n.UP,h),p.setFromAxisAngle(n.OX,this.rollAngle),p.normalize(),s.mult(p,s),s.normalize(),{position:i,quaternion:s,velocity:e}}}new r.A,new a.A(0,-10,0),new a.A;new a.A,new a.A,new a.A;class M{constructor(t,i,s){this.origin=(new a.A).copy(t),this.direction=(new a.A).copy(i).normalize();const e=new a.A(this.direction.x,0,this.direction.z);e.normalize();const h=Math.acos((0,l.qE)(n.OX.dot(e)))*Math.sign(n.OX.cross(this.direction).y),o=Math.asin((0,l.qE)(this.direction.y));this.quaternion=(new r.A).setFromEuler(o,h,0,"YXZ"),this.speed=s,this.velocity=this.direction.scale(this.speed),this.lastPosition=new a.A,this.t=0}getTransform(t,i=new a.A,s=new r.A,n=new a.A){return this.t+=t,this.velocity.scale(this.t,i),this.origin.add(i,i),s.copy(this.quaternion),n.copy(this.velocity),{position:i,quaternion:s,velocity:n}}}const S="resource/model/icon/",y={"double-gun-damage":{label:"X2 Gun Damage",description:"Doubles the firepower of the machinegun.",cost:1e3,iconPath:S+"double-gun-damage/model.glb"},"gun-auto-aim":{label:"Gun Auto-Aim",description:"Automatically aims the gun to a target inside the range",cost:2e3,iconPath:S+"gun-auto-aim/model.glb"},"double-missile-damage":{label:"X2 Missile Damage",description:"Doubles the firepower of the standard missile.",cost:3e3,iconPath:S+"double-missile-damage/model.glb"},"enhance-missile-mobility":{label:"Enhance Missile Mobility",description:"Improves speed and homing capability of the standard missile.",cost:3e3,iconPath:S+"enhance-missile-mobility/model.glb"},"double-engine-power":{label:"X2 Engine Power",description:"Increases top speed and acceleration of the aircraft.",cost:3e3,iconPath:S+"double-engine-power/model.glb"},"enhance-aircraft-mobility":{label:"Enhance Aircraft Mobility",description:"Increases turning rate and braking capability of the aircraft.",cost:3e3,iconPath:""},"double-aircraft-armor":{label:"X2 Aircraft Armor",description:"Doubles anti-damage capability of the aircraft.",cost:3e3,iconPath:""},"post-stall-mode":{label:"Post-Stall Mode",description:"Enables control when the aircraft is in stall",cost:3e3,iconPath:""}};for(const t in y)y[t].acquired=!1,y[t].equipped=!1;const _={"1-wingman":{label:"1 Wingman",description:"Hire 1 wingman that coveres you.",value:1,cost:1e3,iconPath:S+"wingman/model.glb"},"2-wingmen":{label:"2 Wingmen",description:"Hire 2 wingmen that coveres you.",value:2,cost:2e3,iconPath:S+"wingman/model.glb"},"3-wingmen":{label:"3 Wingmen",description:"Hire 3 wingmen that coveres you.",value:3,cost:3e3,iconPath:S+"wingman/model.glb"}};for(const t in _)_[t].acquired=!1,_[t].equipped=!1;var P=s(832),A=s(8161),D=s(7133),q=s(9633),T=s(7545),E=s(2192),C=s(8871),b=s(5995);new a.A;class U extends E.A{constructor(t){super(t),this.props=t,this.focusable=!0,t.size||this.size.set(1,.05,0),this.pop=null==t.pop||t.pop,this.onClicked=t.onClicked?t.onClicked:function(){},this.onFocused=t.onFocused?t.onFocused:function(){},this.padding=t.padding??.0175,this.textSize=t.textSize??n.gI,this.createMesh(),this.boundingBox=new C.A}createMesh(){this.align=this.props.align??T.C7,this.mesh=(0,T.tJ)({size:this.size,position:new a.A(this.position.x,this.position.y,0),actor:this,color:new P.A(0,0,0,0),transparent:!0}),this.labelMesh=(0,T.bY)(this.props.label??"undefined",{size:this.textSize,align:this.align}),this.align==T.C7?this.labelMesh.position.x=-this.size.x/2:this.align==T.t7&&(this.labelMesh.position.x=this.size.x/2),this.labelMesh.test="test",this.mesh.add(this.labelMesh)}lateUpdate(t,i){this.scene.focusedComponent===this?this.labelMesh.material.uniforms.color.copy(b.oU):this.labelMesh.material.uniforms.color.copy(b.QE)}}var N=s(7830),R=s(6585),I=s(2780);class z extends E.A{constructor(t={}){super(t),this.Xi(t),this.Zi(),this.material=new q.A({color:this.color}),this.Yi()}Xi(t){this.maxDigits=t.maxDigits??10,this.fontSize=t.fontSize??n.gI,this.fontWidth=this.fontSize*(t.fontWidthScale??.5),this.spacing=this.fontSize*(t.fontSpacingScale??.25),this.color=t.color??b.QE,this.align=t.align??T.t7,this.fillZero=t.fillZero??!1,this.fillZero&&(this.fillZeroGeometry=this.Ki(String(t.fillZeroText??0))),this.totalWidth=0}Zi(){this.numberGeometries=[];for(let t=0;t<10;t++)this.numberGeometries.push(this.Ki(String(t)))}Ki(t){return(0,T.CB)(t,{size:this.fontSize,align:T.oM,color:this.color})}Yi(){this.mesh=new R.A,this.mesh.position.copy(this.position),this.mesh.frustumCulled=!1,this.numberMeshes=[];for(let t=0;t<this.maxDigits;t++){const i=this.Ji(this.numberGeometries[0],t);this.numberMeshes.push(i),this.mesh.add(i)}}Ji(t,i){0<i&&(this.totalWidth+=this.spacing);const s=new D.A(t,this.material);return s.frustumCulled=!1,s.position.x=-this.totalWidth-this.fontWidth/2,this.totalWidth+=this.fontWidth,s}set(t){this.Qi(t,this.numberMeshes)}Qi(t,i){if(t!==1/0)for(let s=0;s<this.maxDigits;s++){const n=Math.pow(10,s),e=this.fillZero||1==n||n<=t,h=i[s];h.visible=e;const o=(0,l.qE)(Number.parseInt(t/n)%10,0,9);h.geometry=t<n&&this.fillZero?this.fillZeroGeometry:this.numberGeometries[o]}}}class L extends E.A{constructor(t={}){super(t),this.Xi(t),this.mesh=new R.A,this.mesh.position.copy(this.position),this.labelMesh=(0,T.bY)(this.label,{size:this.textSize,color:b.QE,align:T.C7}),this.mesh.add(this.labelMesh),this.labelMesh.material.transparent=!0,this.counter=this.createCounter(),this.counter.material.transparent=!0,this.mesh.add(this.counter.mesh),this.add(this.counter),this.set(0)}Xi(t){this.label=t.label??"LABEL",this.textSize=t.textSize??.04,this.fillZero=t.fillZero??!1,this.fillZeroGeometry=t.fillZeroGeometry,this.maxDigits=t.maxDigits,this.totalWidth=t.width??.5,this.suffix=t.suffix}createCounter(){return new z({align:T.t7,color:b.QE,position:new a.A(this.totalWidth,0,0),fillZero:this.fillZero,fillZeroGeometry:this.fillZeroGeometry,maxDigits:this.maxDigits})}set(t){this.counter.set(t)}setAlpha(t){this.labelMesh.material.uniforms.color.w=t,this.counter.material.uniforms.color.w=t}}const F=new a.A(1.5,.6,0),O=new a.A(-.45,.325,0),V=.1,k=new a.A(.6,V,0),G=new N.A(1,1),B=G.scale(.5),H=.05,j=new a.A(-B.x+H,B.y-H-.03,0),W=(new a.A).copy(j);W.x=.35000000000000003;const $=new a.A(0,j.y-.03-.037500000000000006,0);class X extends E.A{constructor(t={}){super(t),this.props=t,this.initSize(this.props),this.initPosition(this.props),this.initPanelPosition(),this.frameWidth=t.frameWidth??T.hH;const i=new A.A(this.size.x,this.size.y),s=new q.A({color:b.wg,transparent:!0});this.mesh=new D.A(i,s),this.mesh.position.copy(this.position),this.mesh.frustumCulled=!1,this.frameMesh=(0,T.n8)(this.size.add(new N.A(2*this.frameWidth,2*this.frameWidth)),this.frameWidth,b.QE),this.mesh.add(this.frameMesh),this.updateTitle("INGAME MENU"),this.createDivider(this.props),this.lastPanel=null,this.creditsCounter=new L({label:"Credits: ",position:W,width:.4}),this.alertCacheTime=0,this.hide(),this.panel=null}initSize(t){this.size=(new N.A).copy(t.size??G)}initPosition(t){this.position=(new a.A).copy(t.position??n.VT)}initPanelPosition(){this.panelPosition=O.clone()}createDivider(t){const i=new A.A(this.size.x-.1,this.frameWidth),s=new q.A({color:b.QE});this.deviderMesh=new D.A(i,s),this.deviderMesh.position.copy($),this.deviderMesh.frustumCulled=!1,this.mesh.add(this.deviderMesh)}openPanel(t,i){this.panel&&(this.panel.hide(),this.remove(this.panel)),i||(this.lastPanel=this.panel),this.panel=t,this.panel.setPosition(this.panelPosition),this.add(this.panel),this.panel.menu=this,this.updateTitle(t.title),this.panel.show(),this.show()}closePanel(t){this.panel.hide(),this.remove(t)}openConfirmationPanel(t,i){this.panel.hide(),this.confirmationPanel.show(t,i)}hideConfirmationPanel(){this.panel.show(),this.confirmationPanel.hide()}open(){this.mesh.visible=!0}close(){this.hide()}lateUpdate(t,i,s){this.creditsCounter.set(this.game.credits)}openLastPanel(){this.openPanel(this.lastPanel,!0)}alertCache(){this.alertCacheTime=0}updateTitle(t){this.titleMesh&&this.mesh.remove(this.titleMesh),this.titleMesh=(0,T.bY)(t,{position:j,align:T.C7,size:.06}),this.mesh.add(this.titleMesh)}}class Z extends E.A{constructor(t={}){super(t),this.props=t,this.title=t.title??"",this.titleColor=t.titleColor??b.EZ,this.mesh=new D.A(new A.A(this.size.x,this.size.y),new q.A({color:new P.A(1,1,1,0),transparent:!0})),this.mesh.position.copy(this.position),this.mesh.frustumCulled=!1,this.mesh.renderOrder=5,this.hide(),this.menu=null}initSize(){this.size=F.clone()}initPosition(){this.position=O.clone()}setPosition(t){this.position.copy(t),this.mesh.position.copy(this.position)}createButtons(t,i=0){for(let s=0;s<t.length;s++){const n=t[s],e=this.createButton(n,i+s);this.add(e)}}createButton(t,i=0){return new U({label:t.label,size:k,textSize:T.cL,position:this.getComponentPosition(i,k.x),onClicked:t.onClicked})}getComponentPosition(t,i=0){const s=.5*-this.size.x+.5*i,n=this.getComponentY(t);return new a.A(s,n,0)}getComponentY(t){return.5*this.size.y-.05-V*t}}class Y extends E.A{constructor(t){super(t),this.numRows=t.rows?t.rows:2,this.numCols=t.cols?t.cols:2,this.spacing=t.spacing?t.spacing:.2,this.rows=[];for(let t=0;t<this.numCols;t++){const t=[];this.rows.push(t)}this.cellSize=new N.A((this.size.x+this.spacing)/this.numCols,(this.size.y+this.spacing)/this.numRows),this.mesh=new R.A}getSize(t=1,i=1){return new N.A(this.cellSize.x*t-this.spacing,this.cellSize.y*i-this.spacing)}getPosition(t,i,s=1,n=1){const e=new N.A(this.cellSize.x*t+this.cellSize.x*s*.5-.5*this.size.x-.5*this.spacing,this.cellSize.y*i+this.cellSize.y*n*.5-.5*this.size.y-.5*this.spacing);return e.y*=-1,e}getCellSize(t=1,i=1){return new N.A(this.cellSize.x*t-this.spacing,this.cellSize.y*i-this.spacing)}getCellPosition(t,i){const s=new N.A;return s.x=this.cellSize.x*t+.5*this.cellSize.x-.5*this.size.x-.5*this.spacing,s.y=this.cellSize.y*i+.5*this.cellSize.y-.5*this.size.y-.5*this.spacing,s.y*=-1,s}getPositionAndSize(t,i,s=1,n=1){const e=new N.A;e.x=this.cellSize.x*s-this.spacing,e.y=this.cellSize.y*n-this.spacing;const h=new N.A;return h.x=this.cellSize.x*t+this.cellSize.x*s*.5-.5*this.size.x-.5*this.spacing,h.y=this.cellSize.y*i+this.cellSize.y*n*.5-.5*this.size.y-.5*this.spacing,h.y*=-1,{size:e,position:h}}add(t,i=0,s=0,n=1,e=1){super.add(t)}}var K=s(9782),J=s(1235);const Q=WebGL2RenderingContext;class tt extends I.A{constructor(t,i){super();const s=.5*t,n=.5*i,e=.25*i,h=[-s,-n,0,-s,e,0,-s+e,n,0,s,n,0,s,-e,0,s-e,-n,0];this.attributes={position:new J.A(new Float32Array(h),3,Q.FLOAT),normal:new J.A(new Float32Array([0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1]),3,Q.FLOAT),uv:new J.A(new Float32Array([0,1,1,1,0,0,1,0,0,0,1,0]),2,Q.FLOAT)},this.indices=new J.A(new Uint16Array([0,2,1,0,3,2,3,5,4,3,0,5]),1,Q.UNSIGNED_SHORT)}}class it extends E.A{constructor(t){super(t),this.props=t,this.init(t),this.createMesh(),this.boundingBox=new C.A}init(t){this.focusable=t.focusable??!0,t.size||this.size.set(1,.1),this.pop=null==t.pop||t.pop,this.onClicked=t.onClicked?t.onClicked:function(){},this.onFocused=t.onFocused?t.onFocused:function(){},this.padding=t.padding??.0175,this.textSize=t.textSize??n.gI,this.label=t.label??"None",this.labelAlign=t.labelAlign??T.oM}createMesh(){const t=new tt(this.size.x,this.size.y);t.calculateBoundingBox();const i=new q.A({color:b.wg,transparent:!0});this.mesh=new D.A(t,i),this.mesh.position.set(this.position.x,this.position.y,0),this.mesh.frustumCulled=!1,this.mesh.renderOrder=1,this.mesh.actor=this,this.labelMesh=(0,T.bY)(this.label,{size:this.textSize,align:this.labelAlign??T.oM,color:b.EZ,transparent:!0}),this.labelAlign===T.C7?this.labelMesh.position.x=.5*-this.size.x+this.textSize:this.labelAlign===T.t7&&(this.labelMesh.position.x=.5*this.size.x-this.textSize),this.mesh.add(this.labelMesh),this.props.fitLabel&&(this.size.x=this.labelMesh.geometry.boundingBox.max.x-this.labelMesh.geometry.boundingBox.min.x+2*this.padding)}lateUpdate(t,i){this.enabled?this.scene.focusedComponent===this?(this.mesh.material.uniforms.color.copy(b.yJ),this.labelMesh.material.uniforms.color.copy(b.SE)):(this.mesh.material.uniforms.color.copy(b.wg),this.labelMesh.material.uniforms.color.copy(b.EZ)):(this.mesh.material.uniforms.color.copy(b.wg),this.labelMesh.material.uniforms.color.copy(b.EZ),this.mesh.material.uniforms.color.w=.5,this.labelMesh.material.uniforms.color.w=.5)}}class st extends it{constructor(t,i){i.alignCenter=!0,i.label=i.label??t.label,super(i),this.item=t,this.color=i.color??b.QE,this.focusedColor=i.focusedColor??b.SE,this.frameWidth=i.frameWidth??T.hH;const s=new A.A(this.size.x-2*this.frameWidth,this.size.y-2*this.frameWidth);s.calculateBoundingBox();const n=new q.A;this.mesh=new D.A(s,n),this.mesh.position.set(this.position.x,this.position.y,0),this.mesh.frustumCulled=!1,this.mesh.renderOrder=2,this.mesh.actor=this,this.labelMesh&&this.mesh.add(this.labelMesh),this.frameMesh=(0,T.n8)(this.size,this.frameWidth,this.color.clone()),this.frameMesh.renderOrder=2,this.mesh.add(this.frameMesh),this.overlayMaterial=new q.A({color:b.wg,transparent:!0}),this.overlayMesh=new D.A(s,this.overlayMaterial),this.overlayMesh.frustumCulled=!1,this.overlayMesh.renderOrder=30,this.mesh.add(this.overlayMesh);const e=new q.A({color:this.color});this.checkIcon=new D.A(K.A.CHECK.geometry,e);const h=Math.min(this.size.x,this.size.y);this.checkIcon.scale.set(h,h,1),this.checkIcon.frustumCulled=!1,this.mesh.add(this.checkIcon),this.costMesh=(0,T.bY)(this.item.cost+"pt.",{size:T.p5,align:T.t7,color:this.color.clone()}),this.costMesh.frustumCulled=!1,this.costMesh.renderOrder=2,this.costMesh.position.set(.5*this.size.x-T.p5,.5*-this.size.y+1.5*T.p5,0),this.mesh.add(this.costMesh),this.acquiredMesh=(0,T.bY)("Acquired",{size:T.p5,align:T.t7,color:this.color.clone()}),this.acquiredMesh.frustumCulled=!1,this.acquiredMesh.renderOrder=2,this.acquiredMesh.position.set(.5*this.size.x-T.p5,.5*-this.size.y+1.5*T.p5,0),this.mesh.add(this.acquiredMesh)}lateUpdate(t,i){super.lateUpdate(t,i),this.mesh.material.uniforms.color.copy(b.wg),this.overlayMesh.visible=this.item.equipped,this.checkIcon.visible=this.item.equipped,this.acquiredMesh.visible=!this.item.equipped&&this.item.acquired,this.costMesh.visible=!this.item.acquired;const s=!this.isFocused||this.item.acquired&&this.item.equipped?this.color:this.focusedColor;this.frameMesh.material.uniforms.color.copy(s),this.costMesh.material.uniforms.color.copy(s),this.labelMesh&&this.labelMesh.material.uniforms.color.copy(s)}}const nt=-.35,et=new a.A(-.75,nt-.5*T.p5,0),ht=new a.A(.75,nt-.5*T.p5,0),ot=new a.A(0,nt-1.5*T.p5,0);class rt extends Z{constructor(t={}){super(t),this.props=t,this.title=this.createTitle(),this.frameWidth=t.frameWidth??.5*T.hH,this.acquiredLabel=(0,T.bY)("Acquired",{size:T.p5,align:T.t7,color:b.QE}),this.acquiredLabel.position.copy(ht),this.mesh.add(this.acquiredLabel),this.createDivider(),this.grid=this.createGrid(),this.itemSize=this.grid.getCellSize(),this.labelMesh=null,this.descriptionMesh=null,this.costMesh=null;this.backButton=new U({position:new a.A(-.45,-.6499999999999999,0),size:new a.A(.6,.1,0),label:"- Back",onClicked:function(){this.menu.openLastPanel()}.bind(this)}),this.add(this.backButton),this.mesh.visible=!1}createTitle(){return"TITLE"}createGrid(){return new Y({size:this.size.clone(),rows:this.getNumRows(),cols:this.getNumCols(),spacing:.05})}getNumRows(){return 1}getNumCols(){return 1}createDivider(){const t=new A.A(this.size.x,this.frameWidth),i=new q.A({color:b.QE});this.deviderMesh=new D.A(t,i),this.deviderMesh.position.copy(ot),this.deviderMesh.frustumCulled=!1,this.deviderMesh.renderOrder=2,this.mesh.add(this.deviderMesh)}setItems(t){if(this.items=t,this.cards)for(const t in this.cards)this.remove(this.cards[t]);this.createItemMeshes()}createItemMeshes(){this.labelMeshes={},this.descriptionMeshes={},this.costMeshes={},this.cards={};let t=0;for(const i in this.items){const s=this.items[i],n=s.label,e=this.createLabelMesh(n);this.labelMeshes[i]=e;const h=this.createDescriptionMesh(s.description);this.descriptionMeshes[i]=h;const o=this.createCostMesh(s.cost);this.costMeshes[i]=o;const r=t%this.grid.numRows,a=Math.floor(t/this.grid.numRows),c=this.grid.getCellPosition(a,r),l=new st(s,{size:this.itemSize,position:c,color:b.QE,focusedColor:b.oU,onFocused:function(){this.setInfo(i,s.acquired)}.bind(this),onClicked:function(){this.onItemSelected(i,this.items[i])}.bind(this)});this.cards[i]=l,this.add(l),s.equipped&&this.setInfo(i,!0),t++}}onItemSelected(t,i){if(i.acquired)i.equipped||(i.equipped=!0,this.onItemEquipped(t,i));else{if(this.game.credits<i.cost)return void this.menu.alertCache();i.acquired=!0,i.equipped=!0,this.game.credits-=i.cost,this.onItemEquipped(t,i)}}createPurchaseConfurmationMessage(t){return`Are you sure to purchase "${t.label}" by ${t.cost} credits?`}onItemEquipped(t,i){}createLabelMesh(t){return(0,T.bY)(t,{align:T.C7,size:T.p5,color:b.QE,position:et})}createDescriptionMesh(t){const i=t.split("\n"),s=new R.A,n=et.y-.5*T.p5;for(let t=0;t<i.length;t++){const e=(0,T.bY)(i[t],{size:T.p5,align:T.C7,color:b.QE});e.position.x=-this.size.x/2,e.position.y=n-(t+1)*T.p5*2,s.add(e)}return s}createCostMesh(t){return(0,T.bY)("Cost: "+(t??1e3)+" pt.",{size:T.p5,align:T.t7,color:b.QE,position:ht})}setInfo(t,i){this.setLabelMesh(this.labelMeshes[t]),this.setDesctipsionMesh(this.descriptionMeshes[t]),this.setCostMesh(this.costMeshes[t],i)}setLabelMesh(t){this.labelMesh&&this.mesh.remove(this.labelMesh),this.labelMesh=t,this.mesh.add(this.labelMesh)}setDesctipsionMesh(t){this.descriptionMesh&&this.mesh.remove(this.descriptionMesh),this.descriptionMesh=t,this.mesh.add(this.descriptionMesh)}setCostMesh(t,i){this.costMesh&&this.mesh.remove(this.costMesh),this.costMesh=t,i?this.acquiredLabel.visible=!0:(this.acquiredLabel.visible=!1,this.mesh.add(this.costMesh))}}class at extends rt{constructor(t,i={}){super(i)}createTitle(){return"HIRE WINGMAN"}getNumRows(){return 1}getNumCols(){return 3}createPurchaseConfurmationMessage(t){return`Are you sure to hire "${t.label}" by ${t.cost} credits?`}onItemEquipped(t,i){this.game.numWingmen=i.value;for(const t in this.items){const s=this.items[t];s.equipped=s.value<=i.value}}}class ct extends rt{constructor(t={}){super(t)}createTitle(){return"SELECT SP WEAPON"}getNumRows(){return 1}getNumCols(){return 3}onItemEquipped(t,i){this.game.playerAircraft.setSPWeapon(t);for(const i in this.items)this.items[i].equipped=t==i}}class lt extends rt{constructor(t={}){super(t)}createTitle(){return"UPGRADE AIRCRAFT"}getNumRows(){return 2}getNumCols(){return 4}onItemEquipped(t,i){}}class ut extends Z{constructor(t={}){super(t),this.selectSPWeaponPanel=new ct,this.upgradeAircraftPanel=new lt,this.hireWingmenPanel=new at,this.props=t,this.title="RESUPPLY MENU",this.playerAircraft=null,this.onSortiePressed=this.props.onSortiePressed,this.onCompleted=t.onCompleted,this.createButtons(this.createButtonProps())}createButtonProps(){const t=[];return t.push({label:"- Select SP Weapon",onClicked:function(){this.menu.openPanel(this.selectSPWeaponPanel)}.bind(this)}),t.push({label:"- Upgrade Aircraft",onClicked:function(){this.menu.openPanel(this.upgradeAircraftPanel)}.bind(this)}),t.push({label:"- Hire Wingman",onClicked:function(){this.menu.openPanel(this.hireWingmenPanel)}.bind(this)}),t.push({label:"- Resortie",onClicked:function(){this.game.resortie(),this.onCompleted&&this.onCompleted()}.bind(this)}),t}}var ft=s(1296),dt=s(6527),vt=s(4857),mt=s(5639),wt=(s(2627),s(3449)),pt=s(5177);Math.PI;const gt="\n    float getRadiusAlpha(float damping, float timeElapsed) {\n        float lambda = -log(damping);\n        return 1.0 - exp(-lambda * timeElapsed);\n    }\n\n    float getTimeAlpha(float damping, float timeElapsed) {\n        float lambda = -log(damping);\n        // return exp(-lambda * timeElapsed * 0.1);\n        return max(1.0 - lambda * timeElapsed * 0.025, 0.0);\n    }\n\n    vec3 getWorldNormal(vec2 viewCoord, mat4 invViewMatrix) {\n        vec3 viewNormal = vec3(viewCoord, acos(length(viewCoord)));\n        vec3 worldNormal = (invViewMatrix * vec4(viewNormal, 0.0)).xyz;\n        return normalize(worldNormal);\n    }\n\n    float ao(float alpha) {\n        // return (0.25 + (1.0 - exp(-alpha * 5.0)) * 0.75) * exp(-alpha * 1.0);\n        return 0.5 + (1.0 - exp(-alpha * 2.0)) * 0.5;\n    }\n\n    float getDirectLight(vec3 worldNormal, vec3 sunDirection) {\n        return dot(worldNormal, sunDirection) * 0.5 + 0.5;\n    }\n\n    float getAmbientLight(float alpha) {\n        return ao(alpha);\n    }\n\n    float getViewAttenuation(float viewZ, float radius) {\n        return 1.0 - exp(-abs(viewZ) / (radius * 10.0));\n    }\n",xt="\n    const float SHARPNESS = 2.5;\n\n    float depthToDistance(float depth) {\n        return (cameraNear * cameraFar) / (cameraFar - depth * (cameraFar - cameraNear));\n    }\n\n    float getDepthAlpha(float currentSize) {\n        float smokeDistance = depthToDistance(gl_FragCoord.z);\n\n        vec2 screenUv = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n        float fragDistance = depthToDistance(texture(tDepth, screenUv).r);\n\n        float depthAlpha = exp(-max(smokeDistance - fragDistance, 0.0) / currentSize * SHARPNESS);\n        float distanceAlpha = 1.0 - exp(-smokeDistance / currentSize * SHARPNESS);\n\n        return depthAlpha * distanceAlpha;\n    }\n\n    bool toDiscard() {\n        vec2 screenUv = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n        return texture(tDepth, screenUv).r < gl_FragCoord.z;\n    }\n";var Mt=s(1992),St=s(649),yt=s(4867),_t=s(1649),Pt=s(7228);class At extends St.Ay{constructor(t={}){super(t),this.depthTest=!1,this.depthWrite=!1,this.renderingPass=n.xF,this.transparent=!0,this.blending=St.vU}getVertSource(){return`#version 300 es\n            \n            precision mediump float;\n            \n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec2 uv;\n                \n            uniform mat4 modelMatrix;\n            uniform mat4 viewMatrix;\n            uniform mat4 modelViewMatrix;\n            uniform mat4 projectionMatrix;\n\n            uniform vec3 cameraPosition;\n\n            uniform float radius;\n            uniform float damping;\n\n            uniform float timeElapsed;\n\n            uniform float angle;\n\n            out vec2 vUv;\n            out vec2 vRotatedCoord;\n\n            out float vRadiusAlpha;\n            out float vTimeAlpha;\n            out float vCurrentRadius;\n\n            out vec3 vWorldPosition;\n\n            out vec3 vSunIrradiance;\n            out vec3 vSkyIrradiance;\n            out vec3 vSunDirection;\n\n            out vec3 vInScatter;\n            out vec3 vTransmittance;\n                        \n            ${yt.mz}\n\n            ${gt}\n\n            ${yt.SY}\n\n            void main() {\n                vUv = uv;\n\n                vRadiusAlpha = getRadiusAlpha(damping, timeElapsed * 2.0);\n                vTimeAlpha = getTimeAlpha(damping, timeElapsed * 0.5);\n                \n                vCurrentRadius = radius * vRadiusAlpha + sqrt(radius) * timeElapsed * 1.5;\n\n                vec4 worldPosition = modelMatrix * vec4(0.0, 0.0, 0.0, 1.0);\n                vWorldPosition = worldPosition.xyz;\n\n                vSunIrradiance = getSunIrradiance(vWorldPosition.y * METERS_TO_KMS);\n                vSkyIrradiance = getSkyIrradiance(0.0, vWorldPosition.y * METERS_TO_KMS);\n                vSunDirection = atmosphereProfile.sunDirection;\n\n                vec4 viewPosition = viewMatrix * worldPosition;\n                vRotatedCoord = vec2(\n                        position.x * cos(angle) - position.y * sin(angle),\n                        position.x * sin(angle) + position.y * cos(angle));\n                viewPosition.xy += vRotatedCoord * vCurrentRadius;\n\n                getAirealScattering(normalize(vWorldPosition - cameraPosition).y, cameraPosition.y * 0.001, length(viewPosition) * 0.001, vInScatter, vTransmittance);\n\n                gl_Position = projectionMatrix * viewPosition;\n            }\n        `}getFragSource(){return`#version 300 es\n            \n            precision mediump float;\n\n            uniform sampler2D tDiffuse;\n\n            uniform vec3 initialColor;\n            uniform vec3 finalColor;\n            \n            uniform vec3 initialEmissive;\n            uniform vec3 finalEmissive;\n            \n            uniform sampler2D tDepth;\n            uniform float screenWidth;\n            uniform float screenHeight;\n            uniform float cameraNear;\n            uniform float cameraFar;\n\n            uniform mat4 viewMatrix;\n\n            uniform float radius;\n\n            uniform float density;\n            \n            uniform float angle;\n\n            in vec2 vUv;\n            in vec2 vRotatedCoord;\n\n            in float vRadiusAlpha;\n            in float vTimeAlpha;\n\n            in float vCurrentRadius;\n\n            in vec3 vWorldPosition;\n\n            in vec3 vSunIrradiance;\n            in vec3 vSkyIrradiance;\n            in vec3 vSunDirection;\n\n            in vec3 vInScatter;\n            in vec3 vTransmittance;\n\n            out vec4 gDiffuse;\n\n            ${gt}\n\n            ${xt}\n\n            ${yt.mz}\n\n            void main() {\n                float alpha = texture(tDiffuse, vUv).r;\n\n                float sampleDensity = alpha * density * vTimeAlpha * getDepthAlpha(vCurrentRadius) * (radius / vCurrentRadius);\n                float transmittance = 1.0 - exp(-sampleDensity);\n\n                if (1.0 <= length(vRotatedCoord.xy) || sampleDensity == 0.0) {\n                    discard;\n                }\n                \n                vec3 viewNormal = vec3(vRotatedCoord, sqrt(1.0 - dot(vRotatedCoord, vRotatedCoord)));\n                vec3 viewSunDirection = (viewMatrix * vec4(vSunDirection, 0.0)).xyz;\n                float directLight = dot(viewNormal, viewSunDirection) * 0.5 + 0.5; // half lambert\n                directLight = 0.25 + directLight * 0.75;\n\n                float ambientLight = getAmbientLight(alpha);\n                \n                vec3 irradiance = directLight * vSunIrradiance / PI + ambientLight * vSkyIrradiance;\n                vec3 diffuse = mix(initialColor, finalColor, pow(vRadiusAlpha, alpha)) * irradiance;\n                vec3 emissive = mix(initialEmissive, finalEmissive, pow(vRadiusAlpha, alpha));\n\n                gDiffuse.rgb = (diffuse + emissive + vInScatter) * sampleDensity * vTransmittance;\n                gDiffuse.a = sampleDensity;\n            }\n        `}getUniforms(t){return{tDiffuse:Pt.A.SMOKE_TEXTURE,modelMatrix:new Mt.A,viewMatrix:new Mt.A,modelViewMatrix:new Mt.A,projectionMatrix:new Mt.A,invViewMatrix:t.invViewMatrix??new Mt.A,cameraVelocity:t.cameraVelocity??new a.A,cameraPosition:t.cameraPosition??new a.A,radius:t.radius??0,density:t.density??1,angle:t.angle??1,damping:t.damping??1,initialColor:t.initialColor??new P.A(1,1,1,1),finalColor:t.finalColor??new P.A(0,0,0,1),initialEmissive:t.initialEmissive??new P.A(0,0,0,1),finalEmissive:t.finalEmissive??new P.A(0,0,0,1),timeElapsed:t.timeElapsed??0,tDepth:t.tDepth??new _t.A,screenWidth:t.screenWidth??1,screenHeight:t.screenHeight??1,cameraNear:t.cameraNear??1,cameraFar:t.cameraFar??1,atmosphereProfile:{}}}}function Dt(t,i){const s=-Math.log(t);return Math.exp(-s*i*.1)}function qt(t,i){return t*-Math.log(i)}function Tt(t,i){const s=i/t;return Math.exp(-s)}const Et=(0,l.P7)();class Ct extends ft.A{constructor(t,i){super(),this.position=(new a.A).copy(t),this.lastPosition=this.position.clone(),this.lerpedPosition=this.position.clone(),this.ts(i),this.createMesh(i)}ts(t){this.radius=t.radius??10,this.spreadSpeed=t.speed??20*Math.sqrt(this.radius),this.damping=Tt(this.radius,this.spreadSpeed),this.initialColor=t.initialColor??n.A2,this.finalColor=t.finalColor??n.A2,this.initialEmissive=t.initialEmissive??n.FU,this.finalEmissive=t.finalEmissive??n.FU,this.normal=new a.A,t.normal&&this.normal.copy(t.normal);const i=qt(this.radius/Math.PI,this.damping);this.velocity=this.normal.scale(i),t.velocity&&this.velocity.add(t.velocity,this.velocity),this.deltaVelocity=new a.A,this.density=t.density??1,this.timeElapsed=0,this.lastTimeElapsed=0}createMesh(t){this.geometry=this.createGeometry(),this.material=this.createMaterial(t),this.mesh=new D.A(this.geometry,this.material),this.mesh.position.copy(this.lerpedPosition),this.mesh.frustumCulled=!1}createGeometry(){return Et}createMaterial(t){return new At({radius:this.radius,damping:this.damping,density:this.density,angle:2*Math.PI*Math.random(),initialColor:this.initialColor,finalColor:this.finalColor,initialEmissive:this.initialEmissive,finalEmissive:this.finalEmissive})}fixedUpdate(t,i,s){this.velocity.scale(Math.pow(this.damping,i),this.velocity),this.velocity.scale(i,this.deltaVelocity),this.lastPosition.copy(this.position),this.position.add(this.deltaVelocity,this.position),this.lastTimeElapsed=this.timeElapsed,this.timeElapsed+=i,this.parent&&Dt(this.damping,this.timeElapsed)<.001&&this.parent.remove(this)}lateUpdate(t,i,s){const n=this.timeElapsed;this.mesh.material.uniforms.screenWidth=window.innerWidth,this.mesh.material.uniforms.screenHeight=window.innerHeight,this.mesh.material.uniforms.cameraNear=this.scene.mainCamera.near,this.mesh.material.uniforms.cameraFar=this.scene.mainCamera.far,this.mesh.material.uniforms.tDepth=this.scene.main.renderingPipeline.multipleFramebuffer.depthTexture,this.mesh.material.uniforms.timeElapsed=n,this.mesh.material.uniforms.invViewMatrix=this.scene.mainCamera.modelMatrix,this.lastPosition.lerp(this.position,s,this.lerpedPosition),this.mesh.position.copy(this.lerpedPosition)}onAdded(){super.onAdded(),this.mesh.material.uniforms.screenWidth=window.innerWidth,this.mesh.material.uniforms.screenHeight=window.innerHeight}onWindowResize(){super.onWindowResize(),this.mesh.material.uniforms.screenWidth=window.innerWidth,this.mesh.material.uniforms.screenHeight=window.innerHeight}}var bt=s(5284);class Ut extends I.A{constructor(t,i,s=0){super(t,i),this.isInstanced=!0,this.instanceCount=-1,this.extent=s}}const Nt=WebGL2RenderingContext;function Rt(t,i=1){const s=new J.A(new Float32Array(3*t),3,Nt.FLOAT,1);for(let n=0;n<t;n++){const t=new a.A(2*Math.random()-1,2*Math.random()-1,2*Math.random()-1);t.normalize(),t.scale(Math.random()*i,t),s.setXYZ(n,t.x,t.y,t.z)}return s}function It(t){const i=new J.A(new Float32Array(1*t),1,Nt.FLOAT,1);for(let s=0;s<t;s++)i.setX(s,Math.random()*Math.PI*2);return i}class zt extends St.Ay{constructor(t={}){super(t),this.depthTest=!1,this.depthWrite=!1,this.renderingPass=n.xF,this.transparent=!0,this.blending=St.vU}getVertSource(){return`#version 300 es\n            \n            precision mediump float;\n            \n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec2 uv;\n\n            layout (location = 2) in vec3 centerPosition;\n            layout (location = 3) in vec3 velocity;\n            layout (location = 4) in vec3 offset;\n            layout (location = 5) in float density;\n            layout (location = 6) in float angle;\n            layout (location = 7) in float startTime;\n                \n            uniform mat4 modelMatrix;\n            uniform mat4 viewMatrix;\n            uniform mat4 modelViewMatrix;\n            uniform mat4 projectionMatrix;\n\n            uniform vec3 cameraPosition;\n\n            uniform float liftForce;\n            uniform float spreadScale;\n            \n            uniform vec4 initialColor;\n            uniform vec4 finalColor;\n            \n            uniform float radius;\n            uniform float radiusSqrt;\n            uniform float initialRadius;\n            uniform float damping;\n\n            uniform float radiusTimeScale;\n            uniform float eraseTimeScale;\n            uniform float spreadTimeScale;\n            uniform float riseTimeScale;\n\n            uniform float totalTimeElapsed;\n\n            out vec2 vUv;\n            out vec2 vPosition;\n            out vec2 vRotatedCoord;\n\n            out float vDensity;\n\n            out vec3 vSunIrradiance;\n            out vec3 vSkyIrradiance;\n            out vec3 vSunDirection;\n\n            out vec3 vInScatter;\n            out vec3 vTransmittance;\n\n            out vec2 vRotatedViewCoord;\n\n            out float vRadiusAlpha;\n\n            out float vCurrentRadius;\n                        \n            ${yt.mz}\n\n            ${gt}\n\n            ${yt.SY}\n\n            float integrateExp(float x) {\n                return x + exp(-x) - 1.0;\n            }\n            \n            const vec3 A = vec3(0.5, 4.0, 0.5);\n            const float D = 0.1;\n\n            vec3 getMovePosition(float T, vec3 V0) {\n                float v = length(V0);\n                return log(1.0 + D * v * T) / D * normalize(V0);\n            }\n\n            vec3 getLiftPosition(float T) {\n                float a = length(A) * radiusSqrt;\n                float sqrtAD = sqrt(a * D);\n                return log(cosh(sqrtAD * T)) / D * normalize(A);\n            }\n\n            vec4 getViewPosition(float timeElapsed, float radiusAlpha, float eraseAlpha, out float currentRadius, out vec2 rotatedCoord) {\n                currentRadius = initialRadius + (radius - initialRadius) * radiusAlpha + radiusSqrt * timeElapsed * spreadTimeScale;\n                vec3 currentOffset = (radius * radiusAlpha + radiusSqrt * timeElapsed * spreadTimeScale) * offset;\n                vec3 movePosition = getMovePosition(timeElapsed * riseTimeScale, velocity) + getLiftPosition(timeElapsed * riseTimeScale);\n                vec4 viewPosition = viewMatrix * vec4(centerPosition + movePosition + currentOffset * 0.5, 1.0);\n                // vec4 viewPosition = viewMatrix * vec4(centerPosition, 1.0);\n                rotatedCoord = vec2(\n                        position.x * cos(angle) - position.y * sin(angle),\n                        position.x * sin(angle) + position.y * cos(angle));\n                // viewPosition.xyz += offset * currentRadius * 0.5;\n                viewPosition.xy += rotatedCoord * currentRadius;\n                return viewPosition;\n            }\n\n            void main() {\n                vUv = uv;\n\n                float timeElapsed = max(totalTimeElapsed - startTime, 0.0);\n                float radiusAlpha = getRadiusAlpha(damping, timeElapsed * radiusTimeScale);\n                float eraseAlpha = getTimeAlpha(damping, timeElapsed * eraseTimeScale);\n\n                if (startTime == 0.0 || eraseAlpha <= 0.0) {\n                    vDensity = 0.0;\n                    gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(0.0, 0.0, 0.0, 1.0);\n                    return;\n                }\n\n                vRotatedCoord = vec2(0.0);\n                vec4 viewPosition = getViewPosition(timeElapsed, radiusAlpha, eraseAlpha, vCurrentRadius, vRotatedCoord);\n\n                vSunIrradiance = getSunIrradiance(centerPosition.y * METERS_TO_KMS);\n                vSkyIrradiance = getSkyIrradiance(0.0, centerPosition.y * METERS_TO_KMS);\n                vSunDirection = atmosphereProfile.sunDirection;\n\n                // getAirealScattering(centerPosition, cameraPosition, vInScatter, vTransmittance);\n\n                getAirealScattering(normalize(centerPosition - cameraPosition).y, cameraPosition.y * 0.001, length(viewPosition) * 0.001, vInScatter, vTransmittance);\n\n                float opacity = mix(initialColor.a, finalColor.a, radiusAlpha);\n                \n                float currentRadius = initialRadius + (radius - initialRadius) * radiusAlpha + radiusSqrt * timeElapsed * spreadTimeScale;\n                float viewAttenuation = getViewAttenuation(viewPosition.z, currentRadius);\n                vDensity = density * eraseAlpha * opacity * viewAttenuation * (radius / currentRadius);\n\n                vRadiusAlpha = radiusAlpha;\n\n                gl_Position = projectionMatrix * viewPosition;\n            }\n        `}getFragSource(){return`#version 300 es\n            \n            precision mediump float;\n\n            uniform sampler2D tDiffuse;\n\n            uniform mat4 viewMatrix;\n            \n            uniform vec4 initialColor;\n            uniform vec4 finalColor;\n            \n            uniform vec3 initialEmissive;\n            uniform vec3 finalEmissive;\n            \n            uniform sampler2D tDepth;\n            uniform float screenWidth;\n            uniform float screenHeight;\n            uniform float cameraNear;\n            uniform float cameraFar;\n\n            uniform vec3 sunDirection;\n\n            uniform mat4 invViewMatrix;\n\n            in vec2 vUv;\n            in vec2 vRotatedCoord;\n\n            in float vDensity;\n\n            ${gt}\n            \n            ${xt}\n\n            in vec3 vSunIrradiance;\n            in vec3 vSkyIrradiance;\n            in vec3 vSunDirection;\n\n            in vec3 vInScatter;\n            in vec3 vTransmittance;\n\n            in float vRadiusAlpha;\n\n            in float vCurrentRadius;\n\n            out vec4 gDiffuse;\n\n            // layout(location = 0) out vec4 gColor;\n            // layout(location = 1) out vec4 gNormal;\n            // layout(location = 2) out vec4 gSurface;\n            // layout(location = 3) out vec4 gEmissive;\n            // layout(location = 4) out vec4 gFlatNormal;\n\n            #define PI 3.141592653589793\n\n            void main() {\n                if (vDensity <= 0.0 || 1.0 <= length(vRotatedCoord.xy)) discard;\n                // if (1.0 <= length(vRotatedCoord.xy)) discard;\n\n                float alpha = texture(tDiffuse, vUv).r;\n\n                float sampleDensity = alpha * vDensity * getDepthAlpha(vCurrentRadius);\n                float transmittance = 1.0 - exp(-sampleDensity);\n                \n                vec3 viewNormal = vec3(vRotatedCoord, sqrt(1.0 - dot(vRotatedCoord, vRotatedCoord)));\n                vec3 viewSunDirection = (viewMatrix * vec4(vSunDirection, 0.0)).xyz;\n                float directLight = dot(viewNormal, viewSunDirection) * 0.5 + 0.5; // half lambert\n                directLight = 0.15 + directLight * (1.0 - exp(-alpha * 2.0)) * 0.85;\n\n                float ambientLight = getAmbientLight(alpha);\n                \n                vec3 irradiance = directLight * vSunIrradiance / PI + ambientLight * vSkyIrradiance;\n                vec3 diffuse = mix(initialColor.rgb, finalColor.rgb, pow(vRadiusAlpha, alpha)) * irradiance;\n                vec3 emissive = mix(initialEmissive, finalEmissive, pow(vRadiusAlpha, alpha));\n                \n                gDiffuse.rgb = sampleDensity * (diffuse + emissive + vInScatter);\n                gDiffuse.a = sampleDensity;\n\n                // gDiffuse.rgb = vec3(1.0, 0.0, 0.0);\n                // gDiffuse.a = 0.5;\n\n                // gColor = vec4(1.0);\n                // gNormal = vec4(1.0);\n                // gSurface = vec4(1.0);\n                // gEmissive = vec4(1.0);\n                // gFlatNormal = vec4(1.0);\n            }\n        `}getUniforms(t){return{tDiffuse:Pt.A.SMOKE_TEXTURE,modelMatrix:new Mt.A,viewMatrix:new Mt.A,modelViewMatrix:new Mt.A,projectionMatrix:new Mt.A,invViewMatrix:t.invViewMatrix??new Mt.A,cameraPosition:t.cameraPosition??new a.A,radius:t.radius??1,radiusSqrt:t.radiusSqrt??1,initialRadius:t.initialRadius??0,liftForce:t.liftForce??1,spreadScale:t.spreadScale??1,damping:t.damping??1,totalTimeElapsed:t.totalTimeElapsed??0,radiusTimeScale:t.radiusTimeScale??1,eraseTimeScale:t.eraseTimeScale??1,spreadTimeScale:t.spreadTimeScale??1,riseTimeScale:t.riseTimeScale??1,initialColor:t.initialColor??new P.A,finalColor:t.finalColor??new P.A,initialEmissive:t.initialEmissive??new P.A,finalEmissive:t.finalEmissive??new P.A,atmosphereProfile:{}}}}const Lt=WebGL2RenderingContext,Ft=(0,l.P7)(),Ot=100,Vt=Rt(Ot),kt=It(Ot);class Gt extends ft.A{constructor(t={}){super(),this.isInstancedSmokes=!0,this.ts(t),this.createMesh(t)}ts(t){this.radius=t.radius??10,this.radiusSqrt=Math.sqrt(this.radius),this.initialRadius=t.initialRadius??0,this.spreadSpeed=t.spreadSpeed??20*this.radiusSqrt,this.damping=Tt(this.radius,this.spreadSpeed),this.initialColor=t.initialColor?t.initialColor.clone():n.A2.clone(),this.finalColor=t.finalColor?t.finalColor.clone():n.A2.clone(),this.initialEmissive=t.initialEmissive?t.initialEmissive.clone():n.FU.clone(),this.finalEmissive=t.finalEmissive?t.finalEmissive.clone():n.FU.clone(),this.useReverseOrder=t.useReverseOrder??!1,this.numInstances=t.numInstances??Ot,this.currentIndex=this.useReverseOrder?this.numInstances-1:0,this.totalTimeElapsed=0,this.lastTotalTimeElapsed=0,this.timeElapsedLatest=0,this.eraseTimeScale=t.eraseTimeScale??1,this.radiusTimeScale=t.radiusTimeScale??1,this.spreadTimeScale=t.spreadTimeScale??1,this.colorTimeScale=t.colorTimeScale??1,this.riseTimeScale=t.riseTimeScale??1,this.tmpOffset=new a.A,this.liftForce=t.liftForce??.1*this.radiusSqrt,this.density=t.density??1,this.isEmitterRemoved=!1}createMesh(t){this.geometry=this.createGeometry(t),this.material=this.createMaterial(t),this.mesh=new D.A(this.geometry,this.material),this.mesh.frustumCulled=!1}createGeometry(){const t=new Ut;return t.setAttribute("position",Ft.attributes.position),t.setAttribute("uv",Ft.attributes.uv),t.setIndices(Ft.getIndices()),this.centerPositions=new J.A(new Float32Array(3*this.numInstances),3,Lt.FLOAT,1),this.offsets=this.numInstances===Ot?Vt:Rt(this.numInstances),this.velocities=new J.A(new Float32Array(3*this.numInstances),3,Lt.FLOAT,1),this.densities=new J.A(new Float32Array(this.numInstances),1,Lt.FLOAT,1),this.angles=this.numInstances===Ot?kt:It(this.numInstances),this.startTimes=new J.A(new Float32Array(this.numInstances),1,Lt.FLOAT,1),t.setAttribute("centerPosition",this.centerPositions),t.setAttribute("velocity",this.velocities),t.setAttribute("offset",this.offsets),t.setAttribute("density",this.densities),t.setAttribute("angle",this.angles),t.setAttribute("startTime",this.startTimes),t.instanceCount=this.numInstances,t.needsUpdate=!0,t}createMaterial(){return new zt({radius:this.radius,radiusSqrt:this.radiusSqrt,initialRadius:this.initialRadius,damping:this.damping,initialColor:this.initialColor,finalColor:this.finalColor,initialEmissive:this.initialEmissive,finalEmissive:this.finalEmissive,liftForce:this.liftForce??1,radiusTimeScale:this.radiusTimeScale??1,eraseTimeScale:this.eraseTimeScale??1,spreadTimeScale:this.spreadTimeScale??1.5,colorTimeScale:this.colorTimeScale??1,riseTimeScale:this.riseTimeScale??1})}fixedUpdate(t,i,s){this.lastTotalTimeElapsed=this.totalTimeElapsed,this.totalTimeElapsed+=i,this.timeElapsedLatest+=i,this.isEmitterRemoved&&Dt(this.damping,this.timeElapsedLatest*this.eraseTimeScale)<.01&&this.parent.remove(this)}lateUpdate(t,i,s){const n=(0,l.Cc)(this.lastTotalTimeElapsed,this.totalTimeElapsed,s);this.material.uniforms.totalTimeElapsed=n,this.mesh.material.uniforms.screenWidth=window.innerWidth,this.mesh.material.uniforms.screenHeight=window.innerHeight,this.mesh.material.uniforms.cameraNear=this.scene.mainCamera.near,this.mesh.material.uniforms.cameraFar=this.scene.mainCamera.far,this.mesh.material.uniforms.tDepth=this.scene.main.renderingPipeline.multipleFramebuffer.depthTexture,this.material.uniforms.invViewMatrix=this.scene.mainCamera.modelMatrix}add(t){this.centerPositions.setXYZ(this.currentIndex,t.position.x,t.position.y,t.position.z),t.velocity&&this.velocities.setXYZ(this.currentIndex,t.velocity.x,t.velocity.y,t.velocity.z),this.densities.setX(this.currentIndex,t.density??this.density),this.startTimes.setX(this.currentIndex,t.startTime??this.totalTimeElapsed),this.geometry.attributes.centerPosition.needsUpdate=!0,this.geometry.attributes.velocity.needsUpdate=!0,this.geometry.attributes.density.needsUpdate=!0,this.geometry.attributes.startTime.needsUpdate=!0,this.geometry.needsUpdate=!0,this.useReverseOrder?(this.currentIndex--,this.currentIndex<0&&(this.currentIndex=this.numInstances-1)):(this.currentIndex++,this.numInstances-1<this.currentIndex&&(this.currentIndex=0)),this.timeElapsedLatest=0}}const Bt=new P.A(.3,.3,.3,1),Ht=new a.A,jt=(new a.A,new r.A);class Wt extends ft.A{constructor(t,i){super(),this.position=(new a.A).copy(t),this.lastPosition=this.position.clone(),this.lerpedPosition=this.position.clone(),this.velocity=new a.A,i.velocity&&this.velocity.copy(i.velocity),this.deltaVelocity=new a.A,this.angularVelocity=new a.A(2*(Math.random()-.5),2*(Math.random()-.5),2*(Math.random()-.5)),this.angularVelocity.normalize(),this.angularVelocity.scale(30*Math.random(),this.angularVelocity),this.quaternion=new r.A,this.lastQuaternion=this.quaternion.clone(),this.lerpedQuaternion=this.quaternion.clone(),this.damping=i.damping??1,this.size=i.size??1,this.sizeSqrt=Math.sqrt(this.size),this.frameRadius=i.frameRadius??2*this.size,this.frameRadiusSqrt=Math.sqrt(this.frameRadius),this.flames=i.useFlame?new Gt({radius:this.frameRadius,initialRadius:.25*this.frameRadius,initialColor:i.flame.initialColor??n.F5,finalColor:i.flame.initialColor??n.F5,initialEmissive:i.flame.initialEmissive??n.L6,finalEmissive:i.flame.finalEmissive??n.P2,radiusTimeScale:i.flame.radiusTimeScale??n.iE,eraseTimeScale:i.flame.eraseTimeScale??n.eJ,numInstances:50,eraseTimeScale:5,riseTimeScale:0}):null,this.createMesh(i),this.flameTimer=.01*this.frameRadiusSqrt,this.timeElapsed=0}onAdded(){this.game.add(this.flames)}onRemoved(){this.flames.isEmitterRemoved=!0}createMesh(t){const i=(0,l.Ho)(.5*this.size),s=new bt.A({colorFactor:Bt});this.mesh=new D.A(i,s)}fixedUpdate(t,i){this.game.getGravity().scale(i,Ht),this.velocity.add(Ht,this.velocity),this.velocity.scale(Math.pow(this.damping,i),this.velocity),this.velocity.scale(i,this.deltaVelocity),this.lastPosition.copy(this.position),this.position.add(this.deltaVelocity,this.position),this.angularVelocity.add(Ht,this.angularVelocity),this.angularVelocity.scale(Math.pow(this.damping,i),this.angularVelocity),this.lastQuaternion.copy(this.quaternion),jt.copy(this.quaternion),jt.integrate(this.angularVelocity,i,n.ge,this.quaternion),this.quaternion.normalize(),this.flameTimer-=i;const s=Math.exp(-this.timeElapsed/this.frameRadiusSqrt*this.flames.radiusTimeScale*10);s<.01?this.flames.isEmitterRemoved=!0:this.flameTimer<=0&&(this.flames.add({position:this.position,velocity:this.velocity,density:n.L2*s}),this.flameTimer=.01*this.frameRadiusSqrt),this.timeElapsed+=i,5*this.sizeSqrt<this.timeElapsed&&this.parent.remove(this)}lateUpdate(t,i,s){this.lastPosition.lerp(this.position,s,this.lerpedPosition),this.mesh.position.copy(this.lerpedPosition),this.lastQuaternion.slerp(this.quaternion,s,this.lerpedQuaternion),this.mesh.quaternion.copy(this.lerpedQuaternion)}}const $t=new P.A(300,150,0,1),Xt=new P.A(.02,.02,.02,1);class Zt extends St.Ay{constructor(t={}){super(t),this.side=St.c0}getVertSource(){return`#version 300 es\n            \n            precision mediump float;\n            \n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec2 uv;\n\n            layout (location = 2) in vec3 offset;\n            layout (location = 3) in vec3 omega;\n            layout (location = 4) in float scale;\n                \n            uniform mat4 modelMatrix;\n            uniform mat4 viewMatrix;\n            uniform mat4 modelViewMatrix;\n            uniform mat4 projectionMatrix;\n\n            uniform vec3 cameraPosition;\n            \n            uniform float spreadRadius;\n            uniform float damping;\n            uniform float size;\n\n            uniform float timeElapsed;\n\n            out vec3 vNormal;\n            out vec2 vUv;\n\n            ${gt}\n            \n            vec3 rotatePoint(vec3 point, vec3 omega, float t) {\n                float wlen = length(omega);\n\n                float theta = wlen * t;\n                vec3 u = omega / wlen;\n                float cosTheta = cos(theta);\n                float sinTheta = sin(theta);\n\n                vec3 term1 = point * cosTheta;\n                vec3 term2 = cross(u, point) * sinTheta;\n                vec3 term3 = u * (dot(u, point) * (1.0 - cosTheta));\n\n                return term1 + term2 + term3;\n            }\n\n            void main() {\n                vUv = uv;\n                vNormal = normalize((viewMatrix * vec4(0.0, 0.0, 1.0, 0.0)).xyz);\n\n                float currentspreadRadius = spreadRadius * getRadiusAlpha(damping, timeElapsed);\n                vec4 viewPosition = viewMatrix * modelMatrix * vec4(offset * currentspreadRadius, 1.0);\n                // viewPosition.xyz += position * getScaleAlpha(timeElapsed, sizeSqrt);\n                // viewPosition.xyz += position * size * getTimeAlpha(damping, timeElapsed);\n                // viewPosition.xyz += rotatePoint(position * scale, omega, timeElapsed) * size * getTimeAlpha(damping, timeElapsed);\n                viewPosition.xyz += rotatePoint(position * scale, omega, timeElapsed) * size;\n                gl_Position = projectionMatrix * viewPosition;\n            }\n        `}getFragSource(){return"#version 300 es\n            \n            precision mediump float;\n\n            in vec3 vNormal;\n            in vec2 vUv;\n            \n            layout(location = 0) out vec4 gColor;\n            layout(location = 1) out vec4 gNormal;\n            layout(location = 2) out vec4 gSurface;\n            layout(location = 3) out vec4 gEmissive;\n            layout(location = 4) out vec4 gFlatNormal;\n\n            void main() {\n                gColor = vec4(0.1, 0.1, 0.1, 1.0);\n                gNormal = vec4(vNormal, 0.0 );\n                gSurface = vec4(0.0, 1.0, 0.0, 0.0);\n                gEmissive = vec4(0.0, 0.0, 0.0, 0.0);\n                gFlatNormal = vec4(vNormal, 0.0 );\n            }\n        "}getUniforms(t){return{modelMatrix:new Mt.A,viewMatrix:new Mt.A,modelViewMatrix:new Mt.A,projectionMatrix:new Mt.A,cameraPosition:new a.A,spreadRadius:t.spreadRadius??1,timeElapsed:t.timeElapsed??0,size:t.size??1,damping:t.damping??1}}}const Yt=Rt(30),Kt=Rt(30,10),Jt=function(t,i=.5,s=1.5){const n=new J.A(new Float32Array(1*t),1,Nt.FLOAT,1);for(let e=0;e<t;e++)n.setX(e,i+Math.random()*(s-i));return n}(30),Qt=(0,l.Ho)(),ti=new Ut;ti.setAttribute("position",Qt.attributes.position),ti.setAttribute("uv",Qt.attributes.uv),ti.setIndices(Qt.getIndices()),ti.setAttribute("offset",Yt),ti.setAttribute("omega",Kt),ti.setAttribute("scale",Jt),ti.instanceCount=30;const ii=new a.A;class si extends ft.A{constructor(t,i){super(),this.position=t.clone(),this.lastPosition=this.position.clone(),this.lerpedPosition=this.position.clone(),this.ts(i),this.createMesh(i)}ts(t){this.size=t.size??1,this.sizeSqrt=Math.sqrt(this.size),this.spreadRadius=t.spreadRadius??200*this.size,this.spreadSpeed=t.spreadSpeed??20*Math.sqrt(this.spreadRadius),this.damping=Tt(this.spreadRadius,.5*this.spreadSpeed),this.normal=new a.A,t.normal&&this.normal.copy(t.normal);const i=qt(this.spreadRadius/Math.PI,this.damping);this.velocity=this.normal.scale(i),t.velocity&&this.velocity.add(t.velocity,this.velocity),this.deltaVelocity=new a.A,this.orientation=t.orientation??(0,l.Mn)(),this.timeElapsed=0,this.lastTimeElapsed=0}createMesh(t){this.geometry=this.createGeometry(),this.material=this.createMaterial(),this.mesh=new D.A(this.geometry,this.material),t.orientation&&this.mesh.quaternion.copy(t.orientation),this.mesh.position.copy(this.position),this.mesh.frustumCulled=!1,this.mesh.castShadow=!1,ii.set(2*Math.random()-1,2*Math.random()-1,2*Math.random()-1),ii.normalize();const i=Math.random()*Math.PI*2;this.mesh.quaternion.setFromAxisAngle(ii,i)}createGeometry(){return ti}createMaterial(){return new Zt({spreadRadius:this.spreadRadius,damping:this.damping,size:this.size})}fixedUpdate(t,i,s){this.velocity.add(this.game.getGravity().scale(i),this.velocity),this.velocity.scale(Math.pow(this.damping,i),this.velocity),this.velocity.scale(i,this.deltaVelocity),this.lastPosition.copy(this.position),this.position.add(this.deltaVelocity,this.position),this.lastTimeElapsed=this.timeElapsed,this.timeElapsed+=i,this.scene&&Dt(this.damping,this.timeElapsed)<.5&&this.parent.remove(this)}lateUpdate(t,i,s){this.lastPosition.lerp(this.position,s,this.lerpedPosition),this.mesh.position.copy(this.lerpedPosition);const n=this.timeElapsed;this.mesh.material.uniforms.timeElapsed=n}}class ni extends St.Ay{constructor(t={}){super(t),this.depthWrite=!1,this.renderingPass=n.xF,this.transparent=!0,this.blending=St.vU}getVertSource(){return`#version 300 es\n            \n            precision mediump float;\n            \n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec2 uv;\n\n            layout (location = 2) in vec3 offset;\n                \n            uniform mat4 modelMatrix;\n            uniform mat4 viewMatrix;\n            uniform mat4 modelViewMatrix;\n            uniform mat4 projectionMatrix;\n\n            uniform vec3 cameraPosition;\n            \n            uniform float spreadRadius;\n            uniform float damping;\n            uniform float size;\n\n            uniform float timeElapsed;\n            \n            out vec2 vUv;\n            out vec3 vPosition;\n\n            out float vRadiusAlpha;\n            out float vTimeAlpha;\n\n            out float vDistance;\n            out float vScale;\n\n            out vec3 vInScatter;\n            out vec3 vTransmittance;\n\n            ${yt.mz}\n\n            ${gt}\n\n            ${yt.SY}\n            \n            void main() {\n                vUv = uv;\n                vPosition = position;\n\n                vRadiusAlpha = getRadiusAlpha(damping, timeElapsed);\n                vTimeAlpha = getTimeAlpha(damping, timeElapsed * 20.0);\n\n                vec4 worldPosition = modelMatrix * vec4(offset * spreadRadius * vRadiusAlpha, 1.0);\n                vec4 viewPosition = viewMatrix * worldPosition;\n\n                getAirealScattering(normalize(worldPosition.xyz - cameraPosition).y, cameraPosition.y * 0.001, length(viewPosition) * 0.001, vInScatter, vTransmittance);\n\n                vDistance = -viewPosition.z;\n                vScale = max(0.1, vDistance * 0.005 / size);\n                viewPosition.xyz += position * vScale * size;\n                gl_Position = projectionMatrix * viewPosition;\n            }\n        `}getFragSource(){return"#version 300 es\n            \n            precision mediump float;\n\n            uniform float size;\n\n            in vec2 vUv;\n            in vec3 vPosition;\n\n            in float vRadiusAlpha;\n            in float vTimeAlpha;\n\n            in float vDistance;\n            in float vScale;\n\n            in vec3 vInScatter;\n            in vec3 vTransmittance;\n\n            out vec4 gDiffuse;\n            \n            void main() {\n                vec2 coord = vUv * 2.0 - 1.0;\n\n                float density = exp(-length(coord * 15.0)) * 50.0 * vTimeAlpha / pow(vScale, 2.0);\n                float transmittance = 1.0 - exp(-density);\n                vec3 emissive = vec3(1.0, 0.9, 0.5) * 10.0 * density;\n\n                gDiffuse.rgb = (emissive + vInScatter) * density * vTransmittance;\n                gDiffuse.a = density;\n\n                // gDiffuse.rgb = vec3(1.0, 0.0, 0.0);\n                // gDiffuse.a = 1.0;\n            }\n        "}getUniforms(t){return{modelMatrix:new Mt.A,viewMatrix:new Mt.A,modelViewMatrix:new Mt.A,projectionMatrix:new Mt.A,cameraPosition:new a.A,cameraVelocity:new a.A,spreadRadius:t.spreadRadius??1,timeElapsed:t.timeElapsed??0,size:t.size??1,damping:t.damping??1,atmosphereProfile:{}}}}const ei=(0,l.P7)(),hi=new Ut;hi.setAttribute("position",ei.attributes.position),hi.setAttribute("uv",ei.attributes.uv),hi.setAttribute("offset",Rt(40)),hi.setIndices(ei.getIndices()),hi.instanceCount=40;const oi=new a.A;class ri extends si{constructor(t,i){super(t,i)}createMesh(t){this.geometry=this.createGeometry(t),this.material=this.createMaterial(t),this.mesh=new D.A(this.geometry,this.material),t.orientation&&this.mesh.quaternion.copy(t.orientation),this.mesh.position.copy(this.position),oi.set(2*Math.random()-1,2*Math.random()-1,2*Math.random()-1),oi.normalize();const i=Math.random()*Math.PI*2;this.mesh.quaternion.setFromAxisAngle(oi,i),this.mesh.frustumCulled=!1}createGeometry(){return hi}createMaterial(){return new ni({spreadRadius:this.spreadRadius,damping:this.damping,size:this.size})}}class ai extends ft.A{constructor(t,i={}){if(super(),this.position=(new a.A).copy(t),this.mesh=new R.A,this.isLight=i.isLight,this.ts(i),this.createEffects(i),i.audio)i.audio.start(0,0),this.audios.push(i.audio);else if(i.audios)for(const t of i.audios)t.start(0,0),this.audios.push(...i.audios)}ts(t){this.normal=new a.A,t.normal&&(this.normal.copy(t.normal),this.normal.normalize()),this.useSmoke=t.useSmoke??!0,this.useFlameDebris=t.useFlameDebris??!0,this.useInstancedDebris=t.useInstancedDebris??!0,this.useSparks=t.useSparks??!0,this.radius=t.radius??100,this.radiusSqrt=Math.sqrt(this.radius),this.timeElapsed=0,this.initialColor=t.initialColor??Xt,this.finalColor=t.finalColor??Xt,this.initialEmissive=t.initialEmissive??$t,this.finalEmissive=t.finalEmissive??new P.A,this.orientation=(0,l.Mn)(),this.velocity=new a.A,t.velocity&&this.velocity.copy(t.velocity),this.duration=this.radiusSqrt}createEffects(t){if(this.useSmoke&&(this.smoke=new Ct(this.position,{radius:this.radius,speed:t.flameSpeed??30*this.radiusSqrt,normal:this.normal,density:t.density??10,initialColor:this.initialColor,finalColor:this.finalColor,initialEmissive:this.initialEmissive,finalEmissive:this.finalEmissive,opacity:this.opacity,velocity:this.velocity})),this.useInstancedDebris){const t=1.5*this.radius;this.instancedDebris=new si(this.position,{size:.02*t,spreadRadius:3*t,orientation:this.orientation,normal:this.normal,numInstances:100,velocity:this.velocity})}if(this.useSparks&&(this.sparks=new ri(this.position,{size:.05*this.radius,spreadRadius:2*this.radius,orientation:this.orientation,normal:this.normal,numInstances:100,velocity:this.velocity})),this.useFlameDebris){const i=t.flameDebris,s=i?.size??.075*this.radius,n=i?.radius??3*this.radius,e=i?.spreadSpeed??20*this.radiusSqrt,h=Tt(n,e),o=this.normal.scale(-1);this.debris=[];for(let t=0;t<6;t++){const t=(0,l.Vs)(),i=t.scale(.5*e+Math.random()*e),n=Math.max(0,i.dot(o));i.add(this.normal.scale(2*n),i),i.add(this.velocity,i);const r=new Wt(this.position.add(t.scale(.25*this.radius)),{size:s,velocity:i,damping:h,useFlame:!0,flame:{}});this.debris.push(r)}}}onAdded(){if(this.smoke&&this.parent.add(this.smoke),this.sparks&&this.parent.add(this.sparks),this.debris)for(const t of this.debris)this.parent.add(t);this.instancedDebris&&this.parent.add(this.instancedDebris)}onRemoved(){super.onRemoved(),this.smoke&&(this.smoke.isEmitterRemoved=!0)}onPause(){super.onPause()}onContinue(){super.onContinue()}fixedUpdate(t,i,s){this.timeElapsed+=i,this.smoke?Dt(this.smoke.damping,this.smoke.timeElapsed)<.01&&this.parent.remove(this):3*this.radiusSqrt<this.timeElapsed&&this.parent.remove(this)}}const ci=new P.A(1,.95,.9,1).scale(.1),li=new P.A(1,.5,0,1).scale(3),ui=new a.A;class fi extends ft.A{constructor(t,i,s,n,e,h){super(),this.isTerrainTile=!0,this.isStatic=!0,this.width=t;const o=.5*this.width;this.offset=new a.A(o,o,o),this.division=i,this.cellSize=this.width/this.division,this.mesh=s,this.mesh.static=!0,this.terrainBody=n,this.terrainBody.actor=this,this.bodies.push(this.terrainBody),this.objectsBody=e,this.objectsBody.actor=this,this.bodies.push(this.objectsBody),this.objectsBody.onCollision=this.ss.bind(this),this.groundTypes=h,this.objectCells=[],this.grassesMesh=null}applyDamageRaycast(t,i,s){const n=t.hitShape;n.mesh&&n.destructive&&(n.health-=i,n.health<=0&&this.ns(n,t.shapePosition,t.shapeQuaternion))}ss(t){const i=t.thisShape;i.mesh&&i.destructive&&(1e-6<Math.abs(i.maxImpulse-t.impulse)||this.ns(i,t.thisPosition,t.thisQuaternion))}ns(t,i,s){this.es(t.mesh,t.instanceIndex),t.active=!1;const e=new vt.A;t.shape.calculateAABB(i,s,e);const h=e.getCenter();t.shape.calculateAABB(n.VT,n.zN,e);const o=e.max.sub(e.min),r=(o.x+o.y+o.z)/3;this.game.add(new ai(h,{radius:1.5*r,initialRadius:1.5*r*.25,useFlameDebris:!1,useSparks:!1,playSound:!1,density:6,initialColor:ci,finalColor:ci,initialEmissive:li}))}es(t,i){const s=t.geometry;if(s){const t=s.attributes.offset,n=new a.A;t.getValue(i,n),t.setXYZ(i,n.x,n.y-100,n.z),t.needsUpdate=!0,s.needsUpdate=!0}for(const s of t.children)this.es(s,i)}clone(){const t=new fi(this.width,this.division,this.mesh.clone(!1),this.terrainBody.clone(),this.objectsBody.clone(),this.groundTypes);for(const i of this.objectCells)t.addObjectCell(i.clone(!0));return t.setGrassesMesh(this.grassesMesh.clone(!0)),t}addObjectCell(t){this.objectCells.push(t),this.mesh.add(t)}setGrassesMesh(t){this.grassesMesh=t,this.mesh.add(t)}getGroundType(t){const i=ui.copy(t);i.sub(this.terrainBody.position,i),i.add(this.offset,i),i.scale(1/this.cellSize,i);const s=Math.floor(i.x),n=Math.floor(i.z),e=this.division*n+s;return this.groundTypes[e]}applyGraphicSettings(t){const i=t.viewDistance,s=t.drawGrasses;this.grassesMesh.visible=s;for(const t of this.objectCells)for(const s of t.children)s.drawDistance=i*n.dH+s.boundingRadius,s.lods[0].distance=i*n.mX,s.lods[0].material.uniforms.fadeStartDistance=i*n.aW,s.lods[0].material.uniforms.fadeEndDistance=i*n.Hy}}class di extends ft.A{constructor(t,i){super(),this.mesh=new R.A({isStatic:!0}),this.mesh.hs="Terrain",this.isTerrain=!0,this.config=t,this.size=t.size,this.halfSize=.5*this.size,this.offset=new a.A(this.halfSize,this.halfSize,this.halfSize),this.tileSize=t.tileSize,this.tileDivision=t.tileDivision,this.tilePlacements=t.tilePlacements,this.tilePrefabs=i,this.tiles=[];for(let t=0;t<this.config.tilePlacements.length;t++){const i=this.tilePrefabs[this.config.tilePlacements[t]].clone();this.tiles.push(i);const s=this.getTilePosition(t);i.mesh.position.copy(s),i.terrainBody.position.copy(s),i.terrainBody.updateAABB(),i.objectsBody.position.copy(s),i.objectsBody.updateAABB(),this.add(i)}if(this.runways=[],this.config.runways)for(const t of this.config.runways){const i=(new a.A).copy(t.start),s=(new a.A).copy(t.end),e=s.vsub(i),h=e.length();e.normalize();const o=(new a.A).copy(t.touchDown);this.runways.push({start:i,end:s,center:i.add(s).scale(.5),touchDown:o,direction:e,length:h,width:t.width});e.negate();const r=n.UP.cross(e);r.normalize();o.add(r.scale(75)).y+=1.5}}getTilePosition(t,i){const s=this.config.size/this.config.tileDivision,n=-this.config.size/2+s/2;let e=n+t%this.config.tileDivision*s,h=n+Math.floor(t/this.config.tileDivision)*s;return new a.A(e,0,h)}getGroundType(t){const i=t.clone();i.add(this.offset,i),i.scale(1/this.tileSize,i);const s=new a.A(Math.floor(i.x),Math.floor(i.y),Math.floor(i.z)),n=this.tileDivision*s.z+s.x;return this.tiles[n].getGroundType(t)}applyGraphicSettings(t){t.viewDistance,t.drawGrasses;for(const i of this.tiles)i.applyGraphicSettings(t)}}var vi=s(8481),mi=s(4598),wi=s(2319),pi=(s(20),s(7907)),gi=s(2577),xi=s(9794);class Mi extends St.Ay{constructor(t,i={}){super(i),this.slices=t,this.config=i,this.roughness=i.roughness??1,this.metalness=i.metalness??0,this.transparent=i.transparent??!1,this.vertSource=this.getVertSource(),this.fragSource=this.getFragSource(),this.uniforms=this.getUniforms(i)}getVertSource(){return`#version 300 es\n\n            #define PI 3.141592653589793\n            #define slices ${this.slices}.0\n        \n            precision mediump float;\n            \n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec2 uv;\n\n            const vec3 UP = vec3(0.0, 1.0, 0.0);\n            const vec3 BACK = vec3(0.0, 0.0, 1.0);\n            \n            uniform mat4 modelMatrix;\n            uniform mat4 viewMatrix;\n            uniform mat4 projectionMatrix;\n\n            uniform vec3 cameraPosition;\n            \n            out vec2 vUv;\n            out vec3 vPosition;\n\n            out vec3 vNormal;\n            out vec3 vTangent;\n            out vec3 vBitangent;\n\n            out float vIndex;\n\n            out float vAlpha;\n\n            void main() {\n                vec3 center = (modelMatrix * vec4(0.0, 0.0, 0.0, 1.0)).xyz;\n\n                vec3 centerToCamera = cameraPosition - center;\n\n                vNormal = normalize(cameraPosition - center);\n                vTangent = normalize(cross(UP, vNormal));\n                vBitangent = normalize(cross(vNormal, vTangent));\n                vNormal = normalize(cross(vTangent, vBitangent));\n\n                vec3 localPosition = position.x * vTangent + position.y * vBitangent;\n                vPosition = center + localPosition;\n                float dist = length(centerToCamera);\n                vAlpha = clamp((dist - 2500.0) / 2500.0 + angle / (PI * 2.0), 0.0, 1.0);\n\n                vUv = uv;\n\n                vIndex = 0.0;\n                \n                float visibleDist = 2500.0 + 2500.0 * angle / (PI * 2.0);\n                float dist = length(centerToCamera);\n                vAlpha = step(dist, visibleDist);\n\n                gl_Position = projectionMatrix * viewMatrix * vec4(vPosition, 1.0);\n            }\n        `}getFragSource(){return"#version 300 es\n\n            precision mediump sampler2DArray;    \n            precision mediump float;\n\n            in vec3 vPosition;\n            in vec2 vUv;\n\n            in vec3 vNormal;\n            in vec3 vTangent;\n            in vec3 vBitangent;\n\n            in float vIndex;\n\n            in float vAlpha;\n\n            uniform float roughness;\n            uniform float metalness;\n\n            // uniform sampler2DArray tAlbedos;\n            // uniform sampler2DArray tNormals;\n\n            uniform sampler2D tAlbedos;\n            uniform sampler2D tNormals;\n\n            layout(location = 0) out vec4 gColor;\n            layout(location = 1) out vec4 gNormal;\n            layout(location = 2) out vec4 gSurface;\n            layout(location = 3) out vec4 gEmissive;\n            layout(location = 4) out vec4 gFlatNormal;\n            \n            vec3 getNormal(vec3 normalMap, vec3 normal, vec3 tangent, vec3 bitangent) {\n                return tangent * normalMap.x + bitangent * normalMap.y + normal * normalMap.z;\n            }\n\n            void main() {\n                // discard;\n                // if (vAlpha < 0.5) discard;\n\n                // gColor = texture(tAlbedos, vec3(vUv, 0.0));\n                gColor = texture(tAlbedos, vUv);\n                if (gColor.a < 0.5) discard;\n\n                // gColor = vec4(1.0, 0.0, 0.0, 1.0);\n\n                // vec4 normalMap = texture(tNormals, vec3(vUv, 0.0));\n                vec4 normalMap = texture(tNormals, vUv);\n                gNormal.xyz = normalize(getNormal(normalMap.xyz, vNormal, vTangent, vBitangent));\n                // gNormal.w = 1.0;\n\n                // gNormal.xyz = normalize(vNormal);\n                // gNormal.w = 1.0;\n\n                gSurface = vec4(0.0, roughness, metalness, 0.0);\n                gEmissive = vec4(0.0);\n\n                // if (normalMap.w < 0.5) gColor.rgb = vec3(1.0, 0.0, 0.0);\n\n                gFlatNormal = vec4(vNormal, 0.0);\n            }\n        "}getUniforms(t){return{modelMatrix:new Mt.A,viewMatrix:new Mt.A,projectionMatrix:new Mt.A,roughness:this.roughness,metalness:this.metalness,tAlbedos:new _t.A,tNormals:new _t.A,tAlphaDepth:new _t.A,size:1,depthScale:1}}}class Si extends Mi{constructor(t,i={}){super(t,i)}getFragSource(){return"#version 300 es\n\n            precision mediump sampler2DArray;    \n            precision mediump float;\n\n            in vec3 vPosition;\n            in vec2 vUv;\n\n            in vec3 vNormal;\n            in vec3 vTangent;\n            in vec3 vBitangent;\n\n            in float vIndex;\n\n            uniform float roughness;\n            uniform float metalness;\n\n            uniform float size;\n\n            // uniform sampler2DArray tAlbedos;\n            // uniform sampler2DArray tNormals;\n\n            uniform sampler2D tAlbedos;\n            uniform sampler2D tNormals;\n            uniform sampler2D tAlphaDepth;\n\n            layout(location = 0) out vec4 gColor;\n            layout(location = 1) out vec4 gNormal;\n            layout(location = 2) out vec4 gSurface;\n            layout(location = 3) out vec4 gEmissive;\n            layout(location = 4) out vec4 gFlatNormal;\n\n            void main() {\n                vec4 alphaDepth = texture(tAlphaDepth, vUv);\n                // vec4 albedo = texture(tAlbedos, vec3(vUv, vIndex));\n                vec4 albedo = texture(tAlbedos, vUv);\n                if (albedo.a < 0.5) discard;\n\n                // gl_FragDepth = gl_FragCoord.z + (tNormals.w - 0.5) * size;\n\n                // gl_FragDepth = gl_FragDepth - 1.0;\n            }\n        "}}var yi=s(8633);s(9459);class _i extends St.Ay{constructor(t={}){super(t),this.config=t,this.colorFactor=new P.A(1,1,1,1),Array.isArray(t.colorFactor)?this.colorFactor.copyFromArray(t.colorFactor):t.colorFactor&&this.colorFactor.copy(t.colorFactor),this.colorTexture=t.colorTexture,this.uniforms=this.getUniforms()}getVertSource(){return"#version 300 es\n\n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec2 uv;\n            \n            out vec2 vUv;\n\n            void main() {\n                vUv = uv;\n                gl_Position = vec4(position, 1.0);\n            }\n        "}getFragSource(){return"#version 300 es\n            \n            precision mediump float;\n            precision mediump sampler2D;\n            precision mediump sampler2DArray;\n\n            // uniform sampler2DArray tAlbedo;\n            // uniform sampler2DArray tNormal;\n\n            uniform sampler2D tAlbedo;\n            uniform sampler2D tNormal;\n\n            uniform float texelSize;\n\n            uniform float layer;\n\n            in vec2 vUv;\n\n            const int maxStep = 64;\n\n            layout(location = 0) out vec4 gAlbedo;\n            layout(location = 1) out vec4 gNormal;\n\n            const vec2[8] offsets = vec2[](\n                vec2(-1.0, 0.0), vec2(1.0, 0.0), vec2(0.0,  1.0), vec2( 0.0, -1.0), \n                vec2(-1.0, 1.0), vec2(1.0, 1.0), vec2(1.0, -1.0), vec2(-1.0, -1.0)\n            );\n\n            void main() {\n                vec2 coords = vUv;\n                \n                // vec4 albedo = texture(tAlbedo, vec3(coords, layer));\n                // vec4 normal = texture(tNormal, vec3(coords, layer));\n                vec4 albedo = texture(tAlbedo, coords);\n                vec4 normal = texture(tNormal, coords);\n\n                if (albedo.a < 0.5) {\n                    for (int curr_dist = 0; curr_dist < maxStep; curr_dist++) {\n                        for(int o = 0; o < 8; o++) {\n                            vec2 off_coords = offsets[o] * texelSize * float(curr_dist + 1);\n                            // vec4 off_sample = texture(tAlbedo, vec3(coords + off_coords, layer));\n                            vec4 off_sample = texture(tAlbedo, coords + off_coords);\n\n                            if (0.5 < off_sample.a) {\n                                float alpha = 0.45 - (float(curr_dist + 1) / 32.0);\n                                alpha = clamp(alpha, 0.0, 1.0);\n\n                                gAlbedo = vec4(off_sample.rgb, alpha);\n                                // gNormal = texture(tNormal, vec3(coords + off_coords, layer));\n                                gNormal = texture(tNormal, coords + off_coords);\n                                return;\n                            }\n                        }\n                    }\n                } else {\n                    for (int curr_dist = 0; curr_dist < maxStep; curr_dist++) {\n                        for(int o = 0; o < 8; o++) {\n                            vec2 off_coords = offsets[o] * texelSize * float(curr_dist + 1);\n                            // vec4 off_sample = texture(tAlbedo, vec3(coords + off_coords, layer));\n                            vec4 off_sample = texture(tAlbedo, coords + off_coords);\n\n                            if (off_sample.a < 0.5) {\n                                float alpha = float(curr_dist) / 32.0;\n                                alpha = clamp(alpha, 0.55, 1.0);\n\n                                gAlbedo = vec4(albedo.rgb, alpha);\n                                gNormal = vec4(normal.rgb, alpha);\n                                return;\n                            }\n                            \n                        }\n                    }\n                }\n\n                gAlbedo = albedo;\n                gNormal = normal;\n            }\n        "}getUniforms(){return{tAlbedo:this.diffuseTexture,tNormal:this.diffuseTexture,layer:0,texelSize:0}}}class Pi extends St.Ay{constructor(t={}){super(t),this.config=t,this.colorFactor=new P.A(1,1,1,1),Array.isArray(t.colorFactor)?this.colorFactor.copyFromArray(t.colorFactor):t.colorFactor&&this.colorFactor.copy(t.colorFactor),this.colorTexture=t.colorTexture,this.uniforms=this.getUniforms()}getVertSource(){return`#version 300 es\n        \n            precision mediump float;\n\n            ${this.colorTexture?"#define USE_COLOR_MAP":""}\n            \n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec3 normal;\n            #ifdef USE_COLOR_MAP\n            layout (location = 2) in vec2 uv;\n            #endif\n            \n            uniform mat4 modelViewMatrix;\n            uniform mat4 projectionMatrix;\n            \n            out vec3 vNormal;\n            #ifdef USE_COLOR_MAP\n            out vec2 vUv;\n            #endif\n\n            void main() {\n                #ifdef USE_COLOR_MAP\n                vUv = uv;\n                #endif\n\n                vec4 viewNormal = modelViewMatrix * vec4(normal, 0.0);\n                vNormal = normalize(viewNormal.xyz);\n\n                gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n            }\n        `}getFragSource(){return`#version 300 es\n            \n            precision mediump float;\n\n            ${this.colorTexture?"#define USE_COLOR_MAP":""}\n\n            in vec3 vNormal;\n            #ifdef USE_COLOR_MAP\n            in vec2 vUv;\n            #endif\n\n            #ifdef USE_COLOR_MAP\n            uniform sampler2D tColor;\n            #endif\n            uniform vec4 colorFactor;\n\n            uniform mat4 invProjectionMatrix;\n\n            layout(location = 0) out vec4 gAlbedo;\n            layout(location = 1) out vec4 gNormal;\n            layout(location = 2) out vec2 gAlphaDepth;\n\n            void main() {\n                #ifdef USE_COLOR_MAP\n                gAlbedo = texture(tColor, vUv) * colorFactor;\n                #else\n                gAlbedo = colorFactor;\n                #endif\n                \n                float z = gl_FragCoord.z * 2.0 - 1.0;\n                vec4 clipPos = vec4(0.0, 0.0, z, 1.0);\n                vec4 viewPos = invProjectionMatrix * clipPos;\n                viewPos /= viewPos.w;\n                float linearDepth = -viewPos.z / viewPos.w;\n\n                gNormal = vec4(normalize(vNormal), linearDepth);\n\n                gAlphaDepth = vec2(gAlbedo.a, linearDepth);\n\n                // if (9.0 < linearDepth) gAlbedo.rgb = vec3(1.0, 0.0, 0.0);\n                \n                if (gAlbedo.a < 0.5) discard;\n            }\n        `}getUniforms(){return{modelMatrix:new Mt.A,viewMateix:new Mt.A,modelViewMatrix:new Mt.A,projectionMatrix:new Mt.A,invProjectionMatrix:new Mt.A,colorFactor:this.colorFactor,tColor:this.colorTexture}}}const Ai=WebGL2RenderingContext,Di=(new a.A(0,1,0),new a.A(0,0,0),new a.A,new a.A);class qi{constructor(t,i={}){this.renderer=t,this.camera=new pi.A,this.resolution=i.resolution??64,this.slices=i.slices??8,this.deltaPhi=2*Math.PI/this.slices,this.dilateMaterial=new _i,this.dilateRenderPass=new yi.A(this.dilateMaterial),this.mesh=i.mesh??null,this.mesh&&(this.mesh.frustumCulled=!1)}createBillboard(t){this.mesh=t.clone(),this.rs(this.mesh),this.billboardFramebuffer=this.Wi(),this.dilateFramebuffer=this.Wi();const i=new a.A(1/0,1/0,1/0),s=new a.A(-1/0,-1/0,-1/0);return this.calculateAABB(this.mesh,i,s),this.offset=i.add(s),this.offset.scale(-.5,this.offset),this.mesh.position.add(this.offset,this.mesh.position),this.mesh.updateModelMatrix(),this.size=2*this.getMaxVertexDistance(this.mesh)*1.05,this.camera.updateDimensions(this.size,this.size,-this.size,this.size),this.bake(),{mesh:this.createMesh(),offset:this.offset.negate()}}rs(t){t.material&&(t.material=new Pi(t.material.config));for(const i of t.children)this.rs(i)}Wi(){const t=new gi.A({width:this.resolution,height:this.resolution,format:Ai.RGBA,type:Ai.HALF_FLOAT,internalFormat:Ai.RGBA16F,wrapS:Ai.CLAMP_TO_EDGE,wrapT:Ai.CLAMP_TO_EDGE,useDepthBuffer:!0,count:2}),i=new xi.P({width:this.resolution,height:this.resolution,format:Ai.RG,type:Ai.HALF_FLOAT,internalFormat:Ai.RG16F,wrapS:Ai.CLAMP_TO_EDGE,wrapT:Ai.CLAMP_TO_EDGE,useDepthBuffer:!0});return t.addTexture(i),t}bake(){this.camera.updateModelMatrix(),this.camera.updateViewMatrix(),this.renderer.setFramebuffer(this.billboardFramebuffer),this.renderer.clear(),this.mesh.geometry&&this.mesh.material&&this.renderer.draw(this.mesh,this.camera),this.renderer.flush()}dilate(){this.dilateMaterial.uniforms.tAlbedo=this.billboardFramebuffer.textures[0],this.dilateMaterial.uniforms.tNormal=this.billboardFramebuffer.textures[1],this.dilateMaterial.uniforms.texelSize=1/this.resolution,this.renderer.setFramebuffer(this.dilateFramebuffer),this.renderer.clear(),this.dilateRenderPass.render(this.renderer),this.renderer.flush()}createMesh(){const t=this.billboardFramebuffer.textures[0],i=this.billboardFramebuffer.textures[1],s=this.billboardFramebuffer.textures[2];t.needsUpdate=!0,i.needsUpdate=!0,s.needsUpdate=!0;const n=new A.A(this.size,this.size),e=new Mi(this.slices);e.uniforms.tAlbedos=t,e.uniforms.tNormals=i;const h=new Si(this.slices);h.uniforms.tAlbedos=t,h.uniforms.tNormals=i,h.uniforms.tAlphaDepth=s,h.uniforms.size=this.size;const o=new D.A(n,e);return o.shadowMaterial=h,o}calculateAABB(t,i,s,n=new a.A,e=new r.A){if(n.add(t.position,n),t.quaternion.mult(e,e),e.normalize(),t.geometry){const h=t.geometry.attributes.position;for(let t=0;t<h.count;t++)h.getValue(t,Di),e.vmult(Di,Di),n.add(Di,Di),i.min(Di,i),s.max(Di,s)}for(const h of t.children)this.calculateAABB(h,i,s,n,e)}getMaxVertexDistance(t,i=-1/0,s=new a.A,n=new r.A){if(s.add(t.position,s),t.quaternion.mult(n,n),n.normalize(),t.geometry){const e=t.geometry.attributes.position;for(let t=0;t<e.count;t++)e.getValue(t,Di),n.vmult(Di,Di),s.add(Di,Di),i=Math.max(i,Di.length())}for(const e of t.children)i=this.getMaxVertexDistance(e,i,s,n);return i}}class Ti{constructor(t,i,s,n){this.distance=t,this.geometry=i,this.material=s,this.shadowMaterial=n}}class Ei extends Mi{constructor(t,i={}){super(t,i)}getVertSource(){return`#version 300 es\n\n            #define PI 3.141592653589793\n            #define slices ${this.slices}.0\n        \n            precision mediump float;\n            \n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec2 uv;\n\n            layout (location = 2) in vec3 offset;\n            layout (location = 3) in float angle;\n            layout (location = 4) in float scale;\n\n            const vec3 UP = vec3(0.0, 1.0, 0.0);\n            const vec3 BACK = vec3(0.0, 0.0, 1.0);\n            \n            uniform mat4 modelMatrix;\n            uniform mat4 viewMatrix;\n            uniform mat4 projectionMatrix;\n\n            uniform vec3 cameraPosition;\n            \n            out vec2 vUv;\n            out vec3 vPosition;\n\n            out vec3 vNormal;\n            out vec3 vTangent;\n            out vec3 vBitangent;\n\n            out float vIndex;\n\n            out float vDistance;\n            out float vAlpha;\n\n            void main() {\n                vec3 center = (modelMatrix * vec4(0.0, 0.0, 0.0, 1.0)).xyz + offset;\n\n                vec3 centerToCamera = cameraPosition - center;\n\n                vNormal = normalize(centerToCamera);\n                vTangent = normalize(cross(UP, vNormal));\n                // vBitangent = UP;\n                vBitangent = mix(UP, normalize(cross(UP, vTangent)), vNormal.y * 0.5);\n                vBitangent = normalize(vBitangent);\n\n                vec3 localPosition = position.x * vTangent + position.y * vBitangent;\n                vPosition = center + localPosition * scale;\n\n                vUv = uv;\n\n                // vIndex = angle / (PI * 2.0) * slices;\n                vIndex = 0.0;\n                \n                float visibleDist = 3000.0 + 1500.0 * angle / (PI * 2.0);\n                vDistance = length(centerToCamera);\n                vAlpha = step(vDistance, visibleDist);\n\n                gl_Position = projectionMatrix * viewMatrix * vec4(vPosition, 1.0);\n            }\n        `}getFragSource(){return"#version 300 es\n    \n                precision mediump sampler2DArray;    \n                precision mediump float;\n    \n                in vec3 vPosition;\n                in vec2 vUv;\n    \n                in vec3 vNormal;\n                in vec3 vTangent;\n                in vec3 vBitangent;\n    \n                in float vIndex;\n\n                in float vDistance;\n                in float vAlpha;\n    \n                uniform float roughness;\n                uniform float metalness;\n    \n                // uniform sampler2DArray tAlbedos;\n                // uniform sampler2DArray tNormals;\n    \n                uniform sampler2D tAlbedos;\n                uniform sampler2D tNormals;\n                \n                uniform sampler2D tNoise;\n\n                uniform float fadeStartDistance;\n                uniform float fadeEndDistance;\n    \n                layout(location = 0) out vec4 gColor;\n                layout(location = 1) out vec4 gNormal;\n                layout(location = 2) out vec4 gSurface;\n                layout(location = 3) out vec4 gEmissive;\n                layout(location = 4) out vec4 gFlatNormal;\n                \n                vec3 getNormal(vec3 normalMap, vec3 normal, vec3 tangent, vec3 bitangent) {\n                    return tangent * normalMap.x + bitangent * normalMap.y + normal * normalMap.z;\n                }\n    \n                void main() {\n                    // discard;\n                    // if (vAlpha < 0.5) discard;\n    \n                    // gColor = texture(tAlbedos, vec3(vUv, 0.0));\n                    gColor = texture(tAlbedos, vUv);\n                    if (gColor.a < 0.5) discard;\n    \n                    // gColor = vec4(1.0, 0.0, 0.0, 1.0);\n    \n                    // vec4 normalMap = texture(tNormals, vec3(vUv, 0.0));\n                    vec4 normalMap = texture(tNormals, vUv);\n                    gNormal.xyz = normalize(getNormal(normalMap.xyz, vNormal, vTangent, vBitangent));\n                    // gNormal.w = 1.0;\n    \n                    // gNormal.xyz = normalize(vNormal);\n                    // gNormal.w = 1.0;\n    \n                    gSurface = vec4(0.0, roughness, metalness, 0.0);\n                    gEmissive = vec4(0.0);\n    \n                    // if (normalMap.w < 0.5) gColor.rgb = vec3(1.0, 0.0, 0.0);\n    \n                    gFlatNormal = vec4(vNormal, 0.0);\n\n                    // vec2 noiseUv = gl_FragCoord.xy / 32.0;\n                    // float offsetDistance = vDistance + 1500.0 * texture(tNoise, noiseUv).r;\n                    // if (10000.0 < offsetDistance) discard;\n\n                    vec2 noiseUv = gl_FragCoord.xy / 32.0;\n                    float offset = (fadeEndDistance - fadeStartDistance) * pow(texture(tNoise, noiseUv).r, 2.0);\n                    // float fadeDistance = fadeStartDistance + (fadeEndDistance - fadeStartDistance) * texture(tNoise, noiseUv).r;\n                    if (fadeEndDistance < vDistance + offset) discard;\n\n                }\n            "}getUniforms(t){return{modelMatrix:new Mt.A,viewMatrix:new Mt.A,projectionMatrix:new Mt.A,roughness:this.roughness,metalness:this.metalness,tAlbedos:new _t.A,tNormals:new _t.A,tAlphaDepth:new _t.A,size:1,depthScale:1,tNoise:Pt.A.BLUE_NOISE_TEXTURE,fadeStartDistance:t.fadeStartDistance??n.Gg,fadeEndDistance:t.fadeEndDistance??n.zI}}}class Ci extends Ei{constructor(t,i={}){super(t,i)}getVertSource(){return`#version 300 es\n\n            #define PI 3.141592653589793\n            #define slices ${this.slices}.0\n        \n            precision mediump float;\n            \n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec2 uv;\n\n            layout (location = 2) in vec3 offset;\n            layout (location = 3) in float angle;\n            layout (location = 4) in float scale;\n\n            const vec3 UP = vec3(0.0, 1.0, 0.0);\n            const vec3 BACK = vec3(0.0, 0.0, 1.0);\n            \n            uniform mat4 modelMatrix;\n            uniform mat4 viewMatrix;\n            uniform mat4 projectionMatrix;\n\n            uniform vec3 cameraPosition;\n            \n            out vec2 vUv;\n            out vec3 vPosition;\n\n            out vec3 vNormal;\n            out vec3 vTangent;\n            out vec3 vBitangent;\n\n            out float vIndex;\n\n            out float vAlpha;\n\n            out float vScale;\n\n            void main() {\n                vec3 center = (modelMatrix * vec4(0.0, 0.0, 0.0, 1.0)).xyz + offset;\n\n                vec3 centerToCamera = cameraPosition - center;\n\n                vScale = scale;\n\n                vNormal = normalize(centerToCamera);\n                vTangent = normalize(cross(UP, vNormal));\n                // vBitangent = UP;\n                vBitangent = mix(UP, normalize(cross(UP, vTangent)), vNormal.y * 0.5);\n                vBitangent = normalize(vBitangent);\n\n                vec3 localPosition = position.x * vTangent + position.y * vBitangent;\n                vPosition = center + localPosition * scale;\n\n                vUv = uv;\n\n                vIndex = angle / (PI * 2.0) * slices;\n                \n                float visibleDist = 2500.0 + 2500.0 * angle / (PI * 2.0);\n                float dist = length(centerToCamera);\n                vAlpha = step(dist, visibleDist);\n\n                gl_Position = projectionMatrix * viewMatrix * vec4(vPosition, 1.0);\n            }\n        `}getFragSource(){return"#version 300 es\n\n            precision mediump sampler2DArray;    \n            precision mediump float;\n\n            in vec2 vUv;\n\n            in float vIndex;\n\n            in float vAlpha;\n\n            in float vScale;\n\n            // uniform sampler2DArray tAlbedos;\n            // uniform sampler2DArray tNormals;\n\n            uniform sampler2D tAlbedos;\n            uniform sampler2D tNormals;\n            uniform sampler2D tAlphaDepth;\n\n            uniform float size;\n\n            uniform float depthScale;\n\n            layout(location = 0) out vec4 gColor;\n\n            void main() {\n                // vec4 albedo = texture(tAlbedos, vUv);\n                // if (albedo.a < 0.5) discard;\n\n                // vec4 normal = texture(tNormals, vUv);\n                // gl_FragDepth = gl_FragCoord.z - normal.w * vScale / depthScale;\n                \n                vec4 alphaDepth = texture(tAlphaDepth, vUv);\n                if (alphaDepth.r < 0.5) discard;\n\n                gl_FragDepth = gl_FragCoord.z - alphaDepth.g * vScale / depthScale;\n            }\n        "}}class bi extends bt.A{constructor(t={}){super(t),this.isInstancedMaterial=!0,this.name="InstancedMaterial"}getVertSource(){return"#version 300 es\n        \n            precision mediump float;\n            \n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec3 normal;\n            layout (location = 2) in vec2 uv;\n\n            layout (location = 3) in vec3 offset;\n            layout (location = 4) in float angle;\n            layout (location = 5) in float scale;\n            \n            uniform mat4 modelMatrix;\n            uniform mat4 modelViewMatrix;\n            uniform mat4 viewMatrix;\n            uniform mat4 projectionMatrix;\n\n            uniform vec3 cameraPosition;\n            \n            out vec2 vUv;\n            out vec3 vNormal;\n            out vec3 vPosition;\n\n            vec3 rotate(vec3 coord, float angle) {\n                return vec3(\n                    coord.x * cos(angle) + coord.z * sin(angle),\n                    coord.y,\n                    -coord.x * sin(angle) + coord.z * cos(angle)\n                );\n            }\n\n            void main() {\n                vUv = uv;\n\n                vec4 worldNormal = modelMatrix * vec4(rotate(normal, -angle), 0.0);\n                vNormal = normalize(worldNormal.xyz);\n\n                vec4 viewPosition = modelViewMatrix * vec4(rotate(position, -angle) * scale + offset, 1.0);\n                gl_Position = projectionMatrix * viewPosition;\n\n                // vec4 worldPosition = modelMatrix * vec4(offset, 1.0);\n                // float distance = length(cameraPosition - worldPosition.xyz);\n                // float alpha = 1.0 - min((max(distance - 4000.0, 0.0) / 500.0), 1.0);\n                // worldPosition.xyz += rotate(position, -angle) * scale * alpha;\n                // vec4 viewPosition = viewMatrix * worldPosition;\n                // gl_Position = projectionMatrix * viewPosition;\n\n                vPosition = viewPosition.xyz;\n            }\n        "}getFragSource(){return`#version 300 es\n            \n            precision mediump float;\n\n            in vec2 vUv;\n            in vec3 vNormal;\n            in vec3 vPosition;\n\n            ${this.colorTexture?"#define USE_COLOR_MAP":""}\n            ${this.emissiveTexture?"#define USE_EMISSIVE_MAP":""}\n            ${this.alphaTest?"#define ALPHA_TEST":""}\n\n            #ifdef USE_COLOR_MAP\n            uniform sampler2D tColor;\n            #endif\n            uniform vec4 colorFactor;\n\n            uniform sampler2D tEmissive;\n            uniform vec4 emissiveFactor;\n\n            uniform float roughness;\n            uniform float metalness;\n\n            uniform sampler2D tNoise;\n            uniform vec2 resolution;\n\n            layout(location = 0) out vec4 gColor;\n            layout(location = 1) out vec4 gNormal;\n            layout(location = 2) out vec4 gSurface;\n            layout(location = 3) out vec4 gEmissive;\n            layout(location = 4) out vec4 gFlatNormal;\n\n            void main() {\n                #ifdef USE_COLOR_MAP\n                vec4 albedo = texture(tColor, vUv);\n                #ifdef ALPHA_TEST\n                if (albedo.a < 0.5) discard;\n                #endif\n                gColor = albedo * colorFactor;\n                // gColor = albedo;\n                #else\n                gColor = colorFactor;\n                #endif\n\n                gNormal = vec4(normalize(vNormal), 0.0);\n                gSurface = vec4(0.0, roughness, metalness, 0.0);\n                gEmissive = texture(tEmissive, vUv) * emissiveFactor;\n\n                vec3 dx = dFdx(vPosition);\n                vec3 dy = dFdy(vPosition);\n                gFlatNormal = vec4(normalize(cross(normalize(dx), normalize(dy))), 1.0);\n\n                // vec2 noiseUv = gl_FragCoord.xy / 32.0;\n                // float alpha = texture(tNoise, noiseUv).r;\n                // if (alpha < 0.5) discard;\n            }\n        `}getUniforms(t){return{modelMatrix:new Mt.A,viewMatrix:new Mt.A,modelViewMatrix:new Mt.A,projectionMatrix:new Mt.A,cameraPosition:new a.A,colorFactor:this.colorFactor,tColor:this.colorTexture,emissiveFactor:this.emissiveFactor,tEmissive:this.emissiveTexture,roughness:this.roughness,metalness:this.metalness,tNoise:Pt.A.BLUE_NOISE_TEXTURE,resolution:new N.A(window.innerWidth,window.innerHeight),invResolution:new N.A}}}var Ui=s(8608);class Ni extends Ui.A{constructor(t={}){super(t),this.isInstancedDepthMaterial=!0}getVertSource(t){return"#version 300 es\n        \n            precision mediump float;\n            \n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec2 uv;\n\n            layout (location = 2) in vec3 offset;\n            layout (location = 3) in float angle;\n            layout (location = 4) in float scale;\n            \n            out vec2 vUv;\n            out vec3 vViewPosition;\n            \n            uniform mat4 modelMatrix;\n            uniform mat4 modelViewMatrix;\n            uniform mat4 projectionMatrix;\n\n            vec3 rotate(vec3 coord, float angle) {\n                return vec3(\n                    coord.x * cos(angle) + coord.z * sin(angle),\n                    coord.y,\n                    -coord.x * sin(angle) + coord.z * cos(angle)\n                );\n            }\n            \n            void main() {\n                vUv = uv;\n                vec3 vertPosition = rotate(position, -angle) * scale + offset;\n                vViewPosition = (modelViewMatrix * vec4(vertPosition, 1.0)).xyz;\n                gl_Position = projectionMatrix * modelViewMatrix * vec4(vertPosition, 1.0);;\n            }\n        "}}class Ri extends bt.A{constructor(t={}){super(t)}init(t){this.useDetailTexture=t.useDetailTexture??!1}getFragSource(){return`#version 300 es\n            \n            precision mediump float;\n\n            ${this.useDetailTexture?"#define USE_DETAIL_TEXTURE":""}\n\n            in vec2 vUv;\n            in vec3 vNormal;\n            in vec3 vPosition;\n            in vec3 vWorldPosition;\n\n            uniform sampler2D tColor;\n            uniform vec4 colorFactor;\n\n            uniform sampler2D tEmissive;\n            uniform vec4 emissiveFactor;\n\n            uniform float roughness;\n            uniform float metalness;\n\n            uniform sampler2D tNoise;\n            uniform sampler2D tNoiseNormal;\n\n            uniform mat4 viewMatrix;\n\n            uniform sampler2D tWave;\n\n            const vec3 WATER_COLOR = vec3(0.2, 0.3, 0.4) * 0.25;\n\n            layout(location = 0) out vec4 gColor;\n            layout(location = 1) out vec4 gNormal;\n            layout(location = 2) out vec4 gSurface;\n            layout(location = 3) out vec4 gEmissive;\n            layout(location = 4) out vec4 gFlatNormal;\n\n            float getExtraDetail(float scale) {\n                return texture(tNoise, vUv * scale).r * 2.0 - 1.0;\n            }\n\n            float getDetailNoise() {\n                float noise = 1.0;\n                float scale = 100.0;\n                return 1.0 + (\n                    + getExtraDetail(1.0 * scale)\n                    + getExtraDetail(0.5 * scale)\n                    + getExtraDetail(0.25 * scale)\n                ) * 0.15;\n            }\n\n            vec3 getWaveNormal(vec2 uv) {\n                vec3 normal = vec3(0.0);\n                float totalWeight = 0.0;\n                for (int i = 0; i < 3; i++) {\n                    float scale = pow(2.0, float(i)) * 2.0;\n                    vec3 tmpNormal = texture(tWave, uv * scale).xyz * 2.0 - 1.0;\n                    // float intensity = exp(-abs((4.0 - float(i)) * 0.1));\n                    // float intensity = 1.0 - exp(-float(i + 1) * 0.25);\n                    float intensity = 1.0;\n                    totalWeight += intensity;\n                    normal += tmpNormal * intensity;\n                }\n                // normal /= totalWeight;\n                return normal;\n            }\n\n            void main() {\n                #ifdef USE_DETAIL_TEXTURE\n                float noise = getDetailNoise() + getExtraDetail(0.25) * 0.25;\n                #else\n                float noise = 1.0;\n                #endif\n\n                vec4 color = texture(tColor, vUv);\n                vec3 adjustedColor = mix(WATER_COLOR, color.rgb * 1.0 * noise, color.a);\n                float adjustedRoughness = mix(${n.vB}, ${n.jk}, color.a);\n                float adjustedMetalness = mix(0.0, metalness, color.a);\n\n                gColor = vec4(adjustedColor, color.a) * colorFactor;\n                gSurface = vec4(0.0, adjustedRoughness, adjustedMetalness, 0.0);\n\n                vec3 basisX = normalize(dFdx(vPosition));\n                vec3 basisY = normalize(dFdy(vPosition));\n                gFlatNormal = vec4(normalize(cross(basisX, basisY)), 1.0);\n                \n                #ifdef USE_DETAIL_TEXTURE\n                vec3 normalMap = getWaveNormal(vUv);\n                vec3 waveNormal = vec3(normalMap.r * 1.0, 0.0, normalMap.g * 1.0) * (0.5 + 0.5 * (1.0 - color.a)) * 0.25;\n                // vec3 waveNormal = vec3(normalMap.r * 1.0, normalMap.b, normalMap.g * 1.0);\n                gNormal.xyz = normalize(vNormal + waveNormal);\n                #else\n                gNormal.xyz = normalize(normalize(vNormal));\n                #endif\n\n                gEmissive = vec4(0.0);\n            }\n        `}getUniforms(t){return{modelMatrix:new Mt.A,viewMatrix:new Mt.A,projectionMatrix:new Mt.A,modelViewMatrix:new Mt.A,colorFactor:this.colorFactor,tColor:this.colorTexture,emissiveFactor:this.emissiveFactor,tEmissive:this.emissiveTexture,roughness:this.roughness,metalness:this.metalness,tNoise:Pt.A.NOISE_TEXTURE,tWave:Pt.A.WAVE_TEXTURE}}}var Ii=s(7389);class zi extends bi{constructor(t={}){super(t),this.side=St.c0}getVertSource(){return"#version 300 es\n        \n            precision mediump float;\n            precision mediump sampler2D;\n            \n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec3 normal;\n            layout (location = 2) in vec2 uv;\n\n            layout (location = 3) in vec3 offset;\n            layout (location = 4) in float angle;\n            layout (location = 5) in float scale;\n            \n            uniform mat4 modelMatrix;\n            uniform mat4 modelViewMatrix;\n            uniform mat4 projectionMatrix;\n\n            uniform vec3 cameraPosition;\n\n            uniform sampler2D tAlbedo;\n            uniform float tileWidth;\n            uniform vec2 cellOffset;\n\n            uniform sampler2D tMask;\n            \n            out vec2 vUv;\n            out vec3 vNormal;\n            out vec3 vViewPosition;\n            out vec4 vAlbedo;\n\n            const float grassDistance = 400.0;\n\n            vec3 rotate(vec3 coord, float angle) {\n                return vec3(\n                    coord.x * cos(angle) + coord.z * sin(angle),\n                    coord.y,\n                    -coord.x * sin(angle) + coord.z * cos(angle)\n                );\n            }\n\n            void main() {\n                vUv = uv;\n\n                vec3 vertPosition = rotate(position, -angle) * scale + offset;\n\n                vec2 coord = (vec2(vertPosition.x, vertPosition.z) + cellOffset) / tileWidth + 0.5;\n                vertPosition.y -= 50.0 * scale * (1.0 - texture(tMask, coord).x);\n\n                vAlbedo = texture(tAlbedo, coord);\n\n                vec4 viewPosition = modelViewMatrix * vec4(vertPosition, 1.0);\n                vViewPosition = viewPosition.xyz;\n\n                gl_Position = projectionMatrix * viewPosition;\n            }\n        "}getFragSource(){return"#version 300 es\n            \n            precision mediump float;\n            precision mediump sampler2D;\n\n            in vec2 vUv;\n            in vec3 vNormal;\n            in vec3 vViewPosition;\n            in vec4 vAlbedo;\n\n            uniform float roughness;\n            uniform float metalness;\n            \n            uniform mat4 modelViewMatrix;\n\n            uniform sampler2D tNoise;\n            uniform vec2 resolution;\n\n            uniform float fadeStartDistance;\n            uniform float fadeEndDistance;\n\n            layout(location = 0) out vec4 gColor;\n            layout(location = 1) out vec4 gNormal;\n            layout(location = 2) out vec4 gSurface;\n            layout(location = 3) out vec4 gEmissive;\n            layout(location = 4) out vec4 gFlatNormal;\n\n            void main() {\n                gColor = mix(vAlbedo * 1.25, vAlbedo * 1.0, vUv.y);\n                gNormal = vec4(0.0, 1.0, 0.0, 0.0);\n                gSurface = vec4(0.0, 0.85, 0.0, 0.0);\n                gEmissive = vec4(0.0);\n\n                vec3 dx = dFdx(vViewPosition);\n                vec3 dy = dFdy(vViewPosition);\n                gFlatNormal = vec4(normalize(cross(normalize(dx), normalize(dy))), 1.0);\n\n                float distance = length(vViewPosition);\n                vec2 noiseUv = gl_FragCoord.xy / 32.0;\n                float fadeDistance = fadeStartDistance + (fadeEndDistance - fadeStartDistance) * texture(tNoise, noiseUv).r;\n                if (fadeDistance < distance) discard;\n            }\n        "}getUniforms(t){return{modelMatrix:new Mt.A,modelViewMatrix:new Mt.A,projectionMatrix:new Mt.A,colorFactor:this.colorFactor,tColor:this.colorTexture,emissiveFactor:this.emissiveFactor,tEmissive:this.emissiveTexture,roughness:this.roughness,metalness:this.metalness,tAlbedo:t.tileAlbedo,tileWidth:t.tileWidth,cellOffset:t.cellOffset??new N.A,tMask:t.mask??new _t.A,tNoise:Pt.A.BLUE_NOISE_TEXTURE,fadeStartDistance:t.fadeStartDistance??n.j_,fadeEndDistance:t.fadeEndDistance??n.QR}}}const Li=WebGL2RenderingContext,Fi=(function(){const t=[],i=[],s=[];for(let n=0;n<10;n++){const e=(1-Math.pow(Math.abs(-5+n+.5)/5*.5,2))*(.5+Math.random()),h=Math.random()-.5,o=Math.random()-.5,r=new N.A(2*Math.random()-1,2*Math.random()-1);r.normalize(),r.scale(.5*(.5+Math.random()),r),t.push(-5+n+0-.25,-.5,h),t.push(-5+n+.5*r.x,1.5*e,r.y),t.push(-5+n+1+.25,-.5,o),i.push(0,0,1),i.push(0,0,1),i.push(0,0,1),s.push(0,0),s.push(.5,1),s.push(1,0)}const n=new I.A;n.setAttribute("position",new J.A(new Float32Array(t),3,Li.FLOAT)),n.setAttribute("normal",new J.A(new Float32Array(i),3,Li.FLOAT)),n.setAttribute("uv",new J.A(new Float32Array(s),2,Li.FLOAT))}(),new wi.A),Oi=(new a.A,new a.A,new wt.A);class Vi{constructor(t,i,s,n){this.terrainTile=t,this.tileWidth=i,this.division=4,this.cellWidth=this.tileWidth/this.division,this.cellHalfWidth=.5*this.cellWidth,this.spacing=10,this.boundingRadius=Math.sqrt(this.cellHalfWidth**2*3),this.mesh=new R.A,this.terrainBody=s,this.mask=n,this.cs()}cs(){for(let t=0;t<this.division;t++)for(let i=0;i<this.division;i++){const s=new a.A(t-this.division/2+.5,0,i-this.division/2+.5).scale(this.cellWidth),e=this.nt(this.cellWidth,s),h=new zi({tileAlbedo:this.terrainTile.mesh.material.colorTexture,tileWidth:this.tileWidth,cellOffset:new a.A(s.x,s.z),roughness:n.jk,metalness:0,mask:this.mask,fadeStartDistance:n.j_,fadeEndDistance:n.QR}),o=new D.A(e,h,{drawDistance:n.QR+this.boundingRadius});o.position.set(s.x,0,s.z),this.mesh.add(o)}}nt(t,i=new a.A){const s=this.poissonDiskSampling(t,this.spacing,10),e=new vi.A;e.addBody(this.terrainBody);const h=new Ut;for(const t in K.A.GRASSES.geometry.attributes){const i=K.A.GRASSES.geometry.attributes[t];h.setAttribute(t,i)}h.setIndices(K.A.GRASSES.geometry.indices);const o=s.length,r=new J.A(new Float32Array(3*o),3,Li.FLOAT,1),c=new J.A(new Float32Array(3*o),3,Li.FLOAT,1),l=new J.A(new Float32Array(o),1,Li.FLOAT,1),u=new J.A(new Float32Array(o),1,Li.FLOAT,1);h.setAttribute("offset",r),h.setAttribute("angle",l),h.setAttribute("scale",u),h.instanceCount=o,h.boundingRadius=this.boundingRadius;for(let h=0;h<s.length;h++){const o=s[h];Fi.start.set(o.x-.5*t+i.x,1e4,o.y-.5*t+i.z),Fi.end.set(o.x-.5*t+i.x,-1e4,o.y-.5*t+i.z),Fi.updateDirectionAndLength(),Fi.intersectsWorld(e,Oi),Oi.hasHit?(r.setVec3(h,Oi.hitPoint.sub(i)),c.setVec3(h,Oi.hitNormal)):(r.setVec3(h,new a.A(0,-100,0)),c.setVec3(h,n.UP)),l.setX(h,2*Math.PI*Math.random()),u.setX(h,1.25*(.5+Math.random()))}return h}isValidPoint(t,i,s,n,e,h){if(e.x<0||e.x>=t||e.y<0||e.y>=t)return!1;const o=Math.floor(e.x/s),r=Math.floor(e.y/s),a=Math.max(o-1,0),c=Math.min(o+1,n-1),l=Math.max(r-1,0),u=Math.min(r+1,n-1);for(let t=a;t<=c;t++)for(let s=l;s<=u;s++)if(null!=i[t][s]){if(Math.sqrt((i[t][s].x-e.x)**2+(i[t][s].y-e.y)**2)<h)return!1}return!0}insertPoint(t,i,s){const n=Math.floor(s.x/i),e=Math.floor(s.y/i);t[n][e]=s}poissonDiskSampling(t,i,s){const n=[],e=[],h={x:Math.random()*t,y:Math.random()*t},o=Math.floor(i/Math.sqrt(2)),r=Math.ceil(t/o)+1,a=[];for(let t=0;t<r;t++){a[t]=[];for(let i=0;i<r;i++)a[t][i]=null}for(this.insertPoint(a,o,h),n.push(h),e.push(h);0<e.length;){const h=Math.floor(Math.random()*e.length),c=e[h];let l=!1;for(let h=0;h<s;h++){const s=Math.random()*Math.PI*2,h=i+Math.random()*i,u={x:c.x+h*Math.cos(s),y:c.y+h*Math.sin(s)};if(this.isValidPoint(t,a,o,r,u,i)){n.push(u),this.insertPoint(a,o,u),e.push(u),l=!0;break}}l||e.splice(h,1)}return n}}const ki=WebGL2RenderingContext,Gi="config.json";class Bi{constructor(t={}){this.config=null,this.useGroundObjects=t.useGroundObjects??!0,this.useGrasses=t.useGrasses??!0,this.useDetailTexture=t.useDetailTexture??!0,this.groundObjectPrefabs={},this.terrainTiles=[],this.tileWidth=-1}init(){this.groundObjectPrefabs={},this.terrainTiles.length=0}async loadTerrain(t,i){this.config=await(0,l.Fj)(`terrain/${i}/${Gi}`),this.billboardCreator=new qi(t);const s=this.config.size,n=this.config.tileDivision;this.tileWidth=s/n;const e=[];for(const s of this.config.objects)e.push(this.ls(t,i,s));await Promise.all(e).then(t=>{for(const i of t)this.groundObjectPrefabs[i.id]=i}).catch(t=>{throw t});const h=[];for(const t of this.config.tiles)h.push(this.us(i,t));return await Promise.all(h).then(t=>{this.terrainTiles.push(...t)}).catch(t=>{throw t}),new di(this.config,this.terrainTiles)}async ls(t,i,s){const n=await(0,l.Fj)(`terrain/${i}/objects/${s}/${Gi}`),e=await(0,o.i0)(`terrain/${i}/objects/${s}/${n.model}`),h=this.billboardCreator.createBillboard(e),r=n.collider?await(0,o.i0)(`terrain/${i}/objects/${s}/${n.collider}`):null;return{id:s,config:n,mesh:e,billboard:h,shape:(0,l.bk)(r??e)}}async us(t,i){const s=await(0,l.Fj)(`terrain/${t}/tiles/${i}/${Gi}`),n=await(0,o.i0)(`terrain/${t}/tiles/${i}/${s.model}`);{n.material=new Ri({useDetailTexture:this.useDetailTexture,...n.material.config});const t=n.material.uniforms;t.roughness=.75,t.tColor.wrapS=ki.CLAMP_TO_EDGE,t.tColor.wrapT=ki.CLAMP_TO_EDGE,t.tColor.anisotropy=8}const e=(0,l.Hy)(n),h=new mt.A({type:mi.Bi,shape:e,collisionFilterGroup:Ii.N7.TERRAIN}),r=new pt.A,a=new mt.A({type:mi.Bi,shape:r,collisionFilterGroup:Ii.N7.TERRAIN_OBJECT}),c=new vi.A;c.addBody(h);const u=new fi(this.tileWidth,s.division,n,h,a,s.materials);this.fs(u,r,s.objects,c);const f=s.mask?await(0,o.kv)(`terrain/${t}/tiles/${i}/${s.mask}`,{wrapS:ki.CLAMP_TO_EDGE,wrapT:ki.CLAMP_TO_EDGE}):Pt.A.DEFAULT_MASK_TEXTURE,d=new Vi(u,this.tileWidth,h,f);return u.setGrassesMesh(d.mesh),u}fs(t,i,s,e){const h=Math.ceil(this.tileWidth/n.ah-n.HV),o=this.tileWidth/h,c=new wi.A,u=new wt.A,f=[];for(let t=0;t<h;t++){f[t]=[];for(let i=0;i<h;i++){f[t][i]=[];for(const n of s)f[t][i].push({id:n.id,instances:[]})}}for(let t=0;t<s.length;t++){const i=s[t];for(const s of i.instances){const i={position:(new a.A).copy(s.position),rotation:s.rotation},n=$i(s.position,e,c,u),r=(0,l.qE)(Math.floor((i.position.x+.5*this.tileWidth)/o),0,h-1),d=(0,l.qE)(Math.floor((i.position.z+.5*this.tileWidth)/o),0,h-1);i.position.x-=(r+.5)*o-.5*this.tileWidth,i.position.y=n,i.position.z-=(d+.5)*o-.5*this.tileWidth,f[r][d][t].instances.push(i)}}for(let s=0;s<h;s++)for(let e=0;e<h;e++){const h=new a.A((s+.5)*o-.5*this.tileWidth,0,(e+.5)*o-.5*this.tileWidth),c=new R.A;c.position.copy(h);for(const t of f[s][e]){const s=this.groundObjectPrefabs[t.id],e=Hi(s.mesh,s.config,t.instances,this.tileWidth,o),a=ji(s.billboard,s.config,t.instances,this.tileWidth,o);if(e.addLod(new Ti(n.YS,a.geometry,a.material,a.shadowMaterial)),c.add(e),!s.config.overlay)for(let o=0;o<t.instances.length;o++){const a=t.instances[o],c=new pt.r(s.shape,h.add(a.position),(new r.A).setFromAxisAngle(n.PX,a.rotation*l.up),a.scale,s.config.destructive);c.mesh=e,c.instanceIndex=o,i.addShape(c)}}t.addObjectCell(c)}}}function Hi(t,i,s,e,h){const o=i.overlay?Math.sqrt((.5*e)**2*3):Math.sqrt((.5*h)**2*3);let r;if(t.geometry&&t.material){const h=Wi(t.geometry,i,s,e);h.boundingRadius=o;const a=new bi({...t.material.config,fadeStartDistance:n.Gg,fadeEndDistance:n.zI});i.overlay&&(a.polygonOffset=-10,a.depthWrite=!1,a.transparent=!0),r=new D.A(h,a,{drawDistance:n.zI+o,shadowMaterial:new Ni(a.config)})}else r=new R.A;r.boundingRadius=o;for(const n of t.children){const t=Hi(n,i,s,e,h);r.add(t)}return r}function ji(t,i,s,e,h){const o=t.mesh,r=Wi(o.geometry,i,s,e,t.offset),a=Math.sqrt((.5*h)**2*3);r.boundingRadius=a;const c=new Ei(1,{fadeStartDistance:n.Gg,fadeEndDistance:n.zI});c.uniforms.tAlbedos=o.material.uniforms.tAlbedos,c.uniforms.tNormals=o.material.uniforms.tNormals;const l=new D.A(r,c),u=new Ci(1);return u.uniforms.tAlbedos=o.shadowMaterial.uniforms.tAlbedos,u.uniforms.tNormals=o.shadowMaterial.uniforms.tNormals,u.uniforms.tAlphaDepth=o.shadowMaterial.uniforms.tAlphaDepth,u.uniforms.size=o.shadowMaterial.uniforms.size,l.shadowMaterial=u,l}function Wi(t,i,s,e,h=n.VT){const o=new Ut;for(const i in t.attributes){const s=t.attributes[i];o.setAttribute(i,s)}t.indices&&o.setIndices(t.indices);const r=s.length,a=new J.A(new Float32Array(3*r),3,ki.FLOAT,1),c=new J.A(new Float32Array(r),1,ki.FLOAT,1),u=new J.A(new Float32Array(r),1,ki.FLOAT,1);o.setAttribute("offset",a),o.setAttribute("angle",c),o.setAttribute("scale",u);for(let t=0;t<s.length;t++){const n=s[t].position;a.array[3*t+0]=n.x+h.x,a.array[3*t+1]=n.y+h.y,a.array[3*t+2]=n.z+h.z,c.array[t]=s[t].rotation*l.up,i.minScale&&i.maxScale?u.array[t]=i.minScale+Math.random()*(i.maxScale-i.minScale):u.array[t]=1}return o.instanceCount=s.length,o.extent=Math.SQRT2*e*.5,o.visibleDistance=n.zI,o}function $i(t,i,s,n){return s.start.set(t.x,1e4,t.z),s.end.set(t.x,-1e4,t.z),s.updateDirectionAndLength(),s.intersectsWorld(i,n),n.hasHit?n.hitPoint.y:-100}var Xi=s(5487),Zi=s(9262);new a.A,new a.A;class Yi extends Zi.Ay{constructor(t,i,s,n=1,e={}){super(t,e),this.position=i,this.velocity=s,this.scale=n,this.panner=(0,o.BM)(),this.panner.refDistance=n,this.outputNode=this.panner}update(t,i,s){if(this.hasToStart&&(this.createAndStartSource(),this.gain.connect(this.panner),this.hasToStart=!1),this.source)if(this.panner.positionX){const t=o.p8.currentTime+s;this.panner.positionX.linearRampToValueAtTime(this.position.x,t),this.panner.positionY.linearRampToValueAtTime(this.position.y,t),this.panner.positionZ.linearRampToValueAtTime(this.position.z,t)}else this.panner.setPosition(this.position.x,this.position.y,this.position.z)}}class Ki extends Yi{constructor(t,i,s=1){super(Xi.A.CRASH,t,i,s),this.setVolume(.135)}}class Ji extends Yi{constructor(t,i,s=1,n=.75,e=1.5){super(Xi.A.EXPLOSION,t,i,s),this.setVolume(e),this.setPlaybackRate(n)}}var Qi=s(5172);s(7975);const ts=Math.PI,is="external",ss="cockpit",ns="hud",es="spectator",hs=Math.PI/16*3,os=new a.A,rs=new a.A,as=new r.A;class cs extends c.A{constructor(t,i){super(i),this.playerController=t,this.cameraPosition=new a.A,this.view=is,this.vehicle=null,this.freeCameraMode=!1,this.spectatorPosition=new a.A,this.lookPosition=new a.A,this.ray=new wi.A({collisionFilterMask:Ii.m1}),this.raycastResult=new wt.A,this.chaseLimit=0,this.destroyedCameraPosition=new a.A,this.destroyedCameraAngleQuaternion=new r.A,this.destroyedCameraAngleQuaternion.setFromAxisAngle(n.UP,hs),this.delayedBodyQuaternion=new r.A,this.cameraPosition=new a.A,this.lastCameraPosition=(new a.A).copy(this.cameraPosition),this.cameraQuaternion=new r.A,this.lastCameraQuaternion=(new r.A).copy(this.cameraQuaternion),this.verticalLookAngle=0,this.horizontalLookAngle=0,this.delayedHorizontalLookAngle=0,this.delayedVerticalLookAngle=0,this.lookQuaternion=new r.A,this.cameraShakeTime=0,this.cameraShakeScale=0,this.lerpedBodyVelocity=new a.A}update(t,i){this.playerController.changeView&&this.ds(t),this.playerController.changeVehicle&&this.vs(t)}ds(t){switch(this.view){case is:this.view=ss;break;case ss:this.view=ns;break;case ns:this.view=es;break;default:this.view=is}}vs(){this.game.getAllVehicles().forEach(t=>{t!==this.vehicle?this.vehicle||(this.vehicle=t):this.vehicle=null}),this.vehicle||this.vs()}fixedUpdate(t,i){this.lastCameraPosition.copy(this.cameraPosition),this.lastCameraQuaternion.copy(this.cameraQuaternion),this.updateCameraTransform(i),this.cameraPosition.sub(this.lastCameraPosition,this.velocity),this.velocity.scale(1/i,this.velocity)}updateCameraTransform(t){if(this.vehicle){if(this.lerpedBodyVelocity.lerp(this.vehicle.velocity,1-Math.exp(1*-t),this.lerpedBodyVelocity),this.vehicle.destroyed||this.vehicle.exploded)return this.updateDestroyedCamera(),void(this.cameraShakeScale=0);switch(this.view){case is:this.updateCameraQuaternion(t),this.updateExternalCameraPosition();break;case ss:case ns:this.updateCameraQuaternion(t),this.updateCockpitCameraPosition();break;case es:this.updateSpectatorCamera(t)}{this.cameraShakeTime+=16*t;let i=0;for(let t=0;t<10;t++){const s=Math.pow(1.5,t);i+=Math.cos(this.cameraShakeTime*s)/s}as.setFromAxisAngle(n.NS,.025*i*this.cameraShakeScale),this.cameraQuaternion.mult(as,this.cameraQuaternion).normalize();let s=0;for(let t=0;t<10;t++){const i=Math.pow(1.75,t);s+=Math.cos((this.cameraShakeTime+.25)*i)/i}as.setFromAxisAngle(n.UP,.01*s*this.cameraShakeScale),this.cameraQuaternion.mult(as,this.cameraQuaternion).normalize(),this.cameraShakeScale*=Math.exp(4*-t)}}}updateCameraQuaternion(t){if(this.lastCameraQuaternion.copy(this.cameraQuaternion),this.playerController?.chaseTarget?!this.chaseTarget&&this.vehicle.target&&(this.chaseTarget=this.vehicle.target):this.chaseTarget=null,this.chaseTarget){const t=(this.chaseTarget?this.chaseTarget.position:this.cameraLookTarget).sub(this.vehicle.body.position);this.vehicle.body.quaternion.conjugate().vmult(t,t),t.normalize();const i=t.clone();i.y=0,i.normalize(),this.horizontalLookAngle=Math.acos(-i.z)*-Math.sign(i.x);const s=(2*Math.PI-Math.abs(this.horizontalLookAngle))*-Math.sign(this.horizontalLookAngle),n=Math.abs(this.horizontalLookAngle-this.delayedHorizontalLookAngle);Math.abs(s-this.delayedHorizontalLookAngle)<n&&(this.horizontalLookAngle=s),this.verticalLookAngle=Math.asin(t.y)}else this.horizontalLookAngle=-Math.PI*this.playerController.lookHorizontal,this.verticalLookAngle=Math.PI/2*this.playerController.lookVertical;const i=1-Math.exp(10*-t);this.delayedHorizontalLookAngle=(0,l.Cc)(this.delayedHorizontalLookAngle,this.horizontalLookAngle,i),this.delayedVerticalLookAngle=(0,l.Cc)(this.delayedVerticalLookAngle,this.verticalLookAngle,i),Math.PI<Math.abs(this.delayedHorizontalLookAngle)&&(this.delayedHorizontalLookAngle=(2*Math.PI-Math.abs(this.delayedHorizontalLookAngle))*-Math.sign(this.delayedHorizontalLookAngle)),this.lookQuaternion.setFromEuler(this.delayedVerticalLookAngle,this.delayedHorizontalLookAngle,0,"YXZ").normalize();const s=this.game.mainCamera.view===ss?20:10,n=this.view===ns?1:1-Math.exp(-t*s);this.delayedBodyQuaternion.slerp(this.vehicle.body.quaternion,n,this.delayedBodyQuaternion).normalize(),this.delayedBodyQuaternion.mult(this.lookQuaternion,this.cameraQuaternion).normalize()}updateExternalCameraPosition(){this.cameraQuaternion.vmult(this.vehicle.externalCameraPosition,this.cameraPosition),this.vehicle.body.position.add(this.cameraPosition,this.cameraPosition),this.ray.start.copy(this.vehicle.position),this.ray.end.copy(this.cameraPosition),this.ray.updateDirectionAndLength(),this.ray.intersectsWorld(this.game.world,this.raycastResult),this.raycastResult.hasHit&&this.cameraPosition.copy(this.raycastResult.hitPoint)}updateCockpitCameraPosition(){this.vehicle.body.quaternion.vmult(this.vehicle.cockpitCameraPosition,this.cameraPosition),this.vehicle.body.position.add(this.cameraPosition,this.cameraPosition)}lateUpdate(t,i,s){this.lastCameraPosition.lerp(this.cameraPosition,s,this.position),this.lastCameraQuaternion.slerp(this.cameraQuaternion,s,this.quaternion).normalize()}setVehicle(t){this.vehicle=t,this.vehicle=t}updateDestroyedCamera(t){this.destroyedCameraPosition.copy(this.lerpedBodyVelocity),this.destroyedCameraPosition.y=0,this.destroyedCameraPosition.normalize(),this.destroyedCameraPosition.scale(200,this.destroyedCameraPosition),this.destroyedCameraAngleQuaternion.vmult(this.destroyedCameraPosition,this.destroyedCameraPosition),this.destroyedCameraPosition.add(this.vehicle.body.position,this.destroyedCameraPosition),this.destroyedCameraPosition.y+=50,this.cameraPosition.copy(this.destroyedCameraPosition),this.vehicle.body.position.sub(this.cameraPosition,os).normalize();const i=Math.atan2(-os.x,-os.z),s=Math.asin(os.y);this.cameraQuaternion.setFromEuler(s,i,0,"YXZ").normalize()}updateSpectatorCamera(t){if(!this.vehicle)return void this.spectatorPosition.set(1250,100,-4350);if(this.chaseLimit=5*this.vehicle.bodyRadius+this.vehicle.body.velocity.length(),this.chaseLimit<this.vehicle.body.position.distanceTo(this.spectatorPosition)){const t=10<this.vehicle.body.velocity.length()?this.vehicle.body.velocity.clone():this.vehicle.body.quaternion.vmult(new a.A(0,0,-1));t.normalize(),t.scale(.95*this.chaseLimit,t),this.vehicle.body.position.add(t,t);const i=(0,l.Vs)();i.scale(.1*this.chaseLimit,i),t.add(i,t),this.ray.start.copy(t),this.ray.start.add(n.Nh,this.ray.start),this.ray.end.copy(t),this.ray.end.add(n.kp,this.ray.end),this.ray.updateDirectionAndLength(),this.ray.intersectsWorld(this.game.world,this.raycastResult),this.raycastResult.hasHit&&(t.y=Math.max(this.raycastResult.hitPoint.y+.05*this.chaseLimit,t.y)),this.spectatorPosition.copy(t)}this.cameraPosition.copy(this.spectatorPosition);const i=this.vehicle.body.velocity.clone();i.scale(0,i),this.vehicle.body.position.add(i,this.lookPosition),this.lookPosition.sub(this.spectatorPosition,os).normalize();const s=Math.atan2(-os.x,-os.z),e=Math.asin(os.y);this.cameraQuaternion.setFromEuler(e,s,0,"YXZ").normalize()}updateFreeCamera(t){this.lastCameraQuaternion.copy(this.cameraQuaternion),this.lastCameraPosition.copy(this.cameraPosition),this.cameraQuaternion.vmult(n.OX,os).normalize();let i=Math.atan2(-os.x,-os.z),s=Math.asin(os.y);s+=this.playerController.lookVertical*ts*t,i+=this.playerController.lookHorizontal*ts*-1*t,this.cameraQuaternion.setFromEuler(s,i,0,"YXZ").normalize();let e=300;e=(0,l.Cc)(e,3e3,this.playerController.throttleUp),e=(0,l.Cc)(e,30,this.playerController.throttleDown),rs.copy(os),rs.y=0,rs.normalize(),this.cameraPosition.x+=rs.x*this.playerController.elevator*e*-1*t,this.cameraPosition.z+=rs.z*this.playerController.elevator*e*-1*t,this.cameraPosition.x-=rs.z*this.playerController.aileron*e*t,this.cameraPosition.z-=-rs.x*this.playerController.aileron*e*t,this.cameraPosition.y+=this.playerController.rudder*e*t}getCamera=function(){return this.camera};getTarget(){return this.vehicle}shakeCamera(){this.cameraShakeScale=1}}const ls=cs;class us extends ft.A{constructor(t,i,s={}){super(),this.active=s.active??!0,this.vehicle=t,this.controller=i,this.target=s.target??null,this.maxRange=s.maxRange??3e3,this.maxAngle=s.maxAngle??30*n.vT,this.lockonAngleThreshould=s.lockonAngleThreshould??.02,this.cursorAngularSpeed=s.cursorAngularSpeed??1,this.targetSeeking=!1,this.targetLocking=!1,this.subSeekers=[]}setTarget(t){this.target=t}unlock(){}operate(t){}}const fs=(new a.A).copy(n.OX),ds=(new a.A).copy(n.OX),vs=((new a.A).copy(n.OX),(new a.A).copy(n.OX),new r.A),ms=new r.A,ws=new a.A;class ps extends us{constructor(t,i,s){super(t,i,s),this.localDirection=(new a.A).copy(n.OX),this.lastLocalSeekerDirection=(new a.A).copy(n.OX),this.lerpedLocalSeekerDirection=(new a.A).copy(n.OX),this.subSeekers=[this]}operate(t){if(this.lastLocalSeekerDirection.copy(this.localDirection),!this.target||this.controller.ammo<=0)return void this.unlock();this.target.position.sub(this.controller.worldPosition,fs);const i=fs.length();this.controller.worldQuaternion.conjugate(vs),vs.vmult(fs,ds).normalize();const s=Math.acos((0,l.qE)(n.OX.dot(ds)));if(this.maxRange<i||this.maxAngle<s)return void this.unlock();this.targetSeeking=!0;const e=Math.acos((0,l.qE)(this.localDirection.dot(ds)));this.targetLocking=e<=this.lockonAngleThreshould,this.targetLocking?(this.target.isLocked=!0,this.localDirection.copy(ds)):(this.localDirection.cross(ds,ws).normalize(),ms.setFromAxisAngle(ws,Math.min(e,this.cursorAngularSpeed*t)),ms.vmult(this.localDirection,this.localDirection).normalize())}unlock(){this.targetSeeking=!1,this.targetLocking=!1,this.localDirection.copy(n.OX)}lateUpdate(t,i,s){this.lastLocalSeekerDirection.lerp(this.localDirection,s,this.lerpedLocalSeekerDirection).normalize()}}const gs=new a.A;class xs extends ft.A{constructor(t,i){if(super(),this.isMuzzle=!0,this.controller=t,this.vehicle=this.controller.vehicle,this.localPosition=(new a.A).copy(i.position??this.controller.localPosition??n.VT),this.localQuaternion=new r.A,this.localDirection=new a.A,i.quaternion&&i.direction)throw new Error("both quaternion and direction are defined");i.quaternion?this.updateLocalQuaternion(i.quaternion):i.direction?this.updateLocalDirection(i.direction):this.updateLocalDirection(this.controller.localDirection),this.worldPosition=new a.A,this.worldQuaternion=new r.A}updateLocalQuaternion(t){this.localQuaternion.copy(t),this.localQuaternion.vmult(n.OX,this.localDirection),this.localDirection.normalize()}updateLocalDirection(t){this.localDirection.copy(t),this.localDirection.normalize(),n.OX.cross(this.localDirection,gs),gs.normalize();const i=Math.acos((0,l.qE)(n.OX.dot(this.localDirection)));this.localQuaternion.setFromAxisAngle(gs,i),this.localQuaternion.normalize()}fire(){return this.vehicle.body.quaternion.vmult(this.localPosition,this.worldPosition),this.vehicle.body.position.add(this.worldPosition,this.worldPosition),!1}refill(){}}const Ms=new a.A;class Ss extends ft.A{constructor(t,i={}){super(),this.isWeaponController=!0,this.vehicle=t,this.active=i.active??!0,this.localPosition=new a.A,i.position&&this.localPosition.copy(i.position),this.localQuaternion=new r.A,i.quaternion&&this.localQuaternion.copy(i.quaternion),this.worldQuaternion=new r.A,this.vehicle.quaternion.mult(this.localQuaternion,this.worldQuaternion).normalize(),this.localPosition=(new a.A).copy(this.localPosition),this.worldPosition=new a.A,this.localDirection=this.localQuaternion.vmult(n.OX),this.worldDirection=new a.A,this.ws(i),this.ps(i)}ws(t){this.maxAmmo=t.ammo??(this.vehicle.isPlayerAircraft?1e3:1/0),this.ammo=this.maxAmmo,this.maxRange=1/0,this.fireInterval=t.fireInterval??.101,this.fireTimer=0,this.projectileSpeed=t.projectileSpeed??0,this.range=0}ps(t){this.muzzles=[];for(const i of t.muzzles??t.launchers??[{}]){const t=this.gs(i);this.add(t),this.muzzles.push(t)}this.muzzleIndex=0}gs(t){return new xs(this,t)}fixedUpdate(t,i){this.fireTimer-=i,this.xs()}xs(){this.vehicle.body.quaternion.vmult(this.localPosition,this.worldPosition),this.vehicle.body.position.add(this.worldPosition,this.worldPosition),this.vehicle.body.quaternion.vmult(this.localDirection,this.worldDirection),this.vehicle.quaternion.mult(this.localQuaternion,this.worldQuaternion).normalize()}updateLocalDirection(t){this.localDirection.copy(t),n.OX.cross(this.localDirection,Ms).normalize();const i=Math.acos((0,l.qE)(n.OX.dot(this.localDirection)));this.localQuaternion.setFromAxisAngle(Ms,i).normalize()}operate(t,i){}autoFire(t){}fire(){this.ammo<=0||0<this.fireTimer||(this.muzzles[this.muzzleIndex++].fire(),this.muzzles.length<=this.muzzleIndex&&(this.muzzleIndex=0),this.ammo--,this.fireTimer=this.vehicle.isPlayerAircraft?this.fireInterval:.5*this.fireInterval+Math.random()*this.fireInterval)}createProjectile(){return null}refill(){this.ammo=this.maxAmmo}activate(){this.active=!0}deactivate(){this.active=!1}}class ys extends Zi.Ay{constructor(){super(Xi.A.DAMAGE)}}class _s extends Yi{constructor(t,i,s=1){super(Xi.A.MISSILE_CRUISE,t,i,s),this.loop=!0}}class Ps extends St.Ay{constructor(t={}){super(t),this.transparent=!0,this.depthWrite=!1,this.renderingPass=n.xF}getVertSource(){return`#version 300 es\n            \n            precision mediump float;\n            \n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec2 uv;\n\n            layout (location = 3) in vec3 startPosition;\n            layout (location = 4) in vec3 endPosition;\n            layout (location = 5) in float startTime;\n            layout (location = 6) in float endTime;\n            layout (location = 7) in float startDensity;\n            layout (location = 8) in float endDensity;\n                \n            uniform mat4 modelMatrix;\n            uniform mat4 viewMatrix;\n            uniform mat4 modelViewMatrix;\n            uniform mat4 projectionMatrix;\n\n            uniform vec3 cameraPosition;\n\n            uniform float liftForce;\n            uniform float spreadScale;\n            \n            uniform vec4 initialColor;\n            uniform vec4 finalColor;\n            \n            uniform float radius;\n            uniform float radiusSqrt;\n            uniform float initialRadius;\n            uniform float damping;\n\n            uniform float radiusTimeScale;\n            uniform float eraseTimeScale;\n            uniform float spreadTimeScale;\n            uniform float colorTimeScale;\n\n            uniform float totalTimeElapsed;\n\n            out vec2 vUv;\n            out vec3 vPosition;\n\n            out float vDensity;\n\n            out vec3 vSunIrradiance;\n            out vec3 vSkyIrradiance;\n\n            out vec3 vInScatter;\n            out vec3 vTransmittance;\n\n            out float vRadiusAlpha;\n            out float vColorAlpha;\n            \n            ${yt.mz}\n\n            ${gt}\n            \n            ${yt.SY}\n\n            vec4 getViewPosition(float timeElapsed, float radiusAlpha, float eraseAlpha, float alpha) {\n                vec3 trailDirection = normalize(endPosition - startPosition);\n                vec3 centerPosition = mix(startPosition, endPosition, 0.5);\n                vec3 cameraDirection = normalize(centerPosition - cameraPosition);\n\n                vec3 tangent = normalize(cross(cameraDirection, trailDirection));\n                vec3 normal = normalize(cross(tangent, trailDirection));\n                vec3 worldPosition = mix(startPosition, endPosition, alpha)\n                        + tangent * position.x  * (radius + radiusSqrt * timeElapsed * spreadTimeScale)\n                        // + trailDirection * position.y * (radius + radiusSqrt * timeElapsed * spreadTimeScale)\n                        ;\n                return viewMatrix * vec4(worldPosition, 1.0);\n            }\n\n            void main() {\n                float alpha = position.y * 0.5 + 0.5;\n\n                if (startTime == 0.0) {\n                    vDensity = 0.0;\n                    gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(0.0, 0.0, 0.0, 1.0);\n                    return;\n                }\n\n                float timeElapsed = (totalTimeElapsed - mix(startTime, endTime, alpha));\n                float radiusAlpha = getRadiusAlpha(damping, timeElapsed * radiusTimeScale);\n                float eraseAlpha = getTimeAlpha(damping, timeElapsed * eraseTimeScale);\n                float colorAlpha = getRadiusAlpha(damping, timeElapsed * colorTimeScale);\n\n                vec3 centerPosition = mix(startPosition, endPosition, 0.5);\n                vec4 viewPosition = getViewPosition(timeElapsed, radiusAlpha, eraseAlpha, alpha);\n\n                vSunIrradiance = getSunIrradiance(centerPosition.y * METERS_TO_KMS);\n                vSkyIrradiance = getSkyIrradiance(0.0, centerPosition.y * METERS_TO_KMS);\n\n                getAirealScattering(normalize(centerPosition - cameraPosition).y, cameraPosition.y * 0.001, length(viewPosition) * 0.001, vInScatter, vTransmittance);\n\n                float opacity = mix(initialColor.a, finalColor.a, colorAlpha);\n                float viewAttenuation = getViewAttenuation(viewPosition.z, radius);\n                vDensity = mix(startDensity, endDensity, alpha) * eraseAlpha * opacity * viewAttenuation;\n\n                vRadiusAlpha = radiusAlpha;\n                vColorAlpha = colorAlpha;\n\n                gl_Position = projectionMatrix * viewPosition;\n\n                vPosition = position;\n            }\n        `}getFragSource(){return`#version 300 es\n            \n            precision mediump float;\n\n            uniform sampler2D tDiffuse;\n\n            uniform vec4 initialColor;\n            uniform vec4 finalColor;\n            \n            uniform vec3 initialEmissive;\n            uniform vec3 finalEmissive;\n\n            uniform vec3 sunDirection;\n            \n            uniform float radius;\n            uniform float initialRadius;\n            uniform float damping;\n\n            in vec2 vUv;\n            in vec3 vPosition;\n\n            in float vDensity;\n            \n            ${yt.mz}\n            \n            ${yt.SY}\n\n            ${gt}\n\n            in vec3 vSunIrradiance;\n            in vec3 vSkyIrradiance;\n\n            in vec3 vInScatter;\n            in vec3 vTransmittance;\n\n            in float vRadiusAlpha;\n            in float vColorAlpha;\n\n            out vec4 gDiffuse;\n\n            void main() {\n                if (vDensity < 0.001) discard;\n                \n                float scale = initialRadius / radius + vColorAlpha * (1.0 - initialRadius / radius);\n                float factor = clamp(abs(vPosition.x) / scale, 0.0, 1.0);\n                float alpha = pow(1.0 - factor, 2.0);\n\n                float sampleDensity = alpha * vDensity;\n                float transmittance = 1.0 - exp(-sampleDensity);\n\n                vec3 diffuse = mix(initialColor.rgb, finalColor.rgb, pow(vColorAlpha, alpha));\n                diffuse *= (vSunIrradiance / PI + vSkyIrradiance);\n                \n                vec3 emissive = mix(initialEmissive, finalEmissive, pow(vColorAlpha, alpha)) * sampleDensity;\n\n                gDiffuse.rgb = (diffuse + emissive) * vTransmittance + vInScatter;\n                gDiffuse.a = transmittance;\n            }\n        `}getUniforms(t){return{modelMatrix:new Mt.A,viewMatrix:new Mt.A,modelViewMatrix:new Mt.A,projectionMatrix:new Mt.A,cameraPosition:t.cameraPosition??new a.A,radius:t.radius??1,radiusSqrt:t.radiusSqrt??1,initialRadius:t.initialRadius??0,liftForce:t.liftForce??1,spreadScale:t.spreadScale??1,damping:t.damping??1,totalTimeElapsed:t.totalTimeElapsed??0,radiusTimeScale:t.radiusTimeScale??1,eraseTimeScale:t.eraseTimeScale??1,spreadTimeScale:t.spreadTimeScale??1,colorTimeScale:t.colorTimeScale??1,initialColor:t.initialColor??new P.A,finalColor:t.finalColor??new P.A,initialEmissive:t.initialEmissive??new P.A,finalEmissive:t.finalEmissive??new P.A,atmosphereProfile:{}}}}const As=WebGL2RenderingContext,Ds=(0,l.P7)(),qs=1/30;class Ts extends Gt{constructor(t={}){super(t),this.position=(new a.A).copy(t.position??n.VT),this.startPositions.setXYZ(this.currentIndex,this.position.x,this.position.y,this.position.z),this.startTimes.setX(this.currentIndex,.01),this.densities.setX(this.currentIndex,0),this.density=0,this.lastDensity=this.density}ts(t){super.ts(t),this.eraseTimeScale=t.eraseTimeScale??.5,this.radiusTimeScale=t.radiusTimeScale??.25,this.spreadTimeScale=t.spreadTimeScale??.25,this.position=new a.A,this.lastPosition=(new a.A).copy(this.position),this.lerpedPosition=(new a.A).copy(this.position),this.nodeAddTimer=qs}createGeometry(){const t=new Ut;return t.setAttribute("position",Ds.attributes.position),t.setAttribute("uv",Ds.attributes.uv),t.setIndices(Ds.getIndices()),this.startPositions=new J.A(new Float32Array(3*this.numInstances),3,As.FLOAT,1),this.endPositions=new J.A(new Float32Array(3*this.numInstances),3,As.FLOAT,1),this.startTimes=new J.A(new Float32Array(this.numInstances),1,As.FLOAT,1),this.endTimes=new J.A(new Float32Array(this.numInstances),1,As.FLOAT,1),this.startDensities=new J.A(new Float32Array(this.numInstances),1,As.FLOAT,1),this.endDensities=new J.A(new Float32Array(this.numInstances),1,As.FLOAT,1),this.densities=new J.A(new Float32Array(this.numInstances),1,As.FLOAT,1),this.angles=new J.A(new Float32Array(this.numInstances),1,As.FLOAT,1),t.setAttribute("startPosition",this.startPositions),t.setAttribute("endPosition",this.endPositions),t.setAttribute("startTime",this.startTimes),t.setAttribute("endTime",this.endTimes),t.setAttribute("startDensity",this.startDensities),t.setAttribute("endDensity",this.endDensities),t.setAttribute("density",this.densities),t.setAttribute("angle",this.angles),t.instanceCount=this.numInstances,t.needsUpdate=!0,t}createMaterial(){return new Ps({radius:this.radius,radiusSqrt:this.radiusSqrt,initialRadius:this.initialRadius,damping:this.damping,initialColor:this.initialColor,finalColor:this.finalColor,initialEmissive:this.initialEmissive,finalEmissive:this.finalEmissive,liftForce:this.liftForce??1,radiusTimeScale:this.radiusTimeScale,eraseTimeScale:this.eraseTimeScale,spreadTimeScale:this.spreadTimeScale,colorTimeScale:this.colorTimeScale})}updateSmoke(t,i){this.lastPosition.copy(this.position),this.position.copy(t),this.lastDensity=this.density,this.density=i}fixedUpdate(t,i){super.fixedUpdate(t,i),this.nodeAddTimer-=i,this.nodeAddTimer<=0&&!this.isEmitterRemoved&&(this.addNode(),this.nodeAddTimer=qs)}addNode(){this.endPositions.setXYZ(this.currentIndex,this.lastPosition.x,this.lastPosition.y,this.lastPosition.z),this.endTimes.setX(this.currentIndex,this.lastTotalTimeElapsed),this.endDensities.setX(this.currentIndex,this.density),this.currentIndex--,this.currentIndex<0&&(this.currentIndex=this.numInstances-1),this.startPositions.setXYZ(this.currentIndex,this.lastPosition.x,this.lastPosition.y,this.lastPosition.z),this.startTimes.setX(this.currentIndex,this.lastTotalTimeElapsed),this.startDensities.setX(this.currentIndex,this.density),this.timeElapsedLatest=0}lateUpdate(t,i,s){super.lateUpdate(t,i,s),this.lastPosition.lerp(this.position,s,this.lerpedPosition);const n=(0,l.Cc)(this.lastTotalTimeElapsed,this.totalTimeElapsed,s);this.endPositions.setXYZ(this.currentIndex,this.lerpedPosition.x,this.lerpedPosition.y,this.lerpedPosition.z),this.endTimes.setX(this.currentIndex,n);const e=(0,l.Cc)(this.lastDensity,this.density,s);this.endDensities.setX(this.currentIndex,e),this.geometry.attributes.startPosition.needsUpdate=!0,this.geometry.attributes.endPosition.needsUpdate=!0,this.geometry.attributes.startTime.needsUpdate=!0,this.geometry.attributes.endTime.needsUpdate=!0,this.geometry.attributes.startDensity.needsUpdate=!0,this.geometry.attributes.endDensity.needsUpdate=!0,this.geometry.needsUpdate=!0}}class Es extends ft.A{constructor(t){super(),this.shooter=t,this.iff=t?.iff,this.collisionFilterGroup=Ii.N7.WEAPON,this.collisionFilterMask=Ii.N7.TERRAIN|Ii.N7.TERRAIN_OBJECT,this.collisionFilterMask|=((Ii.Ab.ALLY|Ii.Ab.ENEMY|Ii.Ab.OTHER)&~this.iff)<<8}}const Cs=new P.A(1,1,1,0),bs=(new P.A(30,15,0,1),new a.A,new r.A),Us=new a.A,Ns=new a.A,Rs=new a.A;class Is extends Es{constructor(t,i=new a.A,s=new r.A,n={}){super(t),this.shooter.isPlayerAircraft||(this.collisionFilterMask^=Ii.N7.TERRAIN_OBJECT),this.isMissile=!0,this.vehicle=t,this.localPosition=i.clone(),this.localQuaternion=s.clone(),this.ts(n),this.ws(n),this.Ms(),this.mesh=this.createMesh(),this.fixToVehicle(),this.smokes=new Gt({radiusTimeScale:.5,spreadTimeScale:1,eraseTimeScale:1,radius:3,initialRadius:0,numInstances:600,initialColor:Cs,useAngleAlpha:!0,radiusOffset:0,useReverseOrder:!0,position:this.position}),this.trails=null,this.smokeInterval=n.smokeInterval??1/120,this.smokeAccumulator=0,this.smokeType=0,this.ray=new wi.A({collisionFilterGroup:this.collisionFilterGroup,collisionFilterMask:this.collisionFilterMask}),this.raycastResult=new wt.A,this.explosionSize=n.explosionSize??20,this.launchAudio=null,this.thrustAudio=null,this.soundVolume=5,this.missileSound=new _s(this.position,this.velocity,50),this.audios.push(this.missileSound)}ts(t){this.position=new a.A,this.velocity=new a.A,this.direction=new a.A,this.quaternion=new r.A,this.vehicle.quaternion.vmult(this.localPosition,this.position),this.vehicle.position.add(this.position,this.position),this.vehicle.quaternion.mult(this.localQuaternion,this.quaternion),this.quaternion.normalize(),this.quaternion.vmult(n.OX,this.direction),this.velocity.copy(this.vehicle.body.velocity),this.lastPosition=(new a.A).copy(this.position),this.lastQuaternion=(new r.A).copy(this.quaternion),this.target=null,this.isGuidingToTarget=null!=this.target,this.timeElapsed=0,this.lastTimeElapsed=this.timeElapsed,this.isLaunched=!1,this.isDisabled=!1,this.cruiseTime=0,this.thrustDelay=t.thrustDelay??0,this.isThrusting=!1,this.lightIntensity=t.lightIntensity??7.5}ws(t){this.thrustForce=t.thrustForce??400,this.maxTurnRate=t.maxTurnRate??1,this.turnAlpha=this.vehicle.isPlayerAircraft?0:1,this.forwardDrag=t.sideDrag??t.drag??.5,this.sideDrag=t.sideDrag??t.drag??5,this.damage=t.damage??100,this.duration=t.duration??10,this.maxGuidingAngle=t.maxHomingAngle??.5*Math.PI,this.usePredictiveHoming=this.vehicle.isPlayerAircraft}Ms(){this.targetPosition=new a.A,this.targetDirection=new a.A,this.guidingDirection=new a.A,this.smokePosition=new a.A,this.forwardVelocity=new a.A,this.sideVelocity=new a.A}createMesh(){return K.A.MISSILE.clone()}onAdded(){this.game.addMissile(this)}onRemoved(){super.onRemoved(),this.smokes&&(this.smokes.isEmitterRemoved=!0),this.trails&&(this.trails.isEmitterRemoved=!0),this.game.removeMissile(this)}onPause(){super.onPause()}onContinue(){super.onContinue(),this.isLaunched}fixedUpdate(t,i,s){this.isLaunched?this.cruise(i):this.fixToVehicle()}cruise(t){if(this.cruiseTime+=t,this.thrustDelay<=this.cruiseTime&&(this.isThrusting=!0),this.isThrusting||(this.velocity.y-=n.ZQ*t),this.direction.scale(this.direction.dot(this.velocity),this.forwardVelocity),this.velocity.sub(this.forwardVelocity,this.sideVelocity),this.isThrusting&&(this.turnAlpha=1-Math.exp(-this.cruiseTime),this.turnRate=this.maxTurnRate*this.turnAlpha,this.target&&this.isGuidingToTarget&&this.guideToTarget(t),this.direction.scale(this.thrustForce*t,Us),this.forwardVelocity.add(Us,this.forwardVelocity)),this.isThrusting&&(this.forwardVelocity.scale(Math.pow(Math.exp(-this.forwardDrag),t),this.forwardVelocity),this.sideVelocity.scale(1-this.turnAlpha,this.sideVelocity)),this.forwardVelocity.add(this.sideVelocity,this.velocity),this.lastPosition.copy(this.position),this.velocity.scale(t,Ns),this.position.add(Ns,this.position),this.ray.intersectsWorldAlt(this.game.world,this.lastPosition,this.position,this.raycastResult),this.raycastResult.hasHit&&this.onHit(this.raycastResult),this.isThrusting){for(this.smokeAccumulator+=t;this.smokeInterval<this.smokeAccumulator;)this.smokeAccumulator-=this.smokeInterval,this.position.lerp(this.lastPosition,this.smokeAccumulator/t,this.smokePosition),this.smokes.add({density:3,position:this.smokePosition,velocity:this.velocity.scale(1e-4),startTime:(0,l.Cc)(this.smokes.totalTimeElapsed+t,this.smokes.lastTotalTimeElapsed+t,this.smokeAccumulator/t)});this.trails.updateSmoke(this.position,1)}this.duration-=t,this.duration<0&&this.parent.remove(this)}guideToTarget(t){if(this.target.position.sub(this.position,this.targetDirection),this.targetDirection.normalize(),this.usePredictiveHoming){(0,l.u9)(this.target.position,this.target.velocity,this.position,n.VT,Math.max(2*this.target.velocity.length(),1e3)).sub(this.position,this.guidingDirection)}else this.target.position.sub(this.position,this.guidingDirection);this.guidingDirection.normalize();const i=Math.acos((0,l.qE)(this.direction.dot(this.targetDirection)));if(this.maxGuidingAngle<i)return void(this.isGuidingToTarget=!1);this.target.isSeeked=!0,this.lastQuaternion.copy(this.quaternion);const s=Math.min(i,this.turnRate*t);this.direction.cross(this.guidingDirection,Rs),Rs.normalize(),bs.setFromAxisAngle(Rs,s),bs.normalize(),bs.mult(this.quaternion,this.quaternion),this.quaternion.normalize(),this.quaternion.vmult(n.OX,this.direction)}onHit(t){this.explode(t.hitPoint,t.hitNormal);const i=t.hitBody.actor;(this.shooter.isPlayerAircraft||i?.isPlayerAircraft)&&i?.applyDamageRaycast&&i.applyDamageRaycast(t,this.damage,this.shooter)}explode(t,i){const s=[];if(s.push(new Ji(t,n.VT,this.explosionSize*n.L7,1.25,1.5)),this.raycastResult.hitBody.actor?.isVehicle){this.shooter,this.game.vehicleCamera.vehicle;this.raycastResult.hitBody.actor===this.game.vehicleCamera.vehicle&&s.push(new ys)}const e=new ai(t,{radius:this.explosionSize,normal:i,velocity:new a.A,useInstancedDebris:!1,useFlameDebris:!1,isLight:!0,audios:s});this.game.add(e),this.parent.remove(this)}disable(){this.scene.removeBody(this),this.isDisabled=!0}fixToVehicle(){this.lastPosition.copy(this.position),this.vehicle.quaternion.vmult(this.localPosition,this.position),this.vehicle.position.add(this.position,this.position),this.lastQuaternion.copy(this.quaternion),this.vehicle.quaternion.mult(this.localQuaternion,this.quaternion),this.quaternion.normalize(),this.quaternion.vmult(n.OX,this.direction),this.velocity.copy(this.vehicle.body.velocity)}launch(t){this.createAudios(),this.trails=new Ts({radiusTimeScale:1,spreadTimeScale:3,eraseTimeScale:.25,radius:3,initialRadius:.5,numInstances:500,initialColor:Cs,useAngleAlpha:!0,radiusOffset:0,useReverseOrder:!0,position:this.position}),this.scene.add(this.smokes),this.target=t,this.isGuidingToTarget=!0,this.missileSound.start(),this.missileSound.setVolume(4),this.isLaunched=!0}lateUpdate(t,i,s){this.setVisible(),this.isLaunched?(this.lastPosition.lerp(this.position,s,this.mesh.position),this.lastQuaternion.slerp(this.quaternion,s,this.mesh.quaternion)):(this.vehicle.mesh.quaternion.vmult(this.localPosition,this.mesh.position),this.vehicle.mesh.position.add(this.mesh.position,this.mesh.position),this.vehicle.mesh.quaternion.mult(this.localQuaternion,this.mesh.quaternion),this.mesh.quaternion.normalize()),this.mesh.children[0].visible=this.isThrusting}setVisible(){this.mesh.visible=!(!this.isLaunched&&this.game.mainCamera.vehicle===this.vehicle&&this.game.mainCamera.view===ns)}createAudios(){}}class zs extends xs{constructor(t,i={}){super(t,i),this.isMissileLauncher=!0,this.missile=null,this.recharging=!1,this.chargeRate=1,this.rechargeSpeed=i.rechargeSpeed??this.controller.rechargeSpeed}fixedUpdate(t,i){this.recharging&&(this.chargeRate+=this.rechargeSpeed*i),1<=this.chargeRate&&(this.chargeRate=1,this.recharging=!1),this.vehicle.isPlayerAircraft&&1<=this.chargeRate&&!this.missile&&this.Ss()}fire(t){return super.fire(),!(this.chargeRate<1)&&(this.missile||this.Ss(),this.missile.launch(t),this.missile=null,this.chargeRate=0,!0)}recharge(){this.recharging=!0}refill(){this.chargeRate=1,this.recharging=!1}Ss(){this.missile=this.controller.createMissile(this.localPosition,this.localQuaternion),this.game.add(this.missile)}onRemoved(){this.missile&&this.scene.remove(this.missile)}}new a.A,new a.A;class Ls extends Ss{constructor(t,i={}){super(t,i),this.isMissileController=!0,this.launchers=this.muzzles,this.createSeeker(i)}createSeeker(t){this.seeker=new ps(this.vehicle,this,t),this.add(this.seeker)}ws(t){super.ws(t),this.vehicle.isPlayerAircraft||(this.fireInterval=t.fireInterval??10),this.damage=t.damage??100,this.duration=t.duration??10,this.initialSpeed=t.initialSpeed??0,this.maxAcceleration=t.maxAcceleration??20,this.rechargeSpeed=t.rechargeSpeed??.5,this.maxLockonDistance=t.maxLockonDistance??3e3,this.maxLockonAngle=t.maxLockonAngle??.5,this.maxRange=this.maxLockonDistance,this.range=this.maxLockonDistance,this.usePredictiveTargeting=!1,this.lockonToFireInterval=n.sO,this.lockonToFireTimer=this.lockonToFireInterval*(.5+Math.random())}gs(t){return new zs(this,t)}fixedUpdate(t,i){super.fixedUpdate(t,i),this.seeker.targetLocking?this.lockonToFireTimer-=i:this.lockonToFireTimer=this.lockonToFireInterval*(.5+Math.random())}operate(t,i){this.seeker.setTarget(t),this.seeker.operate(i)}autoFire(t){!this.seeker.targetLocking||0<this.lockonToFireTimer||this.fire(this.target)&&(this.lockonToFireTimer=this.lockonToFireInterval*(.5+Math.random()))}fire(){if(this.ammo<=0||0<this.fireTimer)return!1;const t=this.seeker.targetLocking?this.seeker.target:null;return!!this.muzzles[this.muzzleIndex].fire(t)&&(this.ammo--,this.muzzles.length-this.muzzleIndex<=this.ammo&&this.muzzles[this.muzzleIndex].recharge(),this.fireTimer=this.fireInterval,this.muzzleIndex++,this.muzzles.length<=this.muzzleIndex&&(this.muzzleIndex=0),!0)}createMissile(t,i){return new Is(this.vehicle,t,i,{maxTurnRate:this.vehicle.isPlayerAircraft?1:.5,usePredictiveTargeting:this.usePredictiveTargeting,damage:this.damage,duration:this.duration})}deactivate(){super.deactivate(),this.seeker.unlock()}refill(){super.refill();for(const t of this.muzzles)t.refill()}}new a.A;const Fs=new r.A,Os=new a.A,Vs=new a.A,ks=new a.A,Gs=new a.A,Bs=new a.A;class Hs extends Es{constructor(t,i=new a.A,s=new r.A,n={}){super(t),this.isBomb=!0,this.vehicle=t,this.localPosition=i.clone(),this.localQuaternion=s.clone(),this.ts(n),this.ws(n),this.Ms(),this.fixToVehicle(),this.mesh=this.createMesh(),this.lastPosition=(new a.A).copy(this.position),this.lastQuaternion=(new r.A).copy(this.quaternion),this.drag=n.drag??.01,this.damage=n.damage??1e3,this.duration=n.duration??60,this.raycastResult=new wt.A,this.timeElapsed=0,this.lastTimeElapsed=this.timeElapsed,this.explosionSize=n.explosionSize??50,this.ray=new wi.A({collisionFilterGroup:this.collisionFilterGroup,collisionFilterMask:this.collisionFilterMask}),this.raycastResult=new wt.A}ts(t){this.position=new a.A,this.velocity=new a.A,this.direction=new a.A,this.quaternion=new r.A,this.lastPosition=(new a.A).copy(this.position),this.lastQuaternion=(new r.A).copy(this.quaternion),this.target=null,this.isGuidingToTarget=null!=this.target,this.timeElapsed=0,this.lastTimeElapsed=this.timeElapsed,this.isLaunched=!1,this.isDisabled=!1,this.cruiseTime=0,this.thrustDelay=t.thrustDelay??0,this.isThrusting=!1,this.lightIntensity=t.lightIntensity??7.5}ws(t){this.thrustForce=t.thrustForce??(this.vehicle.isPlayerAircraft,400),this.maxTurnRate=t.maxTurnRate??(this.vehicle.isPlayerAircraft?2:1),this.turnAlpha=this.vehicle.isPlayerAircraft?0:1,this.forwardDrag=t.sideDrag??t.drag??.5,this.sideDrag=t.sideDrag??t.drag??5,this.damage=t.damage??(this.vehicle.isPlayerAircraft?100:10),this.duration=t.duration??10,this.maxGuidingAngle=t.maxHomingAngle??.5*Math.PI,this.usePredictiveHoming=this.vehicle.isPlayerAircraft}Ms(){this.targetPosition=new a.A,this.targetDirection=new a.A,this.guidingDirection=new a.A,this.smokePosition=new a.A,this.forwardVelocity=new a.A,this.sideVelocity=new a.A}createMesh(){return K.A.BOMB.clone()}fixedUpdate(t,i,s){this.isLaunched?this.cruise(i):this.fixToVehicle()}fixToVehicle(){this.lastPosition.copy(this.position),this.vehicle.quaternion.vmult(this.localPosition,this.position),this.vehicle.position.add(this.position,this.position),this.velocity.copy(this.vehicle.body.velocity),this.lastQuaternion.copy(this.quaternion),this.vehicle.quaternion.mult(this.localQuaternion,this.quaternion),this.quaternion.normalize(),this.quaternion.vmult(n.OX,this.direction)}cruise(t){this.cruiseTime+=t,this.game.getGravity().scale(t,Os),this.velocity.add(Os,this.velocity),this.velocity.scale(Math.pow(Math.exp(-this.drag),t),this.velocity),this.lastPosition.copy(this.position),this.velocity.scale(t,Vs),this.position.add(Vs,this.position),ks.copy(this.velocity),ks.normalize(),this.quaternion.vmult(n.OX,Gs),Gs.normalize(),Gs.cross(ks,Bs),Bs.normalize();const i=Math.acos((0,l.qE)(Gs.dot(ks))),s=this.velocity.length()**2*t;this.lastQuaternion.copy(this.quaternion),Fs.setFromAxisAngle(Bs,(0,l.qE)(i,-s,s)),Fs.mult(this.quaternion,this.quaternion),this.quaternion.normalize(),this.ray.intersectsWorldAlt(this.game.world,this.lastPosition,this.position,this.raycastResult),this.raycastResult.hasHit&&this.onHit(this.raycastResult),this.duration-=t,this.duration<=0&&this.parent&&this.parent.remove(this)}onHit(t){const i=t.hitBody.actor;t.hitBody.actor?.applyDamageRaycast&&i.applyDamageRaycast(t,this.damage,this.shooter),this.explode(t.hitPoint,t.hitNormal)}explode(t,i){const s=new ai(t,{radius:this.explosionSize,normal:i,velocity:new a.A,useInstancedDebris:!1,useFlameDebris:!1});this.game.add(s),this.game.remove(this)}launch(t){this.isLaunched=!0}lateUpdate(t,i,s){this.lastPosition.lerp(this.position,s,this.mesh.position),this.lastQuaternion.slerp(this.quaternion,s,this.mesh.quaternion)}}class js extends zs{constructor(t,i={}){super(t,i),this.isBombLauncher=!0}}new a.A;const Ws=new a.A,$s=new a.A,Xs=new a.A;class Zs extends Ls{constructor(t,i={}){super(t,i),this.isBombController=!0,this.bombingTarget=(new a.A).copy(i.bombingTarget??n.VT),this.rechargeSpeed=i.rechargeSpeed??.1}ws(t){super.ws(t),this.fireInterval=t.fireInterval??4}gs(t){return new js(this,t)}autoFire(t){$s.set(this.bombingTarget.x,0,this.bombingTarget.z),Ws.copy(this.vehicle.velocity),Ws.y=0,Ws.normalize();const i=this.vehicle.velocity.length();Ws.scale(i*n.jc,Xs),Xs.x+=this.vehicle.position.x,Xs.z+=this.vehicle.position.z,Xs.distanceTo($s)<n.e7&&this.fire()}createMissile(t,i){return new Hs(this.vehicle,t,i,{damage:this.damage,drag:this.drag})}}class Ys extends Zi.Ay{constructor(){super(Xi.A.HIT),this.setVolume(.5),this.setPlaybackRate(.75)}}class Ks extends St.Ay{constructor(t={}){super(t),this.renderingPass=n.xF,this.depthWrite=!1,this.transparent=!0}getVertSource(){return"#version 300 es\n            \n            precision lowp float;\n            \n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec2 uv;\n\n            layout (location = 2) in vec3 translation;\n            layout (location = 3) in vec3 velocity;\n            layout (location = 4) in float time;\n                \n            uniform mat4 modelMatrix;\n            uniform mat4 viewMatrix;\n            uniform mat4 modelViewMatrix;\n            uniform mat4 projectionMatrix;\n\n            uniform vec3 cameraPosition;\n            uniform vec3 cameraVelocity;\n\n            uniform float radius;\n\n            uniform float shootSpeed;\n\n            out float vOffset;\n\n            out vec2 vUv;\n            out vec3 vPosition;\n\n            out float vAlpha;\n            out float vViewZ;\n\n            out float vTime;\n            out vec3 vRelativeVelocity;\n\n            void main() {\n                vUv = uv;\n                vPosition = position;\n                \n                if (time == 0.0) {\n                    gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(0.0, 0.0, 0.0, 1.0);\n                    return;\n                }\n\n                vec3 relativeVelocity = velocity - cameraVelocity;\n                vec3 direction = normalize(relativeVelocity);\n\n                vec3 center = translation;\n                vec3 cameraDirection = normalize(center - cameraPosition);\n                vec3 tangent = normalize(cross(cameraDirection, direction));\n\n                vViewZ = (viewMatrix * vec4(center, 1.0)).z;\n                vOffset = max(-vViewZ * 0.025, 0.0);\n                // vOffset = 1.0;\n\n                float forwardOffset = position.y * radius * 6.0 + (position.y * 2.0 + 1.0) * vOffset;\n                float sideOffset = position.x * radius + position.x * vOffset;\n                vTime = time + forwardOffset / shootSpeed;\n\n                vec3 offset = direction * forwardOffset + tangent * sideOffset;\n\n                gl_Position = projectionMatrix * viewMatrix * vec4(center + offset, 1.0);\n            }\n        "}getFragSource(){return"#version 300 es\n            \n            precision mediump float;\n\n            in float vOffset;\n\n            in vec2 vUv;\n            in vec3 vPosition;\n\n            in float vTime;\n            in float vBulletLength;\n            in vec3 vRelativeVelocity;\n\n            in float vAlpha;\n            in float vViewZ;\n\n            out vec4 gDiffuse;\n\n            void main() {\n                if (vTime < 0.0) discard;\n\n                float head = -vPosition.y;\n                // if (vAlpha < head) discard;\n\n                float density = min(pow(head * 10.0, 2.0), 1.0) * min(pow((1.0 - head), 2.0), 1.0) * exp(-pow(vPosition.x * 30.0, 2.0)) * 5.0 / (1.0 + sqrt(vOffset));\n                float transmittance = 1.0 - exp(-density);\n                vec3 emissive = vec3(1.0, 0.8, 0.1) * 80.0 * density;\n\n                gDiffuse.rgb = emissive;\n                gDiffuse.a = density;\n            }\n        "}getUniforms(){return{radius:1,cameraVelocity:new a.A,cameraPosition:new a.A,modelMatrix:new Mt.A,viewMatrix:new Mt.A,modelViewMatrix:new Mt.A,projectionMatrix:new Mt.A,sunDirection:new a.A,shootSpeed:1,atmosphereProfile:{}}}}const Js=new P.A(.25,.25,.25,.5),Qs=new P.A(30,15,0,1),tn=new a.A,sn=WebGL2RenderingContext;class nn extends Es{constructor(t,i={}){super(t),this.isBullets=!0,this.shooter.isPlayerAircraft||(this.collisionFilterMask^=Ii.N7.TERRAIN|Ii.N7.TERRAIN_OBJECT),this.damage=i.damage??20,this.duration=i.duration??3,this.shootSpeed=i.shootSpeed??1,this.radius=i.radius??2.5,this.numInstances=i.numInstances??100,this.currentIndex=0,this.bullets=[];for(let t=0;t<this.numInstances;t++)this.bullets.push({position:new a.A,lastPosition:new a.A,velocity:new a.A,timeElapsed:0,lastTimeElapsed:0,isAlive:!1});this.createMesh(),this.mesh.material.uniforms.shootSpeed=this.shootSpeed,this.timeElapsed=0,this.lastTimeElapsed=0,this.timeElapsedLatest=0,this.ray=new wi.A({collisionFilterGroup:this.collisionFilterGroup,collisionFilterMask:this.collisionFilterMask}),this.raycastResult=new wt.A}createMesh(){this.createGeometry(),this.material=new Ks,this.material.uniforms.radius=this.radius??3,this.mesh=new D.A(this.geometry,this.material),this.mesh.frustumCulled=!1}createGeometry(){this.geometry=new Ut;this.geometry.setAttribute("position",new J.A(new Float32Array([-1,-1,0,1,-1,0,1,0,0,-1,0,0]),3,sn.FLOAT)),this.geometry.setAttribute("uv",new J.A(new Float32Array([0,0,1,0,1,1,0,1]),2,sn.FLOAT)),this.geometry.setIndices(new J.A(new Uint16Array([0,1,2,2,3,0]),1,sn.UNSIGNED_SHORT)),this.translations=new J.A(new Float32Array(3*this.numInstances),3,sn.FLOAT,1),this.velocities=new J.A(new Float32Array(3*this.numInstances),3,sn.FLOAT,1),this.times=new J.A(new Float32Array(1*this.numInstances),1,sn.FLOAT,1),this.geometry.setAttribute("translation",this.translations),this.geometry.setAttribute("velocity",this.velocities),this.geometry.setAttribute("time",this.times),this.translations.needsUpdate=!0,this.velocities.needsUpdate=!0,this.times.needsUpdate=!0,this.geometry.instanceCount=this.numInstances}onAdded(){super.onAdded()}onRemoved(){super.onRemoved()}add(t,i){const s=this.bullets[this.currentIndex];s.position.copy(t),s.lastPosition.copy(t),s.velocity.copy(i),s.timeElapsed=0,s.lastTimeElapsed=0,s.isAlive=!0,s.isNew=!0,this.currentIndex++,this.numInstances<=this.currentIndex&&(this.currentIndex=0),this.timeElapsedLatest=0}fixedUpdate(t,i){for(const t of this.bullets)t.isAlive&&(t.isNew?t.isNew=!1:(t.lastTimeElapsed=t.timeElapsed,t.timeElapsed+=i,this.duration<t.timeElapsed&&(t.isAlive=!1),t.lastPosition.copy(t.position),t.velocity.scale(i,tn),t.position.add(tn,t.position),this.ray.intersectsWorldAlt(this.game.world,t.lastPosition,t.position,this.raycastResult),this.raycastResult.hasHit&&this.onHit(this.raycastResult,t)));this.timeElapsedLatest+=i,this.isEmitterRemoved&&this.duration<this.timeElapsedLatest&&this.parent.remove(this)}onHit(t,i){const s=t.hitBody.actor;if(!this.shooter.isPlayerAircraft&&!s?.isPlayerAircraft||!s?.applyDamageRaycast)return;i.isAlive=!1;const n=this.shooter===this.game.vehicleCamera.vehicle,e=t.hitBody.actor===this.game.vehicleCamera.vehicle;let h=null;t.hitBody.actor?.isVehicle&&(n?h=new Ys:e&&(h=new ys));const o=new ai(t.hitPoint,{initialColor:Js,finalColor:Js,initialEmissive:Qs,radius:7,normal:t.hitNormal,useInstancedDebris:!1,useFlameDebris:!1,density:1,playSound:!1,audio:h});this.game.add(o),s.applyDamageRaycast(t,this.damage,this.shooter)}lateUpdate(t,i,s){this.mesh.position=this.shooter.body.position;for(let t=0;t<this.numInstances;t++){const i=this.bullets[t];if(i?.isAlive){i.lastPosition.lerp(i.position,s,tn),this.translations.setXYZ(t,tn.x,tn.y,tn.z),this.velocities.setXYZ(t,i.velocity.x,i.velocity.y,i.velocity.z);const n=(0,l.Cc)(i.lastTimeElapsed,i.timeElapsed,s);this.times.setX(t,n)}else{const i=this.shooter.body.position;this.translations.setXYZ(t,i.x,-1e4,i.z)}}this.geometry.attributes.translation.needsUpdate=!0,this.geometry.attributes.velocity.needsUpdate=!0,this.geometry.attributes.time.needsUpdate=!0,this.material.uniforms.cameraVelocity.copy(this.scene.mainCamera.cameraVelocity),this.geometry.needsUpdate=!0}}class en extends Yi{constructor(t,i,s=1){super(Xi.A.GUN_FIRE,t,i,s)}}const hn=new a.A,on=new a.A,rn=new r.A;new a.A;class an extends xs{constructor(t,i){super(t,i),this.spreadAngle=i.spreadAngle??t.spreadAngle??0,this.bulletSpeed=i.bulletSpeed??t.bulletSpeed??2e3,this.gunSounds=[];for(let t=0;t<10;t++){const t=new en(this.vehicle.body.interpolatedPosition,this.vehicle.body.interpolatedVelocity,100);t.setPlaybackRate(1.25),this.gunSounds.push(t)}this.gunSoundIndex=0,this.audios=this.gunSounds}fire(){super.fire(),this.gunSounds[this.gunSoundIndex].restart(0),this.gunSoundIndex++,9<=this.gunSoundIndex&&(this.gunSoundIndex=0),on.set(2*Math.random()-1,2*Math.random()-1,0),on.normalize();const t=Math.random()*this.spreadAngle;rn.setFromAxisAngle(on,t),rn.normalize(),rn.vmult(n.OX,hn),this.localQuaternion.vmult(hn,hn),hn.scale(this.bulletSpeed,hn),this.vehicle.body.quaternion.vmult(hn,hn),this.vehicle.body.velocity.add(hn,hn),this.controller.createBullet(this.worldPosition,hn)}}new a.A,new a.A;const cn=new a.A,ln=new a.A;class un extends Ss{constructor(t,i){super(t,i),this.isGunController=!0,this.ys()}ws(t){super.ws(t),this.spreadAngle=t.spreadAngle??(this.vehicle.isPlayerAircraft?.005:.05),this.bulletSpeed=t.bulletSpeed??(this.vehicle.isPlayerAircraft?2e3:1e3),this.bulletDamage=t.bulletDamage??10,this.bulletDuration=t.bulletDuration??3,this.maxRange=t.maxRange??1500,this.angleThreshould=t.angleThreshould??.1,this.projectileSpeed=this.bulletSpeed}gs(t){return new an(this,t)}ys(){this.bullets=new nn(this.vehicle,{damage:this.bulletDamage,shootSpeed:this.bulletSpeed})}autoFire(t){if(!t)return;const i=this.worldPosition.distanceTo(t.position),s=t.velocity.distanceTo(this.vehicle.velocity);(0,l.u9)(t.position,t.velocity,this.worldPosition,this.vehicle.velocity,Math.max(this.bulletSpeed,2*s),cn),cn.sub(this.worldPosition,ln).normalize();const e=Math.acos((0,l.qE)(this.worldDirection.dot(ln)));this.maxRange<i||n.HB<e||this.fire()}onAdded(t){super.onAdded(),this.bullets&&this.scene.add(this.bullets)}onRemoved(){super.onRemoved(),this.bullets&&(this.bullets.isEmitterRemoved=!0)}createBullet(t,i){this.bullets.add(t,i)}}const fn=new a.A;class dn extends Yi{constructor(t,i,s=1){super(Xi.A.LASER,t,i,s),this.loop=!0}}class vn extends St.Ay{constructor(t={}){super(t),this.config=t,this.transparent=!0,this.depthWrite=!1,this.renderingPass=n.xF}getVertSource(){return"#version 300 es\n        \n            precision mediump float;\n            \n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec2 uv;\n            \n            uniform mat4 modelMatrix;\n            uniform mat4 viewMatrix;\n            uniform mat4 modelViewMatrix;\n            uniform mat4 projectionMatrix;\n\n            uniform vec3 cameraPosition;\n\n            uniform vec3 direction;\n            uniform float range;\n\n            out vec3 vViewCenterPosition;\n            out vec3 vViewOffsetPosition;\n\n            void main() {\n                vec3 directionView = (viewMatrix * vec4(direction, 0.0)).xyz;\n\n                vec3 viewStartPosition = (viewMatrix * modelMatrix * vec4(0.0, 0.0, 0.0, 1.0)).xyz;\n                vec3 viewEndPosition = viewStartPosition + directionView * range;\n                vViewCenterPosition = mix(viewStartPosition, viewEndPosition, position.y);\n\n                vec3 viewCenterDirection = normalize(vViewCenterPosition);\n                vec3 tangent = normalize(cross(-viewCenterDirection, directionView));\n                float offsetScale = 1.0 + max(-vViewCenterPosition.z * 0.0075, 0.0);\n                vViewOffsetPosition = vViewCenterPosition + tangent * position.x * offsetScale;\n\n                gl_Position = projectionMatrix * vec4(vViewOffsetPosition, 1.0);\n            }\n        "}getFragSource(){return`#version 300 es\n            \n            precision mediump float;\n\n            uniform vec3 cameraPosition;\n\n            uniform float range;\n            uniform float alpha;\n\n            in vec3 vViewCenterPosition;\n            in vec3 vViewOffsetPosition;\n\n            out vec4 gDiffuse;\n\n            ${yt.mz}\n\n            ${yt.SY}\n    \n            void main() {\n                float offsetScale = 1.0 + max(-vViewCenterPosition.z * 0.0075, 0.0);\n                float offset = length(vViewOffsetPosition - vViewCenterPosition);\n                float deviation = offset * 8.0 / offsetScale;\n                // float density = exp(-pow(deviation, 2.0)) * sqrt(alpha) / sqrt(offsetScale);\n                float density = exp(-pow(deviation, 2.0)) * sqrt(alpha) / sqrt(offsetScale);\n                vec3 emissive =  vec3(0.8, 0.3, 1.0) * 200.0 * density;\n    \n                gDiffuse.rgb = emissive;\n                gDiffuse.a = density;\n            }\n        `}getUniforms(t){return{modelMatrix:new Mt.A,viewMatrix:new Mt.A,modelViewMatrix:new Mt.A,projectionMatrix:new Mt.A,cameraPosition:t.cameraPosition??new a.A,direction:new a.A,range:t.range??1,alpha:t.alpha??0,atmosphereProfile:{}}}}const mn=WebGL2RenderingContext,wn=new P.A(.1,.1,.1,.5),pn=new r.A,gn=new r.A,xn=new a.A,Mn=new a.A;new a.A;class Sn extends Es{constructor(t,i={}){super(t),this.shooter.isPlayerAircraft||(this.collisionFilterMask^=Ii.N7.TERRAIN|Ii.N7.TERRAIN_OBJECT),this.damage=i.damage??500,this.range=i.range??1e4,this.mesh=this.createMesh(),this.raycastResult=new wt.A,this.explosionInterval=i.explosionInterval??.05,this.explosionCounter=0,this.desiredFireAlpha=0,this.fireAlpha=0,this.lastFireAlpha=this.fireAlpha,this.echo=0,this.lastEcho=this.echo,this.increaseSpeed=0,this.shootPosition=new a.A,this.lastShootPosition=new a.A,this.lerpedShootPosition=new a.A,this.shootDirection=new a.A,this.lastShootDirection=new a.A,this.lerpedShootDirection=new a.A,this.ray=new wi.A({collisionFilterGroup:this.collisionFilterGroup,collisionFilterMask:this.collisionFilterMask}),this.raycastResult=new wt.A,this.laserSound=new dn(new a.A,new a.A,500),this.laserSound.setVolume(0),this.laserSound.start(),this.audios.push(this.laserSound)}createMesh(){const t=this.createGeometry(),i=new vn({range:this.range}),s=new D.A(t,i);return s.material.uniforms.range=this.range,s.frustumCulled=!1,s.renderOrder=2,s}createGeometry(){return yn}createMaterial(){return MATERIAL.clone()}onAdded(){this.game.addMesh(this.mesh)}onRemoved(){this.game.removeMesh(this.mesh)}fire(t){this.desiredFireAlpha=1}updateShootPosition(t){this.lastShootPosition.copy(this.shootPosition),this.shootPosition.copy(t)}updateShootDirection(t){this.lastShootDirection.copy(this.shootDirection),this.shootDirection.copy(t)}fixedUpdate(t,i){this.lastFireAlpha=this.fireAlpha,this.fireAlpha=(0,l.Cc)(this.fireAlpha,this.desiredFireAlpha,1-Math.exp(10*-i)),this.lastEcho=this.echo,this.echo=(0,l.Cc)(this.echo,this.desiredFireAlpha,1-Math.exp(1*-i)),this.echo=Math.max(this.fireAlpha,this.echo),.01<=this.fireAlpha&&this.irradiate(this.shootPosition,this.shootDirection,i),this.desiredFireAlpha=0,this.explosionCounter-=i}irradiate(t,i,s){const n=this.range/1,e=(i.scale(n),t.clone()),h=i.scale(this.range);e.add(h,h),this.ray.intersectsWorldAlt(this.game.world,t,h,this.raycastResult),this.raycastResult.hasHit&&this.onHit(this.raycastResult,s)}onHit(t,i){const s=t.hitBody.actor;if((this.shooter.isPlayerAircraft||s?.isPlayerAircraft)&&s?.applyDamageRaycast){if(this.explosionCounter<0){const i=new ai(t.hitPoint,{initialColor:wn,finalColor:wn,radius:20*Math.sqrt(this.fireAlpha),normal:t.hitNormal,useInstancedDebris:!1,useFlameDebris:!1,density:.3,velocity:t.hitBody.velocity});this.game.add(i),this.explosionCounter=this.explosionInterval}s.applyDamageRaycast(t,this.damage*i*this.fireAlpha,this.shooter,!1)}}lateUpdate(t,i,s){this.lastShootPosition.lerp(this.shootPosition,s,this.lerpedShootPosition),this.lastShootDirection.lerp(this.shootDirection,s,this.lerpedShootDirection),this.mesh.position.copy(this.lerpedShootPosition),this.mesh.material.uniforms.direction.copy(this.lerpedShootDirection);const e=(0,l.Cc)(this.lastFireAlpha,this.fireAlpha,s);this.mesh.material.uniforms.alpha=e,this.mesh.visible=e;const h=(0,l.Cc)(this.lastEcho,this.echo,s);this.laserSound.setVolume(4*h);{n.OX.cross(this.shootDirection,xn).normalize();const t=Math.acos((0,l.qE)(n.OX.dot(this.shootDirection)));pn.setFromAxisAngle(xn,t).normalize(),pn.conjugate(gn).normalize(),this.game.mainCamera.position.sub(this.shootPosition,this.laserSound.position),gn.vmult(this.laserSound.position,this.laserSound.position);const i=(0,l.qE)(-this.laserSound.position.z,0,this.range);pn.vmult(n.OX.scale(i,Mn),this.laserSound.position),this.shootPosition.add(this.laserSound.position,this.laserSound.position)}}}const yn=function(){const t=new I.A;return t.setAttribute("position",new J.A(new Float32Array([-1,1,0,1,1,0,1,0,0,-1,0,0]),3,mn.FLOAT)),t.setAttribute("uv",new J.A(new Float32Array([0,0,1,0,1,1,0,1]),2,mn.FLOAT)),t.setIndices(new J.A(new Uint16Array([0,1,2,2,3,0]),1,mn.UNSIGNED_SHORT)),t}();class _n extends xs{constructor(t,i){super(t,i),this.isLaserMuzzle=!0,this.laser=new Sn(this.vehicle,i),this.laser.mesh.position.copy(this.localPosition),this.add(this.laser),this.shootPosition=new a.A,this.shootDirection=new a.A}fixedUpdate(t,i){this.vehicle.quaternion.vmult(this.localPosition,this.shootPosition),this.shootPosition.add(this.vehicle.position,this.shootPosition),this.laser.updateShootPosition(this.shootPosition),this.vehicle.quaternion.vmult(this.localDirection,this.shootDirection),this.laser.updateShootDirection(this.shootDirection)}fire(t){super.fire(),this.laser.fire(t)}}new a.A;const Pn=new a.A;class An extends Ss{constructor(t,i){super(t,i),this.isLaserController=!0}ws(t){super.ws(t),this.fireInterval=-1,this.range=t.range??1e4,this.angleThreshould=t.angleThreshould??.1}gs(t){return new _n(this,t)}operate(t,i){if(super.operate(),!t)return;t.body.position.sub(this.worldPosition,Pn);const s=Pn.length();Pn.normalize();const n=Math.acos(this.worldDirection.dot(Pn));s<this.range&&n<this.angleThreshould&&this.keepFiring(i)}fire(){}keepFiring(t){if(!(this.ammo<=0))for(const i of this.muzzles)i.fire(t)}}const Dn=new a.A;new r.A;class qn extends Es{constructor(t,i={}){super(t),this.vehicle=t,this._s(i),this.Ei(i),this.Ps(i.weapon)}_s(t){this.maxRotationSpeed=t.maxRotationSpeed?t.maxRotationSpeed*n.vT:1,this.maxTurretRotationSpeed=t.maxTurretRotationSpeed?t.maxTurretRotationSpeed*n.vT:this.maxRotationSpeed,this.maxMuzzleRotationSpeed=t.maxMuzzleRotationSpeed?t.maxMuzzleRotationSpeed*n.vT:this.maxRotationSpeed,this.isFullRotation=t.isFullRotation??!1,this.maxAngle=t.maxAngle?t.maxAngle*n.vT:Math.PI,this.maxTurretAngle=t.maxTurretAngle?t.maxTurretAngle*n.vT:Math.PI,this.maxMuzzleAngle=t.maxMuzzleAngle?t.maxMuzzleAngle*n.vT:.5*Math.PI,this.minMuzzleAngle=t.minMuzzleAngle?t.minMuzzleAngle*n.vT:.5*-Math.PI,this.detectionRange=t.detectionRange??1e4,this.localPosition=(new a.A).copy(t.position??n.VT),this.localNeutralQuaternion=this.As(t),this.invLocalNeutralQuaternion=this.localNeutralQuaternion.conjugate().normalize(),this.localNeutralDirection=this.localNeutralQuaternion.vmult(n.OX),this.turretQuaternion=new r.A,this.muzzleQuaternion=new r.A,this.lastTurretQuaternion=new r.A,this.lastMuzzleQuaternion=new r.A,this.turretAngle=0,this.muzzleAngle=0,this.sensibility=t.sensibility??10,this.turretMesh=t.turretMesh?this.vehicle.Ds(this.vehicle.mesh,t.turretMesh):null,this.muzzleMesh=t.muzzleMesh?this.vehicle.Ds(this.vehicle.mesh,t.muzzleMesh):null}As(t){const i=(new a.A).copy(t.forward??t.direction??n.OX);i.normalize();const s=(new a.A).copy(t.up??n.UP);s.normalize();const e=s.cross(i);return e.normalize(),i.cross(e,s),s.normalize(),(new r.A).makeBasis(i.negate(),e.negate(),s)}Ei(){this.worldTurretPosition=new a.A,this.worldNeutralDirection=new a.A,this.localAimQuaternion=new r.A,this.localAimDirection=new a.A,this.worldTargetPosition=new a.A,this.relativeTargetPosition=new a.A,this.lerpedRelativeTargetPosition=new a.A,this.worldTargetDirection=new a.A,this.localTargetDirection=new a.A,this.delayedLocalTargetDirection=new a.A,this.target=null,this.targetDistance=-1,this.targetAngle=-1}Ps(t={}){const i={...t,maxRange:t.maxRange??3e3,position:this.localPosition,quaternion:this.localNeutralDirection,muzzles:[{}]};switch(t.type){case"missile":this.weaponController=new Ls(this.vehicle,i);break;case"laser":this.weaponController=new An(this.vehicle,i);break;default:this.weaponController=new un(this.vehicle,i),this.gunController=this.weaponController}this.add(this.weaponController)}fixedUpdate(t,i){if(this.vehicle.body.quaternion.vmult(this.localPosition,this.worldTurretPosition),this.vehicle.body.position.add(this.worldTurretPosition,this.worldTurretPosition),this.vehicle.body.quaternion.vmult(this.localNeutralDirection,this.worldNeutralDirection),!this.vehicle.destroyed){this.target=function(t,i,s,e={}){const h=e.direction??n.OX,o=e.maxRange??1/0,r=e.maxAngle??1/0;let a=null,c=1/0;return t.getAllVehicles().forEach(t=>{if(i.iff===t.iff||t.health<=0)return;t.body.position.sub(s,fn);const n=fn.length();if(o<n)return;fn.normalize();const e=Math.acos((0,l.qE)(h.dot(fn)));r<e||n<c&&(a=t,c=n)}),a}(this.game,this.vehicle,this.worldTurretPosition,{direction:this.worldNeutralDirection,maxRange:this.detectionRange,maxAngle:Math.max(this.maxTurretAngle,this.maxMuzzleAngle,-this.minMuzzleAngle)}),this.qs(i),this.Ts(i),this.weaponController.updateLocalDirection(this.localAimDirection);for(const t of this.weaponController.muzzles)t.updateLocalQuaternion(this.localAimQuaternion);this.weaponController.operate(this.target,i),this.weaponController.autoFire(this.target)}}qs(t){if(this.target){if(this.gunController){const t=this.target.velocity.distanceTo(this.vehicle.velocity);(0,l.u9)(this.target.body.position,this.target.body.velocity,this.worldTurretPosition,this.vehicle.body.velocity,Math.max(this.gunController.bulletSpeed,2*t),this.worldTargetPosition)}else this.worldTargetPosition.copy(this.target.position);this.worldTargetPosition.sub(this.worldTurretPosition,this.relativeTargetPosition)}else this.vehicle.body.quaternion.vmult(this.localNeutralDirection,this.relativeTargetPosition);this.lerpedRelativeTargetPosition.lerp(this.relativeTargetPosition,4*t,this.lerpedRelativeTargetPosition),this.worldTargetDirection.copy(this.lerpedRelativeTargetPosition),this.targetDistance=this.worldTargetDirection.length(),this.worldTargetDirection.normalize(),this.vehicle.body.quaternion.conjugate(this.vehicle.body.invQuaternion),this.vehicle.body.invQuaternion.vmult(this.worldTargetDirection,this.localTargetDirection)}Ts(t){this.lastTurretQuaternion.copy(this.turretQuaternion),this.lastMuzzleQuaternion.copy(this.muzzleQuaternion),this.invLocalNeutralQuaternion.vmult(this.localTargetDirection,Dn);const i=Math.asin(Dn.y);this.muzzleAngle+=(0,l.QS)(i-this.muzzleAngle,this.maxMuzzleRotationSpeed*t),this.muzzleAngle=(0,l.qE)(this.muzzleAngle,this.minMuzzleAngle,this.maxMuzzleAngle),this.muzzleQuaternion.setFromAxisAngle(n.NS,this.muzzleAngle).normalize(),Dn.y=0,Dn.normalize();let s=Math.acos((0,l.qE)(n.OX.dot(Dn)))*Math.sign(-Dn.x);if(this.isFullRotation){const t=2*Math.PI*Math.sign(-s)+s;Math.abs(t-this.turretAngle)<Math.abs(s-this.turretAngle)&&(s=t)}this.turretAngle+=(0,l.QS)(s-this.turretAngle,this.maxTurretRotationSpeed*t),Math.PI<Math.abs(this.turretAngle)&&(this.turretAngle=Math.PI*Math.sign(-this.turretAngle)+this.turretAngle%Math.PI),this.isFullRotation||(this.turretAngle=(0,l.QS)(this.turretAngle,this.maxTurretAngle)),this.turretQuaternion.setFromAxisAngle(n.UP,this.turretAngle).normalize(),this.localNeutralQuaternion.mult(this.turretQuaternion,this.turretQuaternion).normalize(),this.turretQuaternion.mult(this.muzzleQuaternion,this.localAimQuaternion),this.localAimQuaternion.vmult(n.OX,this.localAimDirection)}lateUpdate(t,i,s){this.turretMesh&&(this.turretMesh.position.copy(this.localPosition),this.lastTurretQuaternion.slerp(this.turretQuaternion,s,this.turretMesh.quaternion)),this.muzzleMesh&&this.lastMuzzleQuaternion.slerp(this.muzzleQuaternion,s,this.muzzleMesh.quaternion)}}const Tn=1.5;class En extends ft.A{constructor(t,i={}){super(),this.body=t,this.vehicle=i.vehicle,this.ws(i),this.ts(i),this.Ms()}ws(t){this.maxSpeed=t.maxSpeed??100,this.minSpeed=t.minSpeed??0,this.maxForce=t.maxForce??60,this.maxThrustForce=t.maxThrustForce??this.maxForce,this.maxBrakeForce=t.maxBrakeForce??this.maxForce,this.maxTurnForce=t.maxTurnForce??this.maxForce,this.minTurnRadius=Math.max(t.minTurnRadius??0,Math.pow(this.minSpeed,2)/this.maxTurnForce),this.criticalTurnSpeed=Math.sqrt(this.maxTurnForce*this.minTurnRadius),this.maxRollRate=t.maxRollRate??3,this.followMode=!1,this.originalMaxSpeed=this.maxSpeed,this.originalMinSpeed=this.minSpeed,this.originalMaxForce=this.maxForce,this.originalMaxThrustForce=this.maxThrustForce,this.originalMaxBrakeForce=this.maxBrakeForce,this.originalMaxTurnForce=this.maxTurnForce,this.originalMinTurnRadius=this.minTurnRadius}ts(t){if(this.position=this.body.position.copy(t.position??n.VT),this.velocity=this.body.velocity.copy(t.velocity??n.VT),this.angularVelocity=this.body.angularVelocity.copy(t.angularVelocity??n.VT),this.quaternion=this.body.quaternion.copy(t.quaternion??n.zN).normalize(),this.direction=this.quaternion.vmult(n.OX).normalize(),t.direction){this.direction.copy(t.direction),this.direction.scale(this.speed,this.velocity);const i=n.OX.cross(this.direction);i.normalize();const s=Math.acos((0,l.qE)(n.OX.dot(this.direction)));this.quaternion.setFromAxisAngle(i,s)}t.speed&&this.direction.scale(this.speed,this.velocity),this.speed=this.velocity.length(),this.onGround=t.onGround??!1,this.ignoreZ=t.ignoreZ??!1,this.alignGroundForce=0}Ms(){this.desiredPosition=new a.A,this.desiredVelocity=new a.A,this.desiredDirection=new a.A,this.desiredTurnSpeed=0,this.steeringForce=new a.A,this.steeringDirection=new a.A,this.tractionForce=new a.A,this.turnForce=new a.A,this.steeringImpulse=new a.A,this.constraintImpulse=new a.A,this.composedImpulse=new a.A,this.targetPosition=new a.A,this.targetVelocity=new a.A,this.targetDirection=new a.A,this.invTargetDirection=new a.A,this.evadeAxis=new a.A(2*Math.random()-1,2*Math.random()-1,2*Math.random()-1),this.evadeDirection=new a.A(2*Math.random()-1,2*Math.random()-1,2*Math.random()-1),this.evadeAxis.normalize(),this.evadeAxisChangeTimer=10,this.ray=new wi.A({collisionFilterGroup:Ii.nq|Ii.zq,collisionFilterMask:Ii.m1}),this.raycastResult=new wt.A,this.desiredTouchGroundPosition=new a.A}enableFollowMode(){this.followMode=!0,this.maxSpeed=this.originalMaxSpeed*Tn,this.minSpeed=.5*this.originalMinSpeed,this.maxForce=this.originalMaxForce*Tn,this.maxThrustForce=this.originalMaxThrustForce*Tn,this.maxBrakeForce=this.originalMaxBrakeForce*Tn,this.maxTurnForce=this.originalMaxTurnForce*Tn,this.minTurnRadius=.5*this.originalMinTurnRadius,this.criticalTurnSpeed=Math.sqrt(this.maxTurnForce*this.minTurnRadius)}disableFollowMode(){this.followMode=!1,this.maxSpeed=this.originalMaxSpeed,this.minSpeed=this.originalMinSpeed,this.maxForce=this.originalMaxForce,this.maxThrustForce=this.originalMaxThrustForce,this.maxBrakeForce=this.originalMaxBrakeForce,this.maxTurnForce=this.originalMaxTurnForce,this.minTurnRadius=this.originalMinTurnRadius,this.criticalTurnSpeed=Math.sqrt(this.maxTurnForce*this.minTurnRadius)}seek(t,i,s){this.updateSeekVelocity(t,i,s),this.Es(s)}seekOnPlane(t,i,s,e,h){{const i=t.sub(s),n=e.scale(e.dot(i));i.sub(n).add(s,this.targetPosition)}{const t=this.quaternion.vmult(n.OX).normalize(),s=e.scale(e.dot(t)),h=t.sub(s);h.normalize();const o=e.scale(e.dot(i)),r=i.sub(o),a=r.length(),c=h.dot(r);r.sub(h.scale(c),r);const l=Math.max(c,0);r.add(h.scale(l),r),r.normalize(),r.scale(a,r),r.add(o,this.targetVelocity)}this.updateSeekVelocity(this.targetPosition,this.targetVelocity,h),this.Es(h)}updateSeekVelocity(t,i,s){this.targetPosition.copy(t),this.targetVelocity.copy(i),this.targetPosition.sub(this.position,this.desiredVelocity),this.vehicle?.onGround&&(this.desiredVelocity.y=0,this.targetVelocity.y=0);const n=this.desiredVelocity.length();this.desiredVelocity.normalize();const e=.9*this.maxBrakeForce,h=e*(e?Math.sqrt(2*n/e):0);this.desiredVelocity.scale(h,this.desiredVelocity),(0,l.Gk)(this.desiredVelocity,n/e/s,this.desiredVelocity),this.desiredVelocity.add(this.targetVelocity,this.desiredVelocity)}flee(t,i,s){this.targetPosition.copy(t),this.targetVelocity.copy(i),this.position.sub(this.targetPosition,this.desiredVelocity),this.desiredVelocity.normalize(),this.desiredVelocity.scale(this.maxSpeed,this.desiredVelocity),this.desiredVelocity.sub(this.targetVelocity,this.desiredVelocity),this.vehicle&&(this.desiredVelocity.y=0,this.desiredVelocity.normalize(),this.vehicle.onGround||(this.desiredVelocity.y=Math.tan(15*l.up),this.desiredVelocity.normalize()),this.desiredVelocity.scale(this.maxSpeed,this.desiredVelocity)),this.Es(s)}evade(t){this.evadeAxisChangeTimer-=t,this.evadeAxisChangeTimer<=0&&(this.evadeAxis.set(2*Math.random()-1,2*Math.random()-1,2*Math.random()-1).normalize(),this.evadeAxisChangeTimer=5+10*Math.random()),this.quaternion.vmult(n.OX,this.direction).normalize(),this.direction.cross(this.evadeAxis,this.evadeDirection),this.vehicle?.onGround&&(this.evadeDirection.y=0),this.evadeDirection.normalize(),this.quaternion.vmult(n.OX,this.desiredVelocity).normalize(),this.desiredVelocity.scale(this.maxSpeed,this.desiredVelocity);const i=Math.max(this.minSpeed,.5*this.maxSpeed);this.evadeDirection.scale(i,this.evadeDirection),this.desiredVelocity.add(this.evadeDirection,this.desiredVelocity),this.Es(t)}standby(t){this.desiredVelocity.setZero(),this.Es(t)}}const Cn=new a.A(0,1e4,0),bn=new a.A(0,-1e4,0),Un=new a.A(0,-10,0),Nn=new a.A,Rn=new a.A,In=new a.A,zn=new r.A,Ln=new a.A,Fn=new a.A,On=(new a.A,new a.A,new a.A,new a.A,new r.A),Vn=new a.A,kn=(new r.A,new a.A),Gn=new a.A;new a.A;class Bn extends En{constructor(t,i={}){super(t,i)}Es(t){this.vehicle&&!this.vehicle.isTakingoff&&(this.Cs(),this.vehicle.onGround||this.bs()),this.Us(t),this.vehicle&&(this.vehicle?.onGround?this.Ns():this.Rs(t))}bs(){this.constraintImpulse.setZero();const t=Math.max(this.position.y-100,0),i=Math.min(this.maxBrakeForce,this.maxTurnForce);let s=0;{const n=-Math.sqrt(2*i*t)-this.velocity.y;s=Math.max(n,s)}const n=t/this.minTurnRadius;if(n<1){const t=Math.max(n,0),i=-this.criticalTurnSpeed*t-this.velocity.y;s=Math.max(i,s)}{const t=100-this.position.y;s=Math.max(t,s)}this.desiredVelocity.y+=10*s}Us(t){this.quaternion.vmult(n.OX,Ln).normalize(),this.desiredVelocity.unit(Fn);const i=Ln.dot(this.velocity);Ln.cross(Fn,In).normalize();const s=Math.acos((0,l.qE)(Ln.dot(Fn))),e=Math.min(s/t,this.maxTurnForce),h=Math.sqrt(e*this.minTurnRadius);let o=Ln.dot(this.desiredVelocity);o=Math.max(o,h),o=Math.min(o,this.desiredVelocity.length()),o<1&&(o=0);const r=this.maxThrustForce*t,a=this.maxBrakeForce*t,c=(0,l.qE)(o-i,-a,r),u=(0,l.qE)(i+c,this.minSpeed,this.maxSpeed);if(0<i){const n=Math.min(this.maxTurnForce/i,i/this.minTurnRadius)*t,e=(0,l.qE)(s,-n,n);zn.setFromAxisAngle(In,e).normalize(),zn.mult(this.quaternion,this.quaternion).normalize(),In.cross(Ln,this.turnForce).normalize(),this.turnForce.scale(e/t*i,this.turnForce)}this.quaternion.vmult(n.OX,this.velocity),this.velocity.scale(u,this.velocity)}setMinSpeed(t){this.originalMinSpeed=t,this.minSpeed=this.originalMinSpeed*(this.followMode?1.2:1)}Cs(){this.vehicle&&this.vehicle.game.getAllVehicles().forEach(t=>{if(this.vehicle===t||!this.Is(t))return;this.position.sub(t.body.position,Nn);const i=Nn.length();if(Nn.normalize(),this.Is(t))Nn.scale(100*Math.exp(.01*-i),Rn),this.desiredVelocity.add(Rn,this.desiredVelocity);else{const t=1-(0,l.J$)(i/50),s=100*Math.pow(t*t);Nn.scale(s,Rn),this.desiredVelocity.add(Rn,this.desiredVelocity)}})}Is(t){return!this.vehicle.isTakingoff&&(this.vehicle.leader!==t&&(t.leader!==this.vehicle&&t.leader!==this.vehicle.leader))}Ns(){if(!this.vehicle)return;if(this.position.add(Cn,this.ray.start),this.position.add(bn,this.ray.end),this.ray.updateDirectionAndLength(),this.ray.intersectsWorld(this.vehicle.game.world,this.raycastResult),!this.raycastResult.hasHit)return;const t=this.raycastResult.hitPoint.y+this.vehicle.groundOffset*n.UP.dot(this.raycastResult.hitNormal)-this.position.y;this.alignGroundForce+=(1-Math.exp(-Math.abs(t)))*Math.sign(t)*100,this.alignGroundForce*=.5,this.velocity.y=this.alignGroundForce,this.quaternion.vmult(n.UP,Vn).normalize(),Vn.cross(this.raycastResult.hitNormal,In).normalize();const i=Math.acos((0,l.qE)(Vn.dot(this.raycastResult.hitNormal)));zn.setFromAxisAngle(In,i).normalize(),zn.mult(this.quaternion,this.quaternion).normalize()}Rs(t){if(this.quaternion.conjugate(On),On.vmult(n.UP,kn).scale(10,kn),On.vmult(this.turnForce,Gn),kn.add(Gn,kn),kn.z=0,kn.normalize(),n.UP.cross(kn,In).normalize(),In.isZero())return;const i=(0,l.qE)(Math.acos((0,l.qE)(n.UP.dot(kn))),-this.maxRollRate*t,this.maxRollRate*t);zn.setFromAxisAngle(In,i).normalize(),this.quaternion.mult(zn,this.quaternion).normalize()}ragdoll(t){this.zs(),this.vehicle?.onGround?(this.velocity.y=0,this.velocity.scale(Math.pow(.5,t),this.velocity),this.angularVelocity.scale(Math.pow(.5,t),this.angularVelocity),this.Ns()):this.Fs(t)}zs(){this.quaternion.vmult(n.OX,this.direction),this.ignoreZ&&(this.direction.z=0),this.vehicle?.onGround&&(this.direction.y=0),this.direction.normalize(),this.vehicle?.onGround&&(this.velocity.y=0,this.desiredVelocity.y=0),this.speed=this.velocity.length(),this.direction.scale(this.speed,this.velocity),this.desiredDirection.copy(this.desiredVelocity),this.desiredDirection.normalize()}Fs(t){this.velocity.scale(Math.pow(.95,t),this.velocity);const i=this.direction.scale(this.direction.dot(Un)),s=Un.sub(i);this.velocity.add(Un.scale(t),this.velocity),this.velocity.isZero()||(this.direction.cross(s,this.angularVelocity),this.angularVelocity.normalize(),this.angularVelocity.scale(s.length()/this.velocity.length(),this.angularVelocity))}}const Hn=new r.A,jn=new a.A,Wn=new a.A,$n=(new a.A,new a.A),Xn=(new a.A,new a.A),Zn=new a.A,Yn=new a.A,Kn=new a.A,Jn=new r.A,Qn=new r.A,te=new P.A(15,7.5,0,0),ie=new P.A(.02,.02,.02,1),se=new P.A(.02,.02,.02,0);class ne extends ft.A{constructor(t,i,s){super(),this.isVehicle=!0,this.props=t,this.mesh=i??new R.A,this.collider=s??i,this.ts(t),this.ws(t),this.Ms(t),this.Os(t),this.ks(t),this.Gs(t),this.Bs(t)}ts(t){this.type="vehicle",this.id=t.id??(0,l.lk)(),this.name=t.name??"Unknown",this.callsign=t.callsign??"",this.iff=t.iff??Ii.Ab.OTHER,this.leader=t.leader,this.wingmen=t.wingmen??[],this.formationPosition=(new a.A).copy(t.formationPosition??n.VT),this.formationPositionWorld=new a.A,this.isFollowingLeader=!1,this.onGround=t.onGround??!0,this.target=null,this.canIntercept=t.intercept??t.canIntercept??!1,this.canAttack=t.attack??t.canAttack??!1,this.canWander=t.wander??t.canWander??!1,this.path=null,this.destroyed=!1,this.exploded=!1,this.timeToExplode=-1,this.lastHitter=null,this.externalCameraPosition=(new a.A).copy(t.cameraPosition??n.VT),this.cockpitCameraPosition=(new a.A).copy(t.cockpitCameraPosition??n.VT),this.isLocked=!1,this.isSeeked=!1,this.bodyRadius=t.bodyRadius??10,this.nuclei=t.nuclei??[{position:new a.A,radius:this.bodyRadius}],this.ray=new wi.A({collisionFilterGroup:Ii.N7.VEHICLE,collisionFilterMask:Ii.N7.TERRAIN}),this.raycastResult=new wt.A,this.Hs=-1,this.js=(new a.A).copy(n.OX),this.Ws=(new a.A).copy(n.OX)}ws(t){this.detectionRange=t.detectionDistance??1/0,this.maxHealth=this.$s(t),this.health=this.maxHealth,this.score=t.score??100+10*Math.floor(.25*(this.health-100)/10),this.maxSpeed=t.maxSpeed??300,this.minSpeed=t.minSpeed??0,this.maxForce=t.maxForce??30,this.maxThrustForce=t.maxThrustForce??this.maxForce,this.maxBrakeForce=t.maxBrakeForce??this.maxForce,this.maxTurnForce=t.maxTurnForce??this.maxForce,this.minTurnRadius=t.minTurnRadius??0,this.groundOffset=t.groundOffset??0}$s(t){return t.health??100}Ms(){this.flameSource=0,this.flameOxegen=0,this.flameThreshould=1,this.chasingTarget=null}Os(t){let i;switch(t.bodyType){case n.hf:i=(0,l.bk)(this.collider);break;case n.Rk:throw new Error;default:i=new Qi.A({radius:this.bodyRadius})}this.body=new mt.A({type:mi.eS,shape:i,angularDamping:0,linearDamping:0,collisionFilterGroup:Ii.N7.VEHICLE|this.iff<<8,collisionFilterMask:Ii.N7.WEAPON,isTrigger:!0}),this.body.actor=this,this.referBodyTransforms(),t.rotation&&this.body.quaternion.setFromEuler(t.rotation.x*l.up,t.rotation.y*l.up,t.rotation.z*l.up,n.KI)}ks(t){this.movementManager=new Bn(this.body,{minSpeed:this.minSpeed,maxSpeed:this.maxSpeed,maxForce:this.maxForce,maxTractionForce:this.maxTractionForce,maxThrustForce:this.maxThrustForce,maxBrakeForce:this.maxBrakeForce,maxTurnForce:this.maxTurnForce,minTurnRadius:this.minTurnRadius,onGround:this.onGround,body:this.body,vehicle:this}),this.add(this.movementManager)}referBodyTransforms(){this.position=this.body.position,this.quaternion=this.body.quaternion,this.velocity=this.body.velocity}Bs(t){if(this.animations=[],this.Xs(this.mesh),t.animations)for(const i of t.animations){const t=this.Ds(this.mesh,i.mesh);t&&this.animations.push({mesh:t,jointType:i.jointType,axis:new a.A(i.axis.x,i.axis.y,i.axis.z).normalize(),initialPosition:t.position.clone(),initialQuaternion:t.quaternion.clone(),maxAngle:i.maxAngle,minAngle:i.minAngle,input:i.input,inverse:i.inverse})}}Xs(t){t.initialPosition=t.position.clone(),t.initialQuaternion=t.quaternion.clone();for(const i of t.children)this.Xs(i)}Ds(t,i){if(t.name===i)return t;for(const s of t.children){const t=this.Ds(s,i);if(t)return t}return null}Gs(t){if(this.weapons=[],t.weapons)for(const i of t.weapons??{}){if(!1===i.enabled||!0===i.disabled)continue;const t=this.Zs(i);t&&(t.isGunController&&(this.gunController=t,this.gunFireInterval=.5,this.gunFireTimer=this.gunFireInterval+Math.random()*this.gunFireInterval),t.isMissileController&&(this.missileController=t,this.missileFireInterval=10,this.missileFireTimer=.5*this.missileFireInterval+Math.random()*this.missileFireInterval),t.isBombController&&(this.bombController=t),this.weapons.push(t),this.add(t))}}Zs(t){switch(t.type){case"gun":return new un(this,t);case"missile":return new Ls(this,t);case"bomb":return new Zs(this,{...t,bombingTarget:this.bombingTarget});case"turret":case"turret-a":case"turret-b":return new qn(this,t);default:throw new Error(`No weapon found: ${props.type}`)}}update(t,i){this.isLocked=!1,this.isSeeked=!1}fixedUpdate(t,i){this.destroyed?this.Ys(t,i):this.Ks(t,i)}Ys(t,i){const s=.5*this.bodyRadius;this.flame||(this.flame=new Gt({radius:s,initialRadius:.5*s,initialColor:se,finalColor:ie,initialEmissive:te,finalEmissive:new P.A(0,0,0,0),maxInstances:100,liftForce:Math.sqrt(s),density:n.L2,radiusTimeScale:n.iE,eraseTimeScale:n.eJ}),this.game.add(this.flame)),this.flameOxegen+=(.1*this.body.velocity.length()+16)/Math.sqrt(s)*i,this.flameThreshould<=Math.max(this.flameSource,this.flameOxegen)&&(this.flame.add({position:this.body.previousPosition,velocity:this.onGround?this.body.velocity.add(n.UP.scale(10)):this.body.velocity}),this.flameOxegen=0,this.flameSource=0),this.movementManager.ragdoll(i),this.ray.intersectsWorldAlt(this.game.world,this.body.previousPosition,this.body.position,this.raycastResult),this.raycastResult.hasHit&&(this.explode(),this.applyDamageRaycast(this.raycastResult,1/0,this),this.raycastResult.hitBody.actor?.applyDamageRaycast&&this.raycastResult.hitBody.actor.applyDamageRaycast(this.raycastResult,50*this.bodyRadius,this)),this.timeToExplode-=i,this.destroyed&&this.timeToExplode<=0&&this.explode()}Ks(t,i){this.canIntercept&&this.Js(t),this.leader&&this.leader.health<=0&&(this.leader=null),this.Es(i),this.Qs(i)}Es(t){this.leader?(this.movementManager.enableFollowMode(),this.tn(t)):this.target?(this.movementManager.disableFollowMode(),this.sn(t)):(this.movementManager.disableFollowMode(),this.movementManager.standby(t))}tn(t){return this.updateFormationPositionWorld(),this.movementManager.seek(this.formationPositionWorld,this.leader.velocity,t)}updateFormationPositionWorld(){if(this.canIntercept)this.leader.quaternion.vmult(this.formationPosition,this.formationPositionWorld),this.leader.position.add(this.formationPositionWorld,this.formationPositionWorld);else{this.leader.quaternion.vmult(n.OX,jn).normalize();Math.acos(jn.y);jn.y=0,jn.normalize(),n.OX.cross(jn,Kn).normalize();const t=Math.acos((0,l.qE)(n.OX.dot(jn)));Jn.setFromAxisAngle(Kn,t).normalize(),Jn.vmult(this.formationPosition,this.formationPositionWorld),this.leader.position.add(this.formationPositionWorld,this.formationPositionWorld)}}sn(t){const i=this.target.body.position,s=this.target.body.velocity,e=s.length();i.sub(this.body.position,Wn).normalize(),this.Hs=this.body.position.distanceTo(i);const h=this.nn(i),o=this.en(i);if(this.Hs<.5*this.minTurnRadius&&e<.5*this.movementManager.criticalTurnSpeed&&o?this.hasToFlee=!0:(2*this.minTurnRadius<this.Hs||2*this.movementManager.criticalTurnSpeed<e||h)&&(this.hasToFlee=!1),this.hasToFlee)this.movementManager.flee(i,s,t);else if(o)this.movementManager.evade(t);else if(this.gunController){const e=s.distanceTo(this.body.velocity);(0,l.u9)(i,s,this.body.position,this.body.velocity,Math.max(this.gunController.bulletSpeed,2*e),$n),$n.sub(this.body.position,this.js).normalize(),$n.add(this.js.scale(-100,Xn),Xn),this.js.scale(Math.max(this.target.body.velocity.dot(this.js),0),Zn),this.movementManager.seek(Xn,Zn,t),this.quaternion.vmult(n.OX,this.Ws).normalize()}else this.body.position.add(Wn.scale(this.Hs-100,Xn),Xn),this.movementManager.seek(Xn,s,t)}nn(t){return t.sub(this.body.position,Yn),this.body.quaternion.conjugate(Qn).vmult(Yn,Yn),Yn.normalize(),Math.acos(-Yn.z)<(0,l.tR)(45)}en(t){return t.sub(this.body.position,Yn),this.body.quaternion.conjugate(Qn).vmult(Yn,Yn),Yn.normalize(),Math.acos(Yn.z)<30*n.vT}Js(t){this.target&&this.target.health<=0&&(this.target=null);let i=this.detectionRange;this.game.getAllVehicles().forEach((t,s)=>{if(!t.iff||t.iff==this.iff||t.health<=0)return;const n=this.body.position.distanceTo(t.body.position);n<=this.detectionRange&&n<i&&(this.target=t,i=n)})}destroy(t={}){this.destroyed||(this.lastHitter?.isPlayerAircraft&&(this.game.addScore(this.score),this.game.enemiesDown++,this.game.credits+=this.score,this.scene.hud.showPointInfo(`DESTROYED +${this.score}`,1)),this.onGround||(this.body.collisionFilterMask|=Ii.xv|Ii.m1),this.hn(t),this.timeToExplode=(.5*Math.random()+.5)*this.getExplodeTime(),this.destroyed=!0)}explode(){if(!this.exploded){for(const t of this.nuclei){const i=t.position.clone();this.body.quaternion.vmult(i,i),i.add(this.body.position,i);const s=(new a.A).copy(n.VT),e=this.body.velocity.clone();this.ray.start.copy(i),this.ray.start.y+=this.bodyRadius,this.ray.end.copy(i),this.ray.end.y-=this.bodyRadius,this.ray.updateDirectionAndLength(),this.ray.intersectsWorld(this.game.world,this.raycastResult),this.raycastResult.hasHit&&(i.copy(this.raycastResult.hitPoint),s.y=1,e.y=0);const h=1.5*t.radius*Math.SQRT2,o=new ai(i,{radius:h,normal:s,velocity:e,audios:[new Ji(i,e,n.L7*h),new Ki(i,e,n.L7*h)]});this.game.add(o)}this.game.removeVehicle(this),this.exploded=!0}}lateUpdate(t,i,s){this.body&&this.mesh&&(this.body.previousPosition.lerp(this.body.position,s,this.mesh.position),this.body.previousQuaternion.slerp(this.body.quaternion,s,this.mesh.quaternion),this.body.previousVelocity.lerp(this.body.velocity,s,this.body.interpolatedVelocity)),this.mesh.visible=this.game.mainCamera.vehicle!==this||this.game.mainCamera.view!==ns,this.rn(s)}onRemoved(){super.onRemoved(),this.flame&&(this.flame.isEmitterRemoved=!0)}hn(t){for(const i of this.nuclei){const s=new a.A;s.copy(i.position),this.body.quaternion.vmult(s,s),s.add(this.body.position,s);const e=t.scale??1,h=1.5*i.radius*e,o=new ai(s,{radius:h,normal:t.normal??new a.A(0,this.onGround?1:0,0),velocity:this.body.velocity,audios:[new Ji(s,this.body.velocity,n.L7*h),new Ki(s,this.body.velocity,n.L7*h)]});this.game.add(o)}}rn(t){for(const t of this.animations)t.mesh.position.copy(t.initialPosition),t.mesh.quaternion.copy(t.initialQuaternion);for(const i of this.animations){let s=0;switch(i.input){case"gear":s=(0,l.Cc)(this.lastGear,this.gear,t);break;case"throttle":s=(0,l.Cc)(this.lastThrottle,this.throttle,t);break;case"aileron":s=.5*(0,l.Cc)(this.lastAileron,this.aileron,t)+.5;break;case"elevator":s=.5*(0,l.Cc)(this.lastElevator,this.elevator,t)+.5;break;case"rudder":case"steering":s=.5*(0,l.Cc)(this.lastRudder,this.rudder,t)+.5;break;case"missile":s=this.weaponsBayAlpha;break;default:throw new Error(`The target input is not supported: ${i.input}`)}switch(i.jointType){case"hinge":const t=i.maxAngle-i.minAngle,n=i.inverse?i.maxAngle-t*s:i.minAngle+t*s;Hn.setFromAxisAngle(i.axis,n),Hn.normalize(),i.mesh.quaternion.mult(Hn,i.mesh.quaternion),i.mesh.quaternion.normalize();break;case"slide":break;default:throw new Error(`The target joint is not supported: ${component.joint}`)}}}Qs(t){if(!this.target)return;this.body.quaternion.vmult(n.OX,jn),this.target.body.position.sub(this.body.position,Wn);const i=Wn.length();Wn.normalize();const s=Math.acos((0,l.qE)(jn.dot(Wn)));this.gunController&&this.an(i,s,t),this.missileController&&this.cn(i,s,t)}an(t,i,s){this.gunController.operate(this.target,s),this.gunController.autoFire(this.target)}cn(t,i,s){this.missileController.operate(this.target,s),this.missileController.autoFire(this.target)}clone(t={}){return new ne(t,this.mesh.clone(),this.model,this.colliderModel)}getIFF(){return this.iff}applyDamage(t,i){this.lastHitter=i,this.lastHitter?.isPlayerAircraft&&0<this.health&&(this.scene.addScore(t),this.scene.hud.showPointInfo("HIT!",0)),this.health-=t,this.ln(),this.game.vehicleCamera.vehicle===this&&this.game.vehicleCamera.shakeCamera()}ln(){this.health<=0&&!this.destroyed&&this.destroy(),this.health<=-2*this.maxHealth&&!this.exploded&&this.explode()}applyDamageRaycast(t,i,s,n=!0){this.applyDamage(i,s)}getGunController(){return this.gunController}getMissileController(){return this.missileController}getTarget(){return this.target}setTransform(t){this.position.copy(t.position),this.quaternion.copy(t.quaternion)}getExplodeTime(){return 30}}function ee(t,i){const s=structuredClone(i);for(const i in t)"id"!=i&&"player"!=i&&"wingmen"!=i&&"callsign"!=i&&"wiingmen"!=i&&null==s[i]&&(s[i]=t[i]);return s}const he="burst-missile",oe="tactical-laser",re={"burst-missile":{label:"Burst Missile",description:"A guided missile that explodes near the target.\nDeals damage to the target and surrounding enemies.",cost:1e3,iconPath:""},"tactical-laser":{label:"Tactical Laser",description:"Fires a high-power laser at the front of the aircraft.\nAlthough its difficult to aim, it deals large damage to a distant target.",cost:2e3,iconPath:""},"escort-drone":{label:"Escort Drone",description:"A small AI-controlled aircraft that flies alongside the player.\nProvides joint attacks on targets and defend against enemies.",cost:3e3,iconPath:""},"4-mssl":{label:"4-MSSL",description:"(description)",cost:3e3,iconPath:""}};class ae{constructor(t={}){this.config=t,this.id=t.id??(0,l.lk)(),this.active=!1,this.nextEvents=this.config.nextEvents??[],this.skippable=this.config.skippable??!1,this.config.onWakeUp&&(this.onWakeUp=this.config.onWakeUp),this.config.onCompleted&&(this.onCompleted=this.config.onCompleted),this.game=null,this.eventManager=null}update(t,i,s){return this.skippable&&t.playerController.skip&&!s}}class ce extends ae{constructor(t){super(t)}update(t,i){return t.missionComplete=!0,!0}}class le extends ae{constructor(t){super(t)}update(t,i,s){return t.missionFailure=!0,!0}}class ue extends ae{constructor(t){super(t),this.targets=t.targets?t.targets:[]}update(t,i){for(const i of this.targets){const s=t.getVehicleById(i);if(s&&!s.destroyed)return!1}return!0}}class fe extends ae{constructor(t){super(t),this.spawnProps=this.config.vehicles}update(t,i){for(const i of this.spawnProps)t.addVehicle(i);return!0}}class de extends ae{constructor(t){super(t),this.time=t.time}update(t,i){return this.time-=i,this.time<=0}}class ve extends ft.A{constructor(){super(),this.events=new Map,this.active=!1}init(t){this.events=new Map;for(const i of t){if(!i.id)throw new Error(`Event id not set: ${i}`);if(!i.type)throw new Error(`Event type not set: ${i}`);switch(i.type){case"spawn":this.events.set(i.id,new fe(i));break;case"on-destroy":this.events.set(i.id,new ue(i));break;case"on-timeout":this.events.set(i.id,new de(i));break;case"mission-complete":this.events.set(i.id,new ce(i));break;case"mission-failure":case"takeoff":case"landing":this.events.set(i.id,new le(i));break;default:throw new Error(`Unsupported event type: ${i.type}`)}}}addSequentialEvent(t){t.id=this.nextEventId,this.nextEventId=(0,l.lk)(),t.eventManager=this,t.game=this.game,t.nextEvents=[this.nextEventId],this.events.set(t.id,t)}addSingleEvent(t){t.eventManager=this,t.game=this.game,t.id=(0,l.lk)(),this.events.set(t.id,t),this.un(this.game,[t.id])}removeSingleEvent(t){this.events.delete(t.id)}start(){this.active=!0,this.un(this.game,[this.initialEventId])}reset(){this.events.clear()}fixedUpdate(t,i){if(this.active)for(const s of this.events.values())s.active&&s.update(t,i,!1)&&(s.active=!1,s.onCompleted&&s.onCompleted(t),this.un(t,s.nextEvents))}un(t,i){for(const s of i){const i=this.events.get(s);i&&!i.active&&(i.onWakeUp&&i.onWakeUp(t),i.update(t,0,!0)?(i.active=!1,i.onCompleted&&i.onCompleted(t),this.un(t,i.nextEvents)):i.active=!0)}}removeAllEvents(){this.events.forEach((t,i)=>{this.removeEventById(i)})}removeEventById(t){this.events.delete(t)}removeAllVehicles(){this.spawnedVehicles.forEach((t,i)=>{this.removeVehicleById(i)})}}class me extends ae{constructor(t){super(t),this.target=t.target,this.runway=t.runway,this.isLandingCompleted=!1,this.nextEventFireTimer=3}update(t,i){if(t.isMissionCompleted)return!1;const s=t.getVehicleById(this.target);if(!s)return!1;if(this.isLandingCompleted){if(this.nextEventFireTimer-=i,this.nextEventFireTimer<=0)return!0}else s.onGround&&s.velocity.length()<=1&&s.position.distanceTo(this.runway.center)<this.runway.length&&(this.isLandingCompleted=!0,t.inform("LANDING SUCCESS"));return!1}}class we extends ae{constructor(t={}){super(t)}update(t,i){return t.spawnPlayer(),!0}}class pe extends ae{constructor(t){super(t),this.completed=!1}onWakeUp(t,i){if(t.isMissionCompleted)return!1;t.resupply(()=>{this.completed=!0})}update(t,i){return this.completed}}class ge extends ae{constructor(t){super(t),this.survival=this.game,this.timeElapsed=0,this.labelShowed=!1}onWakeUp(t,i){this.survival.missionComplete()}update(t,i){return!0}}class xe extends Zi.Ay{constructor(){super(Xi.A.MUSIC_1),this.type=Zi.bz}}class Me extends Zi.Ay{constructor(){super(Xi.A.MUSIC_2),this.type=Zi.bz}}class Se extends Zi.Ay{constructor(){super(Xi.A.MUSIC_3),this.type=Zi.bz}}const ye=Math.PI,_e=new a.A,Pe=new a.A;class Ae extends c.A{constructor(t,i){super(i),this.playerController=t,this.ray=new wi.A({collisionFilterMask:Ii.m1}),this.raycastResult=new wt.A,this.verticalLookAngle=0,this.horizontalLookAngle=0}lateUpdate(t,i,s){super.lateUpdate(t,i,s),this.game.mainCamera===this&&this.updateFreeCamera(i)}updateFreeCamera(t){this.quaternion.vmult(n.OX,_e).normalize();let i=Math.atan2(-_e.x,-_e.z),s=Math.asin(_e.y);s+=this.playerController.rotateVertical*ye*t,i+=this.playerController.rotateHorizontal*ye*-1*t,this.quaternion.setFromEuler(s,i,0,"YXZ").normalize();let e=300;e=(0,l.Cc)(e,3e3,this.playerController.increaseMoveSpeed),e=(0,l.Cc)(e,30,this.playerController.decreaseMoveSpeed),Pe.copy(_e),Pe.y=0,Pe.normalize(),this.position.x+=Pe.x*this.playerController.moveFrontAndBack*e*t,this.position.x-=Pe.z*this.playerController.moveRightAndLeft*e*t,this.position.z+=Pe.z*this.playerController.moveFrontAndBack*e*t,this.position.z-=-Pe.x*this.playerController.moveRightAndLeft*e*t,this.position.y+=this.playerController.moveUpAndDown*e*t,this.fn()}fn(){this.ray.start.copy(this.position),this.ray.start.y+=2e4,this.ray.end.copy(this.position),this.ray.end.y-=2e4,this.ray.updateDirectionAndLength(),this.ray.intersectsWorld(this.game.world,this.raycastResult),this.raycastResult.hasHit&&(this.position.y=Math.max(this.position.y,this.raycastResult.hitPoint.y+.5))}}class De extends c.A{constructor(t){super(t),this.centerPosition=(new a.A).copy(t.centerPosition??n.VT),this.distance=t.distance??100,this.horizontalAngle=t.horizontalAngle??0,this.verticalAngle=t.verticalAngle??0,this.lastHorizontalAngle=this.horizontalAngle,this.lastVerticalAngle=this.verticalAngle,this.enablePan=t.enablePan??!1,this.panSpeed=t.panSpeed??1}fixedUpdate(t,i){this.lastHorizontalAngle=this.horizontalAngle,this.lastVerticalAngle=this.verticalAngle,this.enablePan&&(this.horizontalAngle+=this.panSpeed*i)}lateUpdate(t,i,s){const n=(0,l.Cc)(this.lastHorizontalAngle,this.horizontalAngle,s),e=(0,l.Cc)(this.lastVerticalAngle,this.verticalAngle,s);this.position.set(Math.cos(e)*Math.sin(n),Math.sin(e),Math.cos(e)*Math.cos(n)).normalize(),this.position.scale(this.distance,this.position),this.position.add(this.centerPosition,this.position),this.quaternion.setFromEuler(-e,n,0,"YXZ")}getTarget(){return null}}const qe=WebGL2RenderingContext;class Te extends _t.A{constructor(t={}){super(t),this.isTexture3D=!0,this.target=qe.TEXTURE_3D,this.wrapR=t.wrapR??qe.REPEAT,this.layers=t.depth??t.layers??1}}class Ee extends gi.A{constructor(t={}){super(t),this.isFramebuffer3D=!0,this.depth=t.depth??t.layer,this.currentLayer=0,this.maxLayer=t.depth??t.layer??1}et(t){this.textures=[];for(let i=0;i<(t.count??1);i++)this.textures.push(new Te(t));this.texture=this.textures[0]}}var Ce=s(2036);class be extends St.Ay{constructor(){super(),this.name="AirealScatteringMaterial"}getVertSource(){return"#version 300 es\n\n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec2 uv;\n\n            out vec2 vUv;\n\n            void main(void) {\n                vUv = uv;\n                gl_Position = vec4(position, 1.0);\n            }\n        "}getFragSource(){return`#version 300 es\n        \n            precision mediump float;\n\n            ${yt.mz}\n            \n            ${yt.AH}\n\n            const int NUM_AERIAL_STEPS = 8;\n            const float INV_NUM_AERIAL_STEPS = 1.0 / float(NUM_AERIAL_STEPS);\n                        \n            void integrateAirealScattering(\n                    vec3 fragPosition,\n                    vec3 cameraPosition,\n                    out vec3 totalInScatter,\n                    out vec3 transmittance) {\n                vec3 viewDirection = fragPosition - cameraPosition;\n                float fragDistance = length(viewDirection);\n                viewDirection = normalize(viewDirection);\n\n                float sampleLength = fragDistance * INV_NUM_AERIAL_STEPS;\n                float scaledLength = sampleLength;\n            \n                vec3 sampleRay = normalize(viewDirection) * sampleLength;\n                vec3 samplePoint = cameraPosition + sampleRay * 0.5;\n\n                totalInScatter = vec3(0.0);\n                transmittance = vec3(1.0);\n            \n                for (int i = 0; i < NUM_AERIAL_STEPS; i++) {\n                    float sampleHeight = samplePoint.y;\n            \n                    MediumProfile medium = sampleMedium(sampleHeight);\n            \n                    vec3 sampleTransmittance = exp(-medium.extinction * scaledLength);\n                    vec3 sampleScattering = (medium.scattering / medium.extinction) * (1.0 - sampleTransmittance);\n            \n                    vec4 sunTransmittance = getTransmittance(atmosphereProfile.sunDirection.y, sampleHeight);\n                    vec3 sunIrradianceReached = atmosphereProfile.sunIrradiance * sunTransmittance.rgb * sunTransmittance.a;\n                    totalInScatter += sunIrradianceReached * sampleScattering * transmittance / (4.0 * PI);\n            \n                    vec3 multipleScattering = getIncattering(atmosphereProfile.sunDirection.y, sampleHeight);\n                    totalInScatter += sampleScattering * multipleScattering * transmittance;\n            \n                    transmittance *= sampleTransmittance;\n                    samplePoint += sampleRay;\n                }\n            }\n            \n            uniform float distance;\n\n            in vec2 vUv;\n\n            layout(location = 0) out vec4 gInScattering;\n            layout(location = 1) out vec4 gTransmittance;\n\n            void main() {\n                vec2 uv = vec2(vUv.x, vUv.y - atmosphereProfile.invTextureResolution3D.y * 0.5);\n                vec2 angleAndHeight = getAngleAndHeight(uv);\n\n                vec3 cameraPosition = vec3(0.0, angleAndHeight.y, 0.0);\n\n                float cosTheta = angleAndHeight.x;\n                vec3 viewDirection = vec3(sqrt(1.0 - cosTheta * cosTheta), cosTheta, 0.0);\n                vec3 fragPosition = cameraPosition + viewDirection * distance;\n\n                vec3 inScattering = vec3(0.0);\n                vec3 transmittance = vec3(1.0);\n                integrateAirealScattering(fragPosition, cameraPosition, inScattering, transmittance);\n                \n                gInScattering.rgb = inScattering;\n                gInScattering.a = 1.0;\n                \n                gTransmittance.rgb = transmittance;\n                gTransmittance.a = 1.0;\n            }\n        `}getUniforms(){return{atmosphereProfile:{},distance:0}}}class Ue{constructor(t={}){this.innerRadius=t.innerRadius??6360,this.outerRadius=t.outerRadius??6460,this.scale=1/(this.outerRadius-this.innerRadius),this.rayleighIntensity=t.rayleighIntensity??1,this.mieIntensity=t.mieIntensity??.5,this.rayleighScaleHeight=t.rayleighScaleHeight??12,this.mieScaleHeight=t.mieScaleHeight??8,this.sunIrradiance=new a.A(1,1,1).scale(12),t.sunIntensity&&this.sunIrradiance.copy(t.sunIntensity),this.sunDirection=new a.A(1,1,1),t.sunDirection&&this.sunDirection.copy(t.sunDirection),this.sunDirection.normalize(),this.starIntensity=t.starIntensity??.03,this.sunAngularRadius=t.sunAngularRadius??.004675,this.groundAlbedo=new a.A(.2,.3,.4).scale(1),t.groundAlbedo&&this.groundAlbedo.copy(t.groundAlbedo),this.transmittanceTexture=null,this.multipleScatteringTexture=null,this.averageColorTexture=null,this.irradianceTexture=null,this.environmentTexture=null,this.atmosphereTexture=null,this.airealInScatteringTexture=null,this.airealTransmittanceTexture=null,this.invTextureResolution3D=new a.A,this.maxMipLevel=-1}setToMaterialUniforms(t){const i=t.uniforms?.atmosphereProfile;i&&(i.innerRadius=this.innerRadius,i.outerRadius=this.outerRadius,i.rayleighIntensity=this.rayleighIntensity,i.mieIntensity=this.mieIntensity,i.rayleighScaleHeight=this.rayleighScaleHeight,i.mieScaleHeight=this.mieScaleHeight,i.sunIrradiance=this.sunIrradiance,i.sunDirection=this.sunDirection,i.starIntensity=this.starIntensity,i.groundAlbedo=this.groundAlbedo,i.tTransmittance=this.transmittanceTexture,i.tInscattering=this.multipleScatteringTexture,i.tAverageColor=this.averageColorTexture,i.tIrradiance=this.irradianceTexture,i.tReflection=this.environmentTexture,i.tAtmosphere=this.atmosphereTexture,i.tAirealScattering=this.airealInScatteringTexture,i.tAirealTransmittance=this.airealTransmittanceTexture,i.maxMipLevel=this.maxMipLevel,i.invTextureResolution3D=this.invTextureResolution3D)}setToRuntimeUniforms(t){const i=t.uniforms?.atmosphereRuntimeProfile;i&&(i.sunIrradiance=this.sunIrradiance,i.sunDirection=this.sunDirection,i.tTransmittance=this.transmittanceTexture,i.tInscattering=this.multipleScatteringTexture,i.tIrradiance=this.irradianceTexture,i.tReflection=this.environmentTexture,i.tAtmosphere=this.atmosphereTexture,i.tAirealInscattering=this.airealInScatteringTexture,i.tAirealTransmittance=this.airealTransmittanceTexture,i.maxMipLevel=this.maxMipLevel,i.invTextureResolution3D=this.invTextureResolution3D)}dispose(t){this.transmittanceTexture&&t.disposeTexture(this.transmittanceTexture),this.multipleScatteringTexture&&t.disposeTexture(this.multipleScatteringTexture),this.averageColorTexture&&t.disposeTexture(this.averageColorTexture),this.irradianceTexture&&t.disposeTexture(this.irradianceTexture),this.environmentTexture&&t.disposeTexture(this.environmentTexture),this.airealInScatteringTexture&&t.disposeTexture(this.airealInScatteringTexture),this.airealTransmittanceTexture&&t.disposeTexture(this.airealTransmittanceTexture)}}class Ne extends St.Ay{constructor(){super(),this.name="AvarageColorMaterial"}getVertSource(){return"#version 300 es\n\n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec2 uv;\n\n            out vec2 vUv;\n\n            void main(void) {\n                vUv = uv;\n                gl_Position = vec4(position, 1.0);\n            }\n        "}getFragSource(){return`#version 300 es\n\n            precision mediump float;\n\n            #define SAMPLE_SINGLE_SCATTERING\n            #define SAMPLE_MULTIPLE_SCATTERING\n            #define SAMPLE_GROUND\n\n            ${yt.mz}\n            \n            ${yt.AH}\n\n            const int NUM_SLICES = 256;\n            const float DELTA_PHI = PI * 2.0 / float(NUM_SLICES);\n\n            in vec2 vUv;\n\n            out vec4 gDiffuse;\n\n            void main() {\n                vec2 angleAndHeight = getAngleAndHeight(vUv);\n                \n                float cosTheta = angleAndHeight.x;\n                // float sinTheta = sin(acos(cosTheta));\n                float sinTheta = sqrt(max(0.0, 1.0 - cosTheta * cosTheta));\n\n                vec3 viewPosition = vec3(0.0, atmosphereProfile.innerRadius + angleAndHeight.y, 0.0);\n\n                vec3 totalInscatter = vec3(0.0);\n\n                for (int i = 0; i < NUM_SLICES; i++) {\n                    float phi = DELTA_PHI * float(i);\n                    vec3 viewDirection = vec3(sin(phi) * sinTheta, cosTheta, cos(phi) * sinTheta);\n                    totalInscatter += integrate(viewPosition, normalize(viewDirection)).inScatter;\n                }\n                \n                gDiffuse.rgb = totalInscatter / float(NUM_SLICES);\n                gDiffuse.a = 1.0;\n            }\n        `}getUniforms(){return{atmosphereProfile:{}}}}var Re=s(8023);class Ie extends Re.A{constructor(){super()}getFragSource(){return`#version 300 es\n\n            precision mediump float;\n\n            #define SAMPLE_SINGLE_SCATTERING\n            #define SAMPLE_GROUND\n\n            ${yt.mz}\n            \n            ${yt.AH}\n            \n            in vec2 vUv;\n\n            out vec4 gDiffuse;\n\n            void main() {\n                vec2 angleAndHeight = getAngleAndHeight(vUv);\n                \n                float cosTheta = angleAndHeight.x;\n                float sinTheta = sin(acos(cosTheta));\n                vec3 sunDirection = vec3(sinTheta, cosTheta, 0.0);\n\n                vec3 viewPosition = vec3(0.0, atmosphereProfile.innerRadius + angleAndHeight.y, 0.0);\n\n                vec3 totalInscatter = vec3(0.0);\n                vec3 totalTransferRate = vec3(0.0);\n\n                for (int i = 0; i < NUM_SAMPLE_DIRECTIONS; i++) {\n                    vec3 viewDirection = getPoissonSampleDirection(i);\n                    IntegrationResult result = integrate(viewPosition, viewDirection, sunDirection);\n\n                    totalInscatter += result.inScatter;\n                    totalTransferRate += result.transferRate;\n                }\n                \n                vec3 inscattering = totalInscatter / float(NUM_SAMPLE_DIRECTIONS);\n                vec3 transferRate = totalTransferRate / float(NUM_SAMPLE_DIRECTIONS);\n\n                // multiple scattering approximation\n                inscattering /= (1.0 - transferRate);\n\n                gDiffuse = vec4(inscattering, 1.0);\n            }\n        `}getUniforms(){return{atmosphereProfile:{}}}}class ze extends St.Ay{constructor(){super(),this.name="SkyIrradianceMaterial"}getVertSource(){return"#version 300 es\n\n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec2 uv;\n\n            out vec2 vUv;\n\n            void main(void) {\n                vUv = uv;\n                gl_Position = vec4(position, 1.0);\n            }\n        "}getFragSource(){return`#version 300 es\n        \n            // Copyright (c) Joey de Vries\n            // This code is licensed under the MIT License.\n            // Source: https://learnopengl.com/PBR/IBL/Diffuse-irradiance\n\n            precision mediump float;\n\n            ${yt.mz}\n            \n            ${yt.AH}\n\n            in vec2 vUv;\n\n            out vec4 gDiffuse;\n\n            void main() {\n                vec2 angleAndHeight = getAngleAndHeight(vUv);\n\n                float viewHeight = angleAndHeight.y;\n                float cosTheta = angleAndHeight.x;\n                float sinTheta = sqrt(max(0.0, 1.0 - cosTheta * cosTheta));\n\n                vec3 normal = vec3(0.0, cosTheta, sinTheta);\n\n                // vec3 upVector = abs(normal.y) > 0.999 ? vec3(1.0, 0.0, 0.0) : vec3(0.0, 1.0, 0.0);\n                vec3 upVector = vec3(0.0, 1.0, 0.0);\n                vec3 tangent = normalize(cross(upVector, normal));\n                vec3 bitangent = cross(tangent, normal);\n\n                const int NUM_THETA = 256;\n                const int NUM_PHI   = 1024;\n\n                float sampleTheta = 0.5 * PI;\n                float deltaTheta = sampleTheta / float(NUM_THETA);\n                float deltaPhi   = 2.0 * PI / float(NUM_PHI);\n\n                vec3 totalIrradiance = vec3(0.0);\n\n                for (int i = 0; i < NUM_THETA; i++) {\n                    float theta = deltaTheta * float(i);\n\n                    for (int j = 0; j < NUM_PHI; j++) {\n                        float phi = deltaPhi * float(j);\n\n                        vec3 tangentSpaceDirection = vec3(\n                            sin(theta) * cos(phi),\n                            cos(theta),\n                            sin(theta) * sin(phi)\n                        );\n\n                        vec3 sampleDirection =\n                            tangentSpaceDirection.x * tangent +\n                            tangentSpaceDirection.y * normal +\n                            tangentSpaceDirection.z * bitangent;\n\n                        totalIrradiance += getAverageColor(sampleDirection.y, viewHeight) * cos(theta) * sin(theta) / float(NUM_PHI) / float(NUM_THETA);\n                    }\n                }\n\n                gDiffuse.rgb = totalIrradiance * PI;\n                gDiffuse.a = 1.0;\n            }\n        `}getUniforms(){return{atmosphereProfile:{}}}}class Le extends St.Ay{constructor(){super(),this.name="SkyReflectionMaterial"}getVertSource(){return"#version 300 es\n\n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec2 uv;\n\n            out vec2 vUv;\n\n            void main(void) {\n                vUv = uv;\n                gl_Position = vec4(position, 1.0);\n            }\n        "}getFragSource(){return`#version 300 es\n        \n            // Copyright (c) Joey de Vries\n            // This code is licensed under the MIT License.\n            // Source: https://learnopengl.com/PBR/IBL/Specular-IBL\n\n            precision mediump float;\n\n            ${yt.mz}\n            \n            ${yt.AH}\n\n            const uint SAMPLE_COUNT = 512u;\n            \n            uniform float roughness;\n\n            in vec2 vUv;\n\n            out vec4 gDiffuse;\n\n            float VanDerCorput(uint n, uint base) {\n                float invBase = 1.0 / float(base);\n                float denom   = 1.0;\n                float result  = 0.0;\n\n                for(uint i = 0u; i < 32u; ++i) {\n                    if(n > 0u) {\n                        denom   = mod(float(n), 2.0);\n                        result += denom * invBase;\n                        invBase = invBase / 2.0;\n                        n       = uint(float(n) / 2.0);\n                    }\n                }\n\n                return result;\n            }\n            \n            vec2 HammersleyNoBitOps(uint i, uint N) {\n                return vec2(float(i) / float(N), VanDerCorput(i, 2u));\n            }\n\n            vec3 ImportanceSampleGGX(vec2 Xi, vec3 N, float roughness) {\n                float a = roughness * roughness;\n                \n                float phi = 2.0 * PI * Xi.x;\n                float cosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a*a - 1.0) * Xi.y));\n                float sinTheta = sqrt(1.0 - cosTheta*cosTheta);\n                \n                // from spherical coordinates to cartesian coordinates\n                vec3 H;\n                H.x = cos(phi) * sinTheta;\n                H.y = sin(phi) * sinTheta;\n                H.z = cosTheta;\n                \n                // from tangent-space vector to world-space sample vector\n                vec3 up        = abs(N.z) < 0.999 ? vec3(0.0, 0.0, 1.0) : vec3(1.0, 0.0, 0.0);\n                vec3 tangent   = normalize(cross(up, N));\n                vec3 bitangent = cross(N, tangent);\n                \n                vec3 sampleVec = tangent * H.x + bitangent * H.y + N * H.z;\n                return normalize(sampleVec);\n            }\n\n            void main() {\n                vec2 angleAndHeight = getAngleAndHeight(vUv);\n\n                float viewHeight = max(angleAndHeight.y, 0.0);\n                \n                float cosTheta = angleAndHeight.x;\n                float sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n                vec3 N = normalize(vec3(sinTheta, cosTheta, 0.0));\n                vec3 R = N;\n                vec3 V = R;\n\n                vec3 totalInScatter = vec3(0.0);\n                float totalWeight = 0.0;\n\n                for (uint i = 0u; i < SAMPLE_COUNT; i++) {\n                    vec2 Xi = vec2(float(i) / float(SAMPLE_COUNT), VanDerCorput(i, 2u));\n                    vec3 H = ImportanceSampleGGX(Xi, N, roughness);\n                    vec3 L = normalize(2.0 * dot(V, H) * H - V);\n                    \n                    float NdotL = dot(N, L);\n                    if (0.0 < NdotL) {\n                        totalInScatter += getAverageColor(L.y, viewHeight) * NdotL;\n                        totalWeight += NdotL;\n                    }\n                }\n                \n                gDiffuse.rgb = totalInScatter / totalWeight;\n                gDiffuse.a = 1.0;\n            }\n        `}getUniforms(){return{atmosphereProfile:{},roughness:0}}}class Fe extends Re.A{constructor(){super()}getFragSource(){return`#version 300 es\n\n            precision mediump float;\n\n            ${yt.mz}\n\n            ${yt.AH}\n\n            in vec2 vUv;\n\n            out vec4 gDiffuse;\n\n            void main() {\n                vec2 angleAndHeight = getAngleAndHeight(vUv);\n\n                vec3 viewPosition = vec3(0.0, atmosphereProfile.innerRadius + angleAndHeight.y, 0.0);\n                \n                float cosTheta = angleAndHeight.x;\n                float sinTheta = sin(acos(cosTheta));\n                vec3 viewDirection = normalize(vec3(sinTheta, cosTheta, 0.0));\n\n                gDiffuse = integrate(viewPosition, viewDirection).transmittance;\n            }\n        `}getUniforms(){return{atmosphereProfile:{}}}}const Oe=new N.A(256,256),Ve=new N.A(256,256),ke=new a.A(64,64,64),Ge=WebGL2RenderingContext;class Be{constructor(t,i=new Ue){this.renderer=t,this.profile=i,this.profile.invTextureResolution3D=ke.invert(),this.renderPass=new yi.A,this.transmittanceMaterial=new Fe,this.InscatteringMaterial=new Ie,this.avarageColorMaterial=new Ne,this.skyIrradianceMaterial=new ze,this.skyReflectionMaterial=new Le,this.airealScatteringMaterial=new be,this.transmittanceFramebuffer=this.Wi(Oe),this.inscatteringFramebuffer=this.Wi(Oe),this.avarageColorFramebuffer=this.Wi(Oe),this.irradianceFramebuffer=this.Wi(Ve),this.reflectionFramebuffer=this.Wi(Oe,{generateMipmap:!0}),this.airealViewFramebuffer=this.dn(ke),this.runtimeTextureArray=this.vn(Oe,4)}Wi(t,i={}){return new gi.A({width:t.x,height:t.y,useDepthBuffer:!1,magFilter:Ge.LINEAR,minFilter:i.generateMipmap?Ge.LINEAR_MIPMAP_LINEAR:Ge.LINEAR,wrapR:Ge.CLAMP_TO_EDGE,wrapS:Ge.CLAMP_TO_EDGE,wrapT:Ge.CLAMP_TO_EDGE,count:1,generateMipmap:i.generateMipmap??!1})}vn(t,i){return new Ce.A({width:t.x,height:t.y,layers:i,useDepthBuffer:!1,magFilter:Ge.LINEAR,minFilter:Ge.LINEAR,wrapR:Ge.CLAMP_TO_EDGE,wrapS:Ge.CLAMP_TO_EDGE,wrapT:Ge.CLAMP_TO_EDGE,internalFormat:Ge.RGBA32F,format:Ge.RGBA,type:Ge.FLOAT,generateMipmap:!1})}dn(t){return new Ee({width:t.x,height:t.y,depth:t.z,useDepthBuffer:!1,count:2,magFilter:Ge.LINEAR,minFilter:Ge.LINEAR,wrapS:Ge.CLAMP_TO_EDGE,wrapT:Ge.RECLAMP_TO_EDGEPEAT,wrapR:Ge.CLAMP_TO_EDGE,generateMipmap:!1})}precompute(){this.mn(),this.wn(),this.pn(),this.gn(),this.xn(),this.Sn(),this.yn()}mn(){this.profile.setToMaterialUniforms(this.transmittanceMaterial),this.profile.transmittanceTexture=this._n(this.transmittanceMaterial,this.transmittanceFramebuffer)}wn(){this.profile.setToMaterialUniforms(this.InscatteringMaterial),this.profile.multipleScatteringTexture=this._n(this.InscatteringMaterial,this.inscatteringFramebuffer)}pn(){this.profile.setToMaterialUniforms(this.avarageColorMaterial),this.profile.averageColorTexture=this._n(this.avarageColorMaterial,this.avarageColorFramebuffer)}gn(){this.profile.setToMaterialUniforms(this.skyIrradianceMaterial),this.profile.irradianceTexture=this._n(this.skyIrradianceMaterial,this.irradianceFramebuffer)}xn(){this.profile.setToMaterialUniforms(this.skyReflectionMaterial);const t=this.reflectionFramebuffer.maxLevel;for(let i=0;i<t;++i)this.skyReflectionMaterial.uniforms.roughness=i/(t-1),this._n(this.skyReflectionMaterial,this.reflectionFramebuffer,i);this.profile.environmentTexture=this.reflectionFramebuffer.texture,this.profile.maxMipLevel=t}yn(){this.renderer.copyFramebufferToTextureLayer(this.transmittanceFramebuffer,this.runtimeTextureArray,0),this.renderer.copyFramebufferToTextureLayer(this.inscatteringFramebuffer,this.runtimeTextureArray,1),this.renderer.copyFramebufferToTextureLayer(this.irradianceFramebuffer,this.runtimeTextureArray,2),this.renderer.copyFramebufferToTextureLayer(this.reflectionFramebuffer,this.runtimeTextureArray,3),this.profile.atmosphereTexture=this.runtimeTextureArray}Sn(){this.profile.setToMaterialUniforms(this.airealScatteringMaterial);for(let t=0;t<this.airealViewFramebuffer.depth;t++)this.airealScatteringMaterial.uniforms.distance=(t+.5)/this.airealViewFramebuffer.depth*e.Eh*n.dl,this._n(this.airealScatteringMaterial,this.airealViewFramebuffer,0,t);this.profile.airealInScatteringTexture=this.airealViewFramebuffer.textures[0],this.profile.airealTransmittanceTexture=this.airealViewFramebuffer.textures[1]}_n(t,i,s=0,n=0){return this.renderPass.setMaterial(t),this.renderer.setFramebuffer(i,s,n),this.renderer.clear(),this.renderPass.render(this.renderer),this.renderer.flush(),i.texture}}s(3739);class He{constructor(t={}){this.coverage=t.coverage??.35,this.topMax=t.topMax??8e3,this.topMin=t.topMin??1e3,this.top=this.topMax,this.bottomMax=t.bottomMax??1500,this.bottomMin=t.bottomMin??500,this.bottom=this.bottomMin,this.shapeTextureScale=t.shapeTextureScale??new a.A(16e3,16e3,16e3),this.detailTextureScale=t.detailTextureScale??new a.A(3200,3200,3200),this.extraDetailTextureScale=t.extraDetailTextureScale??this.detailTextureScale.scale(.25),this.invShapeTextureScale=this.shapeTextureScale.invert(),this.invDetailTextureScale=this.detailTextureScale.invert(),this.invExtraDetailTextureScale=this.extraDetailTextureScale.invert(),this.shapeTextureResolution=t.shapeTextureResolution??new a.A(256,256,256).scale(1),this.detailTextureResolution=t.detailTextureResolution??new a.A(64,64,64).scale(1),this.extraDetailTextureResolution=t.extraDetailTextureResolution??new a.A(32,32,32).scale(1),this.detailIntensity=t.detailInttensity??.2,this.scattering=t.scattering??.15,this.extinction=t.extinction??.15,this.sunDirection=t.sunDirection??new a.A(1,0,0).normalize(),this.shapeTexture=null,this.detailTexture=null}dispose(t){this.shapeTexture&&t.disposeTexture(this.shapeTexture),this.detailTexture&&t.disposeTexture(this.detailTexture)}}class je extends Re.A{constructor(){super()}getFragSource(){return"#version 300 es\n        \n            precision mediump float;\n            precision mediump sampler3D;\n\n            uniform sampler3D tShapeNoise;\n            uniform sampler3D tSunIrradiance;\n            uniform sampler3D tCloudDistance;\n\n            uniform vec3 resolution;\n            uniform vec3 shapeTextureScale;\n\n            uniform float depth;\n            \n            in vec2 vUv;\n            out vec4 gDiffuse;\n\n            void main() {\n                vec3 uvw = vec3(vUv, depth);\n                vec3 centerVoxel = uvw * resolution;\n\n                float sdf = 0.0;\n                float density = texture(tShapeNoise, uvw).r;\n                if (0.0 < density) {\n                    sdf = -density;\n                }\n                else {\n                    // vec3 closestUvw = texture(tCloudDistance, uvw).xyz;\n                    // float offset = length(vec3(0.5)) / resolution.x;\n                    // sdf = max(0.0, length(closestUvw - uvw) - offset);\n                    sdf = texture(tCloudDistance, uvw).w;\n                }\n                \n                float sunIrradiance = texture(tSunIrradiance, uvw).r;\n                \n                gDiffuse = vec4(sdf, sunIrradiance, 0.0, 0.0);\n                // gDiffuse = vec4(density, sunIrradiance, 0.0, 0.0);\n            }\n        "}getUniforms(){return{tShapeNoise:null,tSunIrradiance:null,tCloudDistance:null,resolution:new a.A,shapeTextureScale:new a.A,depth:0}}}class We extends Re.A{constructor(){super()}getFragSource(){return"#version 300 es\n        \n            precision mediump float;\n            precision mediump sampler3D;\n\n            uniform sampler3D tDistanceSeed;\n            uniform ivec3 resolution;\n            uniform float depth;\n            \n            in vec2 vUv;\n            out vec4 gDiffuse;\n\n            void main() {\n                vec3 centerUvw = vec3(vUv, depth);\n                vec4 centerSample = texture(tDistanceSeed, centerUvw);\n\n                vec3 delta = centerSample.xyz;\n                float minDistance = centerSample.w;\n\n                // if (0.0 <= minDistance) {\n                //     gDiffuse = vec4(delta, minDistance);\n                //     return;\n                // }\n                \n                for (int x = -1; x <= 1; x++) {\n                    for (int y = -1; y <= 1; y++) {\n                        for (int z = -1; z <= 1; z++) {\n                            vec3 uvwOffset = vec3(ivec3(x, y, z)) / float(resolution);\n                            vec3 neighborUvw = centerUvw + uvwOffset;\n\n                            vec4 neighborSample = texture(tDistanceSeed, neighborUvw);\n\n                            if (neighborSample.w <= 0.0) {\n                                continue;\n                            }\n                            \n                            vec3 neighborDelta = neighborSample.xyz;\n                            vec3 tmpDelta = uvwOffset + neighborDelta;\n                            float distance = length(tmpDelta);\n                            if (minDistance < 0.0 || distance < minDistance) {\n                                delta = tmpDelta;\n                                minDistance = distance;\n                            }\n                        }\n                    }\n                }\n                \n                gDiffuse = vec4(delta, minDistance);\n            }\n        "}getUniforms(){return{tDistanceSeed:null,resolution:new a.A,depth:0}}}class $e extends Re.A{constructor(){super()}getFragSource(){return"#version 300 es\n        \n            precision mediump float;\n            precision mediump sampler3D;\n\n            uniform sampler3D tShapeNoise;\n            uniform sampler3D tDetailNoise;\n\n            uniform vec3 shapeTextureScale;\n            uniform vec3 detailTextureScale;\n            uniform float detailIntensity;\n\n            uniform ivec3 resolution;\n            uniform float depth;\n            \n            in vec2 vUv;\n            out vec4 gDiffuse;\n\n            float sampleShape(vec3 uvw) {\n                return texture(tShapeNoise, uvw).r;\n            }\n\n            float sampleDetail(vec3 uvw) {\n                uvw /= shapeTextureScale / detailTextureScale;\n                return 1.0 - texture(tDetailNoise, uvw).r;\n            }\n\n            void main() {\n                vec3 centerUvw = vec3(vUv, depth);\n                // float centerDensity = max(sampleShape(centerUvw) - sampleDetail(centerUvw) * detailIntensity, 0.0);\n                float centerDensity = sampleShape(centerUvw);\n                if (0.0 < centerDensity) {\n                    gDiffuse = vec4(0.0, 0.0, 0.0, 0.0);\n                    return;\n                }\n\n                vec3 delta = vec3(0.0);\n                float minDistance = -1.0;\n\n                for (int x = -1; x <= 1; x++) {\n                    for (int y = -1; y <= 1; y++) {\n                        for (int z = -1; z <= 1; z++) {\n                            vec3 uvwOffset = vec3(ivec3(x, y, z)) / float(resolution);\n                            vec3 neighborUvw = centerUvw + uvwOffset;\n\n                            // float neighborDensity = max(sampleShape(neighborUvw) - sampleDetail(neighborUvw) * detailIntensity, 0.0);\n                            float neighborDensity = sampleShape(neighborUvw);\n                            if (0.0 < neighborDensity) {\n                                vec3 tmpDelta = uvwOffset / 2.0;\n                                float distance = length(tmpDelta);\n                                if (minDistance < 0.0 || distance < minDistance) {\n                                    delta = tmpDelta;\n                                    minDistance = distance;\n                                }\n                            }\n                        }\n                    }\n                }\n                \n                gDiffuse = vec4(delta, minDistance);\n\n                // 雲の中: vec4()\n                // 雲の外: vec4(x.x, y.y, z.z, ) \n                // その他: vec4(0.0, 0.0, 0.0, -1.0)\n            }\n        "}getUniforms(){return{tShapeNoise:null,tDetailNoise:null,shapeTextureScale:new a.A,detailTextureScale:new a.A,detailIntensity:0,tCloudDistance:null,resolution:new a.A,depth:0}}}class Xe extends Re.A{constructor(){super()}getFragSource(){return"#version 300 es\n        \n            precision mediump float;\n            precision mediump sampler3D;\n\n            uniform sampler3D tShapeNoise;\n            uniform sampler3D tDetailNoise;\n\n            uniform vec3 shapeTextureScale; // in meters\n            uniform vec3 detailTextureScale; // in meters\n            uniform float detailIntensity;\n            \n            uniform float extinction;\n\n            uniform float depth;\n\n            uniform vec3 sunDirection;\n\n            const int NUM_STEPS = 512;\n            const float STEP_SIZE = 0.75 / float(NUM_STEPS); // in UV (0 to 1)\n\n            const vec3 UP_VEC = vec3(0.0, 1.0, 0.0);\n\n            in vec2 vUv;\n            out vec4 gDiffuse;\n\n            float sampleShape(vec3 uvw) {\n                return texture(tShapeNoise, uvw).r;\n            }\n\n            float sampleDetail(vec3 uvw) {\n                uvw /= detailTextureScale;\n                return 1.0 - texture(tDetailNoise, uvw).r;\n                // return texture(tDetailNoise, uvw2).r;\n                // return 0.2;\n            }\n\n            void main() {\n                vec3 uvw = vec3(vUv, depth);\n\n                // vec3 shadowUvw = uvw + UP_VEC * STEP_SIZE * 0.5;\n                vec3 shadowUvw = uvw + sunDirection * STEP_SIZE * 0.5;\n\n                // float sunIrradiance = 1.0;\n                float totalDensity = 0.0;\n                for (int i = 0; i < NUM_STEPS; i++) {\n                    float shapeShadow = sampleShape(shadowUvw);\n                    float detailShadow = sampleDetail(shadowUvw);\n                    float shadowDensity = max(shapeShadow - detailShadow * detailIntensity, 0.0);\n                    // float shadowDensity = max(shapeShadow, 0.0);\n\n                    // float sampleExtinction = extinction * shadowDensity * STEP_SIZE * shapeTextureScale.y;\n                    // sunIrradiance *= exp(-sampleExtinction);\n\n                    totalDensity += shadowDensity * STEP_SIZE * shapeTextureScale.y;\n\n                    // shadowUvw += UP_VEC * STEP_SIZE;\n                    shadowUvw += sunDirection * STEP_SIZE;\n                }\n                \n                // gDiffuse = vec4(sunIrradiance, 0.0, 0.0, 0.0);\n                // if (detailShadow == 0.0) totalDensity = -1000.0;\n                gDiffuse = vec4(totalDensity, 0.0, 0.0, 0.0);\n            }\n        "}getUniforms(){return{tShapeNoise:null,tDetailNoise:null,extinction:0,shapeTextureScale:new a.A,detailTextureScale:new a.A,sunDirection:new a.A,detailIntensity:0,depth:0}}}class Ze extends Re.A{constructor(){super()}getFragSource(){return"#version 300 es\n\n            precision mediump float;\n            precision mediump sampler3D;\n\n            uniform sampler3D tWorleyNoise;\n\n            uniform float coverage;\n            \n            uniform float topMax;\n            uniform float topMin;\n            \n            uniform float bottomMax;\n            uniform float bottomMin;\n\n            uniform vec3 shapeTextureScale;\n\n            uniform float depth;\n            \n            in vec2 vUv;\n            out vec4 gDiffuse;\n\n            float sculpt(float density) {\n                return max(density - (1.0 - coverage), 0.0);\n            }\n\n            void main() {\n                vec3 uvw = vec3(vUv, depth);\n\n                float height = uvw.y * shapeTextureScale.y;\n                float topCutoff = max(0.0, height - topMin) / (topMax - topMin);\n                float bottomCutoff = max(0.0, bottomMax - height) / (bottomMax - bottomMin);\n                float heightCutoff = max(topCutoff, bottomCutoff);\n                \n                float density = texture(tWorleyNoise, uvw).r;\n                density = max(density - heightCutoff, 0.0);\n                density = sculpt(density);\n\n                gDiffuse = vec4(density, 0.0, 0.0, 0.0);\n            }\n        "}getUniforms(){return{tWorleyNoise:null,depth:0,coverage:0,topMax:0,topMin:0,bottomMax:0,bottomMin:0,shapeTextureScale:new a.A}}}class Ye extends Re.A{constructor(){super()}getFragSource(){return"#version 300 es\n        \n            precision mediump float;\n            \n            uniform float depth;\n\n            in vec2 vUv;\n\n            out vec4 gDiffuse;\n\n            \n    uniform float frequencies;\n\n    #define OCTAVES 8\n\n    // Hash by David_Hoskins\n    #define UI0 1597334673U\n    #define UI1 3812015801U\n    #define UI2 uvec2(UI0, UI1)\n    #define UI3 uvec3(UI0, UI1, 2798796415U)\n    #define UIF (1.0 / float(0xffffffffU))\n    \n    vec3 hash33(vec3 p) {\n        uvec3 q = uvec3(ivec3(p)) * UI3;\n        q = (q.x ^ q.y ^ q.z) * UI3;\n        return -1. + 2. * vec3(q) * UIF;\n    }\n\n    // Tileable 3D worley noise\n    float worleyNoise(vec3 uv, float frequencies) {    \n        vec3 id = floor(uv);\n        vec3 p = fract(uv);\n        \n        float minDist = -1.0;\n        for (float x = -1.; x <= 1.; ++x) {\n            for (float y = -1.; y <= 1.; ++y) {\n                for (float z = -1.; z <= 1.; ++z) {\n                    vec3 offset = vec3(x, y, z);\n                    vec3 h = hash33(mod(id + offset, vec3(frequencies))) * .5 + .5;\n                    h += offset;\n                    vec3 d = p - h;\n\n                    if (minDist < 0.0) {\n                        minDist = dot(d, d);\n                    } else {\n                        minDist = min(minDist, dot(d, d));\n                    }\n                }\n            }\n        }\n        \n        // inverted worley noise\n        return 1.0 - minDist;\n    }\n\n    float worleyFBM(vec3 uvw) {\n        float result = 0.0;\n        for (float i = 0.0; i < float(OCTAVES); i++) {\n            result += worleyNoise(uvw * frequencies * pow(2.0, i), frequencies * pow(2.0, i)) * pow(0.5, i + 1.0);\n        }\n        return result;\n    }\n\n\n            void main() {\n                vec3 uvw = vec3(vUv, depth);\n                float worleyNoise = worleyFBM(uvw);\n                gDiffuse = vec4(worleyNoise, 0.0, 0.0, 0.0);\n            }\n        "}getUniforms(){return{depth:0,frequencies:6}}}const Ke=WebGL2RenderingContext;class Je{constructor(t,i){this.renderer=t,this.renderPass=new yi.A,this.profile=i??new He,this.worleyNoiseFramebuffer=this.createFramebuffer3D(this.profile.shapeTextureResolution,Ke.RED,Ke.HALF_FLOAT,Ke.R16F),this.shapeFramebuffer=this.createFramebuffer3D(this.profile.shapeTextureResolution,Ke.RED,Ke.HALF_FLOAT,Ke.R16F),this.detailFramebuffer=this.createFramebuffer3D(this.profile.detailTextureResolution,Ke.RED,Ke.HALF_FLOAT,Ke.R16F),this.lightDepthFramebuffer=this.createFramebuffer3D(this.profile.shapeTextureResolution,Ke.RED,Ke.HALF_FLOAT,Ke.R16F),this.distanceFieldFramebuffer1=this.createFramebuffer3D(this.profile.shapeTextureResolution,Ke.RGBA,Ke.HALF_FLOAT,Ke.RGBA16F),this.distanceFieldFramebuffer2=this.createFramebuffer3D(this.profile.shapeTextureResolution,Ke.RGBA,Ke.HALF_FLOAT,Ke.RGBA16F),this.composerFramebuffer=this.createFramebuffer3D(this.profile.shapeTextureResolution,Ke.RG,Ke.HALF_FLOAT,Ke.RG16F),this.worleyNoiseMaterial=new Ye,this.shapeMaterial=new Ze,this.lightDepthMaterial=new Xe,this.distanceSeedMaterial=new $e,this.distanceFieldMaterial=new We,this.composerMaterial=new je}createFramebuffer3D(t,i,s,n){return new Ee({width:t.x,height:t.y,depth:t.z,useDepthBuffer:!1,format:i,type:s,internalFormat:n,minFilter:Ke.NEAREST,magFilter:Ke.NEAREST,wrapS:Ke.REPEAT,wrapT:Ke.REPEAT,wrapR:Ke.REPEAT,generateMipmap:!1})}precompute(){const t=this.computeWorleyNoiseTexture(),i=this.updateAsFinalTexture(this.computeShapeTexture(t)),s=this.updateAsFinalTexture(this.computeDetailTexture()),n=this.updateAsFinalTexture(this.computeLightDepthTexture(i,s)),e=this.computeDistanceSeedTexture(i),h=this.computeDistanceFieldTexture(e),o=this.computeComposedTexture(i,n,h);this.profile.shapeTexture=this.updateAsFinalTexture(o),this.profile.detailTexture=s,this.renderer.disposeTexture(t),this.renderer.disposeTexture(i),this.renderer.disposeTexture(n),this.renderer.disposeTexture(e),this.renderer.disposeTexture(h)}computeWorleyNoiseTexture(){return this.worleyNoiseMaterial.uniforms.frequencies=8,this.drawTexture3D(this.worleyNoiseFramebuffer,this.worleyNoiseMaterial)}computeShapeTexture(t){const i=this.shapeMaterial.uniforms;return i.coverage=this.profile.coverage,i.topMax=this.profile.topMax,i.topMin=this.profile.topMin,i.bottomMax=this.profile.bottomMax,i.bottomMin=this.profile.bottomMin,i.shapeTextureScale=this.profile.shapeTextureScale,i.tWorleyNoise=t,this.drawTexture3D(this.shapeFramebuffer,this.shapeMaterial)}computeDetailTexture(){return this.worleyNoiseMaterial.uniforms.frequencies=12,this.drawTexture3D(this.detailFramebuffer,this.worleyNoiseMaterial)}computeLightDepthTexture(t,i){const s=this.lightDepthMaterial.uniforms;return s.shapeTextureScale=this.profile.shapeTextureScale,s.detailTextureScale=this.profile.detailTextureScale,s.sunDirection=this.profile.sunDirection,s.detailIntensity=this.profile.detailIntensity,s.extinction=this.profile.extinction,s.tShapeNoise=t,s.tDetailNoise=i,this.drawTexture3D(this.lightDepthFramebuffer,this.lightDepthMaterial)}computeDistanceSeedTexture(t,i){const s=this.distanceSeedMaterial.uniforms;return s.resolution=this.profile.shapeTextureResolution,s.tShapeNoise=t,s.tDetailNoise=i,s.shapeTextureScale=this.profile.shapeTextureScale,s.detailTextureScale=this.profile.detailTextureScale,s.detailIntensity=this.profile.detailIntensity,this.drawTexture3D(this.distanceFieldFramebuffer1,this.distanceSeedMaterial)}computeDistanceFieldTexture(t){const i=this.distanceFieldMaterial.uniforms;i.tDistanceSeed=t,i.resolution=this.profile.shapeTextureResolution;for(let t=0;t<this.distanceFieldFramebuffer1.width/2;t++){const t=this.distanceFieldFramebuffer2;this.distanceFieldFramebuffer2=this.distanceFieldFramebuffer1,this.distanceFieldFramebuffer1=t,this.drawTexture3D(this.distanceFieldFramebuffer1,this.distanceFieldMaterial),i.tDistanceSeed=this.distanceFieldFramebuffer1.texture}return this.distanceFieldFramebuffer1.texture}computeComposedTexture(t,i,s){const n=this.composerMaterial.uniforms;return n.resolution=this.profile.shapeTextureResolution,n.shapeTextureScale=this.profile.shapeTextureScale,n.tShapeNoise=t,n.tSunIrradiance=i,n.tCloudDistance=s,this.drawTexture3D(this.composerFramebuffer,this.composerMaterial)}drawTexture3D(t,i){this.renderPass.setMaterial(i);for(let s=0;s<t.depth;s++)this.renderer.setFramebuffer(t,0,s),this.renderer.clear(),i.uniforms.depth=(s+.5)/t.depth,this.renderPass.render(this.renderer);return this.renderer.flush(),t.texture}updateAsFinalTexture(t){return t.minFilter=Ke.LINEAR_MIPMAP_NEAREST,t.magFilter=Ke.LINEAR,t.generateMipmap=!0,t.needsUpdate=!0,t}}var Qe=s(261),th=s(1035);class ih extends Z{constructor(t={}){super(t),this.textSize=t.textSize??T.cL,this.textMesh=(0,T.bY)(this.props.text??"undefined",{size:this.textSize,position:this.getComponentPosition(0)}),this.mesh.add(this.textMesh),this.okButton=this.createButton({label:"- Yes",onClicked:t.onOKClicked},1),this.add(this.okButton),this.cancelButton=this.createButton({label:"- Cancel",onClicked:t.onCancelClicked},2),this.add(this.cancelButton)}}class sh extends Z{constructor(t={}){super(t),this.props=t,this.title="GAME OVER",this.titleColor=b.Gh,this.confirmRestartPanel=new ih({title:this.title,titleColor:this.titleColor,text:"Are you sure to restart the mission?",onOKClicked:function(){this.menu.close(),this.game.main.fadeout(function(){this.game.restartGame(),this.game.main.fadein()}.bind(this))}.bind(this),onCancelClicked:function(){this.menu.openPanel(this)}.bind(this)}),this.confirmReturnToMenuPanel=new ih({title:this.title,titleColor:this.titleColor,text:"Are you sure to return to the title?",onOKClicked:function(){this.menu.close(),this.game.main.fadeout(function(){this.game.endGame(),this.game.main.fadein()}.bind(this))}.bind(this),onCancelClicked:function(){this.menu.openPanel(this)}.bind(this)}),this.createButtons(this.createButtonProps())}createButtonProps(){const t=[];return t.push({label:"- Restart Mission",onClicked:function(){this.menu.openPanel(this.confirmRestartPanel)}.bind(this)}),t.push({label:"- Return to Title",onClicked:function(){this.menu.openPanel(this.confirmReturnToMenuPanel)}.bind(this)}),t}}const nh=WebGL2RenderingContext;function eh(t,i={}){const s=i.size??.04,n=.5*s,e=t.split("\n");let h=.5*(e.length*s+(e.length-1)*n)-.5*s;const o=[];for(const t of e){const e=(0,T.CB)(t,i);e.translate(0,h,0),o.push(e),h-=s+n}const r=hh(o),a=(r.boundingBox.max.y+r.boundingBox.min.y)/2;return r.translate(0,-a,0),r.calculateBoundingBox(),r}function hh(t){const i=t[0],s=new I.A;for(const n in i.attributes){let e=0;for(const i of t){e+=i.getAttribute(n).array.length}const h=new Float32Array(e);let o=0;for(const i of t){const t=i.getAttribute(n);h.set(t.array,o),o+=t.array.length}const r=i.attributes[n],a=new J.A(h,r.stride,r.type,r.divider);s.setAttribute(n,a)}if(i.indices){let n=0;for(const i of t){n+=i.getIndices().array.length}const e=new Uint16Array(n);let h=0,o=0;for(const i of t){const t=i.getIndices();for(let i=0;i<t.array.length;i++){const s=t.array[i]+h;e[o+i]=s}h+=i.attributes.position.count,o+=t.array.length}const r=i.indices,a=new J.A(e,r.stride,r.type,r.divider);s.setIndices(a)}return s}var oh=s(8968);class rh extends q.A{constructor(t={}){super(t),this.transparent=!0}getVertSource(){return"#version 300 es\n        \n    precision mediump float;\n\n    layout (location = 0) in vec3 position;\n    layout (location = 2) in vec2 uv;\n\n    uniform mat4 modelMatrix;\n\n    uniform float aspectRatio;\n\n    uniform vec2 size;\n    uniform vec2 padding;\n\n    out vec2 vUv;\n    out vec3 vPosition;\n\n    void main() {\n        vUv = uv;\n        vPosition = position;\n        vPosition.y = (size.y * 0.5 + padding.y) * sign(vPosition.y);\n\n        gl_Position = modelMatrix * vec4(vPosition, 1.0);\n        gl_Position.x /= aspectRatio;\n    }\n"}getFragSource(){return"#version 300 es\n    \n    precision mediump float;\n\n    uniform vec4 color;\n    uniform sampler2D diffuse;\n\n    uniform vec2 size;\n    uniform vec2 padding;\n\n    uniform float fadeoutScale;\n\n    in vec2 vUv;\n    in vec3 vPosition;\n\n    out vec4 gDiffuse;\n\n    void main() {\n        gDiffuse = color;\n        gDiffuse.a *= 1.0 - max(abs(vPosition.x) - (size.x * 0.5 + padding.x), 0.0) / fadeoutScale;\n    }\n"}getUniforms(t){return{...super.getUniforms(t),aspectRatio:1,color:t.color??oh.QE.clone(),padding:new N.A(t.padding?.x??.025,t.padding?.y??.025),fadeoutScale:t.fadeoutScale??.2,size:new N.A}}}class ah extends q.A{constructor(t={}){super(t),this.transparent=!0}getVertSource(){return"#version 300 es\n        \n    precision mediump float;\n\n    layout (location = 0) in vec3 position;\n    layout (location = 2) in vec2 uv;\n\n    uniform mat4 modelMatrix;\n\n    uniform float aspectRatio;\n\n    uniform vec2 size;\n    uniform vec2 padding;\n\n    out vec2 vUv;\n    out vec3 vPosition;\n\n    void main() {\n        vUv = uv;\n        vPosition = position;\n        float offset = (size.y * 0.5 + padding.y) * sign(vPosition.y);\n        vPosition.y = offset + vPosition.y;\n\n        gl_Position = modelMatrix * vec4(vPosition, 1.0);\n        gl_Position.x /= aspectRatio;\n    }\n"}getFragSource(){return"#version 300 es\n    \n    precision mediump float;\n\n    uniform vec4 color;\n    uniform sampler2D diffuse;\n\n    uniform vec2 size;\n    uniform vec2 padding;\n\n    uniform float fadeoutScale;\n\n    in vec2 vUv;\n    in vec3 vPosition;\n\n    out vec4 gDiffuse;\n\n    void main() {\n        gDiffuse = color;\n        gDiffuse.a *= 1.0 - max(abs(vPosition.x) - (size.x * 0.5 + padding.x), 0.0) / fadeoutScale;\n    }\n"}getUniforms(t){return{...super.getUniforms(t),aspectRatio:1,color:t.color??oh.QE.clone(),size:new N.A,padding:new N.A(t.padding?.x??.025,t.padding?.y??.025),fadeoutScale:t.fadeoutScale??.2}}}const ch=.005,lh=new N.A(2.5,.1);new a.A(0,.45,0);class uh extends E.A{constructor(t={}){super(t),this.focusable=!1,this.size=t.size??this.getSize(),this.position=(new a.A).copy(t.position??n.VT),this.mesh=new R.A,this.mesh.position.copy(this.position),this.backgroundGeometry=new A.A(this.size.x,this.size.y),this.backgroundMaterial=new rh({color:new P.A(0,0,0,.8),size:this.size}),this.backgroundMesh=new D.A(this.backgroundGeometry,this.backgroundMaterial),this.backgroundMesh.frustumCulled=!1,this.backgroundMesh.renderOrder=1,this.mesh.add(this.backgroundMesh),this.frameMaterial=new ah({color:new P.A(1,1,1,1),size:this.size}),this.frameGeometry1=new A.A(this.size.x,ch),this.frameGeometry1.translate(0,.0025,0),this.frameMesh1=new D.A(this.frameGeometry1,this.frameMaterial),this.frameMesh1.frustumCulled=!1,this.frameMesh1.renderOrder=2,this.mesh.add(this.frameMesh1),this.frameGeometry2=new A.A(this.size.x,ch),this.frameGeometry2.translate(0,-.0025,0),this.frameMesh2=new D.A(this.frameGeometry2,this.frameMaterial),this.frameMesh2.frustumCulled=!1,this.frameMesh2.renderOrder=2,this.mesh.add(this.frameMesh2)}getSize(){return lh.clone()}fitToMesh(t,i={}){t.calculateBoundingBox();const s=.5*(t.boundingBox.max.x+t.boundingBox.min.x),n=.5*(t.boundingBox.max.y+t.boundingBox.min.y);this.mesh.position.x=s,this.mesh.position.y=n;const e=t.boundingBox.max.x-t.boundingBox.min.x,h=t.boundingBox.max.y-t.boundingBox.min.y;this.backgroundMaterial.uniforms.size.x=e,this.backgroundMaterial.uniforms.size.y=h,this.frameMaterial.uniforms.size.x=e,this.frameMaterial.uniforms.size.y=h,i.padding&&(this.backgroundMaterial.uniforms.padding.copy(i.padding),this.frameMaterial.uniforms.padding.copy(i.padding)),i.fadeoutScale&&(this.backgroundMaterial.uniforms.fadeoutScale=i.fadeoutScale,this.frameMaterial.uniforms.fadeoutScale=i.fadeoutScale),this.frameMesh1.visible=!0===i.showFrame,this.frameMesh2.visible=!0===i.showFrame,this.frameMaterial.uniforms.color.copy(i.color??b.uL)}}const fh=new a.A(1.6,.5,0),dh=new a.A(0,-.55,0),vh=new a.A(1.5,.45,0);class mh extends X{constructor(t={}){super(t),this.creditsCounter.mesh.visible=!1}initSize(t){this.size=(new N.A).copy(t.size??fh)}initPosition(t){this.position=(new a.A).copy(t.position??dh)}initPanelPosition(){this.panelPosition=new a.A(.5*-vh.x,.5*vh.y,0)}updateTitle(t){this.titleMesh&&this.mesh.remove(this.titleMesh),this.titleMesh=function(t,i={}){const s=eh(t,i),n=new q.A(i),e=new D.A(s,n);return e.frustumCulled=!1,e}(t,{size:.06,align:T.oM,color:this.panel?.titleColor}),this.titleMesh.position.y=1.2,this.mesh.add(this.titleMesh),this.backgroundMesh||(this.backgroundMesh=new uh,this.add(this.backgroundMesh)),this.backgroundMesh.fitToMesh(this.titleMesh,{padding:new N.A(.2,.04),fadeoutScale:.4,showFrame:!0,color:this.panel?.titleColor})}createDivider(){}}class wh extends z{constructor(t){super(t)}Zi(){super.Zi(),this.colonGeometry=this.Ki(":")}Yi(){this.mesh=new R.A,this.mesh.position.copy(this.position),this.mesh.frustumCulled=!1;let t=0;this.secondMesh2=this.Ji(this.numberGeometries[0],t++),this.secondMesh1=this.Ji(this.numberGeometries[0],t++),this.colonMesh1=this.Ji(this.colonGeometry,t++),this.minuteMesh2=this.Ji(this.numberGeometries[0],t++),this.minuteMesh1=this.Ji(this.numberGeometries[0],t++),this.colonMesh2=this.Ji(this.colonGeometry,t++),this.hourMesh2=this.Ji(this.numberGeometries[0],t++),this.hourMesh1=this.Ji(this.numberGeometries[0],t++),this.mesh.add(this.hourMesh1),this.mesh.add(this.hourMesh2),this.mesh.add(this.colonMesh1),this.mesh.add(this.minuteMesh1),this.mesh.add(this.minuteMesh2),this.mesh.add(this.colonMesh2),this.mesh.add(this.secondMesh1),this.mesh.add(this.secondMesh2)}set(t){const i=Math.floor(t/3600),s=Math.floor(t%3600/60),n=Math.floor(t%60),e=i<10?0:parseInt(i/10),h=i<10?i:i%10,o=s<10?0:parseInt(s/10),r=s<10?s:s%10,a=n<10?0:parseInt(n/10),c=n<10?n:n%10;this.hourMesh1.geometry=this.numberGeometries[e],this.hourMesh2.geometry=this.numberGeometries[h],this.minuteMesh1.geometry=this.numberGeometries[o],this.minuteMesh2.geometry=this.numberGeometries[r],this.secondMesh1.geometry=this.numberGeometries[a],this.secondMesh2.geometry=this.numberGeometries[c]}}class ph extends L{constructor(t={}){super(t)}createCounter(){return new wh({align:T.t7,color:b.QE,position:new a.A(this.totalWidth,0,0)})}}class gh extends Z{constructor(t={}){super(t),this.titleColor=t.titleColor??b.uL}initSize(){this.size=fh.clone(),this.size.x-=.05,this.size.y-=.05}initPosition(){this.position=n.VT.clone()}}const xh=-.35,Mh=(new a.A(-.75,xh-.5*T.p5,0),new a.A(.75,xh-.5*T.p5,0),new a.A(0,xh-1.5*T.p5,0),.5*vh.x-.05),Sh=.6;class yh extends gh{constructor(t={}){super(t),this.previousView=null,this.props=t,this.title="MISSION\nCOMPLETED",this.titleColor=b.DQ,this.frameWidth=t.frameWidth??.5*T.hH,this.downCounter=new L({label:"Enemies Downed:",width:Mh,position:new a.A(.5*-this.size.x,this.getComponentY(0),0)}),this.add(this.downCounter),this.scoreCounter=new L({label:"Total Score:",width:Mh,position:new a.A(.5*-this.size.x,this.getComponentY(1),0)}),this.add(this.scoreCounter),this.timeCounter=new ph({label:"Clear Time:",width:Mh,position:new a.A(.5*-this.size.x,this.getComponentY(2),0)}),this.add(this.timeCounter),this.createDivider(),this.rankLabel=(0,T.bY)("Rank:",{position:new a.A(.5*vh.x+.05,this.getComponentY(0),0)}),this.mesh.add(this.rankLabel),this.rankValue=(0,T.bY)("SSS",{size:.12,position:new a.A(.5*vh.x+.05+.5*Mh,this.getComponentY(1)-.02,0),align:T.oM}),this.mesh.add(this.rankValue),this.backButton=new U({position:new a.A(.3,this.getComponentY(3)-.05,0),size:new a.A(Sh,.1,0),label:"- Return to Menu",onClicked:function(){this.continue(),this.game.main.fadeout(function(){this.game.playerController.resetWings(),this.game.endGame(),this.game.main.fadein()}.bind(this))}.bind(this)}),this.add(this.backButton),this.continueButton=new U({position:new a.A(vh.x-.3,this.getComponentY(3)-.05,0),size:new a.A(Sh,.1,0),label:"- Continue Flight",align:T.t7,onClicked:function(){this.continue()}.bind(this)}),this.add(this.continueButton)}update(t,i){this.game.playerController.pause&&(this.continue(),this.game.playerController.pause=!1)}continue(){this.game.playerController.resetWings(),this.game.continue(),this.menu.closePanel(this),this.menu.close()}createDivider(){const t=new A.A(this.size.x,this.frameWidth),i=new q.A({color:b.QE});this.deviderMesh=new D.A(t,i),this.deviderMesh.position.y=this.getComponentY(3)+.025,this.deviderMesh.frustumCulled=!1,this.deviderMesh.renderOrder=2,this.mesh.add(this.deviderMesh)}set(t,i,s){this.downCounter.set(t),this.scoreCounter.set(i),this.timeCounter.set(s)}setRank(t){this.rankValue.geometry=(0,T.CB)(t,{size:.12,position:new a.A(.5*vh.x+.05+.5*Mh,this.getComponentY(1)-.02,0),align:T.oM})}}class _h extends Z{constructor(t={}){super(t),this.title="PAUSE MENU",this.confirmRestartPanel=new ih({title:this.title,text:"Are you sure to restart the mission?",onOKClicked:function(){this.menu.close(),this.game.main.fadeout(function(){this.game.restartGame(),this.game.main.fadein()}.bind(this))}.bind(this),onCancelClicked:function(){this.menu.openPanel(this)}.bind(this)}),this.confirmReturnToMenuPanel=new ih({title:this.title,text:"Are you sure to return to the title?",onOKClicked:function(){this.menu.close(),this.game.main.fadeout(function(){this.game.endGame(),this.game.main.fadein(function(){this.game.isMusicPlaying||this.game.startMusic()}.bind(this))}.bind(this))}.bind(this),onCancelClicked:function(){this.menu.openPanel(this)}.bind(this)}),this.createButtons(this.createButtonProps())}createButtonProps(){const t=[];return t.push({label:"- Continue",onClicked:function(){this.game.continue()}.bind(this)}),t.push({label:"- Restart Mission",onClicked:function(){this.menu.openPanel(this.confirmRestartPanel)}.bind(this)}),t.push({label:"- Free Camera Mode",onClicked:function(){this.menu.hide(),this.game.enableFreeCamera(function(){this.menu.show()}.bind(this))}.bind(this)}),t.push({label:"- Return to Title",onClicked:function(){this.menu.openPanel(this.confirmReturnToMenuPanel)}.bind(this)}),t}}var Ph=s(4801);const Ah=WebGL2RenderingContext;class Dh extends I.A{constructor(t=.02,i=n.fl){super(),this.size=t,this.side=i;const s=[0*this.size,0,0,this.size*-this.side,this.size*this.side,0,this.size*-this.side,this.size*-this.side,0];this.attributes={position:new J.A(new Float32Array(s),3,Ah.FLOAT),normal:new J.A(new Float32Array([0,0,1,0,0,1,0,0,1]),3,Ah.FLOAT),uv:new J.A(new Float32Array([0,1,1,1,0,0]),2,Ah.FLOAT)},this.indices=new J.A(new Uint16Array([0,1,2]),1,Ah.UNSIGNED_SHORT)}}const qh=new a.A;class Th extends it{constructor(t){super(t),this.leftArrowBoundingBox=new C.A,this.rightArrowBoundingBox=new C.A,this.canCycle=t.canCycle??!1,this.onClicked=t.onClicked??function(){this.Pn(this.leftArrowBoundingBox)&&this.selectNext(!0),this.Pn(this.rightArrowBoundingBox)&&this.selectNext(!1)}.bind(this)}init(t){super.init(t),this.labelAlign=t.labelAlign??T.C7,this.itemCenter=this.size.x/4,this.options=t.options?.length?t.options:[new Eh(0,"None")],this.value=t.value??this.options[0].value,this.currentIndex=0;for(let t=0;t<this.options.length;t++)if(this.options[t].value===this.value){this.currentIndex=t;break}this.onChanged=t.onChanged}createMesh(){super.createMesh();const t=new q.A({color:b.EZ}),i=this.size.x/2-.04;this.leftArrow=new D.A(new Dh(.02,n.K9),t),this.leftArrow.position.x=.04,this.leftArrow.frustumCulled=!1,this.mesh.add(this.leftArrow),this.rightArrow=new D.A(new Dh(.02,n.fl),t),this.rightArrow.position.x=i,this.rightArrow.frustumCulled=!1,this.mesh.add(this.rightArrow),this.valueLabels=this.createLabels(),this.valueLabel=this.valueLabels[this.value],this.mesh.add(this.valueLabel)}createLabels(){const t={};for(const i of this.options){const s=(0,T.bY)(i.label,{size:.04,align:T.oM});s.position.set(this.itemCenter,0,-.1),s.renderOrder=2,t[i.value]=s}return t}lateUpdate(t,i,s){super.lateUpdate(t,i,s),this.An(this.leftArrow,this.leftArrowBoundingBox),this.An(this.rightArrow,this.rightArrowBoundingBox),this.disabled?(this.leftArrow.material.uniforms.color.copy(b.EZ),this.rightArrow.material.uniforms.color.copy(b.EZ),this.valueLabel.material.uniforms.color.copy(b.EZ),this.leftArrow.material.uniforms.color.w=.5,this.rightArrow.material.uniforms.color.w=.5,this.valueLabel.material.uniforms.color.w=.5):this.scene.focusedComponent===this?(this.leftArrow.material.uniforms.color.copy(b.SE),this.rightArrow.material.uniforms.color.copy(b.SE),this.valueLabel.material.uniforms.color.copy(b.SE)):(this.leftArrow.material.uniforms.color.copy(b.EZ),this.rightArrow.material.uniforms.color.copy(b.EZ),this.valueLabel.material.uniforms.color.copy(b.EZ))}selectNext(t){this.currentIndex+=t?-1:1,this.canCycle&&(this.options.length<=this.currentIndex?this.currentIndex=0:this.currentIndex<0&&(this.currentIndex=this.options.length-1)),this.currentIndex=(0,l.qE)(this.currentIndex,0,this.options.length-1),this.value=this.options[this.currentIndex].value,this.mesh.remove(this.valueLabel),this.valueLabel=this.valueLabels[this.value],this.mesh.add(this.valueLabel),this.onChanged&&this.onChanged(this.value)}getValue(){return this.value}An(t,i){i.init(),i.min.x=.5*-this.size.y,i.min.y=.5*-this.size.y,i.max.x=.5*+this.size.y,i.max.y=.5*+this.size.y,qh.setZero();let s=t;for(;s;)qh.add(s.position,qh),s=s.parent;i.translate(qh)}Pn(t){return this.scene.playerController.mousePosition.x>t.min.x&&this.scene.playerController.mousePosition.y>t.min.y&&this.scene.playerController.mousePosition.x<t.max.x&&this.scene.playerController.mousePosition.y<t.max.y}}class Eh{constructor(t,i){this.value=t??0,this.label=i??"None"}}const Ch=new N.A(100,2),bh=(Ch.scale(.5),.1);class Uh extends E.A{constructor(t={}){super(t),this.props=t,this.size=t.size??(new N.A).copy(Ch),this.mesh=new R.A,this.mesh.frustumCulled=!1,this.mesh.renderOrder=1,this.background=new uh,this.add(this.background),this.title=th.A.generateFontMesh("AUDIO SETTINGS",{size:.06,align:T.oM,color:b.uL}),this.title.position.y=.8,this.mesh.add(this.title),this.background.fitToMesh(this.title,{padding:new N.A(.2,.04),fadeoutScale:.4});const i=localStorage.getItem("audio_settings");this.audioSettings=new Ph.A(i?JSON.parse(i):{});let s=0;this.sfxVolume=new Th({label:"Sound Effect Volume",position:new a.A(0,.5-.125*s++,0),size:new N.A(1.8,bh),options:[new Eh(0,"0"),new Eh(.1,"10"),new Eh(.2,"20"),new Eh(.3,"30"),new Eh(.4,"40"),new Eh(.5,"50"),new Eh(.6,"60"),new Eh(.7,"70"),new Eh(.8,"80"),new Eh(.9,"90"),new Eh(1,"100")],value:this.audioSettings.sfxVolume??1,onChanged:this.onAnyItemChanged.bind(this)}),this.add(this.sfxVolume),this.bgmVolume=new Th({label:"Music Volume",position:new a.A(0,.5-.125*s++,0),size:new N.A(1.8,bh),options:[new Eh(0,"0"),new Eh(.1,"10"),new Eh(.2,"20"),new Eh(.3,"30"),new Eh(.4,"40"),new Eh(.5,"50"),new Eh(.6,"60"),new Eh(.7,"70"),new Eh(.8,"80"),new Eh(.9,"90"),new Eh(1,"100")],value:this.audioSettings.bgmVolume??1,onChanged:this.onAnyItemChanged.bind(this)}),this.add(this.bgmVolume),this.backButton=new it({label:"Back",position:new a.A(-.65,-.8,0),size:new N.A(.5,bh),onClicked:function(){this.game.trialTitleMenu.show(),this.game.remove(this)}.bind(this)}),this.add(this.backButton),this.applyButton=new it({label:"Save",position:new a.A(.65,-.8,0),size:new N.A(.5,bh),onClicked:function(){const t=new Ph.A({sfxVolume:this.sfxVolume.value,bgmVolume:this.bgmVolume.value});this.game.main.applyAudioSettings(t),localStorage.setItem("audio_settings",JSON.stringify(t)),this.applyButton.disabled=!0,this.applyButton.disable()}.bind(this),disabled:!0}),this.add(this.applyButton)}onAnyItemChanged(){this.applyButton.enable()}}var Nh=s(2318);const Rh=new N.A(100,2),Ih=(Rh.scale(.5),1.8),zh=.1,Lh=-.525;class Fh extends E.A{constructor(t={}){super(t),this.props=t,this.size=t.size??(new N.A).copy(Rh),this.mesh=new R.A,this.mesh.frustumCulled=!1,this.mesh.renderOrder=1,this.background=new uh,this.add(this.background),this.title=th.A.generateFontMesh("CONTROL SETTINGS",{size:.06,align:T.oM,color:b.uL}),this.title.position.y=.8,this.mesh.add(this.title),this.background.fitToMesh(this.title,{padding:new N.A(.2,.04),fadeoutScale:.4});const i=localStorage.getItem("control_settings");this.controlSettings=new Nh.A(i?JSON.parse(i):{});{const t=new A.A(Ih,1),i=new q.A({color:oh.wg,transparent:!0}),s=new D.A(t,i);s.frustumCulled=!1,s.position.y=.075-.025,this.mesh.add(s);const n=new q.A({color:oh.EZ});this.controllerMesh=new D.A(K.A.CONTROLLER.geometry,n),this.controllerMesh.frustumCulled=!1,this.controllerMesh.position.y=.03,this.controllerMesh.scale.set(.9,.9,.9),this.mesh.add(this.controllerMesh),this.standardThrottleYawMesh=new D.A(K.A.CONTROLLER.children[0].geometry,n),this.invertedThrottleYawMesh=new D.A(K.A.CONTROLLER.children[1].geometry,n),this.standardThrottleYawMesh.frustumCulled=!1,this.invertedThrottleYawMesh.frustumCulled=!1,this.controllerMesh.add(this.standardThrottleYawMesh),this.controllerMesh.add(this.invertedThrottleYawMesh),this.standardPitchMesh=new D.A(K.A.KEYBOARD.children[0].geometry,n),this.invertedPitchMesh=new D.A(K.A.KEYBOARD.children[1].geometry,n),this.standardPitchMesh.frustumCulled=!1,this.invertedPitchMesh.frustumCulled=!1,this.controllerMesh.add(this.standardPitchMesh),this.controllerMesh.add(this.invertedPitchMesh)}this.device=new Th({label:"Device",position:new a.A(0,.625,0),size:new N.A(Ih,zh),options:[new Eh(0,"Gamepad"),new Eh(1,"Keyboard")],value:0,canCycle:!0,onChanged:function(){0===this.device.value?(this.controllerMesh.geometry=K.A.CONTROLLER.geometry,this.swapThrottleAndYaw.show()):(this.controllerMesh.geometry=K.A.KEYBOARD.geometry,this.swapThrottleAndYaw.hide())}.bind(this)}),this.add(this.device);let s=0;this.invertPitch=new Th({label:"Invert Pitch",position:new a.A(0,Lh-.125*s++,0),size:new N.A(Ih,zh),options:[new Eh(!1,"NO"),new Eh(!0,"YES")],value:this.controlSettings.invertPitch??!1,onChanged:this.onAnyItemChanged.bind(this)}),this.add(this.invertPitch),this.swapThrottleAndYaw=new Th({label:"Swap Throttle / Yaw",position:new a.A(0,Lh-.125*s++,0),size:new N.A(Ih,zh),options:[new Eh(!1,"NO"),new Eh(!0,"YES")],value:this.controlSettings.swapThrottleAndYaw??!1,onChanged:this.onAnyItemChanged.bind(this)}),this.add(this.swapThrottleAndYaw),this.backButton=new it({label:"Back",position:new a.A(-.65,-.8,0),size:new N.A(.5,zh),onClicked:function(){this.game.trialTitleMenu.show(),this.game.remove(this)}.bind(this)}),this.add(this.backButton),this.applyButton=new it({label:"Save",position:new a.A(.65,-.8,0),size:new N.A(.5,zh),onClicked:function(){const t=new Nh.A({invertPitch:this.invertPitch.value,swapThrottleAndYaw:this.swapThrottleAndYaw.value});localStorage.setItem("control_settings",JSON.stringify(t)),this.applyButton.disabled=!0,this.game.playerController.applySettings(t),this.applyButton.disable()}.bind(this),disabled:!0}),this.add(this.applyButton)}onAnyItemChanged(){this.applyButton.enable()}lateUpdate(t,i,s){0!==this.device.value?(this.standardThrottleYawMesh.visible=!1,this.invertedThrottleYawMesh.visible=!1,this.invertPitch.value?(this.standardPitchMesh.visible=!1,this.invertedPitchMesh.visible=!0):(this.standardPitchMesh.visible=!0,this.invertedPitchMesh.visible=!1)):(this.standardPitchMesh.visible=!1,this.invertedPitchMesh.visible=!1,this.swapThrottleAndYaw.value?(this.standardThrottleYawMesh.visible=!1,this.invertedThrottleYawMesh.visible=!0):(this.standardThrottleYawMesh.visible=!0,this.invertedThrottleYawMesh.visible=!1))}}class Oh extends E.A{constructor(t){super(t),this.props=t,this.init(t),this.createMesh(),this.button=new it({label:"OK",position:new a.A(0,-.3,0),size:new N.A(.5,n.EX,0),onClicked:function(){this.game.remove(this),this.onOKClicked&&this.onOKClicked()}.bind(this)}),this.add(this.button)}init(t){t.size||this.size.set(1.6,.4),this.padding=t.padding??.0175,this.textSize=t.textSize??n.gI,this.text=t.text??"None",this.textAlign=t.textAlign??T.C7,this.onOKClicked=t.onOKClicked}createMesh(){const t=new A.A(this.size.x,this.size.y);t.calculateBoundingBox();const i=new q.A({color:b.wg,transparent:!0});this.mesh=new D.A(t,i),this.mesh.position.set(this.position.x,this.position.y,0),this.mesh.frustumCulled=!1,this.mesh.actor=this,this.labelMesh=(0,T.bY)(this.text,{size:this.textSize,align:this.textAlign,color:b.EZ,transparent:!0}),this.labelMesh.position.y=.5*this.size.y-1.5*this.textSize,this.textAlign===T.C7?this.labelMesh.position.x=.5*-this.size.x+this.textSize:this.textAlign===T.t7&&(this.labelMesh.position.x=.5*this.size.x-this.textSize),this.mesh.add(this.labelMesh)}}const Vh=new N.A(100,2),kh=(Vh.scale(.5),1.8),Gh=.1;class Bh extends E.A{constructor(t={}){super(t),this.props=t,this.size=t.size??(new N.A).copy(Vh),this.mesh=new R.A,this.mesh.frustumCulled=!1,this.mesh.renderOrder=1,this.background=new uh,this.add(this.background),this.title=th.A.generateFontMesh("GRAPHIC SETTINGS",{size:.06,align:T.oM,color:b.uL}),this.title.position.y=.8,this.mesh.add(this.title),this.background.fitToMesh(this.title,{padding:new N.A(.2,.04),fadeoutScale:.4});const i=localStorage.getItem("graphic_settings");this.graphicSettings=new dt.Ay(i?JSON.parse(i):{});let s=0;this.shaderType=new Th({label:"Shader Type",position:new a.A(0,.5-.125*s++,0),size:new N.A(kh,Gh),options:[new Eh(n.WB,"Simple Lambert"),new Eh(n.$g,"Physics Based")],value:this.graphicSettings.shaderType??n.$g,onChanged:this.onAnyItemChanged.bind(this)}),this.add(this.shaderType),this.directShadow=new Th({label:"Direct Shadow",position:new a.A(0,.5-.125*s++,0),size:new N.A(kh,Gh),options:[new Eh(!1,"OFF"),new Eh(!0,"ON")],value:this.graphicSettings.useCSM??!0,onChanged:this.onAnyItemChanged.bind(this)}),this.add(this.directShadow),this.ambientOcclusion=new Th({label:"Ambient Occlusion",position:new a.A(0,.5-.125*s++,0),size:new N.A(kh,Gh),options:[new Eh(!1,"OFF"),new Eh(!0,"ON")],value:this.graphicSettings.useGTAO??!0,onChanged:this.onAnyItemChanged.bind(this)}),this.add(this.ambientOcclusion),this.terrainQuality=new Th({label:"Terrain Quality",position:new a.A(0,.5-.125*s++,0),size:new N.A(kh,Gh),options:[new Eh(n.XM,"LOW"),new Eh(n.Ls,"HIGH")],value:this.graphicSettings.terrainQuality??n.Ls,onChanged:this.onAnyItemChanged.bind(this)}),this.add(this.terrainQuality),this.grasses=new Th({label:"Grasses",position:new a.A(0,.5-.125*s++,0),size:new N.A(kh,Gh),options:[new Eh(!1,"OFF"),new Eh(!0,"ON")],value:this.graphicSettings.drawGrasses??!0,onChanged:this.onAnyItemChanged.bind(this)}),this.add(this.grasses),this.volumetricClouds=new Th({label:"Volumetric Clouds",position:new a.A(0,.5-.125*s++,0),size:new N.A(kh,Gh),options:[new Eh(n.pT,"LOW"),new Eh(n.Ap,"MIDIUM"),new Eh(n.$o,"HIGH")],value:this.graphicSettings.volumetricCloudsQuality??2,onChanged:this.onAnyItemChanged.bind(this)}),this.add(this.volumetricClouds),this.bloomEffect=new Th({label:"Bloom Effect",position:new a.A(0,.5-.125*s++,0),size:new N.A(kh,Gh),options:[new Eh(!1,"OFF"),new Eh(!0,"ON")],value:this.graphicSettings.useBloom??!0,onChanged:this.onAnyItemChanged.bind(this)}),this.add(this.bloomEffect),this.viewDistanceSelect=new Th({label:"View Distance",position:new a.A(0,.5-.125*s++,0),size:new N.A(kh,Gh),options:[new Eh(dt.hw,"Near"),new Eh(dt.cj,"Medium"),new Eh(dt.uG,"Far")],value:this.graphicSettings.viewDistance??dt.uG,onChanged:this.onAnyItemChanged.bind(this)}),this.add(this.viewDistanceSelect),this.backButton=new it({label:"Back",position:new a.A(-.65,-.8,0),size:new N.A(.5,Gh),onClicked:function(){this.game.trialTitleMenu.show(),this.game.remove(this)}.bind(this)}),this.add(this.backButton),this.applyButton=new it({label:"Save",position:new a.A(.65,-.8,0),size:new N.A(.5,Gh),onClicked:function(){const t=new dt.Ay({shaderType:this.shaderType.value,useCSM:this.directShadow.value,useGTAO:this.ambientOcclusion.value,terrainQuality:this.terrainQuality.value,drawGrasses:this.grasses.value,volumetricCloudsQuality:this.volumetricClouds.value,useBloom:this.bloomEffect.value,viewDistance:this.viewDistanceSelect.value});this.game.main.applyGraphicSettings(t),localStorage.setItem("graphic_settings",JSON.stringify(t)),this.applyButton.disabled=!0,this.hide(),this.game.add(new Oh({text:"You need to restart the game to apply changes.",onOKClicked:function(){this.show()}.bind(this)})),this.applyButton.disable()}.bind(this),disabled:!0}),this.add(this.applyButton)}onAnyItemChanged(){this.applyButton.enable()}}const Hh=new N.A(100,2);Hh.scale(.5);class jh extends E.A{constructor(t={}){super(t),this.props=t,this.size=t.size??(new N.A).copy(Hh),this.mesh=new R.A,this.mesh.frustumCulled=!1,this.mesh.renderOrder=1,this.background=new uh,this.add(this.background),this.title=th.A.generateFontMesh("INTERCEPTOR",{size:.1,align:T.oM,color:b.uL}),this.title.position.y=.6,this.mesh.add(this.title),this.subTitle=th.A.generateFontMesh("SKY GUARDIANS",{size:.05,align:T.oM,color:b.uL}),this.subTitle.position.y=-.125,this.title.add(this.subTitle),this.background.fitToMesh(this.title,{padding:new N.A(.2,.04),fadeoutScale:.4,showFrame:!0}),this.gameStartBooked=!1;const i=-.4,s=-.125;let n=0;this.startButton=new it({label:"Play Game",position:new a.A(0,i+s*n++,0),size:new N.A(.6,.1),onClicked:function(){this.game.isFadingout=!0,this.gameStartBooked=!0,this.scene.main.fadeout(function(){this.game.startGame(),this.scene.main.fadein()}.bind(this)),this.mesh.visible=!1}.bind(this)}),this.add(this.startButton),this.audioSettings=new it({label:"Audio",position:new a.A(0,i+s*n++,0),size:new N.A(.6,.1),onClicked:function(){this.hide(),this.scene.add(new Uh)}.bind(this)}),this.add(this.audioSettings),this.viewControls=new it({label:"Controls",position:new a.A(0,i+s*n++,0),size:new N.A(.6,.1),onClicked:function(){this.hide(),this.scene.add(new Fh)}.bind(this)}),this.add(this.viewControls),this.graphicSettings=new it({label:"Graphics",position:new a.A(0,i+s*n++,0),size:new N.A(.6,.1),onClicked:function(){this.hide(),this.scene.add(new Bh)}.bind(this)}),this.add(this.graphicSettings)}lateUpdate(t,i,s){}}class Wh extends Yi{constructor(t,i,s=1){super(Xi.A.AFTER_BURNER,t,i,s),this.loop=!0}}Xi.A.ENGINE;class $h extends Yi{constructor(t,i,s=1){super(Xi.A.ENGINE,t,i,s),this.loop=!0}}class Xh extends Yi{constructor(t,i,s=1){super(Xi.A.WIND,t,i,s),this.loop=!0}}var Zh=s(7764),Yh=s(6839);class Kh extends St.Ay{constructor(t={}){super(t),this.transparent=!0,this.depthWrite=!1,this.renderingPass=n.xF,this.side=St.c0}getVertSource(){return`#version 300 es\n            \n            precision mediump float;\n            \n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec3 normal;\n                \n            uniform mat4 modelMatrix;\n            uniform mat4 viewMatrix;\n            uniform mat4 projectionMatrix;\n            \n            out vec3 vPosition;\n            out vec3 vViewNormal;\n            out vec3 vViewPosition;\n\n            ${yt.mz}\n\n            ${yt.SY}\n\n            void main() {\n                vPosition = position;\n                vec3 adjustedPosition = position;\n                adjustedPosition.x *= 0.55 * 1.25;\n                adjustedPosition.z *= 12.0;\n                adjustedPosition.y *= 0.25;\n\n                vViewNormal = (viewMatrix * modelMatrix * vec4(normal, 0.0)).xyz;\n                vViewNormal = normalize(vViewNormal);\n\n                vViewPosition = (viewMatrix * modelMatrix * vec4(adjustedPosition, 1.0)).xyz;\n\n                gl_Position = projectionMatrix * vec4(vViewPosition, 1.0);\n            }\n        `}getFragSource(){return"#version 300 es\n            \n            precision mediump float;\n\n            uniform float cameraNear;\n            uniform float cameraFar;\n\n            uniform float time;\n            uniform float throttle;\n            \n            in vec3 vPosition;\n            in vec3 vViewNormal;\n            in vec3 vViewPosition;\n\n            out vec4 gDiffuse;\n\n            #define PI 3.141592653589793\n\n            float getSinFBM(float theta) {\n                return\n                    + sin(theta * pow(2.0, 0.0)) * pow(0.5, 0.0)\n                    + sin(theta * pow(2.0, 1.0)) * pow(0.5, 1.0)\n                    + sin(theta * pow(2.0, 2.0)) * pow(0.5, 2.0)\n                ;\n            }\n\n            void main() {\n                float highlight = (1.0 - sin(vPosition.z * 75.0)) * 0.5;\n                highlight = 1.0 - highlight;\n                float timeFactor = 50.0;\n\n                float timeNoise = getSinFBM(time * timeFactor + exp(-vPosition.z * 20.0) * 10.0);\n                float intensity = (1.0 + highlight) * (1.0 + timeNoise * 0.01);\n\n                float adjustedThrottle = pow(throttle, 2.0);\n                float deviation = vPosition.z * 8.0;\n                float density = exp(-vPosition.z * 5.0) * (1.0 + highlight) * 1.0 * adjustedThrottle * (1.0 + timeNoise * 0.1) * 1.0;\n                // density *= pow(1.0 - min(length(vec2(vPosition.x, vPosition.y)), 1.0), 2.0);\n\n                float deviation2 = max(length(vec2(vPosition.x, vPosition.y)) - 0.5, 0.0) * 7.5;\n                density *= exp(-pow(deviation2, 2.0));\n                // density /= 1.0 + pow(length(vec2(vPosition.x, vPosition.y)) * 10.0, 2.0);\n\n                vec3 viewDirection = normalize(vViewPosition);\n                density *= abs(dot(viewDirection, vViewNormal));\n\n                float transmittance = 1.0 - exp(-density);\n\n                // vec3 color = vec3(0.3, 0.45, 1.0);\n                // vec3 color = vec3(1.0, 0.9, 0.6);\n                vec3 color = vec3(0.5, 0.5, 1.0);\n                vec3 emissive = color * 100.0 * density;\n\n                gDiffuse = vec4(emissive, transmittance);\n\n                // gl_FragColor = vec4(0.4, 0.4, 1.0, 0.1);\n            }\n        "}getUniforms(){return{time:0,scale:0,opacity:0,throttle:0,cameraNear:1,cameraFar:1,atmosphereProfile:{}}}}const Jh=WebGL2RenderingContext;class Qh extends ft.A{constructor(t,i,s,n){super(),this.vertices=t,this.position=i,this.direction=s,this.aircraft=n,this.geometry=this.createGeometry(),this.material=new Kh,this.mesh=new D.A(K.A.AFTER_BURNER.geometry,this.material),this.mesh.position.copy(this.position)}onAdded(){super.onAdded()}lateUpdate(t,i,s){this.mesh.material.uniforms.time+=i,this.mesh.material.uniforms.throttle=this.aircraft.afterBurner}createGeometry(){const t=[],i=[],s=[],n=[];for(let e=0;e<1;e++){for(let h=0;h<this.vertices.length;h++){const o=this.vertices[h];t.push((0,l.Cc)(0,o.x,(e+1)/1)),t.push((0,l.Cc)(0,o.y,(e+1)/1)),t.push(o.z),t.push((0,l.Cc)(0,1*o.x,(e+1)/1)),t.push((0,l.Cc)(0,1*o.y,(e+1)/1)),t.push(o.z+30),s.push(0),s.push(1),i.push(Math.exp(-e/1*7)),i.push(Math.exp(-e/1*7)),0!=h&&(n.push(e*this.vertices.length*2+2*h),n.push(e*this.vertices.length*2+2*h),n.push(e*this.vertices.length*2+2*(h-1)+1),n.push(e*this.vertices.length*2+2*h+1)),n.push(e*this.vertices.length*2+2*h),n.push(e*this.vertices.length*2+2*h+1)}n.push(e*this.vertices.length*2),n.push(e*this.vertices.length*2),n.push((e+1)*this.vertices.length*2-1),n.push(e*this.vertices.length*2+1)}const e=[];for(const t of this.vertices)e.push(t.x),e.push(t.y),e.push(t.z),i.push(1),s.push(0);const h=(0,Yh.Ay)(e,[],3),o=t.length/3;for(const t of h)n.push(o+t);t.push(...e);const r=new I.A;return r.setAttribute("position",new J.A(new Float32Array(t),3,Jh.FLOAT)),r.setAttribute("opacity",new J.A(new Float32Array(i),1,Jh.FLOAT)),r.setAttribute("offset",new J.A(new Float32Array(s),1,Jh.FLOAT)),r.setIndices(new J.A(new Uint16Array(n),1,Jh.UNSIGNED_SHORT)),r}}class to extends q.A{constructor(t={}){super(t)}getVertSource(){return"#version 300 es\n            \n    precision mediump float;\n\n    layout (location = 0) in vec3 position;\n    layout (location = 2) in vec2 uv;\n\n    uniform mat4 modelMatrix;\n    \n    uniform float aspectRatio;\n    uniform float width;\n\n    // out vec2 vUv;\n    // out vec3 vPosition;\n    // out vec3 vScreenPosition;\n\n    out vec2 vUv;\n    out vec2 vCoord;\n    out vec3 vPosition;\n\n    void main() {\n        vUv = uv;\n        vPosition = position;\n\n        vec3 adjustedPosition = vec3(width * 0.5 * sign(position.x) + position.x, position.y, position.x);\n        gl_Position = modelMatrix * vec4(adjustedPosition, 1.0);\n        vCoord = gl_Position.xy;\n        gl_Position.x /= aspectRatio;\n    }\n"}getUniforms(t){return{...super.getUniforms(t),width:1}}}class io extends E.A{constructor(t={}){super(t),this.size=t.size??new N.A(.1,.1),this.position=t.position??new a.A(0,.4,0),this.frameWidth=t.frameWidth??.005,this.mesh=new R.A,this.mesh.frustumCulled=!1,this.mesh.position.copy(this.position),this.frameGeometry=(0,T.ou)(this.size,this.frameWidth),this.frameMaterial=new to({color:b.QE,size:this.size}),this.frameMesh=new D.A(this.frameGeometry,this.frameMaterial),this.frameMesh.frustumCulled=!1,this.frameMesh.renderOrder=1,this.mesh.add(this.frameMesh),this.geometries=new Map,this.text="TEST",this.labelGeometry=this.createTextGeometry(this.text),this.labelMaterial=new q.A({color:b.QE.clone(),size:this.size}),this.labelMesh=new D.A(this.labelGeometry,this.labelMaterial),this.labelMesh.frustumCulled=!1,this.labelMesh.renderOrder=1,this.mesh.add(this.labelMesh),this.showTimer=0,this.blink=!1,this.blinkTimer=.3,this.isBlinking=!1}lateUpdate(t,i,s){this.mesh.visible=0<=this.showTimer,this.showTimer-=i,this.blink&&this.isBlinking&&(this.mesh.visible=!1),this.blinkTimer-=i,this.blinkTimer<=0&&(this.isBlinking=!this.isBlinking,this.blinkTimer=this.isBlinking?.3:.6)}show(t,i={}){this.text=t;let s=this.geometries.get(this.text);null==s&&(s=this.createTextGeometry(this.text),this.geometries.set(this.text,s)),this.labelMesh.geometry=s,this.frameMaterial.uniforms.width=s.boundingBox.max.x-s.boundingBox.min.x;const n=this.getColor(i.level??0);this.labelMesh.material.uniforms.color.copy(n),this.frameMesh.material.uniforms.color.copy(n),i.color&&(this.labelMesh.material.uniforms.color.copy(i.color),this.frameMesh.material.uniforms.color.copy(i.color)),this.blink=i.blink??!1,this.showTimer=i.duration??3}getColor(t){switch(t){case 0:return b.QE;case 1:return b.J4;case 2:return b.Gh;default:throw new Error}}createTextGeometry(t){return(0,T.CB)(t,{size:.04,align:T.oM,color:b.QE})}}var so=s(5931);const no=new a.A,eo=(new a.A,(new a.A).copy(n.OX),(new a.A).copy(n.OX),(new a.A).copy(n.OX),(new a.A).copy(n.OX),new r.A,new r.A,new a.A,[]),ho=[];class oo extends us{constructor(t,i,s={}){super(t,i,s),this.count=s.count??4,this.subTargets=[],this.subSeekers=[];for(let t=0;t<this.count;t++){const t=new ps(this.vehicle,this.controller,s);this.subSeekers.push(t),this.add(t)}const n=function(t,i){return t.position.distanceTo(this.target.position)<i.position.distanceTo(this.target.position)}.bind(this);this.queue=new so.A(n)}operate(t){if(!this.target)return void this.unlock();this.controller.worldQuaternion.vmult(n.OX,no),this.queue.clear(),this.game.getAllVehicles().forEach(t=>{if(t.iff===this.vehicle.iff||t.health<=0)return;const i=t.position.sub(this.controller.worldPosition),s=i.length();i.normalize();const n=Math.acos((0,l.qE)(no.dot(i)));this.maxRange<s||this.maxAngle<n||this.queue.push(t)}),ho.length=0,eo.length=0;const i=this.queue.length;for(let t=0;t<Math.min(i,this.count);t++)ho.push(this.queue.pop());for(const t of this.subSeekers){const i=ho.indexOf(t.target);0<=i?ho.splice(i,1):(t.setTarget(null),t.unlock(),eo.push(t))}for(const t of ho){if(eo.length<=0)break;eo.pop().setTarget(t)}this.targetSeeking=!1,this.targetLocking=!1;for(const i of this.subSeekers)i.operate(t),this.targetSeeking|=i.targetSeeking,this.targetLocking|=i.targetLocking}unlock(){this.targetSeeking=!1,this.targetLocking=!1;for(const t of this.subSeekers)t.unlock()}}class ro extends Ls{constructor(t,i={}){super(t,i),this.isAAM4Controller=!0,this.targets=[]}ws(t){super.ws(t),this.damage=t.damage??200,this.duration=t.duration??20}ps(t){this.muzzles=[],this.muzzleIndex=0;const i=t.muzzles??t.launchers??[];for(let t=i.length;t<4;t++)i.push({});for(const t of i){const i=this.gs(t);this.add(i),this.muzzles.push(i)}}createSeeker(t){this.seeker=new oo(this.vehicle,this,{count:4,maxRange:t.maxRange??6e3,...t}),this.add(this.seeker)}fire(){let t=!1;for(let i=0;i<4;i++){const s=this.seeker.subSeekers[i],n=s.targetLocking?s.target:null;n&&(this.Dn(n),t=!0)}t||this.Dn()}Dn(t){this.ammo<=0||this.muzzles[this.muzzleIndex].fire(t)&&(this.ammo--,this.muzzles.length-this.muzzleIndex<=this.ammo&&this.muzzles[this.muzzleIndex].recharge(),this.muzzleIndex++,this.muzzles.length<=this.muzzleIndex&&(this.muzzleIndex=0))}}class ao extends Ls{constructor(t,i={}){super(t,i),this.damage=i.damage??500,this.isBurstMissileController=!0,this.maxLockonDistance=i.maxLockonDistance??6e3}}new a.A(0,0,-1),new a.A(0,1,0),new a.A(0,1,0),new a.A(0,-1,0);const co=new r.A,lo=new r.A,uo=(new a.A,new a.A),fo=(new a.A,new a.A),vo=new a.A,mo=new a.A,wo=new a.A,po=new a.A;new a.A;class go extends ne{constructor(t,i,s){t.onGround=t.onGround??!1,super(t,i,s),this.type="aircraft",this.runway=null,this.runwayFormationPosition=new a.A,this.isLanding=t.isLanding??!1,this.isTakingoff=t.isTakingoff??!1,this.takeoffAltitudeAlpha=0,this.onGround=t.onGround??!1,this.maxRollRate=t.maxRollRate??3,this.movementManager.maxRollRate=this.maxRollRate,this.minSpeedAir=null==t.minSpeedAir?this.minSpeed:t.minSpeedAir,this.minTurnRadiusAir=null==t.minTurnRadiusAir?this.minTurnRadius:t.minTurnRadiusAir}ts(t){super.ts(t),this.lastElevator=0,this.lastAileron=0,this.lastRudder=0,this.lastThrottle=0,this.lastBrake=0,this.lastSteering=0,this.lastAfterBurner=0,this.lastAirbrake=0,this.elevator=0,this.aileron=0,this.rudder=0,this.driveInput=0,this.brakeInput=0,this.steerInput=0,this.afterBurner=0,this.airbrake=0,this.canBomb=t.canBomb??!1,this.bombingTarget=(new a.A).copy(t.bombingTarget??n.VT),this.isBombingFleeing=!1,this.gear=this.onGround?1:0,this.lastGear=this.gear}Os(t){super.Os(t)}Ks(t,i){super.Ks(t,i),this.updateGear(i)}Es(t){this.movementManager.setMinSpeed(this.onGround?0:this.minSpeed),this.isTakingoff&&this.leader?(this.movementManager.enableFollowMode(),this.takeoff(t)):!this.leader&&this.canBomb&&this.bombController?(this.movementManager.disableFollowMode(),this.bombing(t)):super.Es(t)}bombing(t){this.bombingTarget.sub(this.body.position,uo),uo.y=0;const i=uo.length();uo.normalize(),this.body.quaternion.vmult(n.OX,fo),fo.y=0,fo.normalize();const s=fo.dot(uo)<0&&i<this.movementManager.minTurnRadius+2e3,e=this.body.position.clone(),h=(s?-1:1)*this.movementManager.criticalTurnSpeed,o=uo.scale(h),r=this.bombingTarget.clone();r.y=1e3,this.movementManager.seekOnPlane(e,o,r,n.UP,t)}updateGear(t){this.lastGear=this.gear,this.isTakingoff&&this.takeoffAltitudeAlpha<=0?this.gear=Math.min(1,this.gear+.5*t):this.gear=Math.max(0,this.gear-.5*t)}takeoff(t){const i=this.runway.start.y+this.groundOffset;100<=this.position.y-i&&(this.isTakingoff=!1),this.minSpeed<this.velocity.length()&&(this.onGround=!1,this.movementManager.setMinSpeed(this.minSpeed));const s=Math.acos((0,l.qE)(this.runway.direction.dot(n.OX)));co.setFromAxisAngle(n.PX,s),co.conjugate(lo),this.leader.position.sub(this.runway.start,wo),lo.vmult(wo,wo),this.position.sub(this.runway.start,po),lo.vmult(po,po),!this.onGround&&po.z<wo.z&&(this.isTakingoff=!1);const e=Math.min(po.z,wo.z+this.runwayFormationPosition.z);vo.set(this.runwayFormationPosition.x,0,e),co.vmult(vo,vo),this.runway.start.add(vo,vo),vo.y=Math.max(this.leader.position.y,i);const h=Math.max(this.runway.direction.dot(this.leader.velocity),0);this.runway.direction.scale(h,mo),this.movementManager.seek(vo,mo,t)}clone(t={}){return new go(t,this.mesh.clone(),this.collider.clone())}getG(t,i){const s=t/(2*Math.PI)*60,n=Math.PI/this.turnRate*i/Math.PI/4;return 4*Math.pow(Math.PI,2)*s*n/3600}Qs(t){this.bombController&&this.bombController.autoFire(),super.Qs(t)}}const xo=new a.A(0,0,-1),Mo=new a.A(0,1,0),So=new a.A(1,0,0),yo=new a.A(7.35,.1,4.5),_o=new a.A(-7.35,.1,4.5),Po=new a.A,Ao=new r.A,Do=new a.A,qo=new a.A,To=new a.A,Eo=new a.A,Co=new a.A,bo=new a.A,Uo=new a.A,No=new a.A,Ro=new a.A,Io=new a.A,zo=new a.A,Lo=new r.A,Fo=new a.A,Oo=new a.A;new a.A;class Vo extends go{constructor(t,i,s,n,e){super(t,i,s),this.playerController=n,this.spWeaponMeshes=e,this.createEffects(t),this.initGear(t),this.availableSPWeapons=t.availableSPWeapons??[],this.selectedSPWeapon=t.selectedSPWeapon,this.setSPWeapon(this.selectedSPWeapon),this.selectedSubWeapon=this.missileController,this.vapourTrails=t.vapourPosition,this.vapourPosition=new a.A,this.acceleration=new a.A,this.lastAcceleration=new a.A,this.jetSound=null,this.afterBurnerSound=null,this.windSound=null,this.jetSoundPlaybackRate=1,this.afterBurnerVolume=0,this.enabledUpgrades={};for(const t in y)this.enabledUpgrades[t]=!1;this.driveInput=0,this.game=null,this.throttle=0,this.elevator=0,this.aileron=0,this.rudder=0,this.brake=0,this.isAnchorEnabled=!1,this.anchorPositionPlane=new a.A,this.anchorDirectionPlane=new a.A,this.isPathEnabled=!1,this.path=null,this.t=0,this.engineSound=new $h(this.body.interpolatedPosition,this.body.interpolatedVelocity,100),this.engineSoundPlaybackRate=0,this.engineSound.start(),this.afterBurnerSound=new Wh(this.body.interpolatedPosition,this.body.interpolatedVelocity,100),this.afterBurnerSoundVolume=0,this.afterBurnerSound.start(),this.windSound=new Xh(this.body.interpolatedPosition,this.body.interpolatedVelocity,1e3),this.windSound.setPlaybackRate(.25),this.windSound.start(),this.audios=[this.engineSound,this.afterBurnerSound,this.windSound]}initProperties(){super.initProperties(),this.isPlayerAircraft=!0}$s(t){return 1e3}Os(t){const i=(0,l.bk)(this.collider);this.body=new mt.A({type:mi.E3,shape:i,mass:t.mass??1e4,inertia:t.inertia??1e3,centerOfMassLocal:t.centerOfMassLocal,collisionFilterGroup:Ii.N7.VEHICLE|Ii.N7.PLAYER_VEHICLE|this.iff<<8,collisionFilterMask:Ii.N7.LARGE_VEHICLE|Ii.N7.TERRAIN|Ii.N7.TERRAIN_OBJECT|Ii.N7.WEAPON}),this.body.actor=this,this.referBodyTransforms(),this.body.onCollision=function(t){const i=Math.floor(t.impulse/300);i&&this.applyDamage(i)}.bind(this)}setSPWeapon(t){this.spWeaponMesh&&this.mesh.remove(this.spWeaponMesh),this.spWeaponController&&this.remove(this.spWeaponController);for(const i of this.availableSPWeapons){if(i.type!==t)continue;const s={active:!1,...i};switch(s.type){case he:this.spWeaponController=new ao(this,s);break;case oe:this.spWeaponMesh=this.spWeaponMeshes[oe].clone(),s.mesh=this.spWeaponMesh,this.spWeaponController=new An(this,s),s.muzzles&&this.spWeaponMesh.position.copy(s.muzzles[0].position);break;case"4-mssl":this.spWeaponController=new ro(this,s);break;default:throw new Error(`No weapon found: ${s.type}`)}this.selectedSPWeapon=t,this.add(this.spWeaponController);break}}refill(){this.gunController&&this.gunController.refill(),this.missileController&&this.missileController.refill(),this.spWeaponController&&this.spWeaponController.refill(),this.health=this.maxHealth}ws(t){super.ws(t),this.pitchForce=t.pitchForce??1,this.rollForce=t.rollForce??1,this.yawForce=t.yawForce??1,this.angularDamping=t.angularDamping??.1,this.thrustForce=t.thrustForce??10,this.brakeForce=t.brakeForce??10,this.drag=t.drag??.02,this.airbrakeDrag=t.airbrakeDrag??.1,this.wingLift=t.wingLift??.125,this.wingDrag=t.wingDrag??.0015,this.criticalAoA=t.criticalAoA??Math.PI/12,this.stallDecay=t.stallDecay??6}initGear(t){this.raycastVehicle=new Zh.A(this.body);for(const i of t.wheels)this.raycastVehicle.addWheel(i);this.onGround?(this.body.velocity.set(0,0,0),this.gearDown=!0,this.gear=1):(this.gearDown=!1,this.gear=0),this.lastGear=this.gear}ts(t){super.ts(t),this.limitter=!0,this.throttleIncreaseSpeed=0,this.gForce=0,this.restoreForce=new a.A,this.gravityForce=new a.A,this.lastVelocity=new a.A,this.wingPressure=0,this.localLinearVelocity=new a.A,this.localAngularVelocity=new a.A,this.localLinearForce=new a.A,this.localVelocityDirection=new a.A,this.speed=0,this.spWeaponSelected=!1,this.onGround=t.onGround??!1,this.isStalling=!1,this.parkingBrake=!1,this.localAngularImpulse=new a.A,this.restoreAxis=new a.A}getSPWeapon(){return this.spWeapon}changeSPWeapon(t){const i=this.weapons.indexOf(this.spWeapon);0<=i&&this.weapons.splice(i,1),this.spWeapon=this.setSPWeapon(t),this.weapons.push(this.spWeapon)}createEffects(t){this.wingTrailInterval=1/80,this.wingTrailAccumulator=0,this.afterBurners=[];for(const i of t.engines??[]){const t=this.createVertices(i.vertices);for(const s of i.nozzles){const i=new Qh(t,(new a.A).copy(s.position),(new a.A).copy(s.direction),this);this.afterBurners.push(i),this.add(i)}}this.vapourTrailRight=new Ts({radius:.2,initialRadius:.1,initialColor:new P.A(1,1,1,0)}),this.vapourTrailLeft=new Ts({radius:.2,initialRadius:.1,initialColor:new P.A(1,1,1,0)})}createVertices(t){const i=[];for(const s of t)i.push((new a.A).copy(s));return i}createWingTrail(){return new Ts({radius:.5,initialColor:new P.A(.95,.95,.95,1.5),finalColor:new P.A(.95,.95,.95,1.5),maxInstances:1e3,timeFactor:.5,useAngleAlpha:!1})}onAdded(){super.onAdded(),this.game.add(this.vapourTrailRight),this.game.add(this.vapourTrailLeft)}onRemoved(){super.onRemoved(),this.vapourTrailRight.isEmitterRemoved=!0,this.vapourTrailLeft.isEmitterRemoved=!0}update(t,i){if(super.update(t,i),this.fireMissileBooked||(this.fireMissileBooked=this.playerController.fireMissile),this.changeTargetBooked||(this.changeTargetBooked=this.playerController.changeTarget),this.playerController.changeWeapon){const t=this.spWeaponSelected?this.spWeaponController:this.missileController,i=this.spWeaponSelected?this.missileController:this.spWeaponController;if(0<i.ammo){this.spWeaponSelected=!this.spWeaponSelected,this.selectedSubWeapon=i;const s=this.spWeaponSelected?re[this.selectedSPWeapon].label:"STDM";t.deactivate(),i.activate(),this.game.hud.showAircraftAlert(s)}else this.game.hud.showAircraftAlert("NO AMMO",{level:2})}const s=this.game.terrain.runways[0];s&&(this.cameraLookTarget=s.center)}fixedUpdate(t,i){super.fixedUpdate(t,i),this.updateVapourTrails(i);const s=.5+.75*this.throttle;this.engineSoundPlaybackRate=(0,l.Cc)(this.engineSoundPlaybackRate,s+.25*this.afterBurner,1-Math.exp(2*-i)),this.engineSound.setVolume(1),this.engineSound.setPlaybackRate(this.engineSoundPlaybackRate),this.afterBurnerSoundVolume=(0,l.Cc)(this.afterBurnerSoundVolume,this.afterBurner,1-Math.exp(2*-i)),this.afterBurnerSound.setVolume(7.5*this.afterBurnerSoundVolume);const n=1-Math.exp(.01*-this.body.velocity.length()),e=Math.cbrt(n);this.windSound.setPlaybackRate(n),this.windSound.setVolume(1*e),this.ray.start.copy(this.body.previousPosition),this.ray.end.copy(this.body.position),this.ray.updateDirectionAndLength(),this.ray.intersectsWorld(this.game.world,this.raycastResult),this.raycastResult.hasHit&&this.explode()}updateVapourTrails(t){this.body.previousVelocity.sub(this.body.velocity,zo),this.body.quaternion.conjugate(Lo).vmult(zo,zo),zo.scale(1/t,zo);const i=(1-Math.exp(.01*-this.body.velocity.length()))*(1-Math.exp(.02*-Math.max(Math.abs(zo.y)-50,0)))*(.65+.7*Math.random())*1.5;this.body.quaternion.vmult(yo,this.vapourPosition),this.body.position.add(this.vapourPosition,this.vapourPosition),this.vapourTrailRight.updateSmoke(this.vapourPosition,i),this.body.quaternion.vmult(_o,this.vapourPosition),this.body.position.add(this.vapourPosition,this.vapourPosition),this.vapourTrailLeft.updateSmoke(this.vapourPosition,i)}Ys(t,i){this.throttle=0,this.afterBurner=0,super.Ys(t,i)}Ks(t,i){this.updateInputs(i),this.isAnchorEnabled?this.fixOnAnchor():this.isPathEnabled?this.tracePath(i):this.destroyed||(this.Js(t,i),this.applyForces(t,i),this.updateGear(i),this.Qs(t,i)),this.updateRaycastVehicle(i,t)}updateRaycastVehicle(t,i){this.raycastVehicle.setSteer(-this.rudder),this.raycastVehicle.setBrake(this.brake);for(const t of this.raycastVehicle.wheels)t.active=.5<this.gear}snapToGround(){}updateInputs(t){if(this.lastThrottle=this.throttle,this.lastElevator=this.elevator,this.lastAileron=this.aileron,this.lastRudder=this.rudder,this.onGround=!1,.5<this.gear)for(const t of this.raycastVehicle.wheels)t.raycastResult.hasHit&&(this.onGround=!0);this.throttle<=0||.5<=this.brake?this.brake=this.playerController.throttleDown:this.brake=0,this.airbrake=this.brake,this.throttle+=(1+this.brake)*this.playerController.throttleUp*t*1,this.throttle-=this.playerController.throttleDown*t*1;const i=1-Math.exp(5*-t);1<=this.throttle?this.afterBurner=(0,l.Cc)(this.afterBurner,this.playerController.throttleUp,i):this.afterBurner=(0,l.Cc)(this.afterBurner,0,i),this.throttle=(0,l.qE)(this.throttle,0,1);this.elevator=Math.pow(Math.abs(this.playerController.elevator),1.5)*Math.sign(this.playerController.elevator),this.aileron=Math.pow(Math.abs(this.playerController.aileron),1.5)*Math.sign(this.playerController.aileron),this.rudder=Math.pow(Math.abs(this.playerController.rudder),1.5)*Math.sign(this.playerController.rudder),this.playerController.toggleGear&&!this.onGround&&(this.gearDown=!this.gearDown,this.playerController.toggleGear=!1)}applyForces(t,i){this.body.quaternion.conjugate(Lo),Lo.vmult(this.body.velocity,this.localLinearVelocity),Lo.vmult(this.body.angularVelocity,this.localAngularVelocity),this.updateLinearVelocity(i),this.updateAngularVelocity(i),this.body.quaternion.vmult(this.localLinearVelocity,this.body.velocity),this.body.quaternion.vmult(this.localAngularVelocity,this.body.angularVelocity)}static LIFT_FACTOR=2;applyGravity(t){const i=this.body.quaternion.conjugate().vmult(this.body.velocity);i.y=0,i.normalize(),this.body.velocity.y-=10*t;const s=this.body.quaternion.conjugate().vmult(this.body.velocity);s.y=0,s.normalize()}updateLinearVelocity(t){const i=this.drag*(1+1*this.gear)+this.airbrakeDrag*this.airbrake;this.isStalling=!1;const s=this.localLinearVelocity.length();this.localVelocityDirection.copy(this.localLinearVelocity),this.localVelocityDirection.normalize(),this.localLinearVelocity.x*=Math.exp(-Math.abs(.0075*s,2)*t),this.localLinearVelocity.y*=Math.exp(-Math.abs(.015*s,2)*t),this.localLinearVelocity.z*=Math.exp(-Math.abs(1e-5*s*i)*t),this.localLinearVelocity.z=Math.max(Math.abs(this.localLinearVelocity.z)-this.airbrakeDrag*this.airbrake*.02,0)*Math.sign(this.localLinearVelocity.z),this.localLinearForce.setZero(),this.localLinearForce.z-=this.thrustForce*(this.throttle+.5*this.afterBurner),this.localLinearVelocity.add(this.localLinearForce.scale(t,Io),this.localLinearVelocity),this.localVelocityDirection.copy(this.localLinearVelocity).normalize(),this.speed=this.body.velocity.length()}dampSpeed(t,i,s){return t*Math.exp(-i*s)}getDrag(t,i){return.3*(Math.abs(this.localLinearVelocity.dot(t))/this.localLinearVelocity.length())*i}getLift(t,i,s,n){if(t.cross(i,qo).normalize(),qo.scale(qo.dot(this.localLinearVelocity),Fo),this.localLinearVelocity.sub(Fo,Fo),Fo.isZero())return new a.A;const e=Math.acos((0,l.qE)(t.dot(Fo)/Fo.length())),h=this.getLiftCoefficient(e,n);return qo.cross(Fo,Oo).normalize(),Oo.scale(h*Math.pow(Fo.length()*s,2)*-Math.sign(Fo.dot(i)))}getLiftCoefficient(t,i=Math.PI/8){const s=Math.abs(t),n=0<=t?1:-1;return s<=i?s*n:(this.isStalling=!0,s*Math.exp(-(s-i)*this.stallDecay)*n)}updateAngularVelocity(t){this.localAngularVelocity.sub(this.localAngularImpulse,this.localAngularVelocity),this.localAngularVelocity.sub(this.gravityForce,this.localAngularVelocity);const i=.75*this.getAngularForce(),s=i*this.elevator,n=i/8*-this.rudder,e=4*i*-this.aileron;Eo.set(s,n,e);const h=1-Math.exp(.005*-this.localLinearVelocity.length());this.localAngularVelocity.lerp(Eo,1-Math.exp(5*-h*t),this.localAngularVelocity);const o=10*this.body.quaternion.vmult(So,Ro).y,r=-this.localLinearVelocity.z,a=1-Math.exp(-Math.abs(r)*Vo.SPEED_INCREASE_FACTOR),c=0==r?0:(0,l.qE)(o/r,-a,a);Mo.scale(c,this.gravityForce);{const t=.01*this.localLinearVelocity.length(),i=10;Co.set(0,this.localLinearVelocity.y,this.localLinearVelocity.z).normalize();const s=Math.acos((0,l.qE)(-Co.z))*Math.sign(Co.y);this.isStalling=this.criticalAoA<Math.abs(s);const n=(0,l.QS)(s,this.criticalAoA);Ao.setFromAxisAngle(So,n).normalize(),Ao.vmult(Mo,Uo).normalize();const e=Co.dot(Uo)*(1-Math.exp(-t))*Math.abs(Uo.dot(Mo))*i;bo.set(this.localLinearVelocity.x,0,this.localLinearVelocity.z).normalize();const h=Math.acos((0,l.qE)(-bo.z))*Math.sign(bo.x),o=(0,l.QS)(h,this.criticalAoA);Ao.setFromAxisAngle(Mo,-o).normalize(),Ao.vmult(So,No).normalize();const r=bo.dot(No)*(1-Math.exp(-t))*Math.abs(No.dot(So))*i;this.localAngularImpulse.set(e,-r,0)}this.localAngularVelocity.add(this.localAngularImpulse,this.localAngularVelocity),this.localAngularVelocity.add(this.gravityForce,this.localAngularVelocity),xo.cross(this.localLinearVelocity,this.restoreAxis).normalize()}static ANGULAR_FACTOR=1.5;static SPEED_INCREASE_FACTOR=.015;static SPEED_ATTENUATE_FACTOR=.001;static POST_STALL_FORCE=1.5;getAngularForce(t){const i=this.localLinearVelocity.length();return(1-Math.exp(-i*Vo.SPEED_INCREASE_FACTOR))/(1+i*Vo.SPEED_ATTENUATE_FACTOR)+(this.limitter?0:Vo.POST_STALL_FORCE)}Js(t,i){if(this.target){const t=this.body.position.distanceTo(this.target.body.position);(this.detectionRange<t||this.target.destroyed||this.target.health<=0)&&(this.target=null)}this.target&&!this.changeTargetBooked||(this.changeTarget(t,i),this.changeTargetBooked=!1)}updateGear(t){if(this.lastGear=this.gear,this.gearDown?this.gear=Math.min(1,this.gear+.5*t):this.gear=Math.max(0,this.gear-.5*t),this.gear<.5&&this.position.y<150&&this.velocity.y<0){let t=!1;for(const i of this.scene.terrain.runways){i.touchDown.vsub(this.position,Po);if(1e4<Po.length())continue;Po.normalize();const s=Math.acos((0,l.qE)(i.direction.dot(Po)));30*l.up<s||(t=!0)}}}changeTarget(t,i){this.quaternion.vmult(xo,To).normalize();let s=-1/0,n=null;t.getAllVehicles().forEach(t=>{if(t.numTargetSkipped||(t.numTargetSkipped=0),t.numTargetSkipped+=1,t==this.target||t.iff==this.iff||t.health<=0)return;const i=t.body.position.vsub(this.body.position),e=i.length();if(this.detectionRange<e)return;i.normalize();const h=Math.acos((0,l.qE)(To.dot(i),-1,1)),o=1-2*Math.exp(-t.numTargetSkipped)+0*Math.exp(-e)+(1-h/Math.PI);s<o&&(s=o,n=t)}),n&&(n.numTargetSkipped=0,this.target=n)}getLockon(){if(!this.target)return!1;const t=this.body.quaternion.conjugate().vmult(this.target.body.position.vsub(this.body.position)),i=t.length();t.normalize();const s=Math.acos(-t.z);return i<=5e3&&s<=.5}fireMissile(){this.missileController.fire()}fireSpWeapon(){this.spWeaponController.fire()}updateGForce(t,i,s){const n=this.body.quaternion.vmult(t).vsub(this.body.velocity).scale(1/s).add(i.world.gravity),e=this.body.quaternion.conjugate().vmult(n);this.gForce=Math.abs(e.y/i.world.gravity.length())}copy(){const t=this.mesh.clone();return new this.constructor(this.props,t,this.playerController,this.model,this.colliderModel)}Qs(t,i){this.playerController.fireGun&&this.gunController&&(this.gunController.fire(),this.gunController.ammo<=0&&this.game.hud.showAircraftAlert("NO AMMO",{level:2}));const s=this.spWeaponSelected?this.spWeaponController:this.missileController;s&&(s.operate(this.target,i),this.fireMissileBooked&&s.fire&&(s.fire(),s.ammo<=0&&this.game.hud.showAircraftAlert("NO AMMO",{level:2})),this.playerController.keepFiring&&s.keepFiring&&(s.keepFiring(i),s.ammo<=0&&this.game.hud.showAircraftAlert("NO AMMO",{level:2}))),this.fireMissileBooked=!1}updateAcceleration(t){this.lastAcceleration.copy(this.acceleration),this.body.velocity.vsub(this.body.previousVelocity,Po),Po.scale(1/t,Po),this.acceleration.lerp(Po,t,this.acceleration)}lateUpdate(t,i,s){super.lateUpdate(t,i,s),this.raycastVehicle.updateVisual(),this.isStalling&&10<this.body.velocity.length()?this.scene.hud.showAircraftAlert("STALL",{level:1,duration:0}):this.gearDown&&n.g5<this.position.y&&n.fH<this.velocity.length()?this.scene.hud.showAircraftAlert("GEAR UP",{duration:.1,blink:!0,color:b.J4}):!this.gearDown&&this.position.y<n.g5&&this.velocity.y<0&&this.scene.hud.showAircraftAlert("PULL UP",{duration:.1,blink:!0,color:b.J4})}updateDestroyedCameraTransform(){this.delayedCameraPosition=new a.A(200,100,200),this.delayedCameraQuaternion=(new THREE.Quaternion).setFromEuler(new THREE.Euler(-Math.PI/9,Math.PI/4,0,"YXZ"))}updateMissileCameraTransform(){const t=this.lastFiredMissile,i=(new THREE.Quaternion).setFromEuler(new THREE.Euler(Math.PI/2*this.game.playerController.cameraViewVertical,-Math.PI*this.game.playerController.cameraViewHorizontal,0,"YXZ")),s=(new r.A).copy(t.body.quaternion).mult(i);this.delayedCameraQuaternion.slerp((new r.A).copy(s),.1,this.delayedCameraQuaternion);const n=(new a.A).copy(t.cameraPosition);n.applyQuaternion(this.delayedCameraQuaternion),this.delayedCameraPosition=n}destroy(){super.destroy(),this.body.collisionFilterMask^=Ii.m1,this.game.hud.aircraftAlert.show("EJECT",{level:2,blink:!0,duration:1/0}),this.game.stopMusic()}explode(){super.explode(),this.game.gameover()}getSPWeaponController(){return this.spWeaponController}enableAnchor(t,i){this.isAnchorEnabled=!0,this.body.position.copy(t),this.anchorPositionPlane.copy(t),this.anchorPositionPlane.y=0,this.body.quaternion.copy(i),i.vmult(xo,this.anchorDirectionPlane),this.anchorDirectionPlane.y=0,this.anchorDirectionPlane.normalize(),this.body.velocity.setZero(),this.body.angularVelocity.setZero()}disableAnchor(){this.isAnchorEnabled=!1}fixOnAnchor(){this.body.quaternion.vmult(xo,Do),Do.y=0,Do.normalize();const t=Math.acos((0,l.qE)(Do.dot(this.anchorDirectionPlane)));Do.cross(this.anchorDirectionPlane,qo),qo.normalize(),Ao.setFromAxisAngle(qo,t),Ao.normalize(),this.body.quaternion.mult(Ao,this.body.quaternion),this.body.quaternion.normalize(),this.body.position.x=this.anchorPositionPlane.x,this.body.position.z=this.anchorPositionPlane.z}enablePath(t){this.isPathEnabled=!0,this.path=t,this.t=0}disablePath(){this.isPathEnabled=!1}tracePath(t){this.path.getTransform(t,this.body.position,this.body.quaternion,this.body.velocity)}applyDamage(t,i){super.applyDamage(t,i),this.scene.hud.showAircraftAlert("DAMAGED",{level:2})}getExplodeTime(){return 5}}class ko extends q.A{constructor(t={}){super(t),this.transparent=!0,this.depthTest=!1,this.depthWrite=!1}getVertSource(){return"#version 300 es\n        \n    precision mediump float;\n\n    layout (location = 0) in vec3 position;\n    layout (location = 2) in vec2 uv;\n\n    uniform mat4 modelMatrix;\n    uniform mat4 viewMatrix;\n    uniform mat4 projectionMatrix;\n\n    uniform float aspectRatio;\n\n    uniform mat4 rollMatrix;\n\n    const vec4 UP = vec4(0.0, 1.0, 0.0, 0.0);\n\n    vec3 rotate(vec3 p, float angle) {\n        return vec3(\n            + p.x * cos(angle) + p.y * sin(angle),\n            - p.x * sin(angle) + p.y * cos(angle),\n            0.0\n        );\n    }\n\n    void main() {\n        vec3 up = (viewMatrix * UP).xyz;\n        up = normalize(vec3(up.x, up.y, 0.0));\n        float angle = acos(clamp(up.y, -1.0, 1.0)) * sign(up.x);\n\n        vec4 projectedCenter = projectionMatrix * viewMatrix * modelMatrix * vec4(0.0, 0.0, 0.0, 1.0);\n        projectedCenter.xyz /= projectedCenter.w;\n\n        vec3 rotatedPosition = rotate(position, angle);\n        rotatedPosition.x /= aspectRatio;\n\n        gl_Position.xyz = projectedCenter.xyz + rotatedPosition;\n        gl_Position.w = 1.0;\n    }\n"}getFragSource(){return"#version 300 es\n        \n    precision mediump float;\n\n    uniform vec4 color;\n\n    out vec4 gDiffuse;\n\n    void main() {\n        gDiffuse = color;\n    }\n"}getUniforms(t){return{modelMatrix:new Mt.A,viewMatrix:new Mt.A,projectionMatrix:new Mt.A,rollMatrix:new Mt.A,aspectRatio:1,color:t.color?t.color.clone():oh.QE.clone(),scissorMin:this.scissorMin??new N.A,scissorMax:this.scissorMax??new N.A}}}class Go extends q.A{constructor(t={}){super(t),this.vertexShader=this.getVertexShader(),this.fragmentShader=this.getFragmentShader(),this.uniforms=this.getUniforms(t),this.transparent=!0,this.depthTest=!!t.depthTest&&t.depthTest,this.depthWrite=!!t.depthWrite&&t.depthWrite,this.props=t}getVertexShader(){return"\n    uniform vec2 offset;\n\n    void main() {\n        vec4 viewPosition = modelViewMatrix * vec4(0.0, 0.0, 0.0, 1.0);\n        viewPosition.xy -= position.xy * (viewPosition.z * 0.5);\n        gl_Position = projectionMatrix * viewPosition;\n    }\n"}getFragmentShader(){return"\n    uniform vec4 color;\n\n    void main() {\n        gl_FragColor = color;\n    }\n"}getUniforms(t){return{aspectRatio:{value:window.innerWidth/window.innerHeight},color:{value:t.color??new Vec4}}}}const Bo=WebGL2RenderingContext,Ho=(new a.A,new a.A);new c.A;class jo extends E.A{constructor(t={}){super(t),this.mesh=new R.A,this.mesh.frustumCulled=!1,this.geometry=this.createGeometry(),this.geometry.translate(0,-.2,0),this.material=new ko({color:b.QE.clone()}),this.markerMesh=new D.A(this.geometry,this.material),this.markerMesh.frustumCulled=!1,this.mesh.add(this.markerMesh),this.labelGeometry=(0,T.CB)("BASE",{size:.06,align:T.oM,color:b.QE}),this.labelGeometry.translate(0,.225,0),this.labelMesh=new D.A(this.labelGeometry,this.material),this.labelMesh.frustumCulled=!1,this.mesh.add(this.labelMesh)}createGeometry(){const t=new I.A,i=[-.05,.355,0,.05,.355,0,.05,.295,0,0,.245,0,-.05,.295,0,-.04,.345,0,.04,.345,0,.04,.299142136,0,0,.25914213599999997,0,-.04,.299142136,0];return t.setAttribute("position",new J.A(new Float32Array(i),3,Bo.FLOAT)),t.setIndices(new J.A(new Uint16Array([9,0,4,9,5,0,8,4,3,8,9,4,6,0,5,6,1,0,2,8,3,2,7,8,1,7,2,1,6,7]),1,Bo.UNSIGNED_SHORT)),t}lateUpdate(t,i){const s=this.game.mainCamera,e=this.game.terrain.runways[0];if(!e)return;s.quaternion.toEuler("YXZ",Ho),this.material.uniforms.rollMatrix.makeRotation(n.IU,-Ho.z),this.mesh.position.copy(e.center);const h=this.mesh.position.distanceTo(this.game.mainCamera.position),o=1-Math.exp(.025*-Math.max(h-250));this.material.uniforms.color.w=o}getLabelMesh(t){const i=(0,T.bY)({text:t,size:.03});return i.material=new Go,i}}jo.SIZE=new N.A(.5,.5),jo.HALF_SIZE=new N.A(jo.SIZE.x/2,jo.SIZE.y/2),jo.POSITION=new a.A(-1.3,-.6,0),jo.CENTER_OFFSET=new a.A(0,-.1,0);class Wo extends E.A{constructor(t={}){super(t),this.focusable=!1,this.size=t.size??new N.A(2,.2),this.position=t.position??new a.A(0,-.8,0),this.mesh=new R.A,this.geometries=new Map,this.labelGeometry=this.createTextGeometry("TEST"),this.labelMaterial=new q.A({color:b.QE.clone(),size:this.size,transparent:!0}),this.labelMesh=new D.A(this.labelGeometry,this.labelMaterial),this.labelMesh.frustumCulled=!1,this.labelMesh.renderOrder=1,this.mesh.add(this.labelMesh),this.mesh.frustumCulled=!1,this.mesh.renderOrder=1,this.mesh.position.copy(this.position),this.mesh.visible=!1,this.toShow=function(t){return!1},this.theta=0}lateUpdate(t,i,s){this.mesh.visible=this.toShow(t),this.theta=(this.theta+3*i)%(2*Math.PI);const n=Math.max(0,Math.sin(this.theta));this.labelMesh.material.uniforms.color.w=1-n}setText(t){let i=this.geometries.get(t);null==i&&(i=this.createTextGeometry(t),this.geometries.set(t,i)),this.labelMesh.geometry=i,this.theta=Math.PI/2}show(t){this.setText(t),this.mesh.visible=!0}hide(){this.toShow=function(t){return!1}}createTextGeometry(t){return(0,T.CB)(t,{size:.04,align:T.oM,color:b.QE})}}const $o=.06,Xo=new N.A(2.5,.1),Zo=new a.A(0,.45,0),Yo=new N.A(.04,.04);class Ko extends E.A{constructor(t={}){super(t),this.focusable=!1,this.size=t.size??this.getSize(),this.position=t.position??this.getPosition(),this.mesh=new R.A,this.mesh.position.copy(this.position),this.mesh.visible=!1,this.background=new uh,this.add(this.background),this.labelGeometry=this.createTextGeometry("TEST"),this.labelMaterial=new q.A({color:new P.A(1,1,1,1),size:this.size}),this.labelMesh=new D.A(this.labelGeometry,this.labelMaterial),this.labelMesh.frustumCulled=!1,this.labelMesh.renderOrder=2,this.mesh.add(this.labelMesh),this.geometries=new Map,this.displayCount=0}getSize(){return Xo.clone()}getPosition(){return Zo.clone()}fixedUpdate(t,i){this.displayCount-=i,this.displayCount<=0&&(this.mesh.visible=!1)}show(t,i={}){const s=this.geometries.get(t)??eh(t,{size:$o,align:T.oM,color:new P.A(0,1,0,1)});this.geometries.set(t,s),this.labelMesh.geometry=s,this.displayCount=i.duration??3,this.mesh.visible=!0,this.labelMaterial.uniforms.color.copy(i.color??b.uL),i.padding=i.padding??Yo,this.background.fitToMesh(this.labelMesh,i)}getTextSize(){return $o}createTextGeometry(t){return(0,T.CB)(t,{size:$o,align:T.oM,color:new P.A(0,1,0,1)})}}class Jo extends Zi.Ay{constructor(t,i,s=1){super(Xi.A.MISSILE_ALERT,t,i,s),this.loop=!0,this.loopEnd=2.15,this.volume=2}}const Qo=WebGL2RenderingContext,tr=new a.A(0,0,1);function ir(t,i,s=oh.MX){const n=.5*s,e=i.clone().sub(t).normalize(),h=tr.cross(e).normalize();h.scale(n,h);const o=t.add(h),r=t.sub(h),a=i.add(h),c=i.sub(h),l=[o.x,o.y,o.z,r.x,r.y,r.z,a.x,a.y,a.z,c.x,c.y,c.z],u=new I.A;return u.setAttribute("position",new J.A(new Float32Array(l),3,Qo.FLOAT)),u.setIndices(new J.A(new Uint16Array([0,1,2,1,3,2]),1,Qo.UNSIGNED_SHORT)),u}function sr(t,i,s=oh.MX){const n=.5*s,e=[],h=t.length-1,o=i?t.length:t.length-1;for(let s=0;s<o;s++){const o=s,r=s==h?0:s+1,c=t[o],l=t[r],u=t[o-1]??t[h],f=t[r+1]??t[0],d=l.clone().sub(c).normalize(),v=tr.cross(d).normalize(),m=new a.A;if(0<s||0==s&&i){const t=u.sub(c).normalize(),i=d.add(t).normalize(),s=v.dot(i);i.scale(n/s,m)}else v.scale(n,m);const w=new a.A;if(s<h||s==h&&i){const t=l.sub(f).normalize(),i=d.add(t).normalize(),s=v.dot(i);i.scale(n/s,w)}else v.scale(n,w);const p=c.add(m),g=c.sub(m),x=l.add(w),M=l.sub(w),S=[p.x,p.y,p.z,g.x,g.y,g.z,x.x,x.y,x.z,M.x,M.y,M.z],y=[0,1,2,1,3,2],_=new I.A;_.setAttribute("position",new J.A(new Float32Array(S),3,Qo.FLOAT)),_.setIndices(new J.A(new Uint16Array(y),1,Qo.UNSIGNED_SHORT)),e.push(_)}return hh(e)}const nr=WebGL2RenderingContext,er=.001875;class hr extends E.A{constructor(t={}){super(t),this.halfWidth=this.size.x/2,this.halfHeight=this.size.y/2,this.vertical=t.vertical??!1,this.geometry=this.createGeometry(),this.material=new q.A({color:b.QE}),this.mesh=new D.A(this.geometry,this.material),this.mesh.frustumCulled=!1,this.mesh.renderOrder=1,this.mesh.position.copy(this.position),this.barGeometry=new A.A(this.size.x,this.size.y),this.vertical?this.barGeometry.translate(0,this.halfHeight,0):this.barGeometry.translate(this.halfWidth,0,0),this.barMaterial=new q.A({color:new P.A(.3,1,.6,.5),transparent:!0}),this.barMesh=new D.A(this.barGeometry,this.barMaterial),this.vertical?this.barMesh.position.y=-this.halfHeight:this.barMesh.position.x=-this.halfWidth,this.barMesh.frustumCulled=!1,this.mesh.add(this.barMesh),this.alpha=1}createGeometry(){const t=new I.A,i=[-this.halfWidth-er,+this.halfHeight+er,0,-this.halfWidth+er,+this.halfHeight-er,0,+this.halfWidth+er,+this.halfHeight+er,0,+this.halfWidth-er,+this.halfHeight-er,0,+this.halfWidth+er,-this.halfHeight-er,0,+this.halfWidth-er,-this.halfHeight+er,0,-this.halfWidth-er,-this.halfHeight-er,0,-this.halfWidth+er,-this.halfHeight+er,0];return t.setAttribute("position",new J.A(new Float32Array(i),3,nr.FLOAT)),t.setIndices(new J.A(new Uint16Array([0,1,2,2,1,3,2,3,4,4,3,5,4,5,6,5,7,6,6,1,0,6,7,1]),1,nr.UNSIGNED_SHORT)),t}set(t){this.alpha=t}lateUpdate(t,i){this.vertical?this.barMesh.scale.y=this.alpha:this.barMesh.scale.x=this.alpha}}const or=WebGL2RenderingContext,rr=.001875;class ar extends E.A{constructor(t={}){super(t),this.halfWidth=this.size.x/2,this.halfHeight=this.size.y/2,this.vertical=t.vertical??!1,this.geometry=this.createGeometry(),this.material=new q.A({color:b.QE}),this.mesh=new D.A(this.geometry,this.material),this.mesh.frustumCulled=!1,this.mesh.renderOrder=1,this.mesh.position.copy(this.position),this.indicatorMesh=new D.A(K.A.DISTANCE_INDICATOR.geometry,this.material),this.indicatorMesh.position.y=-this.halfHeight,this.indicatorMesh.position.x=this.halfWidth-rr,this.indicatorMesh.frustumCulled=!1,this.mesh.add(this.indicatorMesh),this.threshouldGeometry=new A.A(this.size.x,.00375),this.threshouldMesh=new D.A(this.threshouldGeometry,this.material),this.threshouldMesh.frustumCulled=!1,this.mesh.add(this.threshouldMesh),this.threshould=.5,this.alpha=1}createGeometry(){const t=new I.A,i=[-this.halfWidth-rr,+this.halfHeight+rr,0,-this.halfWidth-rr,+this.halfHeight-rr,0,+this.halfWidth+rr,+this.halfHeight+rr,0,+this.halfWidth-rr,+this.halfHeight-rr,0,+this.halfWidth+rr,-this.halfHeight-rr,0,+this.halfWidth-rr,-this.halfHeight+rr,0,-this.halfWidth-rr,-this.halfHeight-rr,0,-this.halfWidth-rr,-this.halfHeight+rr,0];return t.setAttribute("position",new J.A(new Float32Array(i),3,or.FLOAT)),t.setIndices(new J.A(new Uint16Array([0,1,2,2,1,3,2,3,4,4,3,5,4,5,6,5,7,6]),1,or.UNSIGNED_SHORT)),t}set(t){this.alpha=t}setThreshould(t){this.threshould=t}lateUpdate(t,i){this.indicatorMesh.position.y=this.size.y*this.alpha-.5*this.size.y,this.threshouldMesh.position.y=this.size.y*this.threshould-.5*this.size.y}}const cr=.02,lr=.78,ur=.1,fr=new a.A(0,1,0),dr=(new a.A(-.1,-.35,0),new N.A(.02,.4)),vr=new P.A;new a.A(255,177,91).scale(1/255);class mr extends E.A{constructor(t={}){super(t),this.side=this.getSide(),this.createMesh()}getSide(){return T.fl}createMesh(){const t=this.side==T.K9?-1:1;this.createMainMesh(),this.scalesRight=this.createScales(),this.mesh.add(this.scalesRight),this.scalesLeft=this.createScales(-1),this.mesh.add(this.scalesLeft);const i=(0,T.bY)("ALT",{size:.04,color:b.QE,align:T.oM});i.position.set(.93*t,.065,0),this.mesh.add(i);const s=(0,T.bY)("SPD",{size:.04,color:b.QE,align:T.oM});s.position.set(-.93*t,.065,0),this.mesh.add(s),this.altitudeCounter=this.createCounter(1.02),this.add(this.altitudeCounter),this.speedCounter=this.createCounter(-.78-.06),this.add(this.speedCounter),this.throttleIndicator=new hr({size:dr,vertical:!0,position:new a.A(-.73,0,0)}),this.add(this.throttleIndicator),this.distanceIndicator=new ar({size:dr,vertical:!0,position:new a.A(.73,0,0)}),this.add(this.distanceIndicator)}createMainMesh(){const t=[];for(let i=-2;i<=2;i++)for(let i=-1;i<=1;i+=2){const s=sr([new a.A(.8*i,0,ur),new a.A((lr+.05)*i,.03,ur),new a.A(1.03*i,.03,ur),new a.A(1.03*i,-.03,ur),new a.A((lr+.05)*i,-.03,ur)],!0);t.push(s)}const i=hh(t),s=new q.A;this.mesh=new D.A(i,s),this.mesh.frustumCulled=!1}createScales(t=1){const i=[];for(let s=-20;s<=20;s++)i.push(this.createScaleGeometry(cr*s,s%10==0?.03:.02,t));const s=hh(i),n=new q.A({useScissor:!0,scissorMin:new N.A(-10,-.2),scissorMax:new N.A(10,.2)}),e=new D.A(s,n);return e.frustumCulled=!1,e}getIndicatorCaption(){return"ALT"}createCounter(t){return new z({position:new a.A(t,.0015,0),color:b.QE,maxDigits:6})}createLine(t){const i=(new THREE.BufferGeometry).setFromPoints(t),s=new q.A({color:b.QE}),n=new THREE.Line(i,s);return n.frustumCulled=!1,n.renderOrder=2,n}createScaleGeometry(t,i,s=1){const n=.76*s,e=n+i*s;return ir(new a.A(n,t,ur),new a.A(e,t,ur))}createPolyLineGeometry(t,i){const s=i.clone().sub(t),n=s.length();s.normalize();const e=new THREE.PlaneGeometry(2*T.MX,n),h=fr.clone().cross(s),o=Math.acos(fr.dot(s)),r=(new THREE.Quaternion).setFromAxisAngle(h,o),a=t.clone().lerp(i,.5);return e.applyQuaternion(r),e.translate(a.x,a.y,a.z),e}lateUpdate(t,i,s){const e=this.game.mainCamera.vehicle;if(!e)return;const h=e.body.interpolatedPosition.y,o=3.28084*e.body.interpolatedPosition.y;this.scalesRight.position.y=-o%300/300*cr*10;const r=e.body.velocity.length()*n.xz;this.scalesLeft.position.y=-r%50/50*cr*10,0<=h&&this.altitudeCounter.set(o),0<=r&&this.speedCounter.set(r),this.throttleIndicator.set(void 0===e.throttle?1:e.throttle);const a=void 0===e.afterBurner?1:e.afterBurner;b.QE.lerp(b.Gh,a,vr);const c=void 0===e.brake?0:e.brake;if(vr.lerp(b.Gh,c,vr),vr.w=.5,this.throttleIndicator.mesh.material.uniforms.color.copy(vr),this.throttleIndicator.barMesh.material.uniforms.color.copy(vr),e.target){const t=e.body.position.distanceTo(e.target.body.position),i=(0,l.qE)(t/Math.min(e.detectionRange,12e3));this.distanceIndicator.set(i)}const u=e.spWeaponSelected?e.spWeaponController:e.missileController;if(u?.maxRange){const t=u.maxRange/Math.min(e.detectionRange,12e3);this.distanceIndicator.setThreshould(t)}}}const wr=new a.A(1.25,-.4,0),pr=new a.A(-.1,-.35,0),gr=new N.A(.02,.3);class xr extends E.A{constructor(t,i={}){super(i),this.mainCamera=t,this.mesh=new R.A,this.mesh.frustumCulled=!1,this.mesh.position.copy(wr),this.selectorMesh=new D.A(new A.A,new q.A),this.selectorMesh.frustumCulled=!1,this.mesh.add(this.selectorMesh),this.createCounters(),this.createChargeRateIndicators();const s=K.A.WEAPON_SELECTOR;this.selectorMesh.geometry=s.geometry}createCounters(){let t=1;this.gunCounter=this.addCounter("GUN",t++),this.missileCounter=this.addCounter("STDM",t++),this.missileSelectorPosition=this.missileCounter.position.clone(),this.missileSelectorPosition.x-=.025,this.spWeaponCounter=this.addCounter("4-MSSL",t++),this.spWeaponSelectorPosition=this.spWeaponCounter.position.clone(),this.spWeaponSelectorPosition.x-=.025}addCounter(t,i){const s=new L({position:new a.A(0,-.1*i-.025,0),label:t,width:.4,maxDigits:5});return this.add(s),s}createChargeRateIndicators(){this.chargeRateIndicatorsGroup=new R.A,this.chargeRateIndicatorsGroup.position.copy(pr),this.mesh.add(this.chargeRateIndicatorsGroup),this.chargeRateIndicators=[];for(let t=0;t<4;t++){const i=new hr({size:gr,vertical:!0});this.add(i),i.mesh.position.x=-.05*t,i.mesh.position.y+=.06;const s=(0,T.bY)(String(t+1),{size:.04,align:T.oM});s.position.y=.5*-gr.y-.04,i.mesh.add(s),this.chargeRateIndicators.push(i),this.chargeRateIndicatorsGroup.add(i.mesh)}}lateUpdate(t,i,s){const n=this.mainCamera.getTarget();if(!n)return;const e=n.getGunController(),h=n.getMissileController(),o=n.getSPWeaponController?n.getSPWeaponController():null;e&&this.gunCounter.set(e.ammo),h&&this.missileCounter.set(h.ammo),o&&this.spWeaponCounter.set(o.ammo);const r=n.spWeaponSelected?n.spWeaponController:n.missileController;if(n.spWeaponSelected?(this.missileCounter.setAlpha(.5),this.spWeaponCounter.setAlpha(1)):(this.missileCounter.setAlpha(1),this.spWeaponCounter.setAlpha(.5)),this.selectorMesh.position.copy(n.spWeaponSelected?this.spWeaponSelectorPosition:this.missileSelectorPosition),r?.launchers){this.chargeRateIndicatorsGroup.visible=!0;for(let t=0;t<this.chargeRateIndicators.length;t++){const i=this.chargeRateIndicators[t],s=r.launchers[t];i.mesh.visible=null!=s,s&&i.set(s.chargeRate)}}else this.chargeRateIndicatorsGroup.visible=!1}}const Mr=WebGL2RenderingContext;class Sr extends E.A{constructor(t={}){super(t),this.position=t.position??new a.A(1.45,-.85,0),this.geometry=(0,T.ou)(new N.A(.4,.1),.00375),this.material=new q.A({color:b.QE}),this.mesh=new D.A(this.geometry,this.material),this.mesh.frustumCulled=!1,this.mesh.renderOrder=1,this.mesh.position.copy(this.position),this.barGeometry=new A.A(.4,.1),this.barGeometry.translate(.2,0,0),this.barMaterial=new q.A({color:new P.A(0,1,0,.25),transparent:!0}),this.barMesh=new D.A(this.barGeometry,this.barMaterial),this.barMesh.position.x=-.2,this.barMesh.frustumCulled=!1,this.mesh.add(this.barMesh),this.color=new P.A(0,0,0,1),this.colorGreen=b.QE.clone(),this.colorBlue=new P.A(.3,.85,1,.5),this.colorYellow=b.J4.clone(),this.colorRed=oh.Gh.clone(),this.counter=new L({label:"ARMOR",position:new a.A(-.175,0,0),width:.35,comma:!1,suffix:"%"}),this.add(this.counter)}createGeometry(){const t=new I.A,i=[-.201875,.051875000000000004,0,-.19812500000000002,.048125,0,.201875,.051875000000000004,0,.19812500000000002,.048125,0,.201875,-.051875000000000004,0,.19812500000000002,-.048125,0,-.201875,-.051875000000000004,0,-.19812500000000002,-.048125,0];return t.setAttribute("position",new J.A(new Float32Array(i),3,Mr.FLOAT)),t.setIndices(new J.A(new Uint16Array([0,1,2,2,1,3,2,3,4,4,3,5,4,5,6,5,7,6,6,1,0,6,7,1]),1,Mr.UNSIGNED_SHORT)),t}lateUpdate(t,i){if(t.playerAircraft&&null!=t.playerAircraft.health){const i=t.playerAircraft.health/t.playerAircraft.maxHealth,s=Math.floor(100*i);this.counter.set(s),.5<=i?this.colorYellow.lerp(this.colorGreen,(i-.5)/.5,this.color):this.colorRed.lerp(this.colorYellow,i/.5,this.color),this.barMaterial.uniforms.color.copy(this.color),this.barMaterial.uniforms.color.w=.25,this.barMesh.scale.x=i}}}class yr extends q.A{constructor(t={}){super(t),this.transparent=!1,this.depthTest=!!t.depthTest&&t.depthTest,this.depthWrite=!!t.depthWrite&&t.depthWrite,this.options=t}getVertSource(){return"#version 300 es\n        \n            precision mediump float;\n\n            layout (location = 0) in vec3 position;\n            layout (location = 1) in vec2 uv;\n\n            uniform mat4 modelMatrix;\n            uniform mat4 viewMatrix;\n            uniform mat4 projectionMatrix;\n\n            uniform vec3 cameraPosition;\n\n            uniform float aspectRatio;\n            uniform float scale;\n\n            uniform vec3 targetPosition;\n            uniform vec3 predictedPosition;\n\n            uniform vec3 headDirection;\n\n            out vec2 vUv;\n            out vec4 vPosition;\n\n            void main() {\n                vUv = uv;\n                vec4 projTargetPosition = projectionMatrix * viewMatrix * vec4(targetPosition, 1.0);\n                projTargetPosition.xyz /= projTargetPosition.w;\n\n                vec4 projPredictedPosition = projectionMatrix * viewMatrix * vec4(predictedPosition, 1.0);\n                projPredictedPosition.xyz /= projPredictedPosition.w;\n\n                vec2 offset = projPredictedPosition.xy - projTargetPosition.xy;\n\n                vec4 projHeadPosition = projectionMatrix * viewMatrix * vec4(headDirection, 0.0);\n                projHeadPosition.xyz /= projHeadPosition.w;\n                \n                vPosition = vec4(projHeadPosition.xyz, 1.0);\n                vPosition.z = 0.1;\n                vPosition.xy += vec2(position.x / aspectRatio, position.y);\n                vPosition.xy -= offset;\n                gl_Position = vPosition;\n            }\n        "}getFragSource(){return"#version 300 es\n\n            precision mediump float;\n\n            uniform vec4 color;\n\n            in vec2 vUv;\n            in vec4 vPosition;\n\n            out vec4 gDiffuse;\n\n            void main() {\n                gDiffuse = color;\n            }\n        "}getUniforms(t){return{modelMatrix:new Mt.A,viewMatrix:new Mt.A,projectionMatrix:new Mt.A,cameraPosition:new a.A,aspectRatio:1,targetPosition:new a.A,predictedPosition:new a.A,headDirection:new a.A,scale:t.scale?t.scale:1,color:t.color?t.color:new P.A(0,0,0,0),min:t.min?t.min:new N.A(-20,-20),max:t.max?t.max:new N.A(20,20)}}}const _r=new N.A(.5,.5),Pr=(new N.A(_r.x/2,_r.y/2),new a.A(-1.3,-.6,0),new a.A(0,-.1,0),new a.A),Ar=new a.A,Dr=new a.A,qr=new a.A;class Tr extends E.A{constructor(){super({}),this.createMesh()}createMesh(){const t=new yr({color:b.QE});this.mesh=new D.A(K.A.GUN_CURSOR.geometry,t),this.mesh.frustumCulled=!1}lateUpdate(t,i,s){this.mesh.visible=!1;const e=this.game.mainCamera.vehicle;if(!e)return;const h=e.target;if(!h)return;const o=e.getGunController();if(!o)return;this.mesh.visible=!0,(0,l.u9)(h.body.interpolatedPosition,h.body.interpolatedVelocity,e.body.interpolatedPosition,e.body.interpolatedVelocity,o.bulletSpeed,Pr),qr.copy(this.game.mainCamera.position),qr.sub(e.body.interpolatedPosition,qr),Pr.add(qr,Pr),e.body.interpolatedQuaternion.vmult(n.OX,Ar),h.body.interpolatedPosition.sub(e.body.interpolatedPosition,Dr);const r=Dr.length();Dr.normalize();.3<Math.acos(Ar.dot(Dr))||o.maxRange<r?this.mesh.visible=!1:(this.mesh.material.uniforms.targetPosition.copy(h.body.interpolatedPosition),this.mesh.material.uniforms.predictedPosition.copy(Pr),this.mesh.material.uniforms.headDirection.copy(Ar))}}class Er extends q.A{constructor(t={}){super(t)}getVertSource(){return"#version 300 es\n        \n            precision mediump float;\n\n            layout (location = 0) in vec3 position;\n            layout (location = 2) in vec2 uv;\n\n            uniform mat4 modelMatrix;\n            uniform mat4 viewMatrix;\n            uniform mat4 projectionMatrix;\n\n            uniform vec3 cameraPosition;\n\n            uniform vec3 headDirection;\n            uniform vec3 upDirection;\n\n            uniform float aspectRatio;\n\n            const vec4 UP = vec4(0.0, 1.0, 0.0, 0.0);\n\n            out vec2 vUv;\n            out vec2 vCoord;\n            out vec3 vPosition;\n\n            vec3 rotate(vec3 p, float angle) {\n                return vec3(\n                    + p.x * cos(angle) + p.y * sin(angle),\n                    - p.x * sin(angle) + p.y * cos(angle),\n                    0.0\n                );\n            }\n\n            void main() {\n                vUv = uv;\n                vPosition = position;\n\n                vec4 viewDirection = viewMatrix * vec4(headDirection, 0.0);\n                vec4 projectedCenter = projectionMatrix * vec4(viewDirection.xyz, 1.0);\n                projectedCenter.xyz /= projectedCenter.w;\n\n                vec3 up = (viewMatrix * vec4(upDirection, 0.0)).xyz;\n                up = normalize(vec3(up.x, up.y, 0.0));\n                float angle = acos(clamp(up.y, -1.0, 1.0)) * sign(up.x);\n\n                vec3 offsetPosition = (modelMatrix * vec4(position, 1.0)).xyz;\n                // vec3 offsetPosition = position.xyz;\n                offsetPosition = rotate(offsetPosition, angle);\n                offsetPosition.x /= aspectRatio;\n\n                gl_Position = vec4(projectedCenter.xyz + offsetPosition, 1.0);\n\n                vCoord = vec2(gl_Position.xy / gl_Position.w) - projectedCenter.xy;\n                vCoord.x *= aspectRatio;\n                vCoord = rotate(vec3(vCoord, 0.0), -angle).xy;\n            }\n        "}getUniforms(t={}){return{modelMatrix:new Mt.A,viewMatrix:new Mt.A,projectionMatrix:new Mt.A,cameraPosition:new a.A,headDirection:new a.A,vehicleMatrix:new Mt.A,upDirection:new a.A,aspectRatio:1,color:t.color?t.color:oh.QE,lineWidth:t.lineWidth??0,scissorMin:this.scissorMin??new N.A,scissorMax:this.scissorMax??new N.A}}}const Cr=new a.A(1,1,1),br=new a.A,Ur=new r.A;class Nr extends E.A{constructor(t={}){super(t),this.mesh=K.A.CENTER_MARKER,this.mesh.material=new Er,this.mesh.frustumCulled=!1}lateUpdate(t,i,s){const e=this.game.mainCamera.vehicle;if(!e)return;br.copy(e.body.interpolatedPosition),Ur.copy(e.body.interpolatedQuaternion);const h=this.mesh.material.uniforms;Ur.vmult(n.OX,h.headDirection),Ur.vmult(n.UP,h.upDirection),h.vehicleMatrix.compose(br,Ur,Cr),h.headDirection.normalize(),h.upDirection.normalize()}}class Rr extends Zi.Ay{constructor(t,i,s=1){super(Xi.A.MISSILE_LOCK,t,i,s),this.loop=!0,this.loopStart=3.6,this.loopEnd=4.6,this.volume=.25}}const Ir=new a.A;class zr extends E.A{constructor(t,i={}){super(i),this.camera=t,this.material=new q.A,this.mesh=new D.A(K.A.LOCKON_CURSOR.geometry,this.material),this.mesh.draw=this.draw.bind(this),this.mesh.frustumCulled=!1,this.missileLockSound=new Rr,this.missileLockSound.setVolume(0),this.missileLockSound.start(),this.audios.push(this.missileLockSound)}lateUpdate(t,i,s){const n=this.game.mainCamera.vehicle;if(!n?.selectedSubWeapon?.seeker||n.health<=0)return void this.missileLockSound.setVolume(0);n.selectedSubWeapon.seeker.targetLocking?this.missileLockSound.setVolume(2):this.missileLockSound.setVolume(0)}draw(t,i){const s=this.camera.vehicle;if(!s?.selectedSubWeapon?.seeker)return;const n=s.selectedSubWeapon.seeker;for(const e of n.subSeekers)this.qn(t,i,s,e)}qn(t,i,s,n){if(n.targetLocking)Ir.copy(n.target.body.interpolatedPosition),this.mesh.material.uniforms.color.copy(b.Gh);else{if(!n.targetSeeking)return;{s.body.interpolatedQuaternion.vmult(n.lerpedLocalSeekerDirection,Ir);const t=s.body.interpolatedPosition.distanceTo(s.target.body.interpolatedPosition);Ir.scale(t,Ir),Ir.add(s.body.interpolatedPosition,Ir),this.mesh.material.uniforms.color.copy(b.QE)}}this.mesh.position.copy(Ir),this.mesh.position.applyMat4(this.camera.viewMatrix,this.mesh.position),this.mesh.position.applyMat4(this.camera.projectionMatrix,this.mesh.position),this.mesh.position.x*=this.camera.aspect,this.mesh.modelMatrixUpdated=!1,this.mesh.updateModelMatrix(),t.draw(this.mesh,i)}}const Lr=new a.A,Fr=2*Math.PI;new r.A,new r.A;class Or extends E.A{constructor(t,i={}){super(i),this.vehicleCamera=null,this.mesh=new D.A(new A.A,new q.A),this.mesh.onAfterRender=this.onAfterRender.bind(this),this.mesh.frustumCulled=!1,this.angle=0,this.lastAngle=this.angle,this.createCursorMesh()}createCursorMesh(){this.cursorMesh=new D.A(new A.A,new q.A({color:b.J4.clone()})),this.cursorMesh.frustumCulled=!1;const t=K.A.MISSILE_CURSOR;this.airCursorGeometry=t.geometry}onAdded(){super.onAdded(),this.vehicleCamera=this.scene.mainCamera}fixedUpdate(t,i){this.lastAngle=this.angle,this.angle+=Fr*i,this.angle%=2*Math.PI}onAfterRender(t,i){const s=i.vehicle;for(const n of this.game.missiles)n.target===s&&n.isGuidingToTarget&&this.renderCursor(n,t,i)}renderCursor(t,i,s){Lr.copy(t.mesh.position),Lr.applyMat4(s.viewMatrix,Lr),Lr.applyMat4(s.projectionMatrix,Lr),Lr.x*=s.aspect,this.cursorMesh.position.copy(Lr),this.cursorMesh.geometry=this.airCursorGeometry,this.cursorMesh.modelMatrixUpdated=!1,this.cursorMesh.updateModelMatrix(),i.drawRecursive(this.cursorMesh,s)}}class Vr extends bt.A{constructor(t={}){super(t),this.renderingPass=t.renderingPass??n.uk}getVertSource(){return"#version 300 es\n        \n            precision mediump float;\n\n            layout (location = 0) in vec3 position;\n            layout (location = 2) in vec2 uv;\n\n            uniform mat4 modelMatrix;\n\n            uniform float aspectRatio;\n\n            out vec2 vUv;\n            out vec2 vCoord;\n            out vec3 vPosition;\n\n            void main() {\n                vUv = uv;\n                vPosition = position;\n                gl_Position = modelMatrix * vec4(position, 1.0);\n                gl_Position.x /= aspectRatio;\n\n                vCoord = vec2(gl_Position.xy / gl_Position.w);\n                vCoord.x *= aspectRatio;\n            }\n        "}getFragSource(){return`#version 300 es\n            \n            precision mediump float;\n\n            in vec2 vUv;\n            in vec3 vNormal;\n            in vec3 vPosition;\n\n            ${this.colorTexture?"#define USE_COLOR_MAP":""}\n            ${this.alphaTest?"#define ALPHA_TEST":""}\n\n            #ifdef USE_COLOR_MAP\n            uniform sampler2D tColor;\n            #endif\n            uniform vec4 colorFactor;\n\n            out vec4 gDiffuse;\n\n            void main() {\n                #ifdef USE_COLOR_MAP\n                vec4 albedo = texture(tColor, vUv);\n                #ifdef ALPHA_TEST\n                if (albedo.a < 0.5) discard;\n                #endif\n                gDiffuse = albedo * colorFactor;\n                // gDiffuse = albedo;\n                #else\n                gDiffuse = colorFactor;\n                #endif\n            }\n        `}getUniforms(t){return{...super.getUniforms(t),aspectRatio:1}}}class kr extends E.A{constructor(t={}){super(t),this.mesh=K.A.MOUSE_CURSOR,this.mesh.material=new Vr(this.mesh.material.config),this.mesh.children[0].material=new Vr(this.mesh.children[0].material.config),this.mesh.frustumCulled=!1,this.mesh.children[0].frustumCulled=!1,this.parent?.mesh&&this.parent.mesh.add(this.mesh)}lateUpdate(t,i,s){this.mesh.visible=this.game.playerController.mouseMode&&!this.game.playerController.gamepadMode,this.mesh.material.uniforms.tDiffuse=this.scene.main.renderingPipeline.multipleFramebuffer.texture;const n=this.game.playerController;this.mesh.position.x=.95*n.aileron,this.mesh.position.y=.95*-n.elevator}}const Gr=.08,Br=new N.A(.5,.5);new N.A(Br.x/2,Br.y/2),new a.A(-1.3,-.6,0),new a.A(0,-.1,0);class Hr extends E.A{constructor(t={}){super({}),this.headDirection=new a.A,this.totalHeight=.5*Math.PI/(.5*e.Ue*n.vT),this.createMesh()}createMesh(){this.labelMeshes=[];const t=[];for(let i=-90;i<=90;i+=5){const s=i*n.vT,e=0==i?.18:i%10?.08:.13,h=i%10?"":String(i);t.push(this.createLinePair(s,2*e,h))}const i=hh(t),s=new Er({useScissor:!0,scissorMin:new N.A(-.6,-.6),scissorMax:new N.A(.6,.6)});this.mesh=new D.A(i,s),this.mesh.frustumCulled=!1;for(const t of this.labelMeshes)this.mesh.add(t)}createLinePair(t,i,s){if(s){const n=this.createLabel(s,Gr+i+.01,t,!1);this.labelMeshes.push(n);const e=this.createLabel(s,Gr+i+.01,t,!0);this.labelMeshes.push(e)}const n=[];return n.push(this.createLineGeometry(Gr,Gr+i,t,!1)),n.push(this.createLineGeometry(Gr,Gr+i,t,!0)),hh(n)}createLineGeometry(t,i,s,n){return ir(new a.A(n?-t:t,s/(.5*Math.PI)*this.totalHeight,0),new a.A(n?-i:i,s/(.5*Math.PI)*this.totalHeight,0))}createLabel(t,i,s,n){const e=(0,T.CB)(t,{size:.04,align:n?T.t7:T.C7}),h=new Er({useScissor:!0,scissorMin:new N.A(-.6,-.6),scissorMax:new N.A(.6,.6)}),o=new D.A(e,h);return o.position.x=n?-i:i,o.position.y=s/(.5*Math.PI)*this.totalHeight,o.frustumCulled=!1,o}lateUpdate(t,i,s){const e=this.game.mainCamera.vehicle;if(!e)return;e.body.interpolatedQuaternion.vmult(n.OX,this.headDirection),this.headDirection.normalize();const h=Math.asin((0,l.qE)(this.headDirection.y));this.mesh.position.y=-h/(.5*Math.PI)*this.totalHeight,this.Tn(this.mesh.material);for(const t of this.labelMeshes)this.Tn(t.material)}Tn(t){const i=t.uniforms;i.headDirection.copy(this.headDirection),i.upDirection.copy(n.UP)}}class jr extends St.Ay{constructor(t={}){super(),this.props=t,this.depthTest=t.depthTest??!1,this.depthWrite=t.depthWrite??!1,this.transparent=t.transparent??!1,this.useScissor=t.useScissor??!1,this.scissorMin=t.scissorMin??new N.A,this.scissorMax=t.scissorMax??new N.A,this.vertexShader=this.getVertSource(),this.fragmentShader=this.getFragSource(),this.uniforms=this.getUniforms(t),this.renderingPass=t.renderingPass??n.uk}setColor(t){this.uniforms.color.value.copy(t)}getVertSource(){return"#version 300 es\n        \n            precision mediump float;\n\n            layout (location = 0) in vec3 position;\n            layout (location = 2) in vec2 uv;\n\n            uniform mat4 modelMatrix;\n\n            uniform float aspectRatio;\n\n            out vec2 vUv;\n            out vec2 vCoord;\n            out vec3 vPosition;\n\n            void main() {\n                vUv = uv;\n                vPosition = position;\n                gl_Position = modelMatrix * vec4(position, 1.0);\n                // gl_Position = vec4(position, 1.0);\n                gl_Position.x /= aspectRatio;\n\n                vCoord = vec2(gl_Position.xy / gl_Position.w);\n                vCoord.x *= aspectRatio;\n            }\n        "}getFragSource(){return`#version 300 es\n\n            ${this.useScissor?"#define SCISSOR":""}\n            \n            precision mediump float;\n\n            uniform vec4 color;\n\n            #ifdef SCISSOR\n            uniform vec2 scissorMin;\n            uniform vec2 scissorMax;\n            #endif\n\n            uniform float aspectRatio;\n\n            in vec2 vUv;\n            in vec3 vPosition;\n            in vec2 vCoord;\n\n            out vec4 gDiffuse;\n\n            void main() {\n                vec2 coord = vec2(vUv.x, vUv.y) * 2.0 - 1.0;\n                gDiffuse = color;\n                // gDiffuse.a = clamp(1.0 - (length(coord) - 0.75) * 4.0, 0.0, 1.0);\n                // gDiffuse.a = gDiffuse.a * gDiffuse.a;\n                gDiffuse.a *= color.a;\n            }\n        `}getUniforms(t={}){return{modelMatrix:new Mt.A,viewMatrix:new Mt.A,projectionMatrix:new Mt.A,aspectRatio:1,color:t.color?t.color.clone():oh.QE.clone(),scissorMin:this.scissorMin??new N.A,scissorMax:this.scissorMax??new N.A}}}const Wr=new N.A(.25,.25),$r=new N.A(Wr.x/2,Wr.y/2),Xr=new a.A(-1.4,-.65,0),Zr=(new a.A(0,-.1,0),new a.A),Yr=new a.A,Kr=new r.A,Jr=new r.A,Qr=new a.A,ta=new a.A,ia=new a.A,sa=new a.A,na=new a.A(0,1,0),ea=new a.A(0,0,-1);class ha extends E.A{constructor(t={}){super(t),this.focusable=!1,this.scales=[5,15,50],this.radarScale=this.scales[0],this.createMesh(t),this.indicatorMesh=this.createVehicleIndicator(),this.targetBlinkTimer=.3,this.targetBlink=!1}createMesh(t){this.backgroundGeometry=(0,l.FK)(Wr.x,Wr.y),this.backgroundMaterial=new jr({color:new P.A(0,0,0,.5),transparent:!0}),this.mesh=new D.A(this.backgroundGeometry,this.backgroundMaterial),this.mesh.position.copy(t.position??Xr),this.mesh.onAfterRender=this.onAfterRender.bind(this),this.mesh.frustumCulled=!1,this.frame=this.createFrame(),this.add(this.frame),this.scaleGeometries={};for(const t of this.scales)this.scaleGeometries[t]=(0,T.CB)(String(t)+" miles",{size:.03,align:T.t7});this.scaleLabelMesh=new D.A(this.scaleGeometries[this.radarScale],new q.A),this.scaleLabelMesh.position.set(Wr.x-.015,Wr.y-.03,0),this.scaleLabelMesh.frustumCulled=!1,this.mesh.add(this.scaleLabelMesh);const i=K.A.RADAR_AIR_VEHICLE_MARKER;this.airMarkerGeometry=i.geometry;const s=K.A.RADAR_GROUND_VEHICLE_MARKER;this.groundMarkerGeometry=s.geometry}createFrame(){const t=sr([new a.A(-Wr.x,+Wr.y,0),new a.A(+Wr.x,+Wr.y,0),new a.A(+Wr.x,-Wr.y,0),new a.A(-Wr.x,-Wr.y,0)],!0),i=new q.A,s=new D.A(t,i);s.frustumCulled=!1;const n=new E.A;return n.mesh=s,n}createVehicleIndicator(){const t=.2,i=function(t,i){const s=new I.A,n=new Float32Array(3*t.length);for(let i=0;i<t.length;i++){const s=t[i];n[3*i+0]=s.x,n[3*i+1]=s.y,n[3*i+2]=s.z}const e=new J.A(n,3,nh.FLOAT);if(s.setAttribute("position",e),i){const t=new Uint16Array(i.length);for(let s=0;s<i.length;s++)t[s]=i[s];const n=new J.A(t,1,nh.UNSIGNED_SHORT);s.setIndices(n)}return s}([new a.A(.05*t,-.1*t+.01,0),new a.A(0,.05*t+.01,0),new a.A(-.05*t,-.1*t+.01,0)]),s=new q.A({color:new P.A(1,1,1,1),useScissor:!0,scissorMin:new N.A(Xr.x-Wr.x,Xr.y-Wr.y),scissorMax:new N.A(Xr.x+Wr.x,Xr.y+Wr.y)}),n=new D.A(i,s);return n.frustumCulled=!1,n.scale.set(.015,.015,.015),n}update(t,i){if(this.game.playerController.changeRadarScale){const t=this.scales.indexOf(this.radarScale);this.radarScale=this.scales[t+1],void 0===this.radarScale&&(this.radarScale=this.scales[0]),this.scaleLabelMesh.geometry=this.scaleGeometries[this.radarScale]}}fixedUpdate(t,i){this.targetBlinkTimer-=i,this.targetBlinkTimer<=0&&(this.targetBlink=!this.targetBlink,this.targetBlinkTimer=.3)}onAfterRender(t,i){this.vehicle=this.game.mainCamera.vehicle,this.vehicle&&this.renderVehicles(t,i)}renderVehicles(t,i){if(!this.vehicle||!this.game.getAllVehicles())return;Zr.copy(this.vehicle.body.interpolatedPosition),Zr.y=0,this.vehicle.body.interpolatedQuaternion.vmult(ea,Yr),Yr.y=0,Yr.normalize(),ea.cross(Yr,sa).normalize();const s=Math.acos((0,l.qE)(ea.dot(Yr)));Kr.setFromAxisAngle(sa,s),Kr.conjugate(Jr),this.game.getAllVehicles().forEach(s=>{this.vehicle.target===s&&this.targetBlink||s!==this.vehicle&&(s.destroyed?this.indicatorMesh.material.uniforms.color.copy(b.wg):this.vehicle.iff==s.iff?this.indicatorMesh.material.uniforms.color.copy(oh.ZZ):this.indicatorMesh.material.uniforms.color.copy(oh.uL),this.renderVehicle(s,t,i))}),this.indicatorMesh.material.uniforms.color.copy(oh.QE),this.renderVehicle(this.vehicle,t,i)}renderVehicle(t,i,s){t.body.interpolatedPosition.vsub(this.vehicle.body.interpolatedPosition,Qr),Qr.y=0,Qr.scale(1/(this.radarScale*n.oq),Qr),Qr.x*=$r.x,Qr.z*=$r.y,Jr.vmult(Qr,Qr),this.indicatorMesh.position.set(Xr.x+Qr.x,Xr.y-Qr.z,0),t.body.interpolatedQuaternion.vmult(ea,ta),ta.y=0,ta.normalize(),Jr.vmult(ta,ta),ta.normalize(),ia.set(ta.x,-ta.z,0),na.cross(ia,sa).normalize();const e=Math.acos((0,l.qE)(na.dot(ia)));this.indicatorMesh.quaternion.setFromAxisAngle(sa,e),this.indicatorMesh.quaternion.normalize(),this.indicatorMesh.geometry=t.onGround&&t!==this.vehicle?this.groundMarkerGeometry:this.airMarkerGeometry,this.indicatorMesh.modelMatrixUpdated=!1,this.indicatorMesh.updateModelMatrix(),i.draw(this.indicatorMesh,s)}}const oa=WebGL2RenderingContext,ra=.2/Math.sqrt(3),aa=new a.A,ca=new r.A;class la extends E.A{constructor(t={}){super(t),this.radius=t.radius??.8,this.label=t.label??"TARGET",this.mesh=new R.A,this.geometry=this.createGeometry(),this.material=new q.A({color:b.QE}),this.indicatorMesh=new D.A(this.geometry,this.material),this.indicatorMesh.frustumCulled=!1,this.mesh.add(this.indicatorMesh),this.labelMesh=(0,T.bY)(this.label,{align:T.oM}),this.labelMesh.position.y=-.1,this.mesh.add(this.labelMesh),this.targetPosition=new a.A}createGeometry(){const t=new I.A,i=[0,.1,0,-ra/4,0,ra/4,ra/4,0,-ra/4];return t.setAttribute("position",new J.A(new Float32Array(i),3,oa.FLOAT)),t.setIndices(new J.A(new Uint16Array([0,1,2]),1,oa.UNSIGNED_SHORT)),t}setTargetPosition(t){this.targetPosition.copy(t)}lateUpdate(t,i){this.mesh.visible=this.visible&&this.getVisible(),this.targetPosition.sub(t.mainCamera.position,aa),aa.normalize(),t.mainCamera.quaternion.conjugate(ca),ca.vmult(aa,aa);const s=Math.acos(-aa.z)/(Math.PI/2),e=.25+.75*s;if(s<.27)return void(this.mesh.visible=!1);this.indicatorMesh.scale.y=e,aa.z=0,aa.normalize();const h=Math.acos(n.UP.dot(aa))*(0<=aa.x?1:-1);this.mesh.quaternion.setFromAxisAngle(n.OX,h),this.mesh.quaternion.conjugate(this.labelMesh.quaternion),aa.scale(this.radius,this.mesh.position)}getVisible(){return!0}}const ua=new a.A,fa=new c.A;class da extends E.A{constructor(t,i={}){super(i),this.vehicleCamera=null,this.mesh=new D.A(new A.A,new q.A),this.mesh.onAfterRender=this.onAfterRender.bind(this),this.mesh.frustumCulled=!1,this.createCursorMesh(),this.nameLabelGeometries=new Map,this.targetBlinkInterval=.3,this.targetBlinkTimer=this.targetBlinkInterval,this.isTargetBlinking=!1,this.distanceCounter=new z({position:new a.A(-.06,-.025,0),fontSize:.03,color:b.QE,align:T.C7}),this.distanceCounterMesh=this.distanceCounter.mesh,this.cursorGroup.add(this.distanceCounterMesh);const s=K.A.AIR_VEHICLE_MARKER;this.airCursorGeometry=s.geometry;const n=K.A.GROUND_VEHICLE_MARKER;this.groundCursorGeometry=n.geometry}createCursorMesh(){this.cursorGroup=new R.A,this.cursorMesh=new D.A(new A.A,new q.A({color:b.QE.clone()})),this.cursorMesh.frustumCulled=!1,this.cursorGroup.add(this.cursorMesh),this.nameLabelMesh=new D.A(new A.A,new q.A({color:b.QE.clone()})),this.nameLabelMesh.frustumCulled=!1,this.nameLabelMesh.position.set(.06,.025,0),this.cursorGroup.add(this.nameLabelMesh)}onAdded(){super.onAdded(),this.vehicleCamera=this.scene.mainCamera}lateUpdate(t,i){this.targetBlinkTimer-=i,this.targetBlinkTimer<=0&&(this.isTargetBlinking=!this.isTargetBlinking,this.targetBlinkTimer=this.targetBlinkInterval)}onAfterRender(t,i){this.game.getAllVehicles().forEach(s=>{this.renderCursor(s,t,i)})}renderCursor(t,i,s){if(t.destroyed)return;fa.copy(s),fa.far=1e5,fa.updateProjectionMatrix(),ua.copy(t.body.interpolatedPosition),ua.applyMat4(fa.viewMatrix,ua),ua.applyMat4(fa.projectionMatrix,ua),ua.x*=fa.aspect,this.cursorGroup.position.copy(ua);const n=s.vehicle;if(!n||t===n)return;const e=n.target==t;if(this.cursorGroup.renderOrder=e?1:0,e){const i=n.body.interpolatedPosition.distanceTo(t.body.interpolatedPosition);this.distanceCounter.set(i),this.setMaterialColor(t,this.distanceCounter.material,n,e,!1),this.nameLabelMesh.geometry=this.getNameLabelGeometry(t.name),this.setMaterialColor(t,this.nameLabelMesh.material,n,e,!1),this.distanceCounterMesh.visible=!0,this.nameLabelMesh.visible=!0}else this.distanceCounterMesh.visible=!1,this.nameLabelMesh.visible=!1;this.cursorMesh.geometry=t.onGround?this.groundCursorGeometry:this.airCursorGeometry,this.cursorGroup.modelMatrixUpdated=!1,this.cursorGroup.updateModelMatrix();let h=!1;const o=n.selectedSubWeapon?.seeker;if(o)for(const i of o.subSeekers)h|=i.target===t&&i.targetLocking;this.cursorMesh.visible=!(e&&this.isTargetBlinking)||h,this.setMaterialColor(t,this.cursorMesh.material,n,e,h),i.drawRecursive(this.cursorGroup,fa)}setMaterialColor(t,i,s,n,e){0==t.iff?i.uniforms.color.set(1,1,0,1):t.iff==s.iff?i.uniforms.color.copy(b.ZZ):e?i.uniforms.color.copy(b.Gh):i.uniforms.color.copy(b.QE),i.uniforms.color.w=n?1:.75}getNameLabelGeometry(t){const i=this.nameLabelGeometries.get(t)??(0,T.CB)(t,{text:t,size:.03,align:T.C7});return this.nameLabelGeometries.set(t,i),i}}da.SIZE=new N.A(.5,.5),da.HALF_SIZE=new N.A(da.SIZE.x/2,da.SIZE.y/2),da.POSITION=new a.A(-1.3,-.6,0),da.CENTER_OFFSET=new a.A(0,-.1,0);class va extends E.A{constructor(t={}){super(t),this.mesh=K.A.VELOCITY_MARKER,this.mesh.material=new Er,this.mesh.frustumCulled=!1}lateUpdate(t,i,s){const e=this.game.mainCamera.vehicle;if(!e)return;const h=this.mesh.material.uniforms;e.body.velocity.length()<.1?e.body.interpolatedQuaternion.vmult(n.OX,h.headDirection):h.headDirection.copy(e.body.interpolatedVelocity),e.body.interpolatedQuaternion.vmult(n.UP,h.upDirection),h.headDirection.normalize(),h.upDirection.normalize()}}class ma extends z{constructor(t={}){super(t)}Xi(t){super.Xi(t),this.maxValue=t.maxValue??10,this.maxDigits=Math.floor(Math.log10(this.maxValue))+1}Yi(){this.mesh=new R.A,this.mesh.position.copy(this.position),this.mesh.frustumCulled=!1;let t=0;this.maxNumberMeshes=[];for(let i=0;i<this.maxDigits;i++){const i=this.Ji(this.numberGeometries[0],t++);this.maxNumberMeshes.push(i),this.mesh.add(i)}this.Qi(this.maxValue,this.maxNumberMeshes);const i=this.Ji(this.Ki("/"),t++);this.mesh.add(i),this.numberMeshes=[];for(let i=0;i<this.maxDigits;i++){const i=this.Ji(this.numberGeometries[0],t++);this.numberMeshes.push(i),this.mesh.add(i)}}}class wa extends L{constructor(t={}){super(t)}Xi(t){super.Xi(t),this.maxValue=t.maxValue??10}createCounter(){return new ma({align:T.t7,color:b.QE,position:new a.A(this.totalWidth,0,0),fillZero:this.fillZero,fillZeroGeometry:this.fillZeroGeometry,maxDigits:this.maxDigits,maxValue:this.maxValue})}}class pa extends E.A{constructor(t={}){super(t),this.textSize=t.textSize??.04,this.align=t.align??T.t7,this.geometry=this.createTextGeometry("TEST"),this.material=new q.A({color:b.QE}),this.mesh=new D.A(this.geometry,this.material),this.mesh.frustumCulled=!1,this.mesh.position.copy(this.position),this.geometries=new Map,this.set(0)}set(t){let i=this.geometries.get(t);null==i&&(i=this.createTextGeometry(t),this.geometries.set(t,i)),this.mesh.geometry=i}createTextGeometry(t){return(0,T.CB)(t,{size:this.textSize,align:this.align,color:b.QE})}}const ga=new a.A,xa=new a.A;class Ma extends E.A{constructor(t,i,s={}){super(s),this.mesh=new R.A,this.mainCamera=t,this.camera=t,this.playerController=i,this.vehicle=null,this.showHud=!0,this.mouseCursor=new kr,this.timeCounter=new ph({label:"TIME:",position:new a.A(-1.65,.875,0)}),this.add(this.timeCounter),this.scoreCounter=new L({label:"SCORE:",position:new a.A(-1.65,.775,0)}),this.add(this.scoreCounter),this.gunCursor=new Tr(this.mainCamera),this.add(this.gunCursor),this.vehicleCursors=new da(this.mainCamera),this.add(this.vehicleCursors),this.missileCursors=new Or(this.mainCamera),this.add(this.missileCursors),this.altitudeAndDistanceIndicator=new mr,this.add(this.altitudeAndDistanceIndicator),this.pitchIndicator=new Hr,this.add(this.pitchIndicator),this.headIndicator=new Nr,this.add(this.headIndicator),this.ammoCounters=new xr(this.mainCamera),this.add(this.ammoCounters),this.velocityCursor=new va,this.add(this.velocityCursor),this.damageIndicator=new Sr,this.add(this.damageIndicator),this.targetDirectionIndicator=new la,this.add(this.targetDirectionIndicator),this.radar=new ha,this.add(this.radar),this.loclonCursor=new zr(this.mainCamera),this.add(this.loclonCursor);{this.gear=new pa({position:new a.A(-1,-.85,0),align:T.oM}),this.gear.set("DOWN"),this.add(this.gear);const t=(0,T.bY)("GEAR",{size:.04,color:oh.QE,align:T.oM});t.position.set(-1,-.75,0),this.mesh.add(t);const i=(0,T.n8)(new N.A(.2,.1),.004,oh.QE);i.position.set(-1,-.85,0),this.mesh.add(i)}this.enemiesDownCounter=new L({label:"DOWNED:",position:new a.A(1.15,.775,0),width:.5}),this.add(this.enemiesDownCounter),this.waveCounter=new wa({label:"WAVE:",position:new a.A(1.15,.875,0),width:.5,maxValue:Na}),this.add(this.waveCounter),this.missileAlertSound=new Jo,this.missileAlertSound.setVolume(0),this.missileAlertSound.start(),this.audios.push(this.missileAlertSound),this.baseDirectionIndicator=new la({label:"BASE",visible:!1}),this.add(this.baseDirectionIndicator),this.baseDirectionIndicator.getVisible=function(){const t=this.game.terrain.runways[0];if(!this.vehicle||!t)return!1;this.vehicle.position.sub(t.start,ga);const i=(0,l.qE)(t.direction.dot(ga),0,t.length);t.direction.scale(i,xa),t.start.add(xa,xa);return 100<xa.distanceTo(this.vehicle.position)}.bind(this)}hide(){this.uiMesh.visible=!1}show(){this.uiMesh.visible=!0}update(t,i){this.vehicle=this.mainCamera.vehicle,this.playerController.toggleHud&&(this.showHud=!this.showHud,this.playerController.toggleHud=!1),"spectator"!=this.mainCamera.view&&this.showHud&&this.vehicle&&!this.vehicle.destroyed?this.mesh.visible=!0:this.mesh.visible=!1}lateUpdate(t,i,s){this.camera.updateModelMatrix(),this.camera.updateViewMatrix(),this.camera.updateProjectionMatrix(),this.scoreCounter.set(this.game.getScore()),this.timeCounter.set(this.game.getTime()),this.waveCounter.set(this.game.currentWave),this.enemiesDownCounter.set(this.game.enemiesDown);const n=this.mainCamera.vehicle;if(!n)return void this.missileAlertSound.setVolume(0);let e=!1;for(const t of this.game.missiles)if(t.target===this.vehicle&&t.isGuidingToTarget){e=!0;break}e?(this.missileAlertSound.setVolume(2),this.scene.hud.showCombatAlert("MISSILE ALERT",{level:2,blink:!0,duration:.1})):(this.missileAlertSound.setVolume(0),this.vehicle.isLocked&&this.scene.hud.showCombatAlert("WARNING",{level:1})),null!=n?.gear&&(1==n.gear?this.gear.set("DOWN"):.75<n.gear?this.gear.set("----"):.5<n.gear?this.gear.set("---"):.25<n.gear?this.gear.set("--"):0<n.gear?this.gear.set("-"):this.gear.set("UP")),n.target?(this.targetDirectionIndicator.show(),this.targetDirectionIndicator.setTargetPosition(n.target.body.interpolatedPosition)):this.targetDirectionIndicator.hide();const h=this.game.terrain.runways[0];h&&this.baseDirectionIndicator.setTargetPosition(h.center)}}class Sa extends q.A{constructor(t={}){super(t),this.transparent=!0}getFragSource(){return"#version 300 es\n    \n    precision mediump float;\n\n    uniform vec4 color;\n\n    uniform vec2 size;\n\n    // in vec2 vUv;\n    // in vec3 vPosition;\n\n    in vec2 vUv;\n    in vec3 vPosition;\n    in vec2 vCoord;\n\n    out vec4 gDiffuse;\n\n    void main() {\n        gDiffuse = color;\n        // gl_FragColor = vec4(0.0);\n\n        vec2 coord = abs(vPosition.xy);\n        coord = max(coord - size * 0.5, 0.0);\n        float distance = length(coord);\n        float density = exp(-pow(distance * 25.0, 2.0));\n        gDiffuse.a = density * color.a * 0.25;\n    }\n"}getUniforms(t){return{...super.getUniforms(t),size:new N.A,aspectRatio:1,color:t.color??b.QE.clone()}}}class ya extends E.A{constructor(t={}){super(t),this.size=t.size??new N.A(.1,.1),this.position=t.position??new a.A(0,.2,0),this.originalPosition=this.position.clone(),this.mesh=new R.A,this.mesh.frustumCulled=!1,this.mesh.renderOrder=1,this.mesh.position.copy(this.position),this.backGeometry=new A.A(1,1),this.backMaterial=new Sa({color:oh.wg,size:this.size}),this.backMesh=new D.A(this.backGeometry,this.backMaterial),this.backMesh.frustumCulled=!1,this.mesh.add(this.backMesh),this.labelGeometry=this.createTextGeometry(""),this.labelMaterial=new q.A({color:new P.A(1,1,1,1),size:this.size,transparent:!0}),this.labelMesh=new D.A(this.labelGeometry,this.labelMaterial),this.labelMesh.frustumCulled=!1,this.labelMesh.renderOrder=1,this.mesh.add(this.labelMesh),this.fadeinTime=.1,this.intermediateTime=2,this.fadeoutTime=.1,this.timeElapsed=0,this.curentText=null,this.currentLevel=-1,this.nextText=null,this.nextLevel=-1,this.heightOffset=.025,this.geometries=new Map}lateUpdate(t,i,s){(this.nextText&&this.fadeinTime<this.timeElapsed&&this.currentLevel<=this.nextLevel||this.nextText&&this.fadeinTime+this.intermediateTime<this.timeElapsed)&&this.showNextText(),this.timeElapsed+=i;let n=0,e=1;this.timeElapsed<=this.fadeinTime?(e=this.timeElapsed/this.fadeinTime,n=this.heightOffset*(1-e)):this.fadeinTime+this.intermediateTime<this.timeElapsed&&(e=1-(this.timeElapsed-(this.fadeinTime+this.intermediateTime))/this.fadeoutTime,n=-this.heightOffset*(1-e)),e=(0,l.qE)(e,0,1),this.mesh.position.y=this.originalPosition.y+n;const h=this.getColor();this.labelMaterial.uniforms.color.copy(h),this.labelMaterial.uniforms.color.w=e,this.backMaterial.uniforms.color.w=e,this.labelMesh.geometry&&(this.backMaterial.uniforms.size.x=this.labelMesh.geometry.boundingBox.max.x-this.labelMesh.geometry.boundingBox.min.x,this.backMaterial.uniforms.size.y=.04,this.backMesh.position.x=(this.labelMesh.geometry.boundingBox.max.x+this.labelMesh.geometry.boundingBox.min.x)/2)}getColor(){switch(this.currentLevel){case 0:default:return oh.uL;case 1:return b.DQ}}showNextText(){let t=this.geometries.get(this.nextText);null==t&&(t=this.createTextGeometry(this.nextText),this.geometries.set(this.nextText,t)),this.labelMesh.geometry=t,this.timeElapsed=0,this.currentText=this.nextText,this.currentLevel=this.nextLevel,this.nextText=null,this.nextLevel=-1}book(t,i=0){this.nextText&&i<=this.nextLevel||(this.nextText=t,this.nextLevel=i)}createTextGeometry(t){return(0,T.CB)(t,{size:.04,align:T.oM,color:b.QE})}}class _a extends E.A{constructor(t,i,s={}){super(s),this.mesh=new R.A,!1===s.visible&&this.hide(),this.mainCamera=t,this.playerController=i,this.target=null,this.instruments=new Ma(t,i,s),this.add(this.instruments),this.baseMarker=new jo,this.add(this.baseMarker),this.combatAlert=new io({position:new a.A(0,.45,0)}),this.add(this.combatAlert),this.systemInfo=new io({position:new a.A(0,.2,0)}),this.add(this.systemInfo),this.aircraftAlert=new io({position:new a.A(0,-.45,0)}),this.add(this.aircraftAlert),this.information=new Ko,this.add(this.information),this.guidance=new Wo,this.add(this.guidance),this.pointInfo=new ya,this.add(this.pointInfo),this.isEnabled=!1,this.isVisible=!0}enable(){this.isEnabled=!0}disable(){this.isEnabled=!1}show(){this.isVisible=!0}hide(){this.isVisible=!1}showBaseMarker(){this.baseMarker.show()}hideBaseMarker(){this.baseMarker.hide()}showBaseDirection(){this.instruments.baseDirectionIndicator.show()}hideBaseDirection(){this.instruments.baseDirectionIndicator.hide()}showAlert(t,i,s){t.show(i,s)}showCombatAlert(t,i){this.showAlert(this.combatAlert,t,i)}showAircraftAlert(t,i){this.showAlert(this.aircraftAlert,t,i)}showSystemInfo(t,i){this.showAlert(this.systemInfo,t,i)}showPointInfo(t,i){this.pointInfo.book(t,i)}fixedUpdate(t,i){this.isEnabled}lateUpdate(t,i,s){this.mesh.visible=this.isEnabled&&this.isVisible}}class Pa extends ne{constructor(t,i,s,n,e){super(t,i,s,n,e),this.type="ship",this.isShip=!0}clone(t={}){return new Pa(t,this.mesh.clone(),this.collider,this.model,this.colliderModel)}}const Aa=Math.PI/180;new wi.A;class Da extends ft.A{constructor(t){super(),this.game=t,this.world=this.game.world,this.vehicleNames=[],this.vehicleProps=new Map,this.vehicleMeshes=new Map,this.vehicleColliders=new Map,this.spawnedVehicles=new Map,this.playerAircraft=null,this.ray=new wi.A({collisionFilterMask:Ii.m1}),this.raycastResult=new wt.A}init(t){this.vehicleNames=t}async load(){for(const t of this.vehicleNames){const i=await(0,l.Fj)(`vehicle/${t}/config.json`),s=await(0,o.i0)(`vehicle/${t}/${i.model}`),n=i.collider?await(0,o.i0)(`vehicle/${t}/${i.collider}`):null;this.vehicleProps.set(t,i),this.vehicleMeshes.set(t,s),this.vehicleColliders.set(t,n)}}createAndSpawnVehicle(t){const i=this.createVehicle(t);this.spawnVehicle(i)}createVehicle(t){const i=this.vehicleProps.get(t.vehicle),s=(0,l.xv)(i,t),n=s.vehicle,e=this.vehicleMeshes.get(n).clone(),h=this.vehicleColliders.get(n)?this.vehicleColliders.get(n).clone():null,o=s.player?new Vo(s,e,h,this.game.playerController,this.game.weaponMeshes):this.En(s,e,h);return s.player&&this.game.setPlayerAircraft(o),s.leader&&(o.leader=s.leader,s.formationPosition&&o.formationPosition.copy(s.formationPosition)),this.Cn(o,s),o}Cn(t,i){if(t.leader&&i.formationPosition)return t.body.position.copy(i.formationPosition),t.leader.body.quaternion.vmult(t.body.position,t.body.position),t.leader.body.position.add(t.body.position,t.body.position),void t.body.quaternion.copy(t.leader.body.quaternion);i.position&&t.body.position.copy(i.position),i.rotation&&t.body.quaternion.setFromEuler&&t.body.quaternion.setFromEuler(i.rotation.x*Aa,i.rotation.y*Aa,i.rotation.z*Aa,"YXZ")}spawnVehicle(t){const i=t.id??(0,l.lk)();this.spawnedVehicles.set(i,t),t.onGround&&this.bn(t),this.game.add(t)}bn(t){this.ray.start.copy(t.body.position),this.ray.start.y+=2e4,this.ray.end.copy(t.body.position),this.ray.end.y-=2e4,this.ray.updateDirectionAndLength(),this.ray.intersectsWorld(this.world,this.raycastResult),this.raycastResult.hasHit&&(t.body.position.y=this.raycastResult.hitPoint.y+t.groundOffset)}removeVehicleById(t){const i=this.spawnedVehicles.get(t);this.spawnedVehicles.delete(t),this.game.remove(i)}removeAllVehicles(){this.spawnedVehicles.forEach((t,i)=>{this.removeVehicleById(i)})}getVehicleById(t){return this.spawnedVehicles.get(t)}getAllVehicles(){return this.spawnedVehicles}getVehicleProps(t){return this.vehicleProps.get(t)}En(t,i,s){switch(t.type){case"aircraft":case"car":return new go(t,i,s);case"vehicle":case"tank":return new ne(t,i,s);case"ship":return new Pa(t,i,s);default:throw new Error(`The vehicle type is not supported: ${type}`)}}}class qa extends Qe.A{constructor(t,i){super(t),this.isGame=!0,this.atmosphereProfile=new Ue,this.atmosphereCalculator=new Be(this.main.renderer,this.atmosphereProfile),this.atmosphereCalculator.precompute(),this.cloudsProfile=new He({sunDirection:this.atmosphereProfile.sunDirection}),this.cloudsCalculator=new Je(this.main.renderer,this.cloudsProfile),this.cloudsCalculator.precompute(),this.scenarioId=i,this.enemiesDown=0,this.score=0,this.time=0,this.finalScore=0,this.clearTime=0,this.scorePerMinute=0,this.isCountingTime=!1,this.isGameStarted=!1,this.showHud=!0,this.isGameOver=!1,this.gameOverTimer=-1,this.isPauseAvailable=!1,this.isHudAvailable=!1,this.vehicles=[],this.missiles=[],this.playerAircraft=null,this.onStartClicked=this.togglePause,this.onDisableFreeCamera=null,this.createActors(),this.Un(),this.Nn()}createCameras(){this.vehicleCamera=new ls(this.playerController,{near:e.l2,far:e.Eh,fov:e.Ue}),this.add(this.vehicleCamera),this.freeCamera=new Ae(this.playerController,{near:e.l2,far:e.Eh,fov:e.Ue}),this.add(this.freeCamera),this.orbitCamera=new De({distance:2e3,verticalAngle:.25,enablePan:!0,panSpeed:-.05,near:e.l2,far:e.Eh,fov:60}),this.add(this.orbitCamera),this.mainCamera=this.orbitCamera,this.lastCamera=null}createActors(){this.eventManager=this.createEventManager(),this.add(this.eventManager),this.vehicleManager=new Da(this),this.add(this.vehicleManager),this.createUI()}Nn(){this.Rn=[new xe,new Me,new Se],this.In=Math.floor(this.Rn.length*Math.random()),this.zn=null,this.isMusicPlaying=!1}Un(){this.logo=new R.A,this.logo.frustumCulled=!1,this.logo.visible=!1,this.background=new uh,this.logo.add(this.background.mesh),this.title=th.A.generateFontMesh("INTERCEPTOR",{size:.1,align:T.oM,color:b.uL}),this.title.position.y=.5,this.logo.add(this.title),this.subTitle=th.A.generateFontMesh("SKY GUARDIANS",{size:.05,align:T.oM,color:b.uL}),this.subTitle.position.y=-.125,this.title.add(this.subTitle),this.background.fitToMesh(this.title,{padding:new N.A(.2,.04),fadeoutScale:.4,showFrame:!0}),this.meshes.push(this.logo)}Ln(){this.logo.visible=!this.logo.visible}Fn(){this.logo.visible=!0}On(){this.logo.visible=!1}createEventManager(){return new ve}createUI(){this.trialTitleMenu=new jh({onStartButtonClicked:this.startGame.bind(this)}),this.add(this.trialTitleMenu),this.hud=null,this.ingameMenu=new X,this.add(this.ingameMenu),this.pauseMenuPanel=new _h,this.ingameMenuBottom=new mh,this.add(this.ingameMenuBottom),this.gameOverMenuPanel=new sh,this.missionResultsPanel=new yh}async load(){await super.load(),this.Nn()}startGame(){this.alpha=0,this.isFadingin=!0,this.isGameStarted||(this.paused=!1,this.hud.enable(),this.isPauseAvailable=!0,this.trialTitleMenu.hide(),this.mainCamera=this.vehicleCamera,this.eventManager.start(),this.isGameStarted=!0,this.time=0,this.score=0,this.enemiesDown=0,this.main.setMasterGain(1))}enableFreeCamera(t){this.mainCamera&&(this.freeCamera.position.copy(this.mainCamera.position),this.freeCamera.quaternion.copy(this.mainCamera.quaternion)),this.lastCamera=this.mainCamera,this.mainCamera=this.freeCamera,this.onStartClicked=this.disableFreeCamera,this.onDisableFreeCamera=t}disableFreeCamera(){this.mainCamera=this.lastCamera,this.onStartClicked=this.togglePause,this.onDisableFreeCamera&&this.onDisableFreeCamera()}endGame(){this.isGameStarted&&(this.ingameMenu.close(),this.hud.disable(),this.isPauseAvailable=!1,this.trialTitleMenu.show(),this.mainCamera=this.orbitCamera,this.eventManager.reset(),this.vehicleManager.removeAllVehicles(),this.isPaused=!1,this.isGameStarted=!1,this.stopMusic(),this.main.setMasterGain(1))}restartGame(){this.endGame(),this.startGame()}missionComplete(){this.isPauseAvailable=!1,this.hud.disable(),this.ingameMenuBottom.openPanel(this.missionResultsPanel)}update(t,i){this.hud||(this.hud=new _a(this.vehicleCamera,this.playerController,{visible:!1}),this.add(this.hud)),this.playerController.toggleLogo&&this.Ln(),super.update(t,i)}fixedUpdate(t,i){this.isPaused||(this.isGameOver&&(this.gameOverTimer-=i),this.isCountingTime&&(this.time+=i),super.fixedUpdate(t,i))}lateUpdate(t,i,s){this.isPaused&&(s=1),this.playerController.pause&&this.onStartClicked(),this.isMusicPlaying&&this.zn.ended&&(this.stopMusic(),this.startMusic()),super.lateUpdate(t,i,s)}togglePause(){this.isPauseAvailable&&(this.isPaused?this.continue():this.pause())}pause(){this.isPauseAvailable&&(this.isPaused=!0,this.hud.disable(),this.ingameMenu.openPanel(this.pauseMenuPanel),this.main.setMasterGain(0))}continue(){this.isPauseAvailable=!0,this.ingameMenu.close(),this.hud.enable(),this.isPaused=!1,this.playerAircraft&&this.playerAircraft.disablePath(),this.main.setMasterGain(1)}createVehicle(t){return this.vehicleManager.createVehicle(t)}spawnVehicle(t){this.vehicleManager.spawnVehicle(t)}createAndSpawnVehicle(t){this.vehicleManager.createAndSpawnVehicle(t)}getAllVehicles(){return this.vehicleManager.getAllVehicles()}getVehicleById(t){return this.vehicleManager.getAllVehicles().get(t)}getVehicleProps(t){return this.vehicleManager.getVehicleProps(t)}removeVehicle(t){this.remove(t),this.vehicleManager.removeVehicleById(t.id)}setPlayerAircraft(t){this.playerAircraft=t,this.vehicleCamera.setVehicle(t)}addMissile(t){0<=this.missiles.indexOf(t)||this.missiles.push(t)}removeMissile(t){const i=this.missiles.indexOf(t);i<0||this.missiles.splice(i,1)}getWaypoint(t){return this.waypointManager.get(t)}getHud(){return this.hud}gameover(){this.stopMusic(),this.ingameMenu.hide(),this.isPauseAvailable=!1,this.hud.disable(),this.ingameMenuBottom.openPanel(this.gameOverMenuPanel)}inform(t,i){this.hud.information.show(t,i)}informLarge(t,i){}showGuidance(t,i){this.hud.guidance.setText(t),this.hud.guidance.toShow=i}hideGuidance(){this.hud.guidance.hide()}addScore(t){this.score+=t}getScore(){return this.score}getTime(){return this.time}returnToMenu(){this.main.openMainMenu()}async createWeaponMeshes(t=[]){this.weaponMeshes={},this.weaponMeshes.missile=K.A.MISSILE;for(const i of t)if(i.type===oe)this.weaponMeshes[oe]=K.A.TACTICAL_LASER}applyGraphicSettings(t){super.applyGraphicSettings(t),this.terrain&&this.terrain.applyGraphicSettings(t),this.vehicleCamera.far=t.viewDistance,this.orbitCamera.far=t.viewDistance,this.freeCamera.far=t.viewDistance}startMusic(){this.zn=this.Rn[this.In++],this.Rn.length<=this.In&&(this.In=0),this.zt(this.zn),this.zn.start(),this.isMusicPlaying=!0}stopMusic(){this.kt(this.zn),this.zn.stop(),this.isMusicPlaying=!1}}new r.A;const Ta=new a.A,Ea=new a.A;class Ca extends fe{constructor(t,i){super(i),this.options=i,this.game=t,this.center=new a.A,i.center&&this.center.copy(i.center)}update(t,i){for(const t of this.spawnProps)this.Vn(t);return!0}Vn(t){const i=this.game.createVehicle(t);if(t.formationPosition||this.kn(t,i),this.game.spawnVehicle(i),t.wingmen)for(const s of t.wingmen){const n=ee(t,s);n.leader=i,this.Vn(n)}}kn(t,i){for(let s=0;s<100&&(this.Gn(i),t.position&&i.position.copy(t.position),t.rotation&&i.quaternion.setFromEuler(t.rotation.x*n.vT,t.rotation.y*n.vT,t.rotation.z*n.vT,"YZX"),i.onGround);s++){const t=this.game.terrain.getGroundType(i.position);if(i.isShip&&t==n.BH)break;if(!i.isShip&&t!=n.BH)break}}Gn(t){const i=t.position,s=this.Bn(),e=(2500+2500*Math.random())*(t.onGround?1:2);if(s.scale(e,i),this.center.add(i,i),t.canBomb&&t.bombController)i.y=n.W7;else{const t=Math.sin(5+15*Math.random())*n.vT;i.y=Math.sin(t)*e}const h=Math.acos((0,l.qE)(n.IU.dot(s)));t.quaternion.setFromAxisAngle(n.UP,h).normalize()}Bn(){this.game.playerAircraft.position.sub(this.center,Ta),Ta.y=0,Ta.normalize();for(let t=0;t<100;t++){const t=2*Math.random()*Math.PI;if(Ea.set(Math.cos(t),0,Math.sin(t)),45*n.vT<=Math.acos((0,l.qE)(Ta.dot(Ea))))break}return Ea}}class ba extends ae{constructor(t){super(t),this.target=t.target,this.airTime=0,this.isTakeoffCompleted=!1,this.nextEventFireTimer=3,this.introTime=3,this.messageShown=!1}update(t,i){const s=this.game.getVehicleById(this.target);if(!s)return!1;if(this.introTime-=i,!(0<this.introTime)){if(this.messageShown||(this.game.isMusicPlaying||this.game.startMusic(),this.game.inform("CLEARED FOR TAKEOFF"),this.game.showGuidance("Increase throttle to take off",function(){return this.game.playerAircraft.throttle<.3&&this.game.playerAircraft.onGround}),this.messageShown=!0),this.isTakeoffCompleted){if(this.nextEventFireTimer-=i,this.nextEventFireTimer<=0)return!0}else s.onGround?this.airTime=0:this.airTime+=i,3<=this.airTime&&(this.isTakeoffCompleted=!0,this.game.hideGuidance(),this.game.inform("TAKEOFF COMPLETED"));return!1}}}class Ua extends ae{constructor(t){super(t)}update(t,i){return t.respawnWingmen(),!0}}const Na=1,Ra="player";class Ia extends ve{constructor(t){super(),this.survival=t,this.events=new Map}addSequentialEvent(t){t.survival=this.game,super.addSequentialEvent(t)}addSingleEvent(t){t.survival=this.game,super.addSingleEvent(t)}init(t){this.config=t,this.waveCenter=new a.A,this.config.center&&this.waveCenter.copy(this.config.center),this.vehiclePrefabs=this.config.vehiclePrefabs,this.enemyWaveConfigs=[];for(const t of this.config.enemyWaves){if((0,l.d6)(t))continue;const i=[];for(const s of t)(0,l.d6)(s)||(s.point=(0,l.zy)(s),i.push(s));this.enemyWaveConfigs.push(i)}this.nextEventId=(0,l.lk)(),this.initialEventId=this.nextEventId,this.resupplyEvent=null,this.createInitialEvents(),this.survival.totalWaves=Na,this.survival.currentWave=1;for(let t=0;t<this.survival.totalWaves;t++)this.addWave(t);this.addSequentialEvent(this.createRTBEvent()),this.addSequentialEvent(new ge)}createInitialEvents(){this.addSequentialEvent(new we),this.addSequentialEvent(new Ua),this.addSequentialEvent(new Ca(this.survival,{vehicles:this.modifyAllyVehicleConfigs(this.config.allyVehicles)})),this.addSequentialEvent(this.createTakeoffEvent()),this.addSequentialEvent(new de({time:3}))}createTakeoffEvent(){return new ba({target:Ra,onWakeUp:function(){this.game.hud.hideBaseMarker(),this.game.hud.hideBaseDirection()}.bind(this),onCompleted:function(){const t=this.createResupplyEvent();this.addSingleEvent(t),this.resupplyEvent=t,this.game.hud.showBaseMarker()}.bind(this)})}createResupplyEvent(){return new me({target:Ra,runway:this.survival.runway,onCompleted:function(){this.game.hideGuidance(),this.game.main.fadeout(function(){this.game.resupply(function(){this.game.main.fadein(),this.addSingleEvent(this.createTakeoffEvent())}.bind(this))}.bind(this))}.bind(this)})}createRTBEvent(){return new me({target:Ra,runway:this.survival.runway,onWakeUp:function(){this.ResupplyEvent&&this.removeSingleEvent(this.resupplyEvent),this.game.hud.showBaseDirection(),this.game.inform("RETURN TO BASE"),this.game.showGuidance("Return to Base",function(){const t=this.game.terrain.runways[0],i=this.game.playerAircraft.position.distanceTo(t.center);return!this.game.playerAircraft.onGround||.5*t.length<i})}.bind(this),onCompleted:function(){this.game.hideGuidance()}.bind(this)})}modifyAllyVehicleConfigs(t){if((0,l.d6)(t))return[];const i=[];for(const s of t){if((0,l.d6)(s))continue;const t=structuredClone(s);this.modifyAllyVehicleConfig(t),i.push(t)}return i}modifyAllyVehicleConfig(t){if(t.wingmen)for(const i of t.wingmen)this.modifyAllyVehicleConfig(i);return t.id=t.id??(0,l.lk)(),t.iff=Ii.Ab.ALLY,t.health=1/0,t.formationPosition||(t.position=t.position??this.getRandomSpawnPosition(),t.rotation=t.rotation??new a.A(0,360*Math.random(),0)),t}addWave(t){const i=Math.floor(this.enemyWaveConfigs.length*Math.random()),s=this.enemyWaveConfigs[i],n=[];for(const t of s)if(!1!==t.active)for(let i=0;i<(t.count??1);i++){const i=structuredClone(t);this.amendVehiclePropsForEnemy(i),n.push(i)}this.addSequentialEvent(new de({time:3,onWakeUp:function(){this.game.currentWave=this.game.wavesCompleted+1,this.game.inform(`WAVE ${t+1}`)}.bind(this)})),this.addSequentialEvent(new Ca(this.survival,{vehicles:n,center:this.waveCenter,onCompleted:function(){this.game.isCountingTime=!0}.bind(this)})),this.addSequentialEvent(new ue({targets:this.getVehicleIds(n),onCompleted:function(){this.game.wavesCompleted++,this.game.isCountingTime=!1}.bind(this)})),this.addSequentialEvent(new de({time:3,onCompleted:function(){this.game.inform(`WAVE ${t+1}\nCOMPLETED\n`,{color:b.DQ,showFrame:!0})}.bind(this)})),this.addSequentialEvent(new de({time:6}))}addInterval(){this.addSequentialEvent(new de({time:3})),this.addSequentialEvent(new pe({})),this.addSequentialEvent(new we({})),this.addSequentialEvent(new Ua({time:3})),this.addSequentialEvent(new ba({target:Ra})),this.addSequentialEvent(new de({time:3}))}getRandomSpawnPosition(){const t=2*Math.PI*Math.random(),i=200+800*Math.random(),s=300+700*Math.random(),n=new a.A(Math.sin(t)*i,s,Math.cos(t)*i);return n.vadd(new a.A(1e3,0,-4600),n),n}amendVehiclePropsForEnemy(t){if(t.wingmen)for(const i of t.wingmen)this.amendVehiclePropsForEnemy(i);return t.id=t.id??(0,l.lk)(),t.iff=2,t.bombingTarget=this.waveCenter,t}getVehicleIds(t){let i=[];for(const s of t)i.push(s.id),s.wingmen&&(i=i.concat(this.getVehicleIds(s.wingmen)));return i}}const za=[new a.A(1,0,1),new a.A(-1,0,1),new a.A(2,0,2)],La=new r.A,Fa=new a.A,Oa=new a.A;class Va extends qa{constructor(t,i){super(t),this.mapName=i,this.isResupplying=!1,this.playerVehicle=null,this.numWingmen=0,this.wingmen=[],this.totalWaves=-1,this.currentWave=-1,this.wavesCompleted=0,this.credits=1e4,this.isShowingOutro=!1,this.isMissionOver=!1,this.wingmanContracts=structuredClone(_),this.aircraftUpgrades=structuredClone(y),this.playerVehicleAirTime=0,this.playerVehicleLandTime=0,this.circularPath=null,this.missionCompleteAudio=null,this.resupplyTimer=0,this.applyGraphicSettings(this.main.graphicSettings)}createCameras(){super.createCameras(),this.resupplyCamera=new c.A({near:e.l2,far:e.Eh,fov:e.Ue})}createEventManager(){return new Ia(this)}createUI(){super.createUI(),this.resupplyMenuPanel=new ut,this.ingameMenu.add(this.resupplyMenuPanel)}async load(){await super.load(),this.missionCompleteAudio=await(0,o.F3)("resource/audio/ending.mp3")}async loadTerrain(){this.config=await(0,l.b2)(`terrain/${this.mapName}/survival.json`);const t=new Bi({useDetailTexture:this.main.graphicSettings.terrainQuality===n.Ls});if(this.terrain=await t.loadTerrain(this.main.renderer,this.mapName),this.terrain.applyGraphicSettings(this.main.graphicSettings),this.add(this.terrain),this.timeOfDay=(0,l.Vk)(this.config.time??"14:00:00"),this.vehicleManager.init(this.config.vehiclePrefabs),this.resupplyProps={aircraftPosition:this.config.resupply?.aircraftPosition??new a.A,aircraftRotation:this.config.resupply?.aircraftRotation??new a.A,cameraPosition:this.config.resupply?.cameraPosition??new a.A,cameraRotation:this.config.resupply?.cameraRotation??new a.A},this.resupplyCamera.position.copy(this.resupplyProps.cameraPosition),this.resupplyCamera.quaternion.setFromEuler(this.config.resupply?.cameraRotation.x*n.vT,this.config.resupply?.cameraRotation.y*n.vT,this.config.resupply?.cameraRotation.z*n.vT,"YXZ"),this.runwayIndex=this.config.runway??0,this.runway=this.terrain.runways[this.runwayIndex],!this.runway)throw new Error("No runway found for index "+this.runwayIndex);this.orbitCamera.centerPosition.copy(this.terrain.runways[this.runwayIndex].center),this.orbitCamera.centerPosition.y+=300;const i=this.runway.center.clone();i.y+=3e3,this.circularPath=new w(i,n.UP,n.NS,1e3,200),this.straitPath=new M(i,n.NS,300),this.randomPath=new x(i,n.NS,300)}async loadVehicles(){const t=this.vehicleManager.getVehicleProps(this.config.playerVehicle.vehicle);await this.createWeaponMeshes(t.availableSPWeapons)}getLoadTasks(){const t=[];return t.push(new h.A("Loading terrain...",this.loadTerrain.bind(this))),t.push(...super.getLoadTasks()),t.push(new h.A("Loading vehicles...",this.loadVehicles.bind(this))),t}startGame(){this.eventManager.init(this.config),this.isMissionCompleted=!1,super.startGame()}createWingmen(t){this.wingmen=[];for(let i=0;i<3;i++){const s=ee(t,{formationPosition:za[i].scale(50)});s.leader=this.playerVehicle,s.iff=this.playerVehicle.iff;const n=this.createVehicle(s),e=this.getWingmanRunwayOffset(i);n.runwayFormationPosition=e,n.runway=this.runway,n.isTakingoff=!0,n.onGround=!0,this.wingmen.push(n)}}getWingmanRunwayOffset(t){const i=new a.A,s=t%2==0?1:-1;return i.x=.25*this.runway.width*s,i.z=this.runway.width+t*this.runway.width,i}getRunwayOffsetStartPosition(t){const i=Math.acos((0,l.qE)(this.runway.direction.dot(n.OX)));La.setFromAxisAngle(n.PX,i);const s=La.vmult(t);return s.add(this.runway.start,s),s}spawnPlayer(){const t=this.vehicleManager.getVehicleProps(this.config.playerVehicle.vehicle);this.playerVehicle=this.createVehicle({id:n._,iff:Ii.Ab.ALLY,vehicle:this.config.playerVehicle.vehicle,position:this.runway.start.add(new a.A(0,3,0)),rotation:this.config.playerVehicle.rotation,speed:this.config.playerVehicle.onGround?0:100,isTakingoff:!0,onGround:!0,player:!0}),this.createSPWeapons(t.availableSPWeapons),this.resupplyMenuPanel.selectSPWeaponPanel.setItems(this.spWeapons),this.resupplyMenuPanel.upgradeAircraftPanel.setItems(this.aircraftUpgrades),this.resupplyMenuPanel.hireWingmenPanel.setItems(this.wingmanContracts),this.playerVehicle.isPlayerAircraft&&(this.playerAircraft=this.playerVehicle),this.placePlayerVehicleOnRunway(),this.createWingmen(this.config.playerVehicle),this.playerVehicle.parkingBrake=1,this.spawnVehicle(this.playerVehicle),this.adjustPlayerVehicleTransform(),this.vehicleCamera.setVehicle(this.playerVehicle)}placePlayerVehicleOnRunway(){this.playerVehicle.body.position.copy(this.runway.start),this.playerVehicle.body.position.y+=this.playerVehicle.groundOffset,n.OX.cross(this.runway.direction,Oa),Oa.normalize();const t=Math.acos((0,l.qE)(n.OX.dot(this.runway.direction)));this.playerVehicle.body.quaternion.setFromAxisAngle(Oa,t),this.playerVehicle.body.velocity.setZero(),this.playerVehicle.body.angularVelocity.setZero()}adjustPlayerVehicleTransform(){const t=this.playerVehicle.body,i=t.quaternion.vmult(n.OX);i.y=0,i.normalize();const s=t.position.clone(),e=new a.A,h=new r.A;for(let o=0;o<1e3;o++){this.world.step(1/60),t.quaternion.vmult(n.OX,e),e.y=0,e.normalize();const o=Math.acos((0,l.qE)(e.dot(i)));e.cross(i,Oa),Oa.normalize(),h.setFromAxisAngle(Oa,o),h.normalize(),t.quaternion.mult(h,t.quaternion),t.quaternion.normalize(),t.position.x=s.x,t.position.z=s.z}}respawnWingmen(){for(let t=0;t<3;t++){const i=this.wingmen[t];if(this.removeVehicle(i),this.numWingmen<=t)continue;const s=this.getRunwayOffsetStartPosition(i.runwayFormationPosition);i.body.position.copy(s),n.OX.cross(this.runway.direction,Fa),Fa.normalize();const e=Math.acos((0,l.qE)(n.OX.dot(this.runway.direction)));i.body.quaternion.setFromAxisAngle(Fa,e),i.body.velocity.setZero(),i.body.angularVelocity.setZero(),this.spawnVehicle(i)}}resupply(t){this.playerAircraft.refill(),this.resortie(),t&&t()}openResupplyMenuPanel(t){this.resupplyMenuPanel.onSortiePressed=t,this.ingameMenu.openPanel(this.resupplyMenuPanel)}resortie(){this.isResupplying=!1,this.isPauseAvailable=!0,this.hud.enable(),this.playerAircraft.disableAnchor(),this.placePlayerVehicleOnRunway(),this.vehicleManager.bn(this.playerAircraft),this.mainCamera=this.vehicleCamera,this.ingameMenu.close()}showResults(){this.ingameMenu.openPanel(this.missionResultsPanel)}showMissionOverMenu(){this.ingameMenu.openPanel(this.missionOverMenuPanel)}createSPWeapons(t=[]){this.spWeapons={};for(const i of t){const t=i.type,s=structuredClone(re[t]);s.equipped=this.playerVehicle.selectedSPWeapon==t,s.acquired=this.playerVehicle.selectedSPWeapon==t,this.spWeapons[t]=s}}missionComplete(){this.isPauseAvailable=!1,this.hud.disable(),this.missionResultsPanel.set(this.enemiesDown,this.score,this.time),this.missionResultsPanel.previousView=this.vehicleCamera.view;let t="-";if(this.time){const i=this.score/(this.time/60);2e3<=i?t="SSS":1750<=i?t="SS":1500<=i?t="S":1250<=i?t="A":1e3<=i?t="B":750<=i?t="C":500<=i?t="D":250<=i&&(t="E")}this.missionResultsPanel.setRank(t),this.ingameMenuBottom.openPanel(this.missionResultsPanel),this.isMissionCompleted=!0}async loadAudioBuffers(){await super.loadAudioBuffers(),this.endingMusic=await(0,o.F3)(this.main.audioListner,"resource/audio/ending.mp3",{loop:!1})}}},2173:(t,i,s)=>{s.a(t,async(t,i)=>{try{var n=s(2638),e=s(1744),h=s(9120),o=s(4261);globalThis.debug=function(t){document.getElementById("debug").textContent=t},await a();const r=WebGLRenderingContext.prototype.getError;async function a(){const t=new e.A,i=new h.A(t,"England"),s=[];s.push(new n.A("Finalizing...",()=>new Promise(t=>setTimeout(t,1e3)))),s.push(...t.getLoadTasks()),s.push(...i.getLoadTasks());let r=0;for(const t of s)r+=t.weight;const a=new o.Ay(t);t.openScene(a);let c=0;for(const t of s)c+=t.weight,a.setProgress(c/r),a.setLabel(t.label),await t.func();t.openScene(i)}WebGLRenderingContext.prototype.getError=function(){const t=r.call(this);return 0!==t&&console.error(`WebGL Error detected: ${t}`),t},i()}catch(c){i(c)}},1)},7545:(t,i,s)=>{s.d(i,{C7:()=>d,CB:()=>_,K9:()=>p,MX:()=>w,bY:()=>y,cL:()=>x,fl:()=>g,hH:()=>M,n8:()=>D,oM:()=>v,ou:()=>A,p5:()=>S,t7:()=>m,tJ:()=>P});var n=s(7830),e=s(832),h=s(2780),o=s(8161),r=s(7133),a=s(1235),c=s(9633),l=s(1035),u=s(5995);const f=WebGL2RenderingContext,d=0,v=1,m=2,w=.001875,p=0,g=1,x=(new e.A(0,1,0,1),.04),M=.0075,S=.035;function y(t,i={}){const s=_(t,i),n=new c.A(i),e=new r.A(s,n);return i.position&&e.position.copy(i.position),e.frustumCulled=!1,e.renderOrder=2,e}function _(t,i={}){return l.A.generateGeometry(String(t),i)}function P(t={}){const i=t.size??new n.A(1,1),s=new o.A(i.x,i.y);s.calculateBoundingBox();const e=new c.A(t),h=new r.A(s,e);return t.position&&h.position.copy(t.position),t.actor&&(h.actor=t.actor),h.frustumCulled=t.frustumCulled??!1,h}function A(t,i){const s=[-t.x/2,t.y/2,0,t.x/2,t.y/2,0,t.x/2,-t.y/2,0,-t.x/2,-t.y/2,0,-t.x/2+i,t.y/2-i,0,t.x/2-i,t.y/2-i,0,t.x/2-i,-t.y/2+i,0,-t.x/2+i,-t.y/2+i,0],n=new h.A;return n.setAttribute("position",new a.A(new Float32Array(s),3,f.FLOAT)),n.setIndices(new a.A(new Uint16Array([0,4,5,5,1,0,1,5,6,6,2,1,2,6,7,7,3,2,3,7,4,4,0,3]),1,f.UNSIGNED_SHORT)),n}function D(t,i,s){const n=A(t,i),e=new c.A({color:s??u.EZ}),h=new r.A(n,e);return h.frustumCulled=!1,h.renderOrder=1,h}},2192:(t,i,s)=>{s.d(i,{A:()=>u});var n=s(6389),e=s(1296),h=s(4857),o=s(7830),r=s(6101);const a=new r.A,c=new r.A,l=new r.A;class u extends e.A{constructor(t={}){super(),this.isUIComponent=!0,this.focusable=t.focuseable??!1,this.selectable=t.selectable??!1,this.enabled=t.enabled??!0,t.disabled&&(this.enabled=!1),this.visible=t.visible??!0,t.hidden&&(this.visible=!1),this.size=(new r.A).copy(t.size??n.VT),this.position=(new r.A).copy(t.position??n.VT),this.absolutePosition=(new r.A).copy(this.position),this.initAABB(t),this.hidden=!1,this.isUIComponent=!0,this.focusable=!1,this.childFocusable=!1,this.lastFocused=!1,this.isFocused=!1,this.mouseFocusable=!1,this.focused=!1,this.selected=!1,this.absolutePosition=new r.A}initAABB(t){this.size.scale(.5,a),this.position.sub(a,c),this.position.add(a,l),this.aabb=new h.A(t.aabb?.min??c,t.aabb?.max??l)}getSelected(){return!1}enable(){this.enabled=!0}disable(){this.enabled=!1,this.Hn()}show(){this.visible=!0,this.mesh.visible=!0}hide(){this.visible=!1,this.mesh.visible=!1,this.Hn()}onRemoved(){super.onRemoved(),this.Hn()}Hn(){this.game?.focusedComponent===this&&(this.game.focusedComponent=null);for(const t of this.children)t.Hn()}onFocused(){}onClicked(){}onDragged(){}}u.SIZE=new o.A(1920,1080),u.ASPECT_RATIO=u.SIZE.x/u.SIZE.y},5995:(t,i,s)=>{s.d(i,{DQ:()=>d,EZ:()=>o,Gh:()=>f,J4:()=>u,QE:()=>a,SE:()=>r,ZZ:()=>c,oU:()=>l,uL:()=>v,wg:()=>e,yJ:()=>h});var n=s(832);const e=new n.A(0,0,0,.75),h=new n.A(.9,.9,.9,.8),o=(new n.A(.3,.3,.3,.8),new n.A(.9,.9,.9,1)),r=new n.A(0,0,0,1),a=(new n.A(.9,.9,.9,1),new n.A(.3,1,.6,1)),c=new n.A(0,.5,1,1),l=(new n.A(.25,1,.25,1),new n.A(1,.9,.3,1)),u=new n.A(1,1,0,1),f=new n.A(1,.1,.2,1),d=new n.A(1,.95,.3,1),v=(new n.A(.95,1,1,1),new n.A(1,1,1,1));new n.A(0,0,0,-1),new n.A(.5,.5,.5,.75)},4261:(t,i,s)=>{s.d(i,{Ay:()=>x});var n=s(7830),e=s(261),h=s(1447),o=s(2780),r=s(1235);const a=WebGL2RenderingContext;class c extends o.A{constructor(t=1,i=1,s=.01){super(),this.innerWidth=t,this.innerHeight=i,this.lineWidth=s,this.outerWidth=this.innerWidth+this.lineWidth,this.outerHeight=this.innerHeight+this.lineWidth;const n=[-.5*this.outerWidth,.5*this.outerHeight,0,.5*this.outerWidth,.5*this.outerHeight,0,.5*this.outerWidth,-.5*this.outerHeight,0,-.5*this.outerWidth,-.5*this.outerHeight,0,-.5*this.innerWidth,.5*this.innerHeight,0,.5*this.innerWidth,.5*this.innerHeight,0,.5*this.innerWidth,-.5*this.innerHeight,0,-.5*this.innerWidth,-.5*this.innerHeight,0];this.attributes={position:new r.A(new Float32Array(n),3,a.FLOAT)},this.indices=new r.A(new Uint16Array([5,1,0,0,4,5,6,2,1,1,5,6,7,3,2,2,6,7,4,0,3,3,7,4]),1,a.UNSIGNED_SHORT)}}var l=s(8161),u=s(7133),f=s(8968),d=s(9633),v=s(1035),m=s(2192);const w=new n.A(100,2);w.scale(.5);class p extends m.A{constructor(t={}){super(t),this.props=t,this.size=t.size??(new n.A).copy(w);const i=new l.A(this.size.x,this.size.y),s=new d.A({color:f.wg});this.mesh=new u.A(i,s),this.mesh.frustumCulled=!1,this.mesh.renderOrder=1,this.textMesh=v.A.generateFontMesh("TEST",{size:.04}),this.textMesh.position.x=-.7,this.textMesh.position.y=-.4,this.progressBar=new g,this.add(this.progressBar)}setLabel(t){this.textMesh.geometry=v.A.generateGeometry(t,{size:.04})}setProgress(t){this.progressBar.setProgress(t)}}class g extends m.A{constructor(t=1.4,i=.1){super(),this.width=t;const s=new c(t,i),n=new d.A;this.mesh=new u.A(s,n),this.mesh.frustumCulled=!1,this.mesh.renderOrder=1,this.mesh.position.y=-.5;const e=new d.A({transparent:!0});e.uniforms.color.w=.5;const h=new l.A(t,i);this.barMesh=new u.A(h,e),this.barMesh.frustumCulled=!1,this.barMesh.renderOrder=1,this.mesh.add(this.barMesh)}setProgress(t){this.barMesh.position.x=.5*-this.width+this.width*t*.5,this.barMesh.position.x=.5*-this.width+this.width*t*.5,this.barMesh.scale.x=t}}new n.A(1.6,1.2).scale(.5);class x extends e.A{constructor(t){super(t),this.loadPanel=new p,this.add(this.loadPanel),this.progress=0,this.interpolatedProgress=0}lateUpdate(t,i,s){super.lateUpdate(t,i,s),this.interpolatedProgress=(0,h.Cc)(this.interpolatedProgress,this.progress,1-Math.exp(10*-i)),this.loadPanel.setProgress(this.interpolatedProgress)}setLabel(t){this.loadPanel.setLabel(t)}setProgress(t){this.progress=t}}},5487:(t,i,s)=>{s.d(i,{A:()=>e});var n=s(813);class e{static ENGINE;static AFTER_BURNER;static DAMAGE;static EXPLOSION;static CRASH;static GUN_FIRE;static HIT;static LASER;static MISSILE_CRUISE;static MISSILE_ALERT;static MISSILE_LOCK;static WIND;static MUSIC;static MUSIC_1;static MUSIC_2;static MUSIC_3;static async load(){const t=[(0,n.F3)("resource/audio/jet/jet.mp3"),(0,n.F3)("resource/audio/afterburner/afterburner.mp3"),(0,n.F3)("resource/audio/458867__raclure__damage-sound-effect/458867__raclure__damage-sound-effect.mp3"),(0,n.F3)("resource/audio/34200__themfish__bamf/34200__themfish__bamf.wav"),(0,n.F3)("resource/audio/592388__magnuswaker__car-crash-with-glass/592388__magnuswaker__car-crash-with-glass.wav"),(0,n.F3)("resource/audio/gun-fire/gun-fire.mp3"),(0,n.F3)("resource/audio/bullet-impact/bullet-impact.mp3"),(0,n.F3)("resource/audio/laser/laser.mp3"),(0,n.F3)("resource/audio/missile-cruise/missile-cruise.mp3"),(0,n.F3)("resource/audio/165504__ryanconway__missile-lock-detected/165504__ryanconway__missile-lock-detected.mp3"),(0,n.F3)("resource/audio/189327__alxy__missile-lock-on-sound/189327__alxy__missile-lock-on-sound.mp3"),(0,n.F3)("resource/audio/wind/wind.mp3"),(0,n.F3)("resource/audio/music.mp3"),(0,n.F3)("resource/audio/music-1/audiostock_1579326.mp3"),(0,n.F3)("resource/audio/music-2/audiostock_1633599.mp3"),(0,n.F3)("resource/audio/music-3/audiostock_1665372.mp3")];await Promise.all(t).then(t=>{let i=0;e.ENGINE=t[i++],e.AFTER_BURNER=t[i++],e.DAMAGE=t[i++],e.EXPLOSION=t[i++],e.CRASH=t[i++],e.GUN_FIRE=t[i++],e.HIT=t[i++],e.LASER=t[i++],e.MISSILE_CRUISE=t[i++],e.MISSILE_ALERT=t[i++],e.MISSILE_LOCK=t[i++],e.WIND=t[i++],e.MUSIC=t[i++],e.MUSIC_1=t[i++],e.MUSIC_2=t[i++],e.MUSIC_3=t[i++]}).catch(t=>{throw t})}}},7389:(t,i,s)=>{s.d(i,{Ab:()=>a,N7:()=>r,m1:()=>n,nq:()=>e,xv:()=>o,zq:()=>h});const n=1,e=4,h=8,o=16,r={TERRAIN:1,TERRAIN_OBJECT:2,VEHICLE:4,LARGE_VEHICLE:8,PLAYER_VEHICLE:16,WEAPON:32,PLAYER_WEAPON:64},a={ALLY:1,ENEMY:2,OTHER:4}},9782:(t,i,s)=>{s.d(i,{A:()=>e});var n=s(813);class e{static AFTER_BURNER;static TACTICAL_LASER;static WEAPON_SELECTOR;static DISTANCE_INDICATOR;static GUN_CURSOR;static CENTER_MARKER;static LOCKON_CURSOR;static MISSILE_CURSOR;static MOUSE_CURSOR;static RADAR_AIR_VEHICLE_MARKER;static RADAR_GROUND_VEHICLE_MARKER;static AIR_VEHICLE_MARKER;static GROUND_VEHICLE_MARKER;static VELOCITY_MARKER;static CHECK;static CONTROLLER;static KEYBOARD;static GRASSES;static MISSILE;static BOMB;static async load(){const t=[(0,n.i0)("resource/model/after-burner/model.glb"),(0,n.i0)("resource/model/weapon/tactical-laser/model.glb"),(0,n.i0)("resource/model/weapon-selector/model.glb"),(0,n.i0)("resource/model/distance-indicator/model.glb"),(0,n.i0)("resource/model/gun-cursor/model.glb"),(0,n.i0)("resource/model/center-marker/model.glb"),(0,n.i0)("resource/model/lockon-cursor/model.glb"),(0,n.i0)("resource/model/missile-cursor/model.glb"),(0,n.i0)("resource/model/mouse-cursor/model.glb"),(0,n.i0)("resource/model/radar-marker-air/model.glb"),(0,n.i0)("resource/model/radar-marker-ground/model.glb"),(0,n.i0)("resource/model/air-cursor/model.glb"),(0,n.i0)("resource/model/ground-cursor/model.glb"),(0,n.i0)("resource/model/velocity-marker/model.glb"),(0,n.i0)("resource/model/icon/check/model.glb"),(0,n.i0)("resource/model/controller/model.glb"),(0,n.i0)("resource/model/keyboard/model.glb"),(0,n.i0)("resource/model/grass/model.glb"),(0,n.i0)("resource/model/weapon/missile/model.glb"),(0,n.i0)("resource/model/weapon/bomb/model.glb")];await Promise.all(t).then(t=>{let i=0;e.AFTER_BURNER=t[i++],e.TACTICAL_LASER=t[i++],e.WEAPON_SELECTOR=t[i++],e.DISTANCE_INDICATOR=t[i++],e.GUN_CURSOR=t[i++],e.CENTER_MARKER=t[i++],e.LOCKON_CURSOR=t[i++],e.MISSILE_CURSOR=t[i++],e.MOUSE_CURSOR=t[i++],e.RADAR_AIR_VEHICLE_MARKER=t[i++],e.RADAR_GROUND_VEHICLE_MARKER=t[i++],e.AIR_VEHICLE_MARKER=t[i++],e.GROUND_VEHICLE_MARKER=t[i++],e.VELOCITY_MARKER=t[i++],e.CHECK=t[i++],e.CONTROLLER=t[i++],e.KEYBOARD=t[i++],e.GRASSES=t[i++],e.MISSILE=t[i++],e.BOMB=t[i++]}).catch(t=>{throw t})}}},7228:(t,i,s)=>{s.d(i,{A:()=>h});var n=s(813);const e=WebGL2RenderingContext;class h{static SMOKE_TEXTURE;static NOISE_TEXTURE;static WAVE_TEXTURE;static BLUE_NOISE_TEXTURE;static DEFAULT_MASK_TEXTURE;static async load(){const t=[(0,n.kv)("resource/img/smoke.png"),(0,n.kv)("resource/img/noise.png"),(0,n.kv)("resource/img/wave_normal.png"),(0,n.kv)("resource/img/blue-noise.png",{magFilter:e.NEAREST,minFilter:e.NEAREST}),(0,n.kv)("resource/img/default_mask.png")];await Promise.all(t).then(t=>{h.SMOKE_TEXTURE=t[0],h.NOISE_TEXTURE=t[1],h.WAVE_TEXTURE=t[2],h.BLUE_NOISE_TEXTURE=t[3],h.DEFAULT_MASK_TEXTURE=t[4]}).catch(t=>{throw t})}}},1447:(t,i,s)=>{s.d(i,{Cc:()=>v,E6:()=>d,EY:()=>f,FK:()=>R,Fj:()=>u,Gk:()=>E,Ho:()=>A,Hy:()=>P,J$:()=>w,Mn:()=>T,P7:()=>D,QS:()=>p,Vk:()=>b,Vs:()=>q,b2:()=>u,bk:()=>_,d6:()=>U,lk:()=>S,qE:()=>m,tR:()=>y,u9:()=>M,up:()=>l,xv:()=>C,zy:()=>N});s(6389);var n=s(9246),e=s(6101),h=s(9691),o=s(5137),r=s(2780),a=(s(7133),s(1235));s(7389);const c=WebGL2RenderingContext,l=Math.PI/180;async function u(t){return await fetch(t).then(t=>{if(!t.ok)throw new Error(`${t.status} ${t.statusText}`);return t.json()}).catch(i=>{throw new Error(t)})}function f(t,i){0<=i.indexOf(t)||i.push(t)}function d(t,i){const s=i.indexOf(t);s<0||i.splice(s,1)}function v(t,i,s){return i==t?t:t+s*(i-t)}function m(t,i=-1,s=1){return Math.min(Math.max(t,i),s)}function w(t){return m(t,0,1)}function p(t,i=1){return Math.min(Math.max(t,-i),i)}const g=new e.A,x=new e.A;function M(t,i,s,n,h,o=new e.A){t.sub(s,g),i.sub(n,x);const r=Math.pow(x.x,2)+Math.pow(x.y,2)+Math.pow(x.z,2)-Math.pow(h,2),a=2*(s.x+x.x+s.y+x.y+s.z+x.z),c=Math.pow(g.x,2)+Math.pow(g.y,2)+Math.pow(g.z,2);if(0==r)return 0==a?o.copy(t):(i.scale(-c/a,o),o.add(t,o),o);let l=0;const u=Math.pow(a,2)-4*r*c;if(u>0){const t=Math.sqrt(u);d=(-a+t)/(2*r),l=(f=(-a-t)/(2*r))<0&&d<0?0:f<0?d:d<0||f<d?f:d}else l=0;var f,d;return x.scale(l,o),o.add(s,o),o.add(g,o),o}function S(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var i=16*Math.random()|0;return("x"===t?i:3&i|8).toString(16)})}function y(t){return t*(Math.PI/180)}function _(t){const i=t.geometry??t.children[0]?.geometry;if(!i)return;const s=i.attributes.position,n=i.getIndices(),h=[];for(let t=0;t<s.count;t++){const i=new e.A;s.getValue(t,i),h.push(i)}const r=[];for(let t=0;t<n.count/3;t++)r.push([n.getX(3*t+0),n.getX(3*t+1),n.getX(3*t+2)]);return new o.A(h,r)}function P(t){const i=t.geometry.attributes.position,s=t.geometry.indices,n=[];for(let t=0;t<i.count;t++){const s=new e.A;i.getValue(t,s),n.push(s)}const o=s.array,r=[];for(const t of o)r.push(t);return new h.A(n,r)}function A(t=1){const i=WebGL2RenderingContext,s=[-1*t,-.5*t,-.5*t,2*t,-.5*t,-.5*t,0*t,1*t,-.5*t,0*t,0*t,1*t],n=new r.A;return n.setAttribute("position",new a.A(new Float32Array(s),3,i.FLOAT)),n.setAttribute("uv",new a.A(new Float32Array([0,0,0,0,0,0,0,0]),2,i.FLOAT)),n.setIndices(new a.A(new Uint16Array([0,3,2,2,3,1,1,3,0,0,1,2]),1,i.UNSIGNED_SHORT)),n}function D(){const t=WebGL2RenderingContext,i=new r.A;return i.setAttribute("position",new a.A(new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0]),3,t.FLOAT)),i.setAttribute("uv",new a.A(new Float32Array([0,0,1,0,1,1,0,1]),2,t.FLOAT)),i.setIndices(new a.A(new Uint16Array([0,1,2,2,3,0]),1,t.UNSIGNED_SHORT)),i}function q(t=new e.A){return t.set(2*Math.random()-1,2*Math.random()-1,2*Math.random()-1),t.normalize(),t}function T(){const t=new e.A(2*(Math.random()-.5),2*(Math.random()-.5),2*(Math.random()-.5));t.normalize();const i=2*Math.PI*Math.random();return(new n.A).setFromAxisAngle(t,i)}function E(t,i,s=new e.A){const n=Math.min(t.length(),i);return s||(s=new e.A),s.copy(t),s.normalize(),s.scale(n,s),s}new n.A,new e.A;function C(t,i){const s=structuredClone(t);for(const t in i)s[t]=i[t];return s}function b(t){const i=t.split(":");return 60*+i[0]*60+60*+i[1]+ +i[2]}function U(t){return!1===t.active||!0===t.disabled}function N(t){return t.point??t.health}function R(t=1){const i=[-1*t,1*t,0,-1*t,-1*t,0,1*t,-1*t,0,1*t,-1*t,0,-1*t,1*t,0,1*t,1*t,0],s={position:new a.A(new Float32Array(i),3,c.FLOAT),uv:new a.A(new Float32Array([0,0,0,1,1,1,1,1,0,0,1,0]),2,c.FLOAT)};return new r.A(s)}}},h={};function o(t){var i=h[t];if(void 0!==i)return i.exports;var s=h[t]={exports:{}};return e[t](s,s.exports,o),s.exports}t="function"==typeof Symbol?Symbol("webpack queues"):"__webpack_queues__",i="function"==typeof Symbol?Symbol("webpack exports"):"__webpack_exports__",s="function"==typeof Symbol?Symbol("webpack error"):"__webpack_error__",n=t=>{t&&t.d<1&&(t.d=1,t.forEach(t=>t.r--),t.forEach(t=>t.r--?t.r++:t()))},o.a=(e,h,o)=>{var r;o&&((r=[]).d=-1);var a,c,l,u=new Set,f=e.exports,d=new Promise((t,i)=>{l=i,c=t});d[i]=f,d[t]=t=>(r&&t(r),u.forEach(t),d.catch(t=>{})),e.exports=d,h(e=>{var h;a=(e=>e.map(e=>{if(null!==e&&"object"==typeof e){if(e[t])return e;if(e.then){var h=[];h.d=0,e.then(t=>{o[i]=t,n(h)},t=>{o[s]=t,n(h)});var o={};return o[t]=t=>t(h),o}}var r={};return r[t]=t=>{},r[i]=e,r}))(e);var o=()=>a.map(t=>{if(t[s])throw t[s];return t[i]}),c=new Promise(i=>{(h=()=>i(o)).r=0;var s=t=>t!==r&&!u.has(t)&&(u.add(t),t&&!t.d&&(h.r++,t.push(h)));a.map(i=>i[t](s))});return h.r?c:o()},t=>(t?l(d[s]=t):c(f),n(r))),r&&r.d<0&&(r.d=0)},o.d=(t,i)=>{for(var s in i)o.o(i,s)&&!o.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:i[s]})},o.o=(t,i)=>Object.prototype.hasOwnProperty.call(t,i);o(2173)})();